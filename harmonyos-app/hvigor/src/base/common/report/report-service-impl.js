"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ReportServiceImpl=void 0;const fs_1=__importDefault(require("fs")),path_1=__importDefault(require("path")),process_1=__importDefault(require("process")),fs_extra_1=__importDefault(require("fs-extra")),local_file_writer_js_1=require("../../../common/util/local-file-writer.js"),path_util_js_1=require("../../../common/util/path-util.js"),global_core_parameters_js_1=require("../../internal/data/global-core-parameters.js");class ReportServiceImpl{constructor(){this.reportListeners=[]}report(){const e=this.getReport(),t=path_util_js_1.PathUtil.getReportDirPath();fs_1.default.existsSync(t)||fs_1.default.mkdirSync(t,{recursive:!0}),this.deleteUnusableFiles(t),this.storage(e,t)}getReport(){const e={version:"2.0",ppid:process_1.default.ppid};for(const t of this.reportListeners){const r=t.queryReport();e[r.getName()]=r.getValue()}return e}storage(e,t){const r=fs_1.default.readdirSync(t).filter(e=>e.startsWith("report-")&&e.endsWith("json")).sort((e,r)=>{const s=path_1.default.resolve(t,e),o=path_1.default.resolve(t,r),i=fs_1.default.statSync(s);return fs_1.default.statSync(o).birthtimeMs-i.birthtimeMs});for(let e=0;e<r.length;e++)if(e>=9){const s=path_1.default.resolve(t,r[e]);fs_1.default.existsSync(s)&&fs_1.default.unlinkSync(s)}const s=require("../../internal/data/global-data.js");if(void 0===s.globalData.buildId)return;const o=s.globalData.buildId;ReportServiceImpl.buildId=o;const i=path_1.default.resolve(t,`report-${o}.json`);local_file_writer_js_1.LocalFileWriter.getInstance().write(i,e),enableHtmlGenerate()&&this.generateHtmlResource(t,`report-${o}`,e)}deleteUnusableFiles(e){fs_1.default.readdirSync(e).forEach(t=>{if(!ReportServiceImpl.REPORT_REG.test(t)&&(!ReportServiceImpl.HTML_REG.test(t)||enableHtmlGenerate())&&t!==ReportServiceImpl.HTML_RESOURCE_NAME&&t!==ReportServiceImpl.UPLOAD_NAME){const r=path_1.default.resolve(e,t);fs_1.default.existsSync(r)&&fs_1.default.unlinkSync(r)}})}addListener(e){this.reportListeners.push(e)}removeListener(e){const t=this.reportListeners.indexOf(e);-1!==t&&this.reportListeners.splice(t,1)}generateHtmlResource(e,t,r){const s=path_1.default.resolve(e,"htmlResource"),o=path_1.default.resolve(__filename,"../../../../../res/staticHtmlResource/htmlResource");if(fs_1.default.existsSync(s)){const e=fs_1.default.readdirSync(o),t=fs_1.default.readdirSync(s);e.every(e=>{if(!t.includes(e))return!1;return fs_1.default.statSync(path_1.default.resolve(o,e)).size===fs_1.default.statSync(path_1.default.resolve(s,e)).size})||fs_extra_1.default.copySync(o,s)}else fs_extra_1.default.copySync(o,s);const i=path_1.default.resolve(__filename,"../../../../../res/staticHtmlResource/index.html"),l=fs_1.default.readFileSync(i,"utf8"),a=`<script>window.__HVIGOR_REPORT__ = ${JSON.stringify(JSON.stringify(r))};<\/script>`,p=l.indexOf("</body>"),n=l.slice(0,p)+a+l.slice(p),c=path_1.default.resolve(e,`${t}.html`);fs_1.default.writeFileSync(c,n)}static getInstance(){return ReportServiceImpl.instance||(ReportServiceImpl.instance=new ReportServiceImpl),ReportServiceImpl.instance}startProcessMonitor(){this.monitorTimeId&&clearInterval(this.monitorTimeId),ReportServiceImpl.data=[],this.monitorTimeId=setInterval(()=>{const e=process_1.default.memoryUsage(),t={time:Date.now(),rss:this.convertToMb(e.rss),heapTotal:this.convertToMb(e.heapTotal),heapUsed:this.convertToMb(e.heapUsed),external:this.convertToMb(e.external),arrayBuffers:this.convertToMb(e.arrayBuffers)};ReportServiceImpl.data.push(t)},ReportServiceImpl.REPORT_INTERVAL_MS)}stopProcessMonitor(){if(this.monitorTimeId){clearInterval(this.monitorTimeId),this.monitorTimeId=void 0;const e={version:ReportServiceImpl.VERSION,pid:process_1.default.pid,data:ReportServiceImpl.data};if(void 0===ReportServiceImpl.buildId)return;const t=path_util_js_1.PathUtil.getReportDirPath(),r=path_1.default.join(t,`report-monitor-${ReportServiceImpl.buildId}.json`);fs_1.default.writeFileSync(r,JSON.stringify(e,null,2),"utf-8")}}convertToMb(e){return e/ReportServiceImpl.MB_CONVERTER/ReportServiceImpl.MB_CONVERTER}}function enableHtmlGenerate(){return"boolean"==typeof global_core_parameters_js_1.coreParameter.properties["hvigor.analyzeHtml"]&&global_core_parameters_js_1.coreParameter.properties["hvigor.analyzeHtml"]}exports.ReportServiceImpl=ReportServiceImpl,ReportServiceImpl.MAX_REPEAT_TIMES=10,ReportServiceImpl.REPORT_REG=/^report(-monitor)?-[0-9]+\.json$/,ReportServiceImpl.HTML_REG=/^report-?[0-9]*.html$/,ReportServiceImpl.HTML_RESOURCE_NAME="htmlResource",ReportServiceImpl.UPLOAD_NAME="upload",ReportServiceImpl.VERSION="1.0",ReportServiceImpl.MB_CONVERTER=1024,ReportServiceImpl.REPORT_INTERVAL_MS=1e3,ReportServiceImpl.data=[];