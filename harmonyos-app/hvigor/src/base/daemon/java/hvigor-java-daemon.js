"use strict";var _a,_b,__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.startJavaDaemon=void 0;const child_process_1=require("child_process"),cluster_1=__importDefault(require("cluster")),crypto_1=require("crypto"),fs_1=__importDefault(require("fs")),path_1=__importDefault(require("path")),hvigor_common_1=require("@ohos/hvigor-common"),ws_1=__importDefault(require("ws")),index_js_1=require("../../../common/util/iconv/index.js"),hvigor_log_js_1=require("../../log/hvigor-log.js"),hvigor_config_reader_js_1=require("../../util/hvigor-config-reader.js"),session_id_js_1=require("../session/session-id.js"),java_daemon_util_js_1=require("./java-daemon-util.js"),_log=hvigor_log_js_1.HvigorLogger.getLogger("JavaDaemon"),DEFAULT_START_PORT=45050,charSet=(0,hvigor_common_1.isWindows)()?"GBK":"UTF-8",HVIGOR_JAVA_DAEMON_JAR="hvigor-java-daemon.jar",HVIGOR_JAVA_DAEMON_JAR_PATH=path_1.default.resolve(__dirname,"../../../../lib",HVIGOR_JAVA_DAEMON_JAR),jvmXmxValue=Number(process.env.Xmx)||(null===(_b=null===(_a=hvigor_config_reader_js_1.HvigorConfigReader.getHvigorConfig())||void 0===_a?void 0:_a.javaOptions)||void 0===_b?void 0:_b.Xmx)||512;function tryStartDaemonAtPort(e,o,r){const t=(0,crypto_1.randomBytes)(32).toString("hex"),i=session_id_js_1.SessionIdHelper.encryptPwdByDefaultMaterial(t,_log),n=(0,child_process_1.spawn)("java",[`-Xmx${jvmXmxValue}m`,"-jar",e,o.toString(),i],{windowsHide:!0});n.on("spawn",()=>{_log.debug(`java daemon started at port ${o} pid ${n.pid}`);try{(0,java_daemon_util_js_1.writeJavaDaemonInfo2CacheFile)({port:o,pid:n.pid,sessionId:i});const e=(0,crypto_1.randomBytes)(32).toString("hex");(0,java_daemon_util_js_1.writeSecretKeyFile)(e)}catch(e){_log.error(`java daemon writeJavaDaemonInfo2CacheFile failed ${e}`)}}),n.on("error",e=>{_log.debug(`on error: ${e}`)}),n.stdout.on("data",e=>{}),n.stderr.on("data",t=>{_log.debug("javaProcess on stderr"),-1!==t.toString().indexOf("java.net.BindException: Address already in use")&&(o++,++r<10&&tryStartDaemonAtPort(e,o,r))}),n.on("exit",(e,o)=>{_log.debug(`java daemon exit code:${e} signal:${o}`)}),process.on("exit",()=>{if(_log.debug(`master process exit pid ${process.pid}`),n.pid)try{process.kill(n.pid),_log.debug(`kill java process pid ${n.pid}`)}catch(e){_log.error(`kill java process failed ${e}`)}})}function tryConnect(e,o){return new Promise((r,t)=>{const i=new ws_1.default(`ws://127.0.0.1:${e}?sessionId=${o}`);i.on("error",function(e){t(e)}),i.on("open",function(){i.close(),r("")})})}function execSystemCommand(e){try{const o=(0,child_process_1.execSync)(e,{windowsHide:!0,encoding:"buffer",stdio:"pipe"});return index_js_1.iconv.decode(o,charSet)}catch(e){if(e.stderr){const o=index_js_1.iconv.decode(e.stderr,charSet);_log.warn(o)}else _log.warn(e)}}function killByPid(e){const o=execSystemCommand(`ps -fp ${e}`);if(o&&o.includes("java -jar")&&o.includes(HVIGOR_JAVA_DAEMON_JAR)&&!o.includes(HVIGOR_JAVA_DAEMON_JAR_PATH))try{process.kill(Number(e),"SIGKILL")}catch(e){_log.warn(e)}}function killByGrep(){const e=execSystemCommand(`ps -ef | grep ${HVIGOR_JAVA_DAEMON_JAR}`);if(!e)return;const o=e.split("\n");for(const e of o)if(e.includes("java -jar")&&!e.includes(HVIGOR_JAVA_DAEMON_JAR_PATH)){const o=e.trim().split(/\s+/);if(o.length<2)continue;const r=o[1];try{process.kill(Number(r),"SIGKILL")}catch(e){_log.warn(e)}}}function startJavaDaemon(){if(cluster_1.default.isMaster){if(!fs_1.default.existsSync(HVIGOR_JAVA_DAEMON_JAR_PATH))return void _log.error(`${HVIGOR_JAVA_DAEMON_JAR} not exist at path ${HVIGOR_JAVA_DAEMON_JAR_PATH}`);const e=(0,java_daemon_util_js_1.readJavaDaemonInfoFromCacheFile)();((0,hvigor_common_1.isLinux)()||(0,hvigor_common_1.isMac)())&&((null==e?void 0:e.pid)?killByPid(e.pid):killByGrep()),(null==e?void 0:e.port)&&(null==e?void 0:e.sessionId)?tryConnect(e.port,null==e?void 0:e.sessionId).then(()=>{_log.debug("java daemon tryConnect success")},e=>{_log.debug(`java daemon tryConnect failed ${e}`),tryStartDaemonAtPort(HVIGOR_JAVA_DAEMON_JAR_PATH,45050,0)}):tryStartDaemonAtPort(HVIGOR_JAVA_DAEMON_JAR_PATH,45050,0)}}exports.startJavaDaemon=startJavaDaemon;