"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.wrapIncrementalDeclarations=void 0;const incremental_task_js_1=require("../external/task/incremental-task.js"),file_set_js_1=require("../internal/snapshot/util/file-set.js"),time_util_js_1=require("../util/time-util.js"),strategies_js_1=require("./strategies.js"),util_js_1=require("./util.js"),isIncrementalTask=e=>!!e&&e instanceof incremental_task_js_1.IncrementalTask,collectDecoratorDecorations=e=>{const t=new Set,r={inputs:new Map,inputFiles:new file_set_js_1.FileSet,outputFiles:new file_set_js_1.FileSet,ignoreDecoratorTypes:new Set};let n=e;for(;isIncrementalTask(n);){((0,util_js_1.getSelfDeclaratorContainer)(n)||[]).filter(({declaratorType:e,propertyKey:t})=>{const n=r.ignoreDecoratorTypes.has(e);return n&&util_js_1.incrementalDeclaratorLogger.debug(`Incremental declaration: '${t}' will be ignored.`),!n}).forEach(n=>{const{propertyKey:a,declaratorType:s,options:i}=n;if(t.has(a))return;t.add(a);const l=e[a];try{strategies_js_1.Strategies[s](a,l,r,i)}catch{util_js_1.incrementalDeclaratorLogger.warn(`Error occurred while setting '${s}' by '${a}' in task '${e.getPath()}', will treat it as normal property.`)}}),n=Object.getPrototypeOf(n)}return r},wrapDeclareInputs=(e,t)=>{if(!t.size)return;const r=e.declareInputs.bind(e);e.declareInputs=function(){const e=r();for(const[r,n]of t)e.set(r,n);return e}},concatFileSet=(e,t)=>{for(const[r,n]of t.collect())e.addEntry(r,n?{...n}:void 0);return e},wrapDeclareInputFiles=(e,t)=>{if(!t.collect().size)return;const r=e.declareInputFiles.bind(e);e.declareInputFiles=function(){return concatFileSet(r(),t)}},wrapDeclareOutputFiles=(e,t)=>{if(!t.collect().size)return;const r=e.declareOutputFiles.bind(e);e.declareOutputFiles=function(){return concatFileSet(r(),t)}},wrapIncrementalDeclarations=e=>{if(!(0,util_js_1.hasIncrementalDecorator)(e))return;const t=process.hrtime(),{inputs:r,inputFiles:n,outputFiles:a}=collectDecoratorDecorations(e);wrapDeclareInputs(e,r),wrapDeclareInputFiles(e,n),wrapDeclareOutputFiles(e,a);const s=process.hrtime(t),i=(0,time_util_js_1.formatTime)(s);util_js_1.incrementalDeclaratorLogger.debug(`Task '${e.getPath()}' cost while wrapping incremental declarations: ${i}`)};exports.wrapIncrementalDeclarations=wrapIncrementalDeclarations;