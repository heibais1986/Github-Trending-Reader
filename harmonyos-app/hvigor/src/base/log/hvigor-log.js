"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,r,t,o){void 0===o&&(o=t);var i=Object.getOwnPropertyDescriptor(r,t);i&&!("get"in i?!r.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return r[t]}}),Object.defineProperty(e,o,i)}:function(e,r,t,o){void 0===o&&(o=t),e[o]=r[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,r){Object.defineProperty(e,"default",{enumerable:!0,value:r})}:function(e,r){e.default=r}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var r={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(r,e,t);return __setModuleDefault(r,e),r};Object.defineProperty(exports,"__esModule",{value:!0}),exports.configure=exports.evaluateLogLevel=exports.HvigorLogger=void 0;const util=__importStar(require("util")),hvigor_logger_1=require("@ohos/hvigor-logger"),log4js=__importStar(require("log4js")),hvigor_trace_js_1=require("../common/trace/hvigor-trace.js"),log_event_js_1=require("../metrics/event/log-event.js"),metric_factory_js_1=require("../metrics/metric-factory.js"),fileLogger_js_1=require("./adaptor/fileLogger.js"),default_configuration_js_1=require("./default-configuration.js");class HvigorLogger{constructor(e){log4js.configure((0,default_configuration_js_1.updateConfiguration)()),this._logger=log4js.getLogger(e),this._logger.level=(0,default_configuration_js_1.getLevel)(),this._filelogger=log4js.getLogger("debug-file"),this.anonymizeFileLogger=new fileLogger_js_1.FileLogger(log4js.getLogger("debug-file"))}static getInstance(e,r){const t=`${e.name}:${r}`;return this.instanceMap.has(t)||this.instanceMap.set(t,new e(r)),this.instanceMap.get(t)}static getLogger(e){return this.getInstance(HvigorLogger,e)}static getLoggerWithDurationId(e,r){const t={...this.getInstance(HvigorLogger,e)},o=Object.setPrototypeOf(t,HvigorLogger.prototype);return o.durationId=r,o}static clean(){HvigorLogger.instanceMap.clear()}log(e,...r){this.createLogEventByDurationId(e,log_event_js_1.MetricLogType.INFO,...r),this._logger.log(e,...r),this._filelogger.log(e,...r)}debug(e,...r){this.createLogEventByDurationId(e,log_event_js_1.MetricLogType.DEBUG,...r),this._logger.debug(e,...r),this._filelogger.debug(e,...r)}info(e,...r){this.createLogEventByDurationId(e,log_event_js_1.MetricLogType.INFO,...r),this._logger.info(e,...r),this._filelogger.debug(e,...r)}warn(e,...r){void 0!==e&&""!==e&&(this.createLogEventByDurationId(e,log_event_js_1.MetricLogType.WARN,...r),this._logger.warn(e,...r),this._filelogger.warn(e,...r))}error(e,...r){this.createLogEventByDurationId(e,log_event_js_1.MetricLogType.ERROR,...r),this._logger.error(e,...r),this._filelogger.warn(e,...r)}anonymizeDebug(e,...r){this._logger.debug(e,...r);const[t,...o]=this.anonymizeFileLogger.debug(e,...r);this.createLogEventByDurationId(t,log_event_js_1.MetricLogType.DEBUG,...o)}_printTaskExecuteInfo(e,r){this._logger.info(`Finished :${e}... after ${r}`),this._filelogger.info(`Finished :${e}... after ${r}`)}_printFailedTaskInfo(e){this._logger.error(`Failed :${e}... `),this._filelogger.error(`Failed :${e}... `)}_printDisabledTaskInfo(e){this._logger.info(`Disabled :${e}... `),this._filelogger.info(`Disabled :${e}... `)}_printUpToDateTaskInfo(e){this._logger.info(`UP-TO-DATE :${e}...  `),this._filelogger.info(`UP-TO-DATE :${e}...  `)}_printStackErrorToFile(e,...r){this._filelogger.error(e,...r)}errorMessageExit(e,...r){throw new Error(util.format(e,...r))}errorExit(e,r,...t){if(r&&(metric_factory_js_1.MetricFactory.createLogEvent(this.getMessage(r,...t),log_event_js_1.MetricLogType.ERROR),this._logger.error(r,t),this._filelogger.error(r,t)),this._logger.error(e.stack),this._filelogger.error(e.stack),e.stack)throw metric_factory_js_1.MetricFactory.createLogEvent(e.stack,log_event_js_1.MetricLogType.ERROR),e}getLevel(){return this._logger.level}setLevel(e){this._logger.level=e}createLogEventByDurationId(e,r,...t){if("string"==typeof e){const o=metric_factory_js_1.MetricFactory.createLogEvent(this.getMessage(e,...t),r);this.durationId&&o.setDurationId(this.durationId)}return e}getMessage(e,...r){return r.length>0?util.format(e,...r):e}getAdaptor(e){return new hvigor_logger_1.HvigorErrorAdaptor(e)}combinePhase(e){return hvigor_trace_js_1.hvigorTrace.traceErrorMessage(e),e.solutions?hvigor_logger_1.ErrorUtil.combinePhase({code:e.code,cause:e.message,position:"",solutions:e.solutions,moreInfo:e.moreInfo}):e.message}formatErrorAdaptor(e,r,t){let o=this.getAdaptor(e);return r&&(o=o.formatMessage(...r)),t&&t.forEach((e,r)=>{o=o.formatSolutions(r,...e)}),o}printErrorWithAdaptorErrorMessage(e){const r=this.combinePhase(e[0]);this._logger.error(r);for(let r=1;r<e.length;++r)this.combinePhase(e[r])}printError(e,r,t){const o=this.formatErrorAdaptor(e,r,t);this.printErrorWithAdaptorErrorMessage(o.getErrorMessage())}printErrorExit(e,r,t,o){const i=this.formatErrorAdaptor(e,r,t),g=this.combinePhase(hvigor_logger_1.ErrorUtil.getFirstErrorAdaptorMessage(i.getErrorMessage()));throw new hvigor_logger_1.AdaptorError(g,o)}printErrorExitWithoutStack(e,r,t){this.printError(e,r,t),process.exit(-1)}}function evaluateLogLevel(e,r){(0,default_configuration_js_1.setCategoriesLevel)(e,r),log4js.shutdown(),log4js.configure((0,default_configuration_js_1.updateConfiguration)())}function configure(e){const r=(0,default_configuration_js_1.getConfiguration)(),t={appenders:{...r.appenders,...e.appenders},categories:{...r.categories,...e.categories}};(0,default_configuration_js_1.setConfiguration)(t),log4js.shutdown(),log4js.configure(t)}exports.HvigorLogger=HvigorLogger,HvigorLogger.instanceMap=new Map,exports.evaluateLogLevel=evaluateLogLevel,exports.configure=configure;