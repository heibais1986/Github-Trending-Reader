"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.configuration=void 0;const cluster_1=__importDefault(require("cluster")),path_1=__importDefault(require("path")),process_1=__importDefault(require("process")),hvigor_logger_1=require("@ohos/hvigor-logger"),hook_const_js_1=require("../../../common/const/hook-const.js"),common_const_js_1=require("../../common/options/common-const.js"),watch_config_file_js_1=require("../../daemon/cluster/watch-config-file.js"),hvigor_core_js_1=require("../../external/core/hvigor-core.js"),hvigor_js_1=require("../../external/core/hvigor.js"),hvigor_system_plugin_js_1=require("../../external/plugin/hvigor-system-plugin.js"),hvigor_log_js_1=require("../../log/hvigor-log.js"),log_event_js_1=require("../../metrics/event/log-event.js"),file_util_js_1=require("../../util/file-util.js"),time_util_js_1=require("../../util/time-util.js"),global_core_parameters_js_1=require("../data/global-core-parameters.js"),global_data_js_1=require("../data/global-data.js"),task_tree_js_1=require("../task/build/task-tree.js"),tasks_js_1=require("../task/build/tasks.js"),task_prune_js_1=require("../task/prune/task-prune.js"),ts_check_js_1=require("../util/ts_check.js"),hvigor_lifecycle_hook_js_1=require("./hook/hvigor-lifecycle-hook.js"),_log=hvigor_log_js_1.HvigorLogger.getLogger("configuration");async function configuration(e){const o="init configuration",t="ohpm install",i="eval hook",r="fin configuration",s=e.createSubEvent(o,"Initialize configuration."),n=e.createSubEvent("configure project task","Configure project task."),a=e.createSubEvent("eval project","Evaluate project."),_=e.createSubEvent("eval modules","Evaluate modules."),g=e.createSubEvent("add config dependencies","Add configuration dependencies."),l=e.createSubEvent(t,"Ohpm install event."),c=e.createSubEvent(i,"EvaluateEvent hook."),u=e.createSubEvent(r,"Finish configuration.");s.start();const v=process_1.default.hrtime(),f=global_data_js_1.globalData.cliEnv,d=hvigor_core_js_1.hvigorCore.getProject(),h=path_1.default.resolve(f.cwd,common_const_js_1.HvigorCommonConst.BUILD_FILE_NAME);s.stop().setLog(o,log_event_js_1.MetricLogType.INFO),configProject(d,n),await evalProject(d,h,a),await evalSubModules(d,_),addConfigDependencies(g),await hvigor_lifecycle_hook_js_1.HvigorLifecycleHook.getInstance().runHook(hook_const_js_1.HookType.nodesEvaluated,hvigor_js_1.hvigor,e),l.start(),await hvigor_lifecycle_hook_js_1.HvigorLifecycleHook.getInstance().runFn(hvigor_core_js_1.hvigorCore.getHvigorNodesBeforeEvaluatedInternalHook(),hvigor_js_1.hvigor),l.stop().setLog(t,log_event_js_1.MetricLogType.INFO),c.start(),await hvigor_lifecycle_hook_js_1.HvigorLifecycleHook.getInstance().runFn(hvigor_core_js_1.hvigorCore.getHvigorNodesEvaluatedInternalHook(),hvigor_js_1.hvigor),c.stop().setLog(i,log_event_js_1.MetricLogType.INFO),u.start();const p=process_1.default.hrtime(v),j=(0,time_util_js_1.formatTime)(p);return _log.debug(`Configuration phase cost:${j}`),u.stop().setLog(r,log_event_js_1.MetricLogType.INFO),d}function configProject(e,o){o.start(),configNodeTask(e),configProjectTask(e),o.stop().setLog()}async function evalProject(e,o,t){t.start();const i=hvigor_js_1.hvigor.getNodeByName(e.getName());void 0!==i&&await hvigor_lifecycle_hook_js_1.HvigorLifecycleHook.getInstance().runHook(hook_const_js_1.HookType.beforeNodeEvaluate,i,t),await e.executeNodeHook(hook_const_js_1.HookType.beforeNodeEvaluate),await evaluateNodeVigorFile(e,(0,file_util_js_1.findRealHvigorFilePath)(o,_log),t);const r=hvigor_core_js_1.hvigorCore.getHvigorAfterNodeInternalHookList(e.getName());try{void 0!==i&&void 0!==r&&await hvigor_lifecycle_hook_js_1.HvigorLifecycleHook.getInstance().runFn(r,i),void 0!==i&&await hvigor_lifecycle_hook_js_1.HvigorLifecycleHook.getInstance().runHook(hook_const_js_1.HookType.afterNodeEvaluate,i,t),await e.executeNodeHook(hook_const_js_1.HookType.afterNodeEvaluate)}catch(e){if(hvigor_logger_1.ErrorUtil.isAdaptorError(e))throw e;_log.printErrorExit("CATCH_ERROR_IN_HVIGOR_FILE",[e.name.toString().replace("hvigor_1.",""),e.message.toString().replace("hvigor_1.",""),`${o.toString().replace("hvigor_1.","")}.ts`])}t.stop().setLog()}async function evalSubModules(e,o){o.start();for(const t of e.getAllSubModules()){const e="eval submodule",i=o.createSubEvent(e,"Evaluate submodule.");i.start(),configNodeTask(t);const r=hvigor_js_1.hvigor.getNodeByName(t.getName());void 0!==r&&await hvigor_lifecycle_hook_js_1.HvigorLifecycleHook.getInstance().runHook(hook_const_js_1.HookType.beforeNodeEvaluate,r,i),await t.executeNodeHook(hook_const_js_1.HookType.beforeNodeEvaluate),await evaluateNodeVigorFile(t,(0,file_util_js_1.findRealHvigorFilePath)(t.getBuildFilePath(),_log),i);const s=hvigor_core_js_1.hvigorCore.getHvigorAfterNodeInternalHookList(t.getName());try{void 0!==r&&void 0!==s&&await hvigor_lifecycle_hook_js_1.HvigorLifecycleHook.getInstance().runFn(s,r),void 0!==r&&await hvigor_lifecycle_hook_js_1.HvigorLifecycleHook.getInstance().runHook(hook_const_js_1.HookType.afterNodeEvaluate,r,i),await t.executeNodeHook(hook_const_js_1.HookType.afterNodeEvaluate)}catch(e){if(hvigor_logger_1.ErrorUtil.isAdaptorError(e))throw e;_log.printErrorExit("CATCH_ERROR_IN_HVIGOR_FILE",[e.name.toString().replace("hvigor_1.",""),e.message.toString().replace("hvigor_1.",""),path_1.default.resolve(null==r?void 0:r.getNodePath(),"hvigorfile.ts").toString().replace("hvigor_1.","")])}i.stop().setLog(e,log_event_js_1.MetricLogType.INFO)}o.stop().setLog()}function addConfigDependencies(e){if(e.start(),cluster_1.default.isWorker){const e=process_1.default.hrtime();(0,watch_config_file_js_1.addConfigDeps)();const o=process_1.default.hrtime(e),t=(0,time_util_js_1.formatTime)(o);_log.debug(`hvigorfile, resolve hvigorfile dependencies in ${t}`)}e.stop().setLog()}function configNodeTask(e){e.registry(new tasks_js_1.Tasks(e)),e.registry(new task_tree_js_1.TaskTree(e))}function configProjectTask(e){e.registry(new task_prune_js_1.PruneTask(e))}async function bindSystemPlugins(e,o,t){if(_log.debug("hvigorfile, binding system plugins",e),"function"==typeof e){const t=await e(o);return o.bindPlugin(t),void o.bindPluginContextFunc(t.getPluginId(),t.getContext.bind(t))}if(!(e instanceof hvigor_system_plugin_js_1.HvigorSystemPlugin)){Object.keys(e).length||_log.printErrorExit("NO_SYSTEM_PLUGINS_WERE_FOUND_IN_HVIGORFILE",[t]);for(const i of Object.keys(e)){const r=e[i];if(r instanceof hvigor_system_plugin_js_1.HvigorSystemPlugin)o.bindPlugin(r);else if("function"==typeof r){const e=await r(o);e.getPluginId||_log.printErrorExit("NO_SYSTEM_PLUGINS_WERE_FOUND_IN_HVIGORFILE",[t]),o.bindPlugin(e)}}}}async function bindCustomPlugins(e,o,t,i){if(_log.debug("hvigorfile, binding custom plugins",e),!e||Array.isArray(e)&&0===e.length)return void _log.debug(`hvigorfile, no custom plugins were found in ${t}`);if(!Array.isArray(e))return void _log.warn(`hvigorfile, invalid custom plugins config found in ${t}`);const r=hvigor_core_js_1.hvigorCore.getHvigorNodeByScriptPath(t.substring(0,t.lastIndexOf(".")));for(let s=0;s<e.length;s++){const n=e[s];"object"==typeof n&&"function"==typeof n.apply?("string"!=typeof n.pluginId&&_log.warn(`The plugin 'plugins[${s}]' in the file '${t}' must contain a 'pluginId' with string type `),n.context&&o.bindPluginContextFunc(n.pluginId,n.context.bind(n)),n.apply&&hvigor_core_js_1.hvigorCore.hvigorAfterNodeInternalHook(o.getName(),async()=>{const e="apply custom plugin",o=i.createSubEvent(e,`Apply custom plugin ${n.pluginId}.`);o.start(),_log.debug(`hvigorfile, executing apply function of custom plugin, pluginId = ${n.pluginId}`);try{await n.apply(r)}catch(e){_log.printErrorExit("FAILED_TO_EXECUTE_FUNCTION_%S_OF_THE_CUSTOM_PLUGIN",["apply",n.pluginId,e.message],[["apply",n.pluginId]],e.stack)}o.stop().setLog(e,log_event_js_1.MetricLogType.INFO)})):_log.warn(`The plugin 'plugins[${s}]' in the file '${t}' is invalid. This plugin will not be loaded. A valid plugin must contain a 'pluginId' with string type and an 'apply' function`)}}async function evaluateNodeVigorFile(e,o,t){const i="eval hvigorfile",r="require hvigorfile",s="bind plugins",n=t.createSubEvent(i,"Evaluate hvigorfile."),a=n.createSubEvent(r,"Require hvigorfile."),_=n.createSubEvent(s,"Bind plugins.");let g;n.start(),a.start(),_log.debug(`hvigorfile, resolving ${o}`),global_core_parameters_js_1.coreParameter.startParams.hvigorfileTypeCheck&&o.endsWith(".ts")&&ts_check_js_1.hvigorfileTSRoots.add(o),delete require.cache[require.resolve(o)];try{g=require(o),_log.debug("hvigorfile, require result: ",g)}catch(e){e instanceof ReferenceError&&"TransformStream is not defined"===e.message&&_log.printErrorExit("NODE_VERSION_TOO_LOW",[e.message],void 0,e.stack),_log.printErrorExit("FAILED_TO_REQUIRE_HVIGORFILE",[e.message,o],void 0,e.stack)}a.stop().setLog(r,log_event_js_1.MetricLogType.INFO),_.start();const l=g.default;l&&l.system?(parseConfig(e,g.default.config),await bindSystemPlugins(g.default.system,e,o),await e.executeAfterBindSystemPluginsHook(),await bindCustomPlugins(g.default.plugins,e,o,_)):(await bindSystemPlugins(g,e,o),await e.executeAfterBindSystemPluginsHook()),_log.debug(`hvigorfile, resolve finished ${o}`),cluster_1.default.isWorker&&(0,watch_config_file_js_1.addModuleDependency)(o),_.stop().setLog(s,log_event_js_1.MetricLogType.INFO),n.stop().setLog(i,log_event_js_1.MetricLogType.INFO)}function parseConfig(e,o){o&&e.loadConfig(o)}exports.configuration=configuration;