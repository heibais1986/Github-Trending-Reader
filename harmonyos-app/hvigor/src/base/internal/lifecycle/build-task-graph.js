"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.buildTaskGraph=void 0;const hvigor_log_js_1=require("../../log/hvigor-log.js"),task_directed_acyclic_graph_js_1=require("../task/core/task-directed-acyclic-graph.js"),task_path_util_js_1=require("../task/util/task-path-util.js"),_log=hvigor_log_js_1.HvigorLogger.getLogger("hvigor-build-task-graph"),taskPathCache=new Map;function buildTaskGraph(e){e.getSubModules().forEach(e=>buildGraph(e,e.getTaskPaths(),e.getTaskGraph())),buildGraph(e,e.getTaskPaths(),e.getTaskGraph());const{hasCircle:a,circlePath:t}=task_directed_acyclic_graph_js_1.projectTaskDag.checkCircle();if(a){const e=`Circular dependency between the following tasks: ${t.join(" -> ")}`;_log.errorMessageExit(e)}}function buildGraph(e,a,t){const r=e.getProject().getSubModules();a.forEach(a=>{const{moduleName:s,taskName:o}=parseTaskPathWithCache(a);if(void 0!==(""===s?e.getProject():r.get(s)))for(const s of e.getTaskDepends(o)){const{moduleName:o,taskName:i}=parseTaskPathWithCache(s),c=""===o?e.getProject():r.get(o);if(void 0===c)return void _log.printErrorExit("CANNOT_FIND_HVIGOR_DEPEND_NODE",[o,i]);c.hasTask(i)||_log.printErrorExit("CANNOT_FIND_HVIGOR_TASK",[i,o,a]),t.addEdge(a,s),task_directed_acyclic_graph_js_1.projectTaskDag.addEdge(a,s)}else _log.printErrorExit("CANNOT_FIND_HVIGOR_NODE",[s,a])})}exports.buildTaskGraph=buildTaskGraph;const parseTaskPathWithCache=e=>{let a=taskPathCache.get(e);return void 0!==a||(a=(0,task_path_util_js_1.parseTaskPath)(e),taskPathCache.set(e,a)),a};