"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.HvigorConfigLoader=void 0;const fs_1=__importDefault(require("fs")),path_1=__importDefault(require("path")),process_1=__importDefault(require("process")),global_core_parameters_js_1=require("../../base/internal/data/global-core-parameters.js"),const_js_1=require("../const/const.js"),path_const_js_1=require("../const/path-const.js"),parse_json_util_js_1=require("./parse-json/parse-json-util.js");class HvigorConfigLoader{constructor(){this.configPropertyMap=new Map;const e=path_1.default.resolve(path_const_js_1.HVIGOR_PROJECT_WRAPPER_HOME,const_js_1.DEFAULT_HVIGOR_CONFIG_JSON_FILE_NAME);if(!fs_1.default.existsSync(e))return;const t=(0,parse_json_util_js_1.parseJsonFile)(e),o=path_1.default.resolve(path_const_js_1.HVIGOR_USER_HOME,const_js_1.DEFAULT_HVIGOR_CONFIG_JSON_FILE_NAME);let r;fs_1.default.existsSync(o)&&(r=(0,parse_json_util_js_1.parseJsonFile)(o),t.properties={...r.properties,...t.properties}),this.hvigorConfig=t}static init(e){var t,o;if(void 0===e)return void(process_1.default.env.config=void 0);const r=HvigorConfigLoader.getConfigs();let i={};null===(t=e.config)||void 0===t||t.forEach(e=>{const t=e.split("=");2===t.length&&(i[t[0]]=t[t.length-1],this.initCommandLineProperties(t[0],t[t.length-1]))}),Array.isArray(e.prop)&&(null===(o=e.prop)||void 0===o||o.forEach(e=>{const t=e.split("=");2===t.length&&(i[t[0]]=t[t.length-1],this.initCommandLineProperties(t[0],t[t.length-1]))})),i={...r,...i},process_1.default.env.config=JSON.stringify(i)}static initCommandLineProperties(e,t){if(!e.startsWith(`${const_js_1.PROPERTIES+const_js_1.DOT}`))return;const o=e.substring(`${const_js_1.PROPERTIES+const_js_1.DOT}`.length);global_core_parameters_js_1.coreParameter.properties[o]=this.convertToParamValue(t)}static convertToParamValue(e){let t=Number(e);return e.length<=16&&!isNaN(t)?t:(t="true"===e||"false"!==e&&t,"boolean"==typeof t?t:e.trim())}getHvigorConfig(){return this.hvigorConfig}getPropertiesConfigValue(e){var t;if(this.configPropertyMap.has(e))return this.configPropertyMap.get(e);const o=HvigorConfigLoader.getConfigs()["properties.".concat(e)],r=void 0!==process_1.default.env.config&&null!==(t=JSON.parse(process_1.default.env.config)["properties.".concat(e)])&&void 0!==t?t:o;if(void 0!==r){const t=this.parseConfigValue(r);return this.configPropertyMap.set(e,t),t}if(void 0===this.hvigorConfig)return void this.configPropertyMap.set(e,void 0);const i=this.hvigorConfig.properties?this.hvigorConfig.properties[e]:void 0;return this.configPropertyMap.set(e,i),i}static clean(){HvigorConfigLoader.instance&&(HvigorConfigLoader.instance=void 0),HvigorConfigLoader.config&&(HvigorConfigLoader.config=void 0)}static getInstance(){return HvigorConfigLoader.instance||(HvigorConfigLoader.instance=new HvigorConfigLoader),HvigorConfigLoader.instance}static getConfigs(){if(this.config)return this.config;const e=process_1.default.argv.slice(2),t=/^(--config|-c).*/,o=/^(--config|-c)$/,r={};for(const[i,s]of e.entries())if(o.test(s)){const t=e[i+1].split("=");2===t.length&&(r[t[0]]=t[t.length-1])}else if(t.test(s)){const e=s.match(t);if(e&&e[0].length<s.length){const t=s.substring(e[0].length).split("=");2===t.length&&(r[t[0]]=t[t.length-1])}}return this.config=r,r}parseConfigValue(e){if("true"===e.toLowerCase())return!0;if("false"===e.toLowerCase())return!1;const t=Number(e);return isNaN(t)?e:t}}exports.HvigorConfigLoader=HvigorConfigLoader,HvigorConfigLoader.config=void 0;