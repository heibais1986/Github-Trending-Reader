"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,o,t,r){void 0===r&&(r=t);var a=Object.getOwnPropertyDescriptor(o,t);a&&!("get"in a?!o.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return o[t]}}),Object.defineProperty(e,r,a)}:function(e,o,t,r){void 0===r&&(r=t),e[r]=o[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,o){Object.defineProperty(e,"default",{enumerable:!0,value:o})}:function(e,o){e.default=o}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var o={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(o,e,t);return __setModuleDefault(o,e),o},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.startHvigorBuild=exports.parseCommand=void 0;const process_1=__importDefault(require("process")),commander_1=require("commander"),log4js=__importStar(require("log4js")),exit_js_1=require("../../base/boot/hooks/exit.js"),hvigor_daemon_client_log_js_1=require("../../base/daemon/log/hvigor-daemon-client-log.js"),process_info_util_js_1=require("../../base/daemon/util/process-info-util.js"),global_core_parameters_js_1=require("../../base/internal/data/global-core-parameters.js"),global_data_js_1=require("../../base/internal/data/global-data.js"),base_log_js_1=__importDefault(require("../../base/log/base-log.js")),default_configuration_js_1=require("../../base/log/default-configuration.js"),hvigor_log_js_1=require("../../base/log/hvigor-log.js"),check_hvigor_config_before_program_js_1=require("../../base/util/check-hvigor-config-before-program.js"),std_hook_js_1=require("../util/std-hook.js"),wrapper_const_js_1=require("../wrapper/wrapper-const.js"),cliVersion=wrapper_const_js_1.CUR_HVIGOR_VERSION,_log=hvigor_log_js_1.HvigorLogger.getLogger("hvigor"),hvigorCommandMixin={flagPair(e,o){return this.option(`--${e}`,`Enables ${o}`).option(`--no-${e}`,`Disables ${o}`)},deprecatedOption(e,o,t){return this.option(e,`['${e}' deprecated: use '${o}' instead] ${t}`)}};function addCommands(e){commander_1.program.command("version").action(()=>{_log.info("CLI version:",cliVersion),_log.info("Local version:",cliVersion||"Unknown"),(0,exit_js_1.exit)(0)}).description("Shows the version of Hvigor."),commander_1.program.command("tasks").action(()=>{e.unshift("tasks")}).description("Shows all available tasks of specific modules."),commander_1.program.command("taskTree").action(()=>{e.unshift("taskTree")}).description("Shows all available task trees of specific modules."),commander_1.program.command("prune").action(()=>{e.unshift("prune")}).description("Cleans up Hvigor cache files and removes unreferenced packages from store."),commander_1.program.command("collectCoverage").action(()=>{e.unshift("collectCoverage")}).description("Generates coverage statistics reports based on instrumentation test data.")}function addBasicOptions(){commander_1.program.option("-e, --error","Sets the log level to error.").option("-w, --warn","Sets the log level to warn.").option("-i, --info","Sets the log level to info.").option("-d, --debug","Sets the log level to debug.").option("-c, --config <config>","Sets properties in the hvigor-config.json5 file. The settings will overwrite those in the file.",(e,o=[])=>o.concat(e)).option("-p, --prop <value>","Defines extra properties.",(e,o)=>o.concat([e]),[]).option("-m, --mode <string>","Sets the mode in which the command is executed.").option("-s, --sync","Syncs the information in plugin for other platforms.").option("--node-home, <string>","Sets the Node.js location.").option("--stop-daemon","Stops the current project's daemon process.").option("--stop-daemon-all","Stops all projects' daemon process.").option("--status-daemon","Shows the daemon process status of the current project.").option("--verbose-analyze","Enables detailed mode for build analysis.").option("--watch","Enables watch mode.").option("--hot-compile","HotReload watch mode to compile.").option("--hot-reload-build","HotReload build").option("--max-old-space-size <integer>","Sets the maximum memory size of V8's old memory section.",e=>{const o=Number(e);return(!Number.isInteger(o)||o<=0)&&_log.printErrorExit("INVALID_MAX_OLD_SPACE_SIZE",[e]),o}).option("--max-semi-space-size <integer>","Sets the maximum memory size of V8's new space memory section.",e=>{const o=Number(e);return(!Number.isInteger(o)||o<=0)&&_log.warn(`MaxSemiSpaceSize must be positive integer. --max-semi-space-size=${e} is invalid. Default value will be used by Node.`),o})}function addOtherOptions(){commander_1.program.option("--Xmx <integer>","Sets the maximum JVM heap size, in MB.",e=>{const o=Number(e);if(!Number.isInteger(o)||o<=0)throw new Error("--Xmx should be positive integer.");return o}).option("--optimization-strategy <string>","Sets the optimization strategy: memory, performance.").deprecatedOption("--enable-build-script-type-check","type-check","Enables the build script hvigorfile.ts type check. This option is deprecated. Use 'type-check' instead.").flagPair("stacktrace","the printing of stack traces for all exceptions.").flagPair("type-check","the build script hvigorfile.ts type check.").flagPair("parallel","parallel building mode.").flagPair("incremental","incremental building mode.").flagPair("daemon","building with daemon process.").flagPair("generate-build-profile","the generation of BuildProfile.ets files.").flagPair("analyze","build analysis.").option("--analyze=<analysisMode>","Sets the build analysis mode: normal (default), advanced, false.").addHelpText("after","\nExamples:\n  hvigor assembleApp  Do assembleApp task\n").addHelpText("after","copyright 2023").helpOption("-h, --help","Displays help information.").allowUnknownOption()}function parseCommand(){(0,std_hook_js_1.initHook)();let e=[];commander_1.program.version(cliVersion,"-v, --version","Shows the version of Hvigor.").name("hvigor").usage("[taskNames...] <options...>"),addBasicOptions(),addOtherOptions(),commander_1.program.arguments("[taskNames...]").action(o=>e=o),addCommands(e),commander_1.program.parse(process_1.default.argv);const o={...commander_1.program.opts(),_:e,env:process_1.default.env};return(0,check_hvigor_config_before_program_js_1.checkHvigorConfigBeforeProgram)(o,base_log_js_1.default).result||(0,exit_js_1.exit)(-1),(0,global_data_js_1.initStartData)(o),initLogger(),(0,hvigor_log_js_1.evaluateLogLevel)(global_core_parameters_js_1.coreParameter.startParams.logLevel),o}function initDaemonClientLogger(){(0,hvigor_daemon_client_log_js_1.configureDaemonClient)(),(0,hvigor_log_js_1.evaluateLogLevel)(global_core_parameters_js_1.coreParameter.startParams.logLevel)}function initLogger(){log4js.shutdown(),log4js.configure((0,default_configuration_js_1.getConfiguration)())}async function startHvigorBuild(e){if(e.stopDaemon&&(0,process_info_util_js_1.stopDaemons)(!1),e.stopDaemonAll&&(0,process_info_util_js_1.stopDaemons)(!0),e.statusDaemon&&(0,process_info_util_js_1.logDaemonInfo)(),_log.debug(`env: daemon=${global_core_parameters_js_1.coreParameter.startParams.daemon}`),global_core_parameters_js_1.coreParameter.startParams.daemon){initDaemonClientLogger();const{daemonBoot:o}=require("./daemon-client.js");await o(e)}else{process_1.default.execArgv.length>0?_log.debug(`no-daemon, use the parent process.execArgv ${process_1.default.execArgv}`):_log.debug("no-daemon, use the default node options");const{boot:o}=require("../../base/boot/index.js");await o(e)}}Object.assign(commander_1.Command.prototype,hvigorCommandMixin),exports.parseCommand=parseCommand,exports.startHvigorBuild=startHvigorBuild;