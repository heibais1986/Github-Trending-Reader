"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.CompileResource=void 0;const path_1=__importDefault(require("path")),hvigor_1=require("@ohos/hvigor"),fs_extra_1=__importDefault(require("fs-extra")),common_util_js_1=require("../common/common-util.js"),build_directory_const_js_1=require("../const/build-directory-const.js"),common_const_js_1=require("../const/common-const.js"),distro_filter_handler_js_1=require("../distribution/distro-filter-handler.js"),compile_resources_util_js_1=require("../utils/compile-resources-util.js"),file_util_js_1=require("../utils/file-util.js"),json_util_js_1=require("../utils/json-util.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),abstract_compile_resource_js_1=require("./abstract/abstract-compile-resource.js"),task_names_js_1=require("./common/task-names.js"),process_resource_js_1=require("./process-resource.js");var Task=task_names_js_1.TaskNames.Task;class CompileResource extends abstract_compile_resource_js_1.AbstractCompileResource{async beforeAlwaysAction(){return this.checkStartupTaskDependencies(),super.beforeAlwaysAction()}declareInputs(){var e,t;const s=super.declareInputs(),i=null===(t=null===(e=this.targetService.getBuildOption())||void 0===e?void 0:e.strictMode)||void 0===t?void 0:t.useNormalizedOHMUrl;return s.set("useNormalizedOHMUrl",!!i),s}declareInputFiles(){var e,t;const s=this.restoolConfigBuilder.inputFiles,i=this.pathInfo.getIntermediatesRouterMap(null!==(e=this.targetService.getRouterMapJsonFileName(this.moduleModel))&&void 0!==e?e:build_directory_const_js_1.BuildArtifactConst.TEMP_ROUTER_MAP_FILE_NAME);if(fs_extra_1.default.existsSync(i)){(null===(t=(0,json_util_js_1.getJson5Obj)(i).routerMap)||void 0===t?void 0:t.length)&&s.addEntry(i)}return this.intermediateTempStartupFilePath&&fs_extra_1.default.existsSync(this.intermediateTempStartupFilePath)&&s.addEntry(this.intermediateTempStartupFilePath),s.addEntries([this.resConfigFilePath],{isDirectory:!1})}declareExecutionCommand(){return this.getCommand().toString()}constructor(e){super(e,Task.COMPILE_RESOURCE),this._log=ohos_logger_js_1.OhosLogger.getLogger(CompileResource.name),this.generateSourceRDir=this.pathInfo.getGenerateSourceR(),this.resConfigFilePath=path_1.default.resolve(this.pathInfo.getIntermediatesRes(),common_const_js_1.CommonConst.RES_CONFIG_FILE),this.processProfileTask=process_resource_js_1.ProcessResource.name}initTaskDepends(){this.declareDepends(process_resource_js_1.ProcessResource.name)}async doTaskAction(){await this.compilationProcess(compile_resources_util_js_1.CompileResourceBuildCommandType.FILE,this.targetData)}async invokeRestool(e){const t="create intermediate resource category",s=this.durationEvent.createSubEvent(t,"");s.start(),await fs_extra_1.default.ensureDir(path_1.default.resolve(this.pathInfo.getIntermediatesRes(),"ids_map")),s.stop(),s.setLog(t,hvigor_1.MetricLogType.INFO);const i=this.sdkInfo.getHosToolchainsLibDir(),r=this.sdkInfo.getPreviewerCommonBinDir(),o={path:`${i};${r}`},a={DYLD_FALLBACK_LIBRARY_PATH:`${process.env.DYLD_FALLBACK_LIBRARY_PATH}:${i}:${r}`},n={LD_LIBRARY_PATH:`${process.env.LD_LIBRARY_PATH}:${i}:${r}`},l=(0,hvigor_1.isWindows)()?o:(0,hvigor_1.isLinux)()?n:a,u=path_1.default.dirname(this.getResToolFile());await this.executeCommand(this.getCommand(),this._log,()=>this.replaceTargetPages(e,this._log),{env:l,cwd:u}),this.customizeDistroFilter(),this.customizeShortcut(),this.processRouterMap(),this.processStartupConfig()}customizeDistroFilter(){var e,t;const s=this.targetData.getTargetOpt();if(!(null===(e=s.config)||void 0===e?void 0:e.distributionFilter))return;const i=s.config.distributionFilter,r=this.service.getProjectModel().getProjectDir(),o=this.targetData.getApiMeta().compileSdkVersion.version,a=this.service.getModuleModel(),n=a.getModule().getNodeDir(),l=path_1.default.resolve(r,n,`src/main/${common_const_js_1.CommonConst.MODULE_JSON5}`),u=(0,json_util_js_1.getJson5Obj)(l).module.metadata;let _,d={};const c=distro_filter_handler_js_1.DistroFilterHandler.findFirstDistroFilterConfigMetadata(r,a,u);let p="";if(9===o?p="distroFilter":o>=10&&(p="distributionFilter"),!c){const e=path_1.default.resolve(this.pathInfo.getModuleProductPath(),`intermediates/res/${s.name}/${build_directory_const_js_1.BuildDirConst.RESOURCES_BASE_PROFILE_DIR}`),t=file_util_js_1.FileUtil.traverseFileFolder(e);_=file_util_js_1.FileUtil.uniqueFileName(t,"ohos_module_distro_filter");const r=path_1.default.resolve(this.pathInfo.getModuleProductPath(),`intermediates/res/${s.name}/module.json`),o=(0,json_util_js_1.getJson5Obj)(r);o.module.metadata?o.module.metadata.push({resource:`$profile:${_}`}):Object.assign(o.module,{metadata:[{resource:`$profile:${_}`}]}),fs_extra_1.default.writeJSONSync(r,o),d={[p]:i}}if(null==c?void 0:c.resource){_=(0,common_util_js_1.parsingProfileName)(c.resource);const e=path_1.default.resolve(r,n,`src/main/${build_directory_const_js_1.BuildDirConst.RESOURCES_BASE_PROFILE_DIR}/${_}.json`),s=(0,json_util_js_1.getJson5Obj)(e);p=null!==(t=Object.keys(s)[0])&&void 0!==t?t:p,d={[p]:{...s.distroFilter,...i}}}const m=path_1.default.resolve(this.pathInfo.getModuleProductPath(),`intermediates/res/${s.name}/${build_directory_const_js_1.BuildDirConst.RESOURCES_BASE_PROFILE_DIR}/${_}.json`);fs_extra_1.default.existsSync(m)||fs_extra_1.default.createFileSync(m),fs_extra_1.default.writeJSONSync(m,d)}writeRouterMap(e){var t;if(!e||0===e.length)return;const s=null!==(t=this.targetService.getRouterMapJsonFileName(this.moduleModel))&&void 0!==t?t:build_directory_const_js_1.BuildArtifactConst.DEFAULT_ROUTER_MAP,i=path_1.default.resolve(this.targetData.getPathInfo().getIntermediatesResProfilePath(),`${s}.json`);fs_extra_1.default.ensureFileSync(i),fs_extra_1.default.writeFileSync(i,JSON.stringify({routerMap:e}));const r=path_1.default.resolve(this.targetData.getPathInfo().getIntermediatesRes(),common_const_js_1.CommonConst.MODULE_JSON),o=(0,json_util_js_1.getJson5Obj)(r);Object.assign(o.module,{routerMap:`$profile:${s}`}),fs_extra_1.default.writeFileSync(r,JSON.stringify(o))}processRouterMap(){var e;const t=this.pathInfo.getIntermediatesRouterMap(null!==(e=this.targetService.getRouterMapJsonFileName(this.moduleModel))&&void 0!==e?e:build_directory_const_js_1.BuildArtifactConst.TEMP_ROUTER_MAP_FILE_NAME);if(!fs_extra_1.default.existsSync(t))return;const s=(0,json_util_js_1.getJson5Obj)(t).routerMap;(null==s?void 0:s.length)&&(s.forEach(e=>{delete e.moduleNodeDir}),this.writeRouterMap(s))}processStartupConfig(){var e,t,s,i;const r=(0,json_util_js_1.getJson5Obj)(this.intermediateTempStartupFilePath);if(void 0===r)return;null===(e=r.startupTasks)||void 0===e||e.forEach(e=>{delete e.moduleName,delete e.srcEntryAbsolutePath,delete e.startupConfigPath}),null===(t=r.appPreloadHintStartupTasks)||void 0===t||t.forEach(e=>{delete e.moduleName,delete e.startupConfigPath,delete e.isRemoteByteCodeHar});const o=path_1.default.resolve(this.targetData.getPathInfo().getIntermediatesResProfilePath(),`${null!==(s=this.appStartupFileName)&&void 0!==s?s:"startup_config"}.json`);if(fs_extra_1.default.ensureFileSync(o),fs_extra_1.default.writeFileSync(o,JSON.stringify(r)),void 0===this.appStartupPath){const e=path_1.default.resolve(this.targetData.getPathInfo().getIntermediatesRes(),"module.json"),t=(0,json_util_js_1.getJson5Obj)(e);t.module.appStartup=`$profile:${null!==(i=this.appStartupFileName)&&void 0!==i?i:"startup_config"}`,fs_extra_1.default.writeFileSync(e,JSON.stringify(t))}}checkStartupTaskDependencies(){var e,t;const s=(0,json_util_js_1.getJson5Obj)(this.intermediateTempStartupFilePath);if(void 0===s)return;const[i,r]=this.getAllStartupTaskNames(s);null===(e=s.startupTasks)||void 0===e||e.forEach(e=>{e.dependencies&&e.dependencies.length>0&&e.dependencies.forEach(t=>{i.includes(t)||this._log._buildError(`The dependency startupTask named ${t} in module ${e.moduleName} is not exist.`)._detail(`Check startupConfig file of module ${e.moduleName} and fix it.`)._file(e.startupConfigPath)._printWarn(this.moduleName)})}),null===(t=s.appPreloadHintStartupTasks)||void 0===t||t.forEach(e=>{e.dependencies&&e.dependencies.length>0&&e.dependencies.forEach(t=>{r.includes(t)||this._log._buildError(`The dependency startupTask named ${t} in module ${e.moduleName} is not exist.`)._detail(`Check startupConfig file of module ${e.moduleName} and fix it.`)._file(e.startupConfigPath)._printWarn(this.moduleName)})})}getAllStartupTaskNames(e){var t,s;const i=[],r=[];return null===(t=e.startupTasks)||void 0===t||t.forEach(e=>{i.push(e.name)}),null===(s=e.appPreloadHintStartupTasks)||void 0===s||s.forEach(e=>{r.push(e.name)}),[i,r]}}exports.CompileResource=CompileResource;