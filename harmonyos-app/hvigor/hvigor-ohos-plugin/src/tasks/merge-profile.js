"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,i){void 0===i&&(i=s);var o=Object.getOwnPropertyDescriptor(t,s);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,i,o)}:function(e,t,s,i){void 0===i&&(i=s),e[i]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.MergeProfile=void 0;const path_1=__importDefault(require("path")),wdk_1=require("@baize/wdk"),hvigor_1=require("@ohos/hvigor"),fs=__importStar(require("fs-extra")),fs_extra_1=__importStar(require("fs-extra")),project_ohos_config_manager_js_1=require("../common/global/project-ohos-config-manager.js"),module_dependency_util_js_1=require("../common/module-dependency-util.js"),build_directory_const_js_1=require("../const/build-directory-const.js"),build_mode_const_js_1=require("../const/build-mode-const.js"),common_const_js_1=require("../const/common-const.js"),sdk_const_js_1=require("../const/sdk-const.js"),module_type_enum_js_1=require("../enum/module-type-enum.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),abstract_merge_profile_js_1=require("./abstract-merge-profile.js"),task_names_js_1=require("./common/task-names.js"),pre_build_js_1=require("./pre-build.js");var Task=task_names_js_1.TaskNames.Task;const array_util_js_1=require("../utils/array-util.js"),inject_util_js_1=require("../utils/inject-util.js"),har_target_util_js_1=require("../utils/har-target-util.js"),json_util_js_1=require("../utils/json-util.js"),hvigor_config_loader_js_1=require("@ohos/hvigor/src/common/util/hvigor-config-loader.js"),dependency_interface_js_1=require("../project/dependency/core/dependency-interface.js"),hsp_target_utils_js_1=require("../utils/hsp-target-utils.js"),ohos_test_util_js_1=require("../utils/ohos-test-util.js"),task_util_js_1=require("../utils/task-util.js"),_log=ohos_logger_js_1.OhosLogger.getLogger("hvigor-merge-profile");class MergeProfile extends abstract_merge_profile_js_1.AbstractMergeProfile{constructor(e){var t,s;super(e,Task.MERGE_PROFILE),this._ohLibs=[],this._isHarModule=this.service.getModuleModel().isHarModule(),this._multiProjects=this._projectModel.getProfileOpt().app.multiProjects||!1,this._appRes=this._projectModel.getAppRes();const i=this.service.getModuleModel().getSourceSetByTargetName(this._targetName);this._moduleTargetRes=i.getModuleTargetRes(),this._mergedModuleJson=this._pathInfo.getIntermediatesMergeProfile(),this._moduleBuildAbilities=null===(s=null===(t=(0,array_util_js_1.getElementFromArr)(this.moduleModel.getProfileOpt().targets,this.targetName))||void 0===t?void 0:t.source)||void 0===s?void 0:s.abilities}declareInputs(){var e,t,s,i;return super.declareInputs().set(abstract_merge_profile_js_1.INPUT_KEY.isHarModule,this._isHarModule).set(abstract_merge_profile_js_1.INPUT_KEY.multiProjects,this._multiProjects).set(abstract_merge_profile_js_1.INPUT_KEY.asanEnable,this.asanEnable).set(abstract_merge_profile_js_1.INPUT_KEY.hwasanEnable,this.hwAsanEnable).set(abstract_merge_profile_js_1.INPUT_KEY.ubsanEnable,this.ubsanEnable).set(abstract_merge_profile_js_1.INPUT_KEY.isDebug,this.targetService.isDebug()).set(abstract_merge_profile_js_1.INPUT_KEY.buildProfileAbilities,JSON.stringify(this._moduleBuildAbilities)).set(abstract_merge_profile_js_1.INPUT_KEY.projectConfigAppOpt,JSON.stringify(null===(e=project_ohos_config_manager_js_1.projectOhosConfigManager.getOverrides())||void 0===e?void 0:e.appOpt)).set(abstract_merge_profile_js_1.INPUT_KEY.moduleJsonOpt,JSON.stringify(this._moduleTargetRes.getModuleJsonOpt())).set(abstract_merge_profile_js_1.INPUT_KEY.appJsonOpt,JSON.stringify(this._appRes.getAppResOpt())).set("integratedHsp",!!(null===(t=this.targetService.getBuildOption().arkOptions)||void 0===t?void 0:t.integratedHsp)).set("removePermissions",JSON.stringify(null===(s=this.targetService.getBuildOption())||void 0===s?void 0:s.removePermissions)).set("isBundledDependencies",this.isBundledDependencies).set("packageName",null!==(i=this.packageJsonObj.name)&&void 0!==i?i:"").set("ohLibs",this._ohLibs)}declareInputFiles(){const e=(new hvigor_1.FileSet).addEntry(this._appRes.getJsonPath()).addEntry(this.projectModel.getProfilePath()).addEntry(this._moduleTargetRes.getJsonPath());return this._ohLibs.forEach(t=>{fs.existsSync(t)&&e.addEntry(t)}),e}declareOutputFiles(){const e=(new hvigor_1.FileSet).addEntry(this._mergedModuleJson);return inject_util_js_1.InjectUtil.isOhosTest()&&e.addEntry(this._pathInfo.getIntermediatesOhosTestResourceStr(),{isDirectory:!0}),e}async beforeAlwaysAction(){await super.beforeAlwaysAction(),this._ohLibs=this.mergeDependsLibs(common_const_js_1.CommonConst.MODULE_JSON)}initTaskDepends(){this.declareDepends(pre_build_js_1.PreBuild.name)}initHarModuleDepends(){har_target_util_js_1.HarTargetUtil.calDepHarTargets(this.targetService).forEach((e,t)=>this.declareDepends(`${e}@${Task.MERGE_PROFILE.name}`,t))}async doTaskAction(){var e,t,s,i;const o=this.computeAppJsonOpt();this.mergeDslConfig(o),this.mergeAppEnvironmentConfig(o);const r=(0,wdk_1.cloneDeep)(this._moduleTargetRes.getModuleJsonOpt());this.targetName===common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET&&(0,ohos_test_util_js_1.isTemplatesAfterSourceCodeMigration)(path_1.default.resolve(this._moduleTargetRes.getResourcePath(),".."))&&(r.module={...(0,ohos_test_util_js_1.getOhosTestAbilityConfig)(),...r.module}),Object.assign(r.module,{packageName:this.packageJsonObj.name});const n=this.mergeBuildProfileAbilities(r),a=this.moduleModel.isHspModule()||this.moduleModel.isHapModule()?this.getRemovePermissionSet(n):new Set,l=this.mergeAllHarModuleOpt(n);(null===(e=null==l?void 0:l.module)||void 0===e?void 0:e.requestPermissions)&&a.size>0&&(l.module.requestPermissions=null===(t=l.module.requestPermissions)||void 0===t?void 0:t.filter(e=>!(null==a?void 0:a.has(e.name)))),fs_extra_1.default.existsSync(this.pathInfo.getResourceStr())&&fs.rmSync(this.pathInfo.getResourceStr(),{recursive:!0,force:!0});const d=l.module.requestPermissions;this.processResourceStr(d),null===(s=r.module.proxyData)||void 0===s||s.forEach(e=>{if(this._bundleName){const t=e.uri.split("/")[2];this._appRes.getAppResOpt().app.bundleName===t&&(e.uri=e.uri.replace(t,this._bundleName))}});const u={...o,...l};this.customizeModuleOpt(u,this.targetData.getProduct());const _=null===(i=this.targetService.getBuildOption().arkOptions)||void 0===i?void 0:i.integratedHsp;this.moduleModel.isHspModule()&&_&&(u.app.bundleName="");if(hvigor_config_loader_js_1.HvigorConfigLoader.getInstance().getPropertiesConfigValue(common_const_js_1.HvigorConfigConst.OHOS_PACK_COMPRESS_LEVEL)&&(u.module.compressNativeLibs=!0),fs_extra_1.default.existsSync(this._mergedModuleJson)){const e=(0,json_util_js_1.getJson5Obj)(this._mergedModuleJson);if(this.moduleModel.isOutModule()&&e.app.bundleName!==u.app.bundleName){_log.debug("Clean the ArkTS cache due to bundleName is changed.");const e=path_1.default.resolve(this.targetData.getPathInfo().getModuleBuildCachePath());await fs_extra_1.default.emptydir(e)}if(e.app.compileSdkVersion&&this.sdkInfo.getToolchainsComponentVersion()&&e.app.compileSdkVersion!==this.sdkInfo.getToolchainsComponentVersion()){_log.debug("Clean the ArkTS cache due to SDK version is changed.");const e=path_1.default.resolve(this.targetData.getPathInfo().getModuleBuildCachePath());await fs_extra_1.default.emptydir(e)}}fs.outputJSONSync(this._mergedModuleJson,u,{spaces:"\t"})}get isBundledDependencies(){return this.targetService.isBundledDependencies()}computeAppJsonOpt(){const e=(0,wdk_1.cloneDeep)(this._appRes.getAppResOpt());if(void 0!==e.app.multiProjects&&(_log.warn(`Field 'multiProjects' should be configured in project's build-profile.json5. The value of this field configured in app.json5 will be ignored. Please configure this field in ${this._projectModel.getProfilePath()}.`),delete e.app.multiProjects),this._isHarModule){const t={app:{bundleName:e.app.bundleName,debug:e.app.debug,versionCode:e.app.versionCode,versionName:e.app.versionName,minCompatibleVersionCode:e.app.minCompatibleVersionCode,minAPIVersion:e.app.minAPIVersion,targetAPIVersion:e.app.targetAPIVersion,apiReleaseType:e.app.apiReleaseType}};this.targetService.getTargetData().getTargetName()===common_const_js_1.CommonConst.OHOS_TEST&&Object.assign(t.app,{icon:e.app.icon,label:e.app.label,vendor:e.app.vendor,bundleType:e.app.bundleType}),e.app=t.app}return this.asanEnable&&(e.app.asanEnabled=this.asanEnable),this.tsanEnable&&(e.app.tsanEnabled=this.tsanEnable),this.hwAsanEnable&&(e.app.hwasanEnabled=this.hwAsanEnable),this.ubsanEnable&&(e.app.ubsanEnabled=this.ubsanEnable),e}mergeAppEnvironmentConfig(e){var t;const s=this.parseToAppEnvironments(this.appEnvironments);if(void 0!==e.app.appEnvironments&&0!==e.app.appEnvironments.length){_log.debug("Change app appEnvironment");const i=new Map;s.forEach(e=>{i.set(e.name,e.value)}),null===(t=e.app.appEnvironments)||void 0===t||t.forEach(e=>{i.set(e.name,e.value)}),e.app.appEnvironments=Array.from(i,([e,t])=>({name:e,value:t}))}else _log.debug("Use cli appEnvironment"),e.app.appEnvironments=s}processResourceStr(e){module_dependency_util_js_1.moduleDependencyUtil.getPureHar(this.service,this.moduleModel,this.projectModel,this.isFaMode).has(this.moduleName)||(this.moduleModel.isHspModule()||this.moduleModel.isHarModule()?(null==e?void 0:e.length)&&this.generateResourceStrByPermissions(e):this.initResourceStr())}generateResourceStrByPermissions(e){const t=[];e.forEach(e=>{e.reason&&!t.includes(e.reason)&&t.push(e.reason.replace("$string:",""))}),t.length&&(this.copyStringToResourceStr(),this.initResourceStr(),this.filterResStr(this.pathInfo.getResourceStr(),t))}copyStringToResourceStr(){const e=this._moduleTargetRes.getResourcePath();fs_extra_1.default.existsSync(e)&&fs_extra_1.default.readdirSync(e).forEach(e=>{if("rawfile"===e||"resfile"===e)return;const t=path_1.default.resolve(this._moduleTargetRes.getResourcePath(),e,"element","string.json");if(!fs_extra_1.default.existsSync(t))return;const s=path_1.default.resolve(this.pathInfo.getResourceStr(),e,"element","string.json");fs_extra_1.default.ensureDirSync(path_1.default.dirname(s)),fs_extra_1.default.copySync(t,s)})}filterResStr(e,t){fs_extra_1.default.existsSync(e)&&fs_extra_1.default.readdirSync(e).forEach(s=>{if("rawfile"!==s&&"resfile"!==s){const i=path_1.default.resolve(e,s,"element","string.json"),o={string:[]};if(fs_extra_1.default.existsSync(i)){if((0,fs_extra_1.readJSONSync)(i).string.forEach(e=>{t.includes(e.name)&&o.string.push(e)}),0===o.string.length)return void fs_extra_1.default.removeSync(path_1.default.resolve(e,s));(0,task_util_js_1.getBuildModeName)()===build_mode_const_js_1.BuildModeConst.TEST&&fs_extra_1.default.outputFileSync(path_1.default.resolve(this.pathInfo.getModuleBuildIntermediates(),build_directory_const_js_1.BuildDirConst.INTERMEDIATES_RES,common_const_js_1.CommonConst.OHOS_TEST,build_directory_const_js_1.BuildDirConst.RESOURCE_STR,s,"element","string.json"),JSON.stringify(o)),fs_extra_1.default.outputFileSync(path_1.default.resolve(e,s,"element","string.json"),JSON.stringify(o))}}})}mergeDslConfig(e){this._bundleName&&(e.app.bundleName=this._bundleName,_log.debug((0,hvigor_1.replaceBundleName)(`Change app bundleName with '${this._bundleName}'.`,this._bundleName))),this._multiProjects&&(e.app.multiProjects=this._multiProjects,_log.debug(`Change app multiProjects with '${this._multiProjects}'.`)),this._vendor&&(e.app.vendor=this._vendor,_log.debug(`Change app vendor with '${this._vendor}'.`)),e.app.apiReleaseType=this.sdkInfo.getReleaseType(),_log.debug(`Change app api release type with '${this.sdkInfo.getReleaseType()}'`),this.resolveApi(e.app)}resolveApi(e){var t,s,i;const o=this.targetData.getApiMeta(),r=!![o.compileSdkVersion.version,o.compatibleSdkVersion.version,null!==(s=null===(t=o.targetSdkVersion)||void 0===t?void 0:t.version)&&void 0!==s?s:o.compileSdkVersion.version].find(e=>e<=sdk_const_js_1.ApiVersion.API_VERSION_9),n=null!==(i=o.targetSdkVersion)&&void 0!==i?i:o.compileSdkVersion,a=this.targetData.isHarmonyOS()?this.apiTransform(n):n.version,l=this.targetData.isHarmonyOS()?this.apiTransform(o.compatibleSdkVersion):o.compatibleSdkVersion.version;e.compileSdkVersion=this.sdkInfo.getToolchainsComponentVersion(),_log.debug(`Change app compile API version with '${this.sdkInfo.getToolchainsComponentVersion()}'`),e.targetAPIVersion=r?n.version:a,_log.debug(`Change app target API version with '${e.targetAPIVersion}'`),e.minAPIVersion=r?o.compatibleSdkVersion.version:l,_log.debug(`Change app minimum API version with '${e.minAPIVersion}'`),e.compileSdkType=this.targetData.isHarmonyOS()?"HarmonyOS":"OpenHarmony"}getRemovePermissionSet(e){var t,s,i;const o=null!==(s=null===(t=this.targetService.getBuildOption())||void 0===t?void 0:t.removePermissions)&&void 0!==s?s:[],r=new Set(o.map(e=>e.name));if((null==r?void 0:r.size)>0&&void 0!==(null===(i=null==e?void 0:e.module)||void 0===i?void 0:i.requestPermissions)){const t=[];e.module.requestPermissions.forEach(e=>{r.has(e.name)&&(t.push(e.name),r.delete(e.name))}),t.length>0&&_log.warn(`The permissions ${t.join(", ")} being removed in the removePermission configuration are duplicated with those in the module.json files of the hap/hsp source code modules. These permissions belong to the current module and should not be removed`)}return r}mergeAllHarModuleOpt(e){if(this._isHarModule)return this.mergeBundledDependenciesHar(e),e;const t=this.transformJson2Opts();let s=e.module.metadata,i=e.module.requestPermissions;for(let o=0;o<t.length;o++){const r=t[o];null!==r&&(this.checkHarApiStatus(r),r.module.type!==module_type_enum_js_1.ModuleType.Har&&checkHarDeviceTypes(e,r,this.targetService),s=this.mergeArrayOptions(s,r.module.metadata,r.module.name),i=this.mergeHarRequestPermission(i,r))}return 0!==(null==s?void 0:s.length)&&(e.module.metadata=s),0!==(null==i?void 0:i.length)&&(e.module.requestPermissions=i),e}mergeBundledDependenciesHar(e){var t,s;if(!this.isBundledDependencies)return;const i=null!==(t=e.module.metadata)&&void 0!==t?t:[],o=null!==(s=e.module.requestPermissions)&&void 0!==s?s:[];this.service.getHarDependencies().forEach(e=>{if(e.isByteCodeHarDependency())return;const t=path_1.default.resolve(e.getDependencyRootPath(),build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN,e.isLocal()?common_const_js_1.CommonConst.MODULE_JSON5:common_const_js_1.CommonConst.MODULE_JSON),s=(0,json_util_js_1.getJson5Obj)(t),r=s.module.metadata;this.deDuplicateArr(r,i);const n=s.module.requestPermissions;this.deDuplicateArr(n,o)}),Object.assign(e.module,{metadata:i}),Object.assign(e.module,{requestPermissions:o})}deDuplicateArr(e,t){null==e||e.forEach(e=>{t.some(t=>t.name===e.name)||t.push(e)})}mergeDependsLibs(e){const t=this.service.getDependencyRootPaths(),s=this.service.getHarModuleDependenciesWithRootPath(),i=this.service.getHarModuleDependencyPaths(),o=this.service.getHspModuleDependencies(),r=this.service.getHspModuleDependencyPaths(),n=hsp_target_utils_js_1.HspTargetUtils.calDepHspTargets(this.targetService);return t.map(t=>{var a,l;const d=inject_util_js_1.InjectUtil.getBuildCacheParentDir(t,path_1.default.join(hvigor_1.hvigorCore.getProject().getName(),t.substring(hvigor_1.hvigorCore.getProject().getNodeDir().length)));if(r.includes(t)){const s=(null!==(a=o.find(([,e])=>e.getDependencyRootPath()===t))&&void 0!==a?a:[""])[0],i=n.get(s);return path_1.default.resolve(d,this._buildRoot,this.targetData.getProduct().name,build_directory_const_js_1.BuildDirConst.INTERMEDIATES,build_directory_const_js_1.BuildDirConst.INTERMEDIATES_MERGE_PROFILE,null!==(l=null==i?void 0:i.getTargetName())&&void 0!==l?l:common_const_js_1.DefaultTargetConst.DEFAULT_TARGET,e)}return i.includes(t)?this.getHarDenPath(s,t,d,e):path_1.default.resolve(t,build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN,e)})}transformJson2Opts(){return this._ohLibs.map(e=>fs.pathExistsSync(e)?(0,json_util_js_1.getJson5Obj)(e):(_log.warn(`${e} does not exist. This library will not be merged. This may occur when the project is manually modified and the local library is not declared in ${this._projectModel.getProfilePath()}. Please confirm the correctness of this module. You may try to solve the problem by declare it in ${this.moduleModel.getName()} build-profile.json5.`),null))}mergeHarRequestPermission(e,t){return this.mergeArrayOptions(e,t.module.requestPermissions)}mergeArrayOptions(e,t,s){const i=[],o=[];return null==e||e.forEach(e=>{i.push(e),o.push(e.name)}),null==t||t.forEach(e=>{const t=e.name;void 0!==t&&""!==t?o.includes(e.name)||i.push(e):_log.warn(`The metadata configuration in module.json5 whose name is empty or undefined in the har:${s}.\n        This configuration will not be merged.`)}),i}checkHarApiStatus(e){let t=e.app.minAPIVersion;const s=e.module.packageName;void 0===t&&_log.printErrorExit("EMPTY_MIN_API_VERSION",[`${s}`]),t.toString().length>=4&&(t=this.harMinApiVersionToAPi(t.toString())),this.targetData.getCompatibleApiVersion()<(0,wdk_1.parseInt)(t)&&_log.printErrorExit("HAR_UNSUPPORTED_API_VERSION",[this.compatibleApiVersion,t,`${s}`],[[this.projectModel.getProfilePath()],[s,this.compatibleApiVersion],[s,this.compatibleApiVersion]])}harMinApiVersionToAPi(e){const t=e.length,s=e.substring(t-3,t);return(0,wdk_1.parseInt)(s)}customizeModuleOpt(e,t){var s,i,o,r,n,a,l,d,u,_,p,c,m,h;const g=(0,wdk_1.cloneDeep)(null===(s=project_ohos_config_manager_js_1.projectOhosConfigManager.getOverrides())||void 0===s?void 0:s.appOpt),f=e.module,v=null!==(r=null!==(o=null!==(i=null==g?void 0:g.bundleType)&&void 0!==i?i:t.bundleType)&&void 0!==o?o:e.app.bundleType)&&void 0!==r?r:"app",b=e.app;b.bundleType=v,this._isHarModule||(b.label=null!==(a=null!==(n=null==g?void 0:g.label)&&void 0!==n?n:t.label)&&void 0!==a?a:b.label,b.icon=null!==(d=null!==(l=null==g?void 0:g.icon)&&void 0!==l?l:t.icon)&&void 0!==d?d:b.icon),b.versionCode=null!==(_=null!==(u=null==g?void 0:g.versionCode)&&void 0!==u?u:t.versionCode)&&void 0!==_?_:b.versionCode,b.versionName=null!==(c=null!==(p=null==g?void 0:g.versionName)&&void 0!==p?p:t.versionName)&&void 0!==c?c:b.versionName,v===common_const_js_1.BundleType.ATOMIC_SERVICE&&(f.atomicService=null!==(h=null===(m=this.targetData.getTargetOpt().config)||void 0===m?void 0:m.atomicService)&&void 0!==h?h:f.atomicService,f.installationFree=!0),v!==common_const_js_1.BundleType.APP&&v!==common_const_js_1.BundleType.SHARED||(f.installationFree=!1,f.atomicService&&delete f.atomicService),b.buildMode=this.targetService.isDebug()?build_mode_const_js_1.BuildModeConst.DEBUG:build_mode_const_js_1.BuildModeConst.RELEASE,void 0===b.debug&&(b.debug=this.targetService.isDebug())}mergeBuildProfileAbilities(e){var t,s,i;if(!this.moduleModel.isHapModule()||!this._moduleBuildAbilities||!e.module.abilities)return this.moduleModel.isHspModule()&&this._moduleBuildAbilities&&_log.warn("hsp module does not support custom icon/label/lauchType in buildProfile"),e;const o=e.module.abilities.map(e=>e.name);for(const r of this._moduleBuildAbilities)for(const n of e.module.abilities)r.name&&o.includes(r.name)?n.name===r.name&&(n.icon=null!==(t=r.icon)&&void 0!==t?t:n.icon,n.label=null!==(s=r.label)&&void 0!==s?s:n.label,n.launchType=null!==(i=r.launchType)&&void 0!==i?i:n.launchType):_log.warn(`The ability name :${r.name} in build-profile can't find correspond ability name\n            in module.json.`);return e}initResourceStr(){[...this.service.getHspDependencies(),...this.service.getHarDependencies()].forEach(e=>{let t;t=e.isLocal()?this.pathInfo.getDependencyResourceStr(e.getDependencyRootPath()):e.getDependencyType()===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HAR?path_1.default.resolve(e.getDependencyRootPath(),"src","main","resources"):path_1.default.resolve(e.getDependencyRootPath(),"src","main","resource"),fs_extra_1.default.existsSync(t)&&fs_extra_1.default.readdirSync(t).forEach(e=>{if("rawfile"!==e&&"resfile"!==e){const s=path_1.default.resolve(t,e,"element","string.json"),i=path_1.default.resolve(this.pathInfo.getResourceStr(),e,"element","string.json");let o;const r=(0,json_util_js_1.getJson5Obj)(s);r&&!Object.prototype.hasOwnProperty.call(r,"string")&&_log.printErrorExit("WRONG_STRING_JSON_FORMAT",[s]),fs_extra_1.default.existsSync(i)?(o=(0,json_util_js_1.getJson5Obj)(i),Object.prototype.hasOwnProperty.call(o,"string")||_log.printErrorExit("WRONG_STRING_JSON_FORMAT",[i]),o=(0,json_util_js_1.mergeStringJson)(o,r)):o=r,o&&fs_extra_1.default.outputFileSync(i,JSON.stringify(o))}})})}}function checkHarDeviceTypes(e,t,s){const i=s.getTargetData().getTargetDeviceType(),o=t.module.deviceTypes,r="default",n="phone";(o.includes(r)||o.includes(n))&&(o.push(n),o.push(r));const a=i.filter(e=>!o.includes(e));a.length>0&&_log.printErrorExit("CURRENT_MODULE_NOT_SUPPORT_THE_DEVICE_TYPE",[t.module.type,t.module.name,a.join(", ")])}exports.MergeProfile=MergeProfile;