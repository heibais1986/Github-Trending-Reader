"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ProcessRouterMap=void 0;const fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path")),build_directory_const_js_1=require("../const/build-directory-const.js"),common_const_js_1=require("../const/common-const.js"),module_type_enum_js_1=require("../enum/module-type-enum.js"),dependency_manager_js_1=require("../project/dependency/dependency-manager.js"),file_util_js_1=require("../utils/file-util.js"),json_util_js_1=require("../utils/json-util.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),ohmurl_utils_js_1=require("../utils/ohmurl-utils.js"),task_names_js_1=require("./common/task-names.js"),ohos_hap_task_js_1=require("./task/ohos-hap-task.js"),array_util_js_1=require("../utils/array-util.js"),har_target_util_js_1=require("../utils/har-target-util.js"),dependency_util_js_1=require("../utils/dependency-util.js");class ProcessRouterMap extends ohos_hap_task_js_1.OhosHapTask{constructor(e){var t,s,r;super(e,task_names_js_1.TaskNames.Task.PROCESS_ROUTER_MAP),this._log=ohos_logger_js_1.OhosLogger.getLogger(ProcessRouterMap.name),this.moduleName2Target=new Map,this.compileEntry=[],this.routerMapFileName=this.targetService.getRouterMapJsonFileName(this.moduleModel),this.intermediatesRouterMapObjs=[],this.intermediatesTempRouterMapFilePath=this.pathInfo.getIntermediatesRouterMap(null!==(t=this.routerMapFileName)&&void 0!==t?t:build_directory_const_js_1.BuildArtifactConst.TEMP_ROUTER_MAP_FILE_NAME),this.intermediatesToLoaderRouterMap=this.pathInfo.getIntermediatesRouterMap(build_directory_const_js_1.BuildArtifactConst.LOADER_ROUTER_MAP_FILE_NAME),this.useNormalizedOHMUrl=!!(null===(r=null===(s=this.targetService.getBuildOption())||void 0===s?void 0:s.strictMode)||void 0===r?void 0:r.useNormalizedOHMUrl)}declareInputFiles(){const e=super.declareInputFiles(),t=this.projectModel.isOhpmProject();e.addEntry(t?this.moduleModel.getOhPackageJson5Path():this.moduleModel.getPackageJsonPath()).addEntry(t?this.projectModel.getOhPackageJson5Path():this.projectModel.getPackageJsonPath()).addEntry(this.moduleModel.getJsonPathByTargetName(this.targetName));const s=this.targetService.getRouterMapJsonPath(this.moduleModel);return s&&fs_extra_1.default.existsSync(s)&&e.addEntry(s),fs_extra_1.default.existsSync(this.pathInfo.getIntermediatesPkgContextInfoPath())&&e.addEntry(this.pathInfo.getIntermediatesPkgContextInfoPath()),e}declareOutputFiles(){return super.declareOutputFiles().addEntry(this.intermediatesTempRouterMapFilePath).addEntry(this.intermediatesToLoaderRouterMap)}declareInputs(){const e=super.declareInputs();return e.set(common_const_js_1.CommonConst.USE_NORMALIZED_OHM_URL,this.useNormalizedOHMUrl),e.set("obfuscated",this.targetService.isOpenSource()),e.set("byteCodeHar",this.targetService.isByteCodeHar()),this.service.getHarDependencies().forEach(t=>{if(t.isLocal()){const s=this.getLocalDependencyRouterMap(t);s&&e.set("localDependencyRouterMapObjList",JSON.stringify(s))}else{const s=dependency_manager_js_1.DependencyManager.getRemoteDependencyRouterMapObjList(t);s&&e.set("remoteDependencyRouterMapObjList",JSON.stringify(s))}}),e}async beforeAlwaysAction(){await super.beforeAlwaysAction(),this.moduleName2Target=har_target_util_js_1.HarTargetUtil.calDepHarTargets(this.targetService)}doTaskAction(){const e=this.targetService.getTargetRouterMapObjList(this.moduleModel);this.service.getModuleModel().getModuleType()!==module_type_enum_js_1.ModuleType.Har||this.targetService.isBundledDependencies()?this.processHapOrHspRouterMap(e):this.processHarRouterMap(e)}processHarRouterMap(e){if(!e)return;this.checkModuleRouterMapObj(e,this.moduleModel,!1),this.checkRouterMapObjName(e);const t=this.hasUseTsHarField()?".ts":".js";e.forEach(e=>{const s={name:e.name,pageSourceFile:path_1.default.resolve(this.module.getNodeDir(),e.pageSourceFile),buildFunction:e.buildFunction};if(this.intermediatesRouterMapObjs.push(s),this.compileEntry.push(s.pageSourceFile),!this.targetService.isOpenSource()||this.targetService.isByteCodeHar()){const s=e.pageSourceFile,r=file_util_js_1.FileUtil.getFileSuffix(s);common_const_js_1.ValidateRegExp.DYNAMIC_IMPORT_FILE_SUFFIX_REG_EXP.test(r)&&Object.assign(e,{pageSourceFile:`${s.substring(0,s.lastIndexOf("."))}${t}`,originalSuffix:`.${r}`})}}),this.generateTempRouterMap(e,this.intermediatesRouterMapObjs)}processHapOrHspRouterMap(e){const t=[];this.processModuleSelfRouterMap(t,e),this.processModuleDependencyRouterMap(t),this.checkRouterMapObjName(t),this.generateTempRouterMap(t,this.intermediatesRouterMapObjs)}processModuleSelfRouterMap(e,t){t&&(this.checkModuleRouterMapObj(t,this.moduleModel,!1),t.forEach(e=>{const t=path_1.default.resolve(this.moduleModel.getModule().getNodeDir(),e.pageSourceFile);this.compileEntry.push(t);let s="";if(this.useNormalizedOHMUrl){const t=this.pathInfo.getIntermediatesPkgContextInfoPath(),r=(0,json_util_js_1.getJson5Obj)(t)[this.packageJsonObj.name];s=(0,ohmurl_utils_js_1.generateOhmUrlForSourceFile)(r,e.pageSourceFile)}else s=this.generateModuleOhmurl(this.moduleName,e.pageSourceFile);Object.assign(e,{ohmurl:s,bundleName:this.getBundleName(),moduleName:this.moduleName});const r={ohmurl:s,name:e.name,pageSourceFile:t,buildFunction:e.buildFunction};this.intermediatesRouterMapObjs.push(r)}),e.push(...t))}processModuleDependencyRouterMap(e){const t=new Map;this.service.getHarDependencies().forEach(s=>{s.isLocal()?this.processLocalDependencyRouterMap(s,e,t):this.processRemoteDependencyRouterMap(s,e)})}getLocalDependencyRouterMap(e){return(0,dependency_util_js_1.getLocalDependencyRouterMap)(this.projectModel,this.targetService,e)}processLocalDependencyRouterMap(e,t,s){const r=dependency_manager_js_1.DependencyManager.getModuleModelByDependency(e,this.projectModel),a=this.getLocalDependencyRouterMap(e);r&&a&&!s.has(r)&&(s.set(r,a),this.checkModuleRouterMapObj(a,r,!0),a.forEach(t=>{const s=path_1.default.resolve(e.getDependencyRootPath(),t.pageSourceFile),a=r.getModuleType();this.pushCompileEntry(a,s);let o="";this.useNormalizedOHMUrl?o=this.getOhmUrlWithNormalize(e,t.pageSourceFile):(a===module_type_enum_js_1.ModuleType.Shared&&(o=this.generateModuleOhmurl(r.getName(),t.pageSourceFile)),a===module_type_enum_js_1.ModuleType.Har&&(o=this.generateHarOhmurl(this.moduleName,r.getName(),t.pageSourceFile,!0))),Object.assign(t,{ohmurl:o,bundleName:this.getBundleName(),moduleName:this.moduleName});const n={ohmurl:o,name:t.name,pageSourceFile:s,buildFunction:t.buildFunction};this.routerMapAddPackageName(t,e),this.intermediatesRouterMapObjs.push(n)}),this.checkDependencyRouterMap(e,a),t.push(...a))}processRemoteDependencyRouterMap(e,t){const s=dependency_manager_js_1.DependencyManager.getRemoteDependencyRouterMapObjList(e);if(!s)return;const r=dependency_manager_js_1.DependencyManager.getModuleObjByRemoteDependency(e),a=r.module.type;s.forEach(t=>{var s;const o=t.pageSourceFile,n=path_1.default.resolve(e.getDependencyRootPath(),o);e.isByteCodeHarDependency()||this.pushCompileEntry(a,n);const i=r.module.name;let u;this.useNormalizedOHMUrl?u=this.getOhmUrlWithNormalize(e,t.pageSourceFile):(a===module_type_enum_js_1.ModuleType.Shared&&(u=this.generateModuleOhmurl(i,t.pageSourceFile)),a===module_type_enum_js_1.ModuleType.Har&&(u=this.generateHarOhmurl(this.moduleName,i,n,!1,e.getDependencyName()))),Object.assign(t,{ohmurl:e.isBundleDependency()&&null!==(s=t.ohmurl)&&void 0!==s?s:u,bundleName:this.getBundleName(),moduleName:this.moduleName});const l={ohmurl:u,name:t.name,pageSourceFile:n,buildFunction:t.buildFunction};this.routerMapAddPackageName(t,e),this.intermediatesRouterMapObjs.push(l)}),this.checkDependencyRouterMap(e,s),t.push(...s)}routerMapAddPackageName(e,t){e.packageName=e.packageName||t.getPackageName()}checkModuleRouterMapObj(e,t,s){if(!e)return;const r=t.getName();e.forEach(e=>{const a=s?dependency_manager_js_1.DependencyManager.getDependencyModuleRouterMapJsonPath(t,this.moduleName2Target.get(r)):this.targetService.getRouterMapJsonPath(t),o=this.getModulePageSourceFile(t,e);""!==e.pageSourceFile&&""!==o&&o&&fs_extra_1.default.existsSync(o)||this._log.printErrorExit("PAGE_SOURCE_FILE_NOT_FOUND",[null!=o?o:"",r,a],[[r]]),common_const_js_1.ValidateRegExp.PAGE_SOURCE_FILE_REG_EXP.test(e.pageSourceFile)||this._log.printErrorExit("PAGE_SOURCE_FILE_FORMAT_INVALID",[r,a])})}getModulePageSourceFile(e,t){const s=t.pageSourceFile;if(""!==s)return path_1.default.resolve(e.getModule().getNodeDir(),s)}checkDependencyRouterMap(e,t){t&&t.forEach(t=>{const s=dependency_manager_js_1.DependencyManager.getModuleModelByDependency(e,this.projectModel);if(!s)return;const r=null==s?void 0:s.getName(),a=dependency_manager_js_1.DependencyManager.getDependencyModuleRouterMapJsonPath(s,this.moduleName2Target.get(r)),o=t.pageSourceFile,n=path_1.default.resolve(e.getDependencyRootPath(),o);""!==o&&""!==n&&n&&fs_extra_1.default.existsSync(n)||this._log.printErrorExit("PAGE_SOURCE_FILE_NOT_FOUND",[""===o?"":n,r,null!=a?a:""],[[r]])})}checkRouterMapObjName(e){if(!e||e.length<=1)return;const t=new Map;e.forEach(e=>{const s=e.packageName;if(t.has(s)){const r=t.get(s);if(!r)return;r.includes(e.name)||(r.push(e.name),t.set(s,r))}else t.set(s,[e.name])});const s=new Map;t.forEach((e,r)=>{const a=(0,array_util_js_1.findDuplicateElement)(e);t.forEach((t,s)=>{if(s===r)return;const o=(0,array_util_js_1.getIntersection)(t,e);0!==o.length&&a.push(...o)}),0!==a.length&&s.set(r,Array.from(new Set(a)))}),0!==s.size&&this._log.printErrorExit("DUPLICATE_ROUTERMAP_OBJECT_NAME_DETECTED",void 0,[[JSON.stringify(Object.fromEntries(s.entries()))]])}getBundleName(){var e;return null!==(e=this.targetData.getProduct().bundleName)&&void 0!==e?e:this.projectModel.getDefaultBundleName()}generateModuleOhmurl(e,t){const s=t.substring(0,t.indexOf(".")),r=s.includes("src/main/ets/")?s.replace("src/main/",""):s;return`@bundle:${this.getBundleName()}/${e}/${r}`}generateHarOhmurl(e,t,s,r,a){if(r){const r=s.substring(0,s.indexOf(".")),a=r.includes("src/main/ets/")?r.replace("src/main/",""):r;return`@bundle:${this.getBundleName()}/${e}@${t}/${a}`}const o=path_1.default.parse(s).name,n=`${s.substring(0,s.lastIndexOf(path_1.default.sep)+1)}${o}`,i=n.substring(n.indexOf(common_const_js_1.CommonConst.OH_MODULES)).replace(common_const_js_1.CommonConst.OH_MODULES,common_const_js_1.CommonConst.PKG_MODULES),u=i.indexOf(path_1.default.sep+(null==a?void 0:a.replace("/",path_1.default.sep))+path_1.default.sep),l=i.substring(0,u),c=l.replace(path_1.default.basename(l),common_const_js_1.CommonConst.PKG_MODULES)+i.substring(u),d=new RegExp("\\"+path_1.default.sep,"g");return`@package:${c.replace(d,"/")}`}pushCompileEntry(e,t){e!==module_type_enum_js_1.ModuleType.Shared&&this.compileEntry.push(t)}initTaskDepends(){}getOhmUrlWithNormalize(e,t){const s=e.getPackageName(),r=this.pathInfo.getIntermediatesPkgContextInfoPath(),a=(0,json_util_js_1.getJson5Obj)(r);a||this._log.printErrorExit("PKG_CONTEXT_INFO_PATH_NOT_AVAILABLE",[r]);const o=a[s];return o||this._log.printErrorExit("PKG_NAME_NOT_EXIST",[s,r]),(0,ohmurl_utils_js_1.generateOhmUrlForSourceFile)(o,t)}generateTempRouterMap(e,t){fs_extra_1.default.ensureFileSync(this.intermediatesTempRouterMapFilePath),fs_extra_1.default.writeFileSync(this.intermediatesTempRouterMapFilePath,JSON.stringify({routerMap:e})),fs_extra_1.default.ensureFileSync(this.intermediatesToLoaderRouterMap),fs_extra_1.default.writeFileSync(this.intermediatesToLoaderRouterMap,JSON.stringify({routerMap:t}))}}exports.ProcessRouterMap=ProcessRouterMap;