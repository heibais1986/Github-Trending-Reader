"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,o,i){void 0===i&&(i=o);var s=Object.getOwnPropertyDescriptor(t,o);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,i,s)}:function(e,t,o,i){void 0===i&&(i=o),e[i]=t[o]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&__createBinding(t,e,o);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ArkCompile=void 0;const crypto_1=__importDefault(require("crypto")),path_1=__importDefault(require("path")),hvigor_1=require("@ohos/hvigor"),hvigor_arkts_compose_1=require("@ohos/hvigor-arkts-compose"),fse=__importStar(require("fs-extra")),ohos_trace_js_1=require("../common/trace/ohos-trace.js"),build_directory_const_js_1=require("../const/build-directory-const.js"),common_const_js_1=require("../const/common-const.js"),inject_const_js_1=require("../const/inject-const.js"),sdk_const_js_1=require("../const/sdk-const.js"),code_type_enum_js_1=require("../enum/code-type-enum.js"),dependency_manager_js_1=require("../project/dependency/dependency-manager.js"),get_obfuscation_rules_js_1=require("../common/obfuscation/get-obfuscation-rules.js"),har_target_util_js_1=require("../utils/har-target-util.js"),inject_util_js_1=require("../utils/inject-util.js"),json_util_js_1=require("../utils/json-util.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),math_util_js_1=require("../utils/math-util.js"),mock_config_utils_js_1=require("../utils/mock-config-utils.js"),obfuscation_config_resolver_js_1=require("../utils/obfuscation-config-resolver.js"),source_roots_utils_js_1=require("../utils/source-roots-utils.js"),task_util_js_1=require("../utils/task-util.js"),abstract_compile_node_js_1=require("./abstract/abstract-compile-node.js"),task_names_js_1=require("./common/task-names.js"),compile_resource_js_1=require("./compile-resource.js"),generate_loader_json_js_1=require("./generate-loader-json.js"),har_extend_info_js_1=require("./har/har-extend-info.js"),global_project_data_service_js_1=require("./service/global-project-data-service.js"),target_task_service_js_1=require("./service/target-task-service.js"),run_ark_js_1=require("./worker/run-ark.js");var CommonTask=task_names_js_1.TaskNames.CommonTask;const dependency_util_js_1=require("../utils/dependency-util.js"),ohos_uitransform_optimization_js_1=require("./module-info/ohos-uitransform-optimization.js");class ArkCompile extends abstract_compile_node_js_1.AbstractCompileNode{constructor(e,t,o){super(e,t,o),this._log=ohos_logger_js_1.OhosLogger.getLogger(ArkCompile.name),this.obfuscationHash="",this.writeBuildModePromise=void 0;const i=e.getTargetData().getModuleSourceSetModel().getModuleTargetRes();this.formJsonPathArr=target_task_service_js_1.TargetTaskService.getFormJsonArr(i),this.needSubmitArkTsWidget=(0,task_util_js_1.shouldCompileArkTsWidget)(this.formJsonPathArr),this.pkgNameToPkgBriefInfo={},this._taskService=e,this.arkdataPathAll=[]}taskShouldDo(){return(void 0!==this.sourcePath||this.checkPackageMain())&&this.checkRollUpPlugin()}declareInputs(){var e,t,o,i,s,r,n,a,l,c,u,d,_,h,g,p;const f=super.declareInputs().set("arkTsWdiget",this.needSubmitArkTsWidget),m=hvigor_1.hvigorCore.getExtraConfig().get(common_const_js_1.CommonConst.DEBUG_LINE);m&&f.set(common_const_js_1.CommonConst.DEBUG_LINE,m);const v=this.getObfuscationEnable();return f.set(common_const_js_1.CommonConst.OBFUSCATION_ENABLE,String(v)),f.set(common_const_js_1.CommonConst.OBFUSCATION_FILES_HASH,this.obfuscationHash),f.set(common_const_js_1.CommonConst.TSC_MAX_FLOW_DEPTH,String(null===(o=null===(t=null===(e=this.buildOption)||void 0===e?void 0:e.arkOptions)||void 0===t?void 0:t.tscConfig)||void 0===o?void 0:o.maxFlowDepth)),f.set(common_const_js_1.CommonConst.NO_EXTERNAL_IMPORT_BY_PATH,null!==(i=this.targetService.isNoExternalImportByPath())&&void 0!==i&&i),f.set(common_const_js_1.CommonConst.COPY_CODE_RESOURCE_ENABLE,null===(a=null===(n=null===(r=null===(s=this.targetService.getBuildOption())||void 0===s?void 0:s.resOptions)||void 0===r?void 0:r.copyCodeResource)||void 0===n?void 0:n.enable)||void 0===a||a),(null===(d=null===(u=null===(c=null===(l=this.targetService.getBuildOption())||void 0===l?void 0:l.resOptions)||void 0===c?void 0:c.copyCodeResource)||void 0===u?void 0:u.enable)||void 0===d||d)&&f.set(common_const_js_1.CommonConst.COPY_CODE_RESOURCE_EXCLUDES,null!==(p=null===(g=null===(h=null===(_=this.targetService.getBuildOption())||void 0===_?void 0:_.resOptions)||void 0===h?void 0:h.copyCodeResource)||void 0===g?void 0:g.excludes)&&void 0!==p?p:[]),f.set(common_const_js_1.CommonConst.OHOS_UI_TRANSFORM_OPTIMIZATION,(0,ohos_uitransform_optimization_js_1.getOhosUiTransformOptimization)(this.targetService)),f}declareOutputFiles(){const e=super.declareOutputFiles(),t=this.targetService.getTargetData().getTargetName();return!this.moduleModel.isHspModule()||t===common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET||inject_util_js_1.InjectUtil.isColdReload()||inject_util_js_1.InjectUtil.isUnitTestProcess()||inject_util_js_1.InjectUtil.isHotReload()||inject_util_js_1.InjectUtil.isPreviewProcess()||e.addEntry(path_1.default.resolve(this.aceModuleBuild,`../${build_directory_const_js_1.BuildDirConst.DECLARE_FILE_OUTPUT}`),{isDirectory:!0}),e}async beforeAlwaysAction(){await super.beforeAlwaysAction(),this.obfuscationOptions=await this.getObfuscationOptions(),this.obfuscationOptions&&(this.obfuscationHash=this.computeObfuscationFileHash(this.obfuscationOptions)),this._log.debug(`obfuscationOptions: ${JSON.stringify(this.obfuscationOptions)}`),this.arkDataCompile(),this.setPkgNameToPkgBriefInfo()}async beforeTask(){if(await super.beforeTask(),this.targetService.isDebug())return;const e=this.getIncrementalCacheItem(common_const_js_1.CommonConst.OBFUSCATION_ENABLE);if(String(e)!==String(this.getObfuscationEnable()))return this._log.debug("Clean the arkts cache due to obfuscation config changes."),void await this.cleanCache();this.getIncrementalCacheItem(common_const_js_1.CommonConst.OBFUSCATION_FILES_HASH)!==this.obfuscationHash&&(this._log.debug("Clean the arkts cache due to obfuscation file changes."),await this.cleanCache())}declareInputFiles(){var e,t;const o=super.declareInputFiles().addEntries(this.formJsonPathArr),i=this.targetService.getTargetData().getTargetName(),s=this.pathInfo.getGenerateBuildProfilePath(i);fse.existsSync(s)&&o.addEntry(s);const r=this.targetService.getModuleService().getModuleModel().getProjectDir(),n=path_1.default.resolve(r,build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN,build_directory_const_js_1.BuildDirConst.CPP_TYPES);fse.existsSync(n)&&o.addEntry(n,{isDirectory:!0}),this.service.getHarModuleDependencies().forEach(([,e])=>{var t;const i=e.getDependencyRootPath(),s=path_1.default.resolve(i,build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN,build_directory_const_js_1.BuildDirConst.CPP_TYPES);fse.existsSync(s)&&o.addEntry(s,{isDirectory:!0});const r=path_1.default.resolve(i,build_directory_const_js_1.BuildArtifactConst.BUILD_PROFILE_FILE);fse.existsSync(r)&&o.addEntry(r);const n=null===(t=this.pkgNameToPkgBriefInfo[e.getPackageName()])||void 0===t?void 0:t.originalSourceRoots;(null==n?void 0:n.length)&&n.forEach(e=>{const t=path_1.default.resolve(i,e);fse.existsSync(t)&&o.addEntry(path_1.default.resolve(i,e),{isDirectory:!0})})});const a=null===(t=null===(e=this.targetService.getTargetData().getTargetOpt())||void 0===e?void 0:e.source)||void 0===t?void 0:t.sourceRoots;(null==a?void 0:a.length)&&a.forEach(e=>{o.addEntry(path_1.default.resolve(this.pathInfo.getModulePath(),e),{isDirectory:!0})});const l=this.moduleModel.getMockConfigPath();fse.existsSync(l)&&(o.addEntry(l,{isDirectory:!1}),o.addEntries((0,mock_config_utils_js_1.getMockConfigSources)(l,this.moduleModel.getProjectDir())));const c=this.moduleModel.getCompilePluginPath();return c&&fse.existsSync(c)&&o.addEntry(c),o}async doTaskAction(){this.validateModuleJson(this._log);const e=await this.initDefaultArkCompileConfig();this._log.debug("build config:"),this._log.anonymizeDebug(e),e.externalApiPaths.length>0&&this._log.debug(`Compile arkts with external api path: ${e.externalApiPaths.join(path_1.default.delimiter)}`),e.obfuscationOptions&&(await fse.ensureDir(e.obfuscationOptions.obfuscationCacheDir),await fse.ensureDir(path_1.default.dirname(e.obfuscationOptions.exportRulePath))),e.cachePath&&this.trace(e.cachePath),fse.ensureDirSync(e.cachePath),fse.ensureDirSync(e.aceModuleBuild);let t=null,o=hvigor_1.coreParameter.properties.ohosArkCompileMaxSize;(void 0===o||o<=0||o>hvigor_1.PoolConstant.MAX_POOL_NUM)&&(o=common_const_js_1.ArkPackConst.MAX_ARK_COMPILE_NUM);const i=[...new Array(o).keys()];let s=i;const r=(0,hvigor_1.getWorkerIdWithModule)(e.modulePath),n=this.getWorkerPool().getMaxPoolNum();if(void 0!==r&&n>0&&(s=[(0,math_util_js_1.mod)(r,Math.min(n,o))]),t=await(0,run_ark_js_1.submitArkCompileWork)(this,this.getWorkerPool(),this._log,e,async(o,i)=>{void 0!==i&&(0,hvigor_1.setWorkerIdWithModule)(e.modulePath,i),this.moveReleaseMap(this.targetData,this._log,this.codeType),this.handleCompileEvents(o,t?this.getSubDurationEvent(t):this.durationEvent,!1),await this.writeBuildMode(e)},s),this.needSubmitArkTsWidget){const t=await this.initWidgetDefaultArkCompileConfig();let s=i;const r=(0,hvigor_1.getWorkerIdWithModule)(e.modulePath,!0);void 0!==r&&n>0&&(s=[(0,math_util_js_1.mod)(r,Math.min(n,o))]),t.ignoreWarning=!0;let a=null;a=await(0,run_ark_js_1.submitArkCompileWork)(this,this.getWorkerPool(),this._log,t,async(o,i)=>{void 0!==i&&(0,hvigor_1.setWorkerIdWithModule)(e.modulePath,i,!0),this.handleCompileEvents(o,a?this.getSubDurationEvent(a):this.durationEvent,!1),await this.writeBuildMode(t)},s)}(0,task_util_js_1.warnCreateBuildProfileTask)(this.targetData,this.targetService,this._log)}async writeBuildMode(e){if(!this.writeBuildModePromise){const t=path_1.default.resolve(e.arkCompileCachePath,"compileInfo.json");this.writeBuildModePromise=new Promise(o=>{e.buildMode&&(fse.ensureFileSync(t),fse.writeJsonSync(t,{buildMode:e.buildMode}),o())}).finally(()=>{this.writeBuildModePromise=void 0})}await this.writeBuildModePromise}trace(e){const t=path_1.default.resolve(e,hvigor_arkts_compose_1.MSGPACK_COMPILE_CACHE_DIR_NAME);ohos_trace_js_1.ohosTrace.traceIncrement(this.moduleName,"COMPILE_ARKTS",fse.existsSync(t))}getSelfPkgBriefInfo(){var e;const t=null===(e=this.targetData.getTargetOpt().source)||void 0===e?void 0:e.sourceRoots,o=this.pathInfo.getModulePath(),i=this.packageJsonObj.name||this.moduleName,s={pkgRoot:o,originalSourceRoots:t,sourceRoots:[...t||[],path_1.default.relative(o,this.pathInfo.getModuleSrcMainPath()),path_1.default.relative(o,path_1.default.resolve(this.pathInfo.getGenerateBuildProfileDir(),this.targetName))],pkgName:i};return{[i]:s}}setPkgNameToPkgBriefInfo(){this.pkgNameToPkgBriefInfo={...(0,source_roots_utils_js_1.getDependenciesPkgBriefInfo)(this.targetService),...this.getSelfPkgBriefInfo()}}getCollectImportersConfig(){var e,t;const o=this.pathInfo.getBuildConfigPath(),i=(0,json_util_js_1.getJson5Obj)(o);if("hotReload"===(null===(e=null==i?void 0:i.patchConfig)||void 0===e?void 0:e.mode)||"coldReload"===(null===(t=null==i?void 0:i.patchConfig)||void 0===t?void 0:t.mode))return{relativeDir:path_1.default.resolve(this.pathInfo.getModuleSrcMainPath(),"ets"),buildConfigJsonPath:this.pathInfo.getBuildConfigPath(),isReload:!1}}getTscAddressPaths(e){const t=this.pkgNameToPkgBriefInfo,o={};return Object.values(t).forEach(t=>{var i;const s=null===(i=t.sourceRoots)||void 0===i?void 0:i.map(o=>path_1.default.join(path_1.default.relative(e,path_1.default.resolve(t.pkgRoot,o)),"*"));(null==s?void 0:s.length)&&(o[`${t.pkgName}/*`]=s)}),o}async initDefaultArkCompileConfig(){var e,t,o,i,s,r,n,a,l,c,u;const d=this.targetData.getModuleModel().getMockConfigPath(),_={...await super.initDefaultArkCompileConfig(),pkgNameToPkgBriefInfo:this.pkgNameToPkgBriefInfo,projectModel:global_project_data_service_js_1.GlobalProjectDataService.getInstance().getCompileProjectModel(),pkgJsonFileHash:global_project_data_service_js_1.GlobalProjectDataService.getInstance().getProjectPkgJsonFileHash(),allModulePaths:global_project_data_service_js_1.GlobalProjectDataService.getInstance().getAllModulePaths(),routerMap:this.getRouterMapConfig(),obfuscationOptions:this.obfuscationOptions,compileBlockPkg:this.getBlockDependencies().map(e=>e.getDependencyName()),mockParams:{decorator:"@MockSetup",packageName:"@ohos/hamock",etsSourceRootPath:"src/main/ets",mockConfigPath:fse.existsSync(d)?d:void 0,mockConfigKey2ModuleInfo:(0,mock_config_utils_js_1.getMockConfigKey2ModuleInfoMap)(this.moduleModel.getMockConfigPath(),this.service),source2ModuleIdMap:(0,mock_config_utils_js_1.getSource2ModuleIdMap)(d,this.moduleModel.getProjectDir())},caseSensitiveCheck:!(!(0,hvigor_1.isWindows)()&&!(0,hvigor_1.isMac)())&&(null!==(o=null===(t=null===(e=this.targetService.getBuildOption())||void 0===e?void 0:e.strictMode)||void 0===t?void 0:t.caseSensitiveCheck)&&void 0!==o&&o),copyCodeResourceEnable:null===(n=null===(r=null===(s=null===(i=this.targetService.getBuildOption())||void 0===i?void 0:i.resOptions)||void 0===s?void 0:s.copyCodeResource)||void 0===r?void 0:r.enable)||void 0===n||n,copyCodeResourceExcludes:null!==(u=null===(c=null===(l=null===(a=this.targetService.getBuildOption())||void 0===a?void 0:a.resOptions)||void 0===l?void 0:l.copyCodeResource)||void 0===c?void 0:c.excludes)&&void 0!==u?u:[],uiTransformOptimization:(0,ohos_uitransform_optimization_js_1.getOhosUiTransformOptimization)(this.targetService)};return _.aceModuleRoot||(_.aceModuleRoot=path_1.default.resolve(this.pathInfo.getModuleSrcMainPath(),this.codeType)),_.otherPaths=this.getTscAddressPaths(_.aceModuleRoot),_.collectImportersConfig=this.getCollectImportersConfig(),_}async initWidgetDefaultArkCompileConfig(){const e=this.getTaskTempDir(this.targetData,"_widget"),t={...await this.initDefaultArkCompileConfig(),widgetCompile:"true",cachePath:e,aceBuildJson:this.pathInfo.getWidgetLoaderJsonPath(),byteCodeHar2HspDep:this.service.getByteCodeHar2Hsp()};return t.obfuscationOptions&&(t.obfuscationOptions={...t.obfuscationOptions,obfuscationCacheDir:path_1.default.resolve(e,"obfuscation")}),t}getRouterMapConfig(){var e;const t=new Map,o=[];this.service.getHarDependencies().forEach(e=>{if(e.isLocal()){const t=(0,dependency_util_js_1.getLocalDependencyRouterMap)(this.projectModel,this.targetService,e);t&&Array.prototype.push.apply(o,t)}else{const t=dependency_manager_js_1.DependencyManager.getRemoteDependencyRouterMapObjList(e);t&&Array.prototype.push.apply(o,t)}});const i=null!==(e=this.targetService.getTargetRouterMapObjList(this.moduleModel))&&void 0!==e?e:o;return null==i||i.sort((e,t)=>e.name.localeCompare(t.name)).forEach(e=>{const o=path_1.default.resolve(e.moduleNodeDir,e.pageSourceFile),i=`${e.name}@${e.buildFunction}`,s=t.has(o)?`${t.get(o)}#${i}`:i;t.set(o,s)}),t}arkDataCompile(){const e=this._taskService.getModuleService().getHarDependencies();if(void 0===e||e.length<=0)return;const t=this._taskService.getModuleService().getModuleModel().getName(),o=this._taskService.getTargetData().getPathInfo().getModuleSrcMainResourceRawfileArkdataPath(),i=this._taskService.getTargetData().getPathInfo().getIntermediatesResArkDataPath();this.arkdataPathAll.push(o);const s=new Set;if(fse.existsSync(o)){const e=fse.readdirSync(o);for(const t of e)s.add(t)}fse.existsSync(i)||fse.mkdirSync(i,{recursive:!0});for(const o of e){const e=o.getPackageName(),r=this._taskService.getModuleService().getProjectModel().getModuleModelByName(e),n=null==r?void 0:r.getProjectDir();if(void 0!==n){const o=path_1.default.resolve(n,build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN,build_directory_const_js_1.BuildDirConst.RESOURCES,build_directory_const_js_1.BuildDirConst.RAW_FILE,build_directory_const_js_1.BuildDirConst.ARK_DATA,build_directory_const_js_1.BuildDirConst.SCHEMA);if(!fse.existsSync(o))continue;this.arkdataPathAll.push(o);const r=fse.readdirSync(o);for(const n of r){s.has(n)&&this._log.printErrorExit("SAME_NAME_ARK_DATA_JSON_FILE",[n,e,n,t]),s.add(n);const r=path_1.default.resolve(o,n),a=path_1.default.resolve(i,n);fse.existsSync(i)&&fse.copyFileSync(r,a)}}}}initTaskDepends(){if((0,task_util_js_1.limitMinApiVersion)(this.targetData,sdk_const_js_1.ApiVersion.API_VERSION_9)){this.declareDependsList(generate_loader_json_js_1.GenerateLoaderJson.name,compile_resource_js_1.CompileResource.name,CommonTask.CREATE_BUILD_PROFILE.name);har_target_util_js_1.HarTargetUtil.calDepHarTargets(this.targetService).forEach((e,t)=>this.declareDepends(`${e}@${CommonTask.CREATE_HAR_BUILD_PROFILE.name}`,t))}else this.declareDependsList(generate_loader_json_js_1.GenerateLoaderJson.name,compile_resource_js_1.CompileResource.name)}async getObfuscationOptions(){var e,t,o,i;const s=this.targetService.getBuildOption();if(s.debuggable)return void("true"===(null===(e=hvigor_1.hvigorCore.getExtraConfig().get(inject_const_js_1.InjectConst.ARK_OBFUSCATION))||void 0===e?void 0:e.toLowerCase())&&this._log.warn("Obfuscation is only enabled in release mode."));const r=path_1.default.resolve(this.getTaskTempDir(this.targetData),"obfuscation");let n=null===(t=s.arkOptions)||void 0===t?void 0:t.obfuscation;s.artifactType&&this._log.warn("buildOption/artifactType is deprecated, please use buildOption/arkOptions/obfuscation instead."),s.artifactType===har_extend_info_js_1.ArtifactType.OBFUSCATION&&void 0===(null===(o=null==n?void 0:n.ruleOptions)||void 0===o?void 0:o.enable)&&(n={...n,ruleOptions:{enable:!0},libDir:this.module.getNodeDir()});const a=this.getObfuscationEnable();if(!n||void 0===(null===(i=n.ruleOptions)||void 0===i?void 0:i.enable)){if(void 0===a)return;this._log.debug(`Command line specified enable was used, obfuscationEnable is: ${a}`),n={ruleOptions:{enable:a},libDir:this.module.getNodeDir()}}if(!(this.compileApiVersion<sdk_const_js_1.ApiVersion.API_VERSION_10||this.isFaMode)){if(this.moduleModel.isHapModule()&&void 0!==n.consumerFiles&&this._log.warn("The property 'consumerFiles' is not support in hap module´s build-profile.json5"),void 0!==a&&n.ruleOptions&&(n.ruleOptions.enable=a),!0===hvigor_1.hvigorCore.getParameter().getProperty("ohos.obfuscationRules.optimization"))try{return(0,get_obfuscation_rules_js_1.getObfuscationOptionsWithCache)(this.targetService,n,r)}catch(e){return(0,obfuscation_config_resolver_js_1.resolveObfuscationOptions)(this.targetService,n,r)}return(0,obfuscation_config_resolver_js_1.resolveObfuscationOptions)(this.targetService,n,r)}this._log.warn(`Obfuscation is supported in stage mode of API${sdk_const_js_1.ApiVersion.API_VERSION_10} or later.`)}computeObfuscationFileHash(e){var t,o,i,s,r,n,a,l;const c=[];c.push(...null!==(i=null===(o=null===(t=e.selfConfig)||void 0===t?void 0:t.ruleOptions)||void 0===o?void 0:o.rules)&&void 0!==i?i:[]),c.push(...null!==(r=null===(s=e.selfConfig)||void 0===s?void 0:s.consumerRules)&&void 0!==r?r:[]),c.push(...e.dependencies.hars),c.push(...e.dependencies.hsps);for(const t of[...e.dependencies.libraries,...e.dependencies.hspLibraries])c.push(...null!==(a=null===(n=t.ruleOptions)||void 0===n?void 0:n.rules)&&void 0!==a?a:[]),c.push(...null!==(l=t.consumerRules)&&void 0!==l?l:[]);const u=crypto_1.default.createHash("sha256");for(const e of c)fse.existsSync(e)&&u.update(fse.readFileSync(e));return u.digest("hex")}getIncrementalCacheItem(e){var t,o,i;return null===(i=null===(o=null===(t=hvigor_1.ProjectCacheService.getInstance(this.projectModel.getProject()).getTaskSnapShot(this.getName(),this.module))||void 0===t?void 0:t.getInputs())||void 0===o?void 0:o.find(t=>t.getName()===e))||void 0===i?void 0:i.getValue()}async cleanCache(){const e=this.getTaskTempDir(this.targetData);await fse.emptydir(e);const t=path_1.default.resolve(e,"..",".ts_checker_cache");fse.existsSync(t)&&await fse.rm(t)}getObfuscationEnable(){var e,t,o,i,s;const r=null===(e=hvigor_1.hvigorCore.getExtraConfig().get(inject_const_js_1.InjectConst.ARK_OBFUSCATION))||void 0===e?void 0:e.toLowerCase();return"false"!==r&&("true"===r||(null===(s=null===(i=null===(o=null===(t=this.buildOption)||void 0===t?void 0:t.arkOptions)||void 0===o?void 0:o.obfuscation)||void 0===i?void 0:i.ruleOptions)||void 0===s?void 0:s.enable))}checkPackageMain(){const e=this.packageJsonObj.main?this.packageJsonObj.main:build_directory_const_js_1.BuildArtifactConst.INDEX_ETS;return fse.existsSync(path_1.default.resolve(this.pathInfo.getModulePath(),e))}checkRollUpPlugin(){return this.codeType===code_type_enum_js_1.CodeType.ETS?this.sdkInfo.hasRollUpPluginInEtsLoader:this.sdkInfo.hasRollUpPluginInJsLoader}}exports.ArkCompile=ArkCompile;