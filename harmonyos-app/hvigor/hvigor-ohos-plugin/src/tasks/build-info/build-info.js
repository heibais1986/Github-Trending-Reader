"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,o,t,i){void 0===i&&(i=t);var r=Object.getOwnPropertyDescriptor(o,t);r&&!("get"in r?!o.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return o[t]}}),Object.defineProperty(e,i,r)}:function(e,o,t,i){void 0===i&&(i=t),e[i]=o[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,o){Object.defineProperty(e,"default",{enumerable:!0,value:o})}:function(e,o){e.default=o}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var o={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(o,e,t);return __setModuleDefault(o,e),o};Object.defineProperty(exports,"__esModule",{value:!0}),exports.BuildInfo=void 0;const os=__importStar(require("os")),hvigor_1=require("@ohos/hvigor"),build_mode_manager_js_1=require("../../project/build-option/build-mode-manager.js"),log=hvigor_1.HvigorLogger.getLogger("no-pattern-info");class BuildInfo extends hvigor_1.DefaultTask{constructor(e){super(e,{name:"buildInfo",group:hvigor_1.HvigorTaskGroupType.HELP_TASK_GROUP,isEnabled:!0,description:"Displays the build information of the Project or Module."})}registryAction(){return()=>{const e=hvigor_1.hvigorCore.getParameter().getExtParams();let o={},t=this.node;const i=""===e.buildOption,r=""===e.json;if(e.module){const r=this.node.findModuleByName(e.module);r&&(o=this.getModuleBuildInfo(r,i),t=r)}else o=this.getProjectBuildInfo(t,i);if(r)log.info(JSON.stringify(o,null,2));else{const e=["--------------------------------------------------------------------------",`All build information from hvigor node '${t.getName()}'`,"--------------------------------------------------------------------------"],i=[];this.createFormatInfoRecursively(o,i,0),e.push(...i),log.info(e.join(os.EOL))}}}getModuleBuildInfo(e,o){const t={},i=(0,hvigor_1.parseJsonFile)(e.getBuildProfilePath()),r=(0,hvigor_1.parseJsonFile)(e.getProject().getBuildProfilePath());if(i){const n=this.getBuildModes(r),l=this.getModuleBuildOption(i,n,e.getName(),o);t.buildMode=n,t.buildInfo=l}return t}getProjectBuildInfo(e,o){const t={},i=(0,hvigor_1.parseJsonFile)(e.getBuildProfilePath());if(i){const e=this.getProducts(i),r=this.getModules(i),n=this.getBuildModes(i),l=this.getProductBuildOption(i,e,n,o);t.product=e,t.module=r,t.buildMode=n,t.buildInfo=l}return t}createFormatInfoRecursively(e,o,t){if("string"!=typeof e&&"boolean"!=typeof e){if(e instanceof Array)e.forEach(e=>{this.createFormatInfoRecursively(e,o,t)});else if(e instanceof Object)for(const[i,r]of Object.entries(e))o.push(this.getPrefix(t)+i),this.createFormatInfoRecursively(r,o,t+1)}else o.push(this.getPrefix(t)+e)}getPrefix(e){let o="";for(let t=0;t<e;t++)o+="    ";return o}getProducts(e){var o;const t=[];return(null===(o=null==e?void 0:e.app)||void 0===o?void 0:o.products)&&e.app.products.forEach(e=>{t.push(null==e?void 0:e.name)}),t}getModules(e){const o=[];return(null==e?void 0:e.modules)&&e.modules.forEach(e=>{o.push(null==e?void 0:e.name)}),o}getBuildModes(e){var o,t;const i=[];return null===(t=null===(o=null==e?void 0:e.app)||void 0===o?void 0:o.buildModeSet)||void 0===t||t.forEach(e=>{i.push(null==e?void 0:e.name)}),i}getModuleBuildOption(e,o,t,i){const r={};return null==e||e.targets.forEach(e=>{o.forEach(o=>{const n=null==e?void 0:e.name;n in r||(r[n]={}),r[n][o]=i?build_mode_manager_js_1.buildOptionManager.getTargetBuildOptionWithProductBuildMode(t,n,o):{}})}),r}getProductBuildOption(e,o,t,i){const r={};o.forEach(e=>{r[e]={}});const n=e.modules;return null==n||n.forEach(e=>{var o;null===(o=null==e?void 0:e.targets)||void 0===o||o.forEach(o=>{var n;null===(n=null==o?void 0:o.applyToProducts)||void 0===n||n.forEach(n=>{t.forEach(t=>{const l=n,u=null==e?void 0:e.name,d=null==o?void 0:o.name;u in r[l]||(r[l][u]={}),d in r[l][u]||(r[l][u][d]={}),r[l][u][d][t]=i?build_mode_manager_js_1.buildOptionManager.getTargetBuildOptionWithProductBuildMode(u,d,t,l):{}})})})}),r}}exports.BuildInfo=BuildInfo;