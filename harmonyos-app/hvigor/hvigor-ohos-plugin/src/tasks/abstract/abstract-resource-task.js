"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.AbstractResource=void 0;const path_1=__importDefault(require("path")),restool_command_builder_js_1=require("../../builder/restool-command-builder.js"),restool_file_config_builder_js_1=require("../../builder/restool-file-config-builder.js"),build_directory_const_js_1=require("../../const/build-directory-const.js"),compile_resources_util_js_1=require("../../utils/compile-resources-util.js"),file_util_js_1=require("../../utils/file-util.js"),har_target_util_js_1=require("../../utils/har-target-util.js"),json_util_js_1=require("../../utils/json-util.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),ohos_hap_task_js_1=require("../task/ohos-hap-task.js"),_log=ohos_logger_js_1.OhosLogger.getLogger("Resource");class AbstractResource extends ohos_hap_task_js_1.OhosHapTask{constructor(e,t){super(e,t),this.outputDir=this.pathInfo.getIntermediatesRes(),this.restoolConfigBuilder=this.getRestoolConfigBuilder()}getRestoolConfigBuilder(){const e=this.initConfigTargetResource(),t=compile_resources_util_js_1.CompileResourcesUtil.getRestoolModuleNames(this.service,this.targetName).join(",");_log.debug(`restool module names: ${t}; moduleName=${this.moduleName}, taskName=${this.name}`),e.addModules(t).forceDelete();const o=new Map;return this.getHarPathToResourcesDirMap(o),o.set(this.pathInfo.getModulePath(),this.pathInfo.getResourceStr()),o.forEach(t=>{Array.isArray(t)?t.forEach(t=>{e.addInputDir(t,build_directory_const_js_1.ResToolInputTypeConst.HAR)}):e.addInputDir(t,build_directory_const_js_1.ResToolInputTypeConst.HAR)}),e}initConfigTargetResource(){const e=new restool_file_config_builder_js_1.RestoolConfigBuilder;return this.targetService.getResourceDirs().forEach(t=>e.addInputDir(t,"Module")),e}getRestoolCommandBuilder(){const e=this.initCommandTargetResource();return e.addModules(compile_resources_util_js_1.CompileResourcesUtil.getRestoolModuleNames(this.service,this.targetName).join(",")).forceDelete(),e}initCommandTargetResource(){const e=new restool_command_builder_js_1.RestoolCommandBuilder(this.sdkInfo.getRestool()),t=new Map,o=new Map;this.targetService.getResourceDirs().forEach((e,o)=>{const s=compile_resources_util_js_1.CompileResourcesUtil.getCompileTargetFolderBySeq(build_directory_const_js_1.BuildDirConst.MODULE_COMPILED,o);t.set(e,s)});const s=new Map,r=[];return this.getHarPathToResourcesDirMap(s),s.forEach(e=>{Array.isArray(e)?e.forEach(e=>{r.push(e)}):r.push(e)}),r.forEach((e,t)=>{const s=compile_resources_util_js_1.CompileResourcesUtil.getCompileTargetFolderBySeq(build_directory_const_js_1.BuildDirConst.HAR_COMPILED,t);o.set(e,s)}),e.addModuleResourcesMap(t),e.addHarResourcesMap(o),e}getHarPathToResourcesDirMap(e){har_target_util_js_1.HarTargetUtil.calDepHarTargets(this.targetService).forEach((t,o)=>{var s,r,i;const l=this.projectModel.getModuleModelByName(o);if(void 0===l)return;const u=l.getProfileOpt();if(null===(s=null==u?void 0:u.targets)||void 0===s?void 0:s.length){const o=u.targets.find(e=>e.name===t);if(null===(i=null===(r=null==o?void 0:o.resource)||void 0===r?void 0:r.directories)||void 0===i?void 0:i.length){const t=o.resource.directories.map(e=>e.replace(/\\/g,"/"));e.set(l.getProjectDir(),file_util_js_1.FileUtil.convertToAbsolutePaths(t,l.getProjectDir()))}}}),this.service.getHarDependencies().forEach(t=>{var o,s,r;if(e.has(t.getDependencyRootPath()))return;const i=(0,json_util_js_1.getJson5Obj)(t.getPackageFilePath(),"utf-8");if(null===(r=null===(s=null===(o=null==i?void 0:i.metadata)||void 0===o?void 0:o.resource)||void 0===s?void 0:s.directories)||void 0===r?void 0:r.length){const o=i.metadata.resource.directories.map(e=>e.replace(/\\/g,"/"));e.set(t.getDependencyRootPath(),file_util_js_1.FileUtil.convertToAbsolutePaths(o,t.getDependencyRootPath()))}else e.set(t.getDependencyRootPath(),path_1.default.resolve(t.getDependencyRootPath(),build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN,build_directory_const_js_1.BuildDirConst.RESTOOL_BUILD_RESOURCES))})}}exports.AbstractResource=AbstractResource;