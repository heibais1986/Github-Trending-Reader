"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,o,i){void 0===i&&(i=o);var s=Object.getOwnPropertyDescriptor(t,o);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,i,s)}:function(e,t,o,i){void 0===i&&(i=o),e[i]=t[o]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&__createBinding(t,e,o);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.AbstractCompileNode=void 0;const os_1=__importDefault(require("os")),path=__importStar(require("path")),wdk_1=require("@baize/wdk"),hvigor_1=require("@ohos/hvigor"),const_1=require("@ohos/hvigor/src/common/const/const"),fs_extra_1=__importDefault(require("fs-extra")),ini_1=require("ini"),find_target_product_js_1=require("../../common/find-target-product.js"),project_ohos_config_manager_js_1=require("../../common/global/project-ohos-config-manager.js"),build_directory_const_js_1=require("../../const/build-directory-const.js"),common_const_js_1=require("../../const/common-const.js"),sdk_const_1=require("../../const/sdk-const"),aot_compile_mode_enum_js_1=require("../../enum/aot-compile-mode-enum.js"),code_type_enum_js_1=require("../../enum/code-type-enum.js"),compile_mode_enum_js_1=require("../../enum/compile-mode-enum.js"),module_type_enum_js_1=require("../../enum/module-type-enum.js"),sdk_info_extension_js_1=require("../../sdk/sdk-info-extension.js"),file_util_js_1=require("../../utils/file-util.js"),inject_util_js_1=require("../../utils/inject-util.js"),json_util_js_1=require("../../utils/json-util.js"),oh_package_loader_js_1=require("../../utils/loader/file/oh-package-loader.js"),res_model_loader_js_1=require("../../utils/loader/file/res-model-loader.js"),ohos_test_util_js_1=require("../../utils/ohos-test-util.js"),global_project_data_service_js_1=require("../service/global-project-data-service.js"),ohos_hap_task_js_1=require("../task/ohos-hap-task.js");class AbstractCompileNode extends ohos_hap_task_js_1.OhosHapTask{constructor(e,t,o){var i;super(e,{...o,name:`${AbstractCompileNode.getCompileNodeTaskName(t,o.name)}`}),this.TSIMPORTSENDABLE="ark.tsImportSendable",this.commonOption={path:path.dirname(process.execPath),watchMode:"false"},this.externalApiPaths=[],this.buildOption=e.getBuildOption();const s=e.getTargetData().getTargetName();if(this.codeType=t,this.codeModel=this.moduleModel.getSourceSetByTargetName(s).getCodeMap().get(this.codeType),this.isArkModule=this.service.isArkModule(),this.sourcePath=null===(i=this.codeModel)||void 0===i?void 0:i.getSrcPath(),this.targetName===common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET&&!this.isFaMode&&this.sourcePath&&(0,ohos_test_util_js_1.isTemplatesAfterSourceCodeMigration)(path.resolve(this.sourcePath,".."))){const e=this.moduleModel.getModule().getNodeDir();this.sourcePath=(0,ohos_test_util_js_1.getOhosTestIntermediatesEtsPath)(e)}this.aceSuperVisualPath=path.resolve(this.moduleModel.getSourceRootByTargetName(s),"supervisual"),this.aceModuleJsonPath=this.pathInfo.getIntermediatesArkModuleJsonPath(),fs_extra_1.default.existsSync(this.aceModuleJsonPath)||(this.aceModuleJsonPath=path.resolve(this.pathInfo.getIntermediatesProcessProfile())),this.resourceTable=path.resolve(this.pathInfo.getIntermediatesRes(),build_directory_const_js_1.BuildArtifactConst.RESOURCE_TABLE_TXT),this.rawFileResource=path.resolve(this.pathInfo.getIntermediatesRes(),build_directory_const_js_1.BuildDirConst.RESTOOL_BUILD_RESOURCES,build_directory_const_js_1.BuildDirConst.RAW_FILE),this.resProfileDir=this.pathInfo.getIntermediatesResProfilePath(),this.aceBuildJsonDir=this.pathInfo.getIntermediatesLoaderPath(),this.aceModuleBuild=path.resolve(this.pathInfo.getInterMediatesLoaderOutPath(),this.codeType);const r=this.moduleModel.getSourceRootByTargetName(common_const_js_1.DefaultTargetConst.DEFAULT_TARGET);this.mainCodePath=path.resolve(r,this.codeType.toString().toLowerCase()),this.anBuildOutputPath=path.resolve(this.pathInfo.getInterMediatesLoaderOutPath(),aot_compile_mode_enum_js_1.AotCompileModeEnum.AN),this.isCrossplatform=this.moduleModel.isCrossplatformModule(this.projectModel.getArkUIXConfigJsonObj())}static getCompileNodeTaskName(e,t){return e===code_type_enum_js_1.CodeType.ETS?`${t}ArkTS`:`${t}${e.toUpperCase()}`}async beforeAlwaysAction(){var e,t,o,i;this.userProjectConfig={autoLazyImport:null!==(t=null===(e=this.targetService.getBuildOption().arkOptions)||void 0===e?void 0:e.autoLazyImport)&&void 0!==t&&t,allowEmptyBundleName:!0===hvigor_1.hvigorCore.getParameter().getProperty(common_const_js_1.CommonConst.EMPTY_BUNDLENAME),reExportCheckMode:null!==(i=null===(o=this.targetService.getBuildOption().arkOptions)||void 0===o?void 0:o.reExportCheckMode)&&void 0!==i?i:"noCheck",executionMode:hvigor_1.coreParameter.startParams.optimizationStrategy}}get isByteCodeHarOptimize(){return inject_util_js_1.InjectUtil.isByteCodeHarOptimize()}declareInputs(){var e,t,o,i,s,r,a,n,l,d,c,_,u,h;const g=(new Map).set("debuggable",this.targetService.isDebug()).set("isArk",this.isArkModule).set("needCoverageInsert",inject_util_js_1.InjectUtil.isOhosTestCoverage()).set(this.TSIMPORTSENDABLE,!0===hvigor_1.hvigorCore.getParameter().getProperty(this.TSIMPORTSENDABLE)).set("customTypes",null!==(e=this.targetService.getCustomTypes())&&void 0!==e?e:"").set("isByteCodeHarOptimize",this.isByteCodeHarOptimize);for(const[e,o]of Object.entries(null!==(t=this.packageJsonObj.dependencies)&&void 0!==t?t:{}))g.set(e,`${e}: ${o}`);return this.moduleModel.getModuleType()!==module_type_enum_js_1.ModuleType.Har||(null===(o=this.buildOption)||void 0===o?void 0:o.debuggable)||g.set("sourceMapDir",null!==(i=hvigor_1.coreParameter.properties[const_1.OHOS_ARK_COMPILE_SOURCE_MAP_DIR])&&void 0!==i?i:""),(null===(s=this.buildOption)||void 0===s?void 0:s.debuggable)||g.set("branchElimination",null!==(n=null===(a=null===(r=this.targetService.getBuildOption())||void 0===r?void 0:r.arkOptions)||void 0===a?void 0:a.branchElimination)&&void 0!==n&&n),g.set("caseSensitiveCheck",null!==(c=null===(d=null===(l=this.targetService.getBuildOption())||void 0===l?void 0:l.strictMode)||void 0===d?void 0:d.caseSensitiveCheck)&&void 0!==c&&c),g.set(common_const_js_1.CommonConst.USE_NORMALIZED_OHM_URL,this.getUseNormalizedOHMUrl()),g.set(build_directory_const_js_1.BuildDirConst.TRANSFORM_LIB,null!==(h=null===(u=null===(_=this.targetService.getBuildOption())||void 0===_?void 0:_.arkOptions)||void 0===u?void 0:u.transformLib)&&void 0!==h?h:""),g.set("compatibleSdkVersionStage",this.compatibleSdkVersionStage||""),this.userProjectConfig&&Object.entries(this.userProjectConfig).forEach(([e,t])=>{g.set(e,t)}),g}declareOutputFiles(){var e;const t=(new hvigor_1.FileSet).addEntry(this.aceModuleBuild,{isDirectory:!0});if(this.targetService.getAnBuildMode()===aot_compile_mode_enum_js_1.AotCompileModeEnum.AOT_PARTIAL&&t.addEntry(this.anBuildOutputPath,{isDirectory:!0}),this.moduleModel.getModuleType()===module_type_enum_js_1.ModuleType.Har&&!(null===(e=this.buildOption)||void 0===e?void 0:e.debuggable))if(hvigor_1.coreParameter.properties[const_1.OHOS_ARK_COMPILE_SOURCE_MAP_DIR]){const e=this.getSourceMapDir(hvigor_1.coreParameter.properties[const_1.OHOS_ARK_COMPILE_SOURCE_MAP_DIR]);t.addEntry(path.resolve(e,build_directory_const_js_1.BuildArtifactConst.SOURCEMAPS_MAP),{isDirectory:!1})}else t.addEntry(path.resolve(this.pathInfo.getDefaultSourceMapPath(),build_directory_const_js_1.BuildArtifactConst.SOURCEMAPS_MAP),{isDirectory:!1});return t}declareInputFiles(){const e=(new hvigor_1.FileSet).addEntry(this.aceBuildJsonDir,{isDirectory:!0}).addEntries(this.getAllExistDependentMainPath()).addEntries(this.getAllExistHarSrcPath(),{isDirectory:!0});fs_extra_1.default.existsSync(this.rawFileResource)&&e.addEntry(this.rawFileResource,{isDirectory:!0});this.targetService.getResourceDirs().length>0&&e.addEntry(this.resourceTable),this.service.hasLiteDevice()||e.addEntry(this.aceModuleJsonPath),this.resProfileDir&&fs_extra_1.default.existsSync(this.resProfileDir)&&e.addEntry(this.resProfileDir,{isDirectory:!0}),this.aceSuperVisualPath&&fs_extra_1.default.existsSync(this.aceSuperVisualPath)&&e.addEntry(this.aceSuperVisualPath,{isDirectory:!0}),this.sourcePath&&fs_extra_1.default.existsSync(this.sourcePath)&&e.addEntry(this.sourcePath,{isDirectory:!0});const t=(0,json_util_js_1.getJson5Obj)(this.packageManagerPath);if(t){const o=path.join(this.module.getNodeDir(),t.main||"Index.ets");fs_extra_1.default.existsSync(o)&&fs_extra_1.default.statSync(o).isFile()&&e.addEntry(o)}if(this.targetService.getTargetData().getTargetName()===common_const_js_1.CommonConst.OHOS_TEST){const t=path.resolve(this.module.getNodeDir(),build_directory_const_js_1.BuildDirConst.SRC,common_const_js_1.CommonConst.OHOS_TEST);fs_extra_1.default.existsSync(t)&&e.addEntry(t,{isDirectory:!0})}return fs_extra_1.default.existsSync(this.pathInfo.getIntermediatesPkgContextInfoPath())&&e.addEntry(this.pathInfo.getIntermediatesPkgContextInfoPath()),e}getAllExistHarSrcPath(){return this.service.getDependencyRootPaths().map(e=>path.resolve(e,"src","main",this.codeType)).filter(e=>fs_extra_1.default.existsSync(e))}getAllExistDependentMainPath(){return this.service.getDependencyMainPaths().filter(e=>fs_extra_1.default.existsSync(e))}taskShouldDo(){return void 0!==this.sourcePath}moveReleaseMap(e,t,o=this.codeType){const i=path.resolve(e.getPathInfo().getInterMediatesLoaderOutPath(),o,build_directory_const_js_1.BuildArtifactConst.RELEASE_MAP);if(!fs_extra_1.default.existsSync(i))return;const s=path.resolve(this.getTaskTempDir(e),o,build_directory_const_js_1.BuildArtifactConst.RELEASE_MAP);fs_extra_1.default.existsSync(s)&&fs_extra_1.default.removeSync(s),fs_extra_1.default.moveSync(i,s),t.debug(`move ${i} to ${s}`)}async beforeTask(){if(inject_util_js_1.InjectUtil.isColdReload()||fs_extra_1.default.removeSync(this.aceModuleBuild),this.projectModel.isCrossplatformProject()){const e=this.projectModel.getCompileApiMetaByProduct((0,find_target_product_js_1.findTargetProduct)(this.projectModel).name),t=new sdk_info_extension_js_1.SdkInfoExtension(e).getArkUIXInfo();await t.setup();const o=t.getArkUIXRootPath();this.externalApiPaths.push(path.resolve(o))}}getTaskTempDir(e,t=""){const o=path.resolve(this.getArkCompileCachePath(e),`${this.targetService.getBuildMode().toLowerCase()}${t}`);return fs_extra_1.default.existsSync(o)||fs_extra_1.default.mkdirsSync(o),o}getArkCompileCachePath(e){const t=path.resolve(super.getTaskTempDir(e),`${this.targetCompileMode}`);return fs_extra_1.default.existsSync(t)||fs_extra_1.default.mkdirsSync(t),t}validateModuleJson(e){const t=this.pathInfo.getIntermediatesArkModuleJsonPath(),o=(0,json_util_js_1.getJson5Obj)(t);this.validateModulePage(e,o),this.validateAbilitiesAndExtensionAbilitiesSrcEntry(e,o)}initCommonArkConfig(){var e,t,o,i,s,r,a,n,l,d,c,_,u,h,g;const p=(0,wdk_1.cloneDeep)(null===(e=project_ohos_config_manager_js_1.projectOhosConfigManager.getOverrides())||void 0===e?void 0:e.appOpt),m=this.getPkgContextInfo();let v=this.getResolveConflictMode(),f=new Map;if(v){const e=this.service.getDependencyName2RootPath();!1===e?(v=!1,f=new Map):f=e}const P=null===(t=this.buildOption)||void 0===t?void 0:t.strictMode;return(null==P?void 0:P.useNormalizedOHMUrl)&&void 0===(null==P?void 0:P.noExternalImportByPath)&&Object.assign(P,{noExternalImportByPath:!0}),{moduleType:this.moduleModel.getModuleType(),perf:hvigor_1.AnalyzeModeMap.get(hvigor_1.hvigorCore.getParameter().getStartParams().analyze),targetName:`.${this.targetName}`,packageManagerType:this.isOhpmProject?"ohpm":"npm",localPropertiesPath:path.resolve(this.projectModel.getProjectDir(),"local.properties"),isPreview:!1,isOhosTest:"ohosTest"===this.targetName,isLocalTest:inject_util_js_1.InjectUtil.isLocalTest(),buildMode:this.targetService.getBuildMode(),hotReloadBuild:hvigor_1.hvigorCore.getParameter().getStartParams().hotReloadBuild,watchMode:"false",aceProfilePath:this.resProfileDir,etsLoaderPath:fs_extra_1.default.realpathSync.native(this.sdkInfo.getEtsLoader()),modulePath:this.module.getNodeDir(),testFrameworkPar:{testMode:inject_util_js_1.InjectUtil.isOhosTestCoverage()?common_const_js_1.CommonConst.OHOS_TEST:void 0,coveragePathFilter:inject_util_js_1.InjectUtil.getCoveragePathFilter(),coverageMode:inject_util_js_1.InjectUtil.getCoverageMode()},needCoverageInsert:inject_util_js_1.InjectUtil.isOhosTestCoverage(),debugLine:inject_util_js_1.InjectUtil.isDebugLineEnable(),projectTopDir:path.resolve(this.projectModel.getProjectDir()),compileSdkVersion:this.compileApiVersion,compatibleSdkVersion:this.compatibleApiVersion,compatibleSdkVersionStage:this.compatibleSdkVersionStage,bundleName:null!==(i=null!==(o=null==p?void 0:p.bundleName)&&void 0!==o?o:this.targetData.getProduct().bundleName)&&void 0!==i?i:this.projectModel.getDefaultBundleName(),etsLoaderVersion:this.sdkInfo.getEtsComponentVersion(),etsLoaderReleaseType:this.sdkInfo.getEtsComponentReleaseType(),aotCompileMode:inject_util_js_1.InjectUtil.isOhosTestCoverage()?aot_compile_mode_enum_js_1.AotCompileModeEnum.AOT_NULL:this.targetService.getAnBuildMode(),apPath:this.targetService.getApAbsolutePath(),entryModuleName:this.moduleName,entryModuleVersion:this.packageJsonObj.version,entryPackageName:"ohosTest"===this.targetName&&inject_util_js_1.InjectUtil.isOhosTestCoverage()?`${this.packageJsonObj.name}_test`:this.packageJsonObj.name,allModuleNameHash:global_project_data_service_js_1.GlobalProjectDataService.getInstance().getAllModuleNameHash(),externalApiPaths:this.getExternalApiPaths(),compilerTypes:this.targetService.getCustomTypes(),isCrossplatform:this.isCrossplatform,hvigorPluginFile:this.getHvigorPluginFile(),compilePluginPath:this.moduleModel.getCompilePluginPath(),buildGeneratedProfilePath:path.resolve(this.pathInfo.getGenerateBuildProfileDir(),this.targetName),bundleType:null!==(r=null!==(s=null==p?void 0:p.bundleType)&&void 0!==s?s:this.targetData.getProduct().bundleType)&&void 0!==r?r:this.projectModel.getBundleType(),arkTSVersion:this.targetData.getProduct().arkTSVersion,apiVersion:this.sdkInfo.getSdkVersion(),needCompleteSourcesMap:"ohosTest"===this.targetName||inject_util_js_1.InjectUtil.isOhosTestCoverage()||inject_util_js_1.InjectUtil.isLocalTest()||this.moduleModel.isHarModule()&&!this.targetService.isOpenSource(),isFaMode:this.isFaMode,strictMode:P,buildDir:this.pathInfo.getModuleBuildPath(),deviceTypes:this.moduleModel.getDeviceTypes(),useNormalizedOHMUrl:this.getUseNormalizedOHMUrl(),pkgContextInfo:m,ohPackagePathMap:oh_package_loader_js_1.ohPackageLoader.OhPackagePathMap,dependencyAliasMap:this.getDependencyAliasMap(m),permission:this.moduleModel.getPermission(),integratedHsp:!!this.moduleModel.isHspModule()&&(null===(a=this.targetService.getBuildOption().arkOptions)||void 0===a?void 0:a.integratedHsp),projectArkOption:null===(n=this.targetService.getBuildOption())||void 0===n?void 0:n.arkOptions,sourceMapDir:hvigor_1.coreParameter.properties[const_1.OHOS_ARK_COMPILE_SOURCE_MAP_DIR]?this.getSourceMapDir(hvigor_1.coreParameter.properties[const_1.OHOS_ARK_COMPILE_SOURCE_MAP_DIR]):void 0,branchElimination:null!==(d=null===(l=this.targetService.getBuildOption().arkOptions)||void 0===l?void 0:l.branchElimination)&&void 0!==d&&d,transformLib:this.normalizeTransformLib(),caseSensitiveCheck:null!==(u=null===(_=null===(c=this.targetService.getBuildOption())||void 0===c?void 0:c.strictMode)||void 0===_?void 0:_.caseSensitiveCheck)&&void 0!==u&&u,tsImportSendable:!0===hvigor_1.hvigorCore.getParameter().getProperty(this.TSIMPORTSENDABLE),resolveConflictMode:v,depName2RootPath:f,depName2DepInfo:this.service.getDependencyName2DepInfo(),rootPathSet:Array.from(global_project_data_service_js_1.GlobalProjectDataService.getInstance().getRootPathSet()),useNativeResolver:null===(h=hvigor_1.hvigorCore.getParameter().getProperty(common_const_js_1.CommonConst.USE_NATIVE_RESOLVER))||void 0===h||h,shouldEmitJs:this.targetCompileMode===compile_mode_enum_js_1.CompileModeEnum.JS_BUNDLE||inject_util_js_1.InjectUtil.isOhosTestCoverage()||!(!0===hvigor_1.hvigorCore.getParameter().getProperty(common_const_js_1.CommonConst.NO_EMIT_JS)),useTscResolve:!0===hvigor_1.hvigorCore.getParameter().getProperty(common_const_js_1.CommonConst.USE_TSC_RESOLVE),singleFileEmit:this.targetService.isDebug()&&null!==(g=hvigor_1.hvigorCore.getParameter().getProperty(common_const_js_1.CommonConst.SINGLE_FILE_EMIT))&&void 0!==g&&g&&!inject_util_js_1.InjectUtil.isOhosTestCoverage(),userProjectConfig:this.userProjectConfig,executionMode:hvigor_1.coreParameter.startParams.optimizationStrategy,...this.userProjectConfig,arkCompileCachePath:this.getArkCompileCachePath(this.targetData)}}getResolveConflictMode(){const e=e=>{if(fs_extra_1.default.existsSync(e)){return(0,ini_1.parse)(fs_extra_1.default.readFileSync(e,{encoding:"utf-8"})).resolve_conflict}};let t=e(path.resolve(this.projectModel.getProjectDir(),".ohpmrc"));return void 0!==t?t:(t=e(path.resolve(os_1.default.homedir(),".ohpm/.ohpmrc")),void 0===t||t)}normalizeTransformLib(){var e,t;if(!inject_util_js_1.InjectUtil.isInTest()&&this.targetService.isSourceCodeHar())return;const o=null===(t=null===(e=this.targetService.getBuildOption())||void 0===e?void 0:e.arkOptions)||void 0===t?void 0:t.transformLib;return o?path.resolve(this.pathInfo.getModulePath(),o):void 0}getBlockDependencies(){return this.isByteCodeHarOptimize?this.service.getRootHspDependencies().concat(this.service.getRootByteCodeHarDependencies()):this.service.getHspOrByteCodeHarDependencies()}async initDefaultArkCompileConfig(){const e=this.moduleModel.isHspModule()||this.targetService.isByteCodeHar(),t=this.pathInfo.getIntermediatesEtsTgzPath(this.moduleName);return{...this.initCommonArkConfig(),aceModuleJsonPath:this.aceModuleJsonPath,appResource:this.resourceTable,rawFileResource:this.rawFileResource,resourceTableHash:(0,hvigor_1.hashFile)(this.resourceTable),runtimeOS:this.sdkInfo.isOhos?common_const_js_1.CommonConst.OPEN_HARMONY:common_const_js_1.CommonConst.HARMONY_OS,sdkInfo:`${this.sdkInfo.isOhos}:${this.sdkInfo.getSdkVersion()}:${this.sdkInfo.getEtsComponentVersion()}:${this.sdkInfo.getEtsComponentReleaseType()}`,aceModuleRoot:this.sourcePath,compileMode:this.targetCompileMode,aceSuperVisualPath:this.aceSuperVisualPath,aceBuildJson:path.resolve(this.aceBuildJsonDir,build_directory_const_js_1.BuildArtifactConst.LOADER_JSON),cachePath:this.getTaskTempDir(this.targetData),aceModuleBuild:this.aceModuleBuild,supportChunks:!0,declaredFilesPath:e?t:void 0,shouldCollectDirectImportees:this.isByteCodeHarOptimize,isByteCodeHarOptimize:this.isByteCodeHarOptimize}}async getPreviewCompileConfig(e){const t=this.pathInfo.getBuildConfigPath(!0);let o={};fs_extra_1.default.existsSync(t)?o=fs_extra_1.default.readJsonSync(t):e.debug(`Build config file not found: ${t}`),o.cachePath&&delete o.cachePath;const i={...await this.initDefaultArkCompileConfig(),...o};return i.obfuscationOptions&&delete i.obfuscationOptions,i.watchMode="true",i.isPreview=!0,i.projectPath=i.aceModuleRoot,i.level=e.getLevel(),i.buildDir=this.pathInfo.getModulePreviewPath(),i.uiTransformOptimization=!1,fs_extra_1.default.ensureDirSync(i.cachePath),fs_extra_1.default.ensureDirSync(i.aceModuleBuild),i}handleCompileEvents(e,t,o){t&&e&&(e.forEach(e=>{const o=Object.assign(e.head.type===hvigor_1.MetricEventType.DURATION?new hvigor_1.DurationEvent("","","",0,"",""):new hvigor_1.ContinualEvent("","","",0,""),e);hvigor_1.MetricService.getInstance().submit(o),o.getParent()||(t.addChild(o.getId()),o.setParent(t.getId())),o.setLog(o.getName(),hvigor_1.MetricLogType.INFO,o.getDescription())}),o&&this.updateTid(t))}validateAbility(e){const t=this.targetData.getTargetName(),o=this.moduleModel.getSourceSetByTargetName(t).getLegacyModuleTargetRes().getJsonPath();if(!fs_extra_1.default.existsSync(o))return;const i=res_model_loader_js_1.resModelLoader.getConfigJson(o),s=i.module.abilities?i.module.abilities:[],r=path.resolve(this.moduleModel.getModule().getNodeDir(),build_directory_const_js_1.BuildDirConst.SRC,t===common_const_js_1.CommonConst.OHOS_TEST?common_const_js_1.CommonConst.OHOS_TEST:build_directory_const_js_1.BuildDirConst.MAIN),a=new Map;s.forEach(t=>{t.srcLanguage||e.printErrorExit("SRC_LANGUAGE_UNDEFINED",[t.name,i]);const s=t.srcLanguage?t.srcLanguage:"",n=path.resolve(r,s,t.srcPath);fs_extra_1.default.existsSync(n)||e.printErrorExit("SRC_PATH_NOT_FOUND",[t.srcPath,n,o],[[t.srcPath]]),a.set(t.name,s)});(i.module.js?i.module.js:[]).forEach(t=>{var i;if("form"===t.type)return;const s=null!==(i=a.get(t.name))&&void 0!==i?i:"";t.pages.forEach(i=>{var a,n;const l=path.resolve(r,s,`${t.name.substring(1)}`,`${i}.${null!==(n=null===(a=t.mode)||void 0===a?void 0:a.syntax)&&void 0!==n?n:"hml"}`);fs_extra_1.default.existsSync(l)||e.printErrorExit("MODULE_JS_PAGE_NOT_FOUND",[i,l,o],[[i]])})})}updateTid(e){e.getChildren().forEach(t=>{const o=hvigor_1.MetricService.getInstance().getEventById(t);o&&this.updateTid(o.setTid(e.getTid()))})}validateModulePage(e,t){const o=t.module.pages;if(void 0===o)return;const i=`${o.replace(/\$profile:/,"")}.json`,s=path.resolve(this.resProfileDir,i);fs_extra_1.default.existsSync(s)||e.printErrorExit("MODULE_PAGE_NOT_FOUND",[o,s],[[i]])}validateAbilitiesAndExtensionAbilitiesSrcEntry(e,t){this.validateSrcEntry(e,t.module.abilities),this.validateSrcEntry(e,t.module.extensionAbilities)}validateSrcEntry(e,t){const o=this.moduleModel.getSourceSetByTargetName(this.targetData.getTargetName());if(t&&(!t||0!==t.length))for(const i of t){const t=i.srcEntry;if(void 0===t)continue;const s=path.isAbsolute(t)?t:path.resolve(o.getSourceSetRoot(),t);if(this.targetName===common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET&&(0,ohos_test_util_js_1.isTemplatesAfterSourceCodeMigration)(o.getSourceSetRoot()))return;if(!file_util_js_1.FileUtil.fileExists(s)){const i=o;e.printErrorExit("MODULE_SRC_ENTRY_NOT_FOUND",[t,i.getModuleTargetRes().getJsonPath()])}}}getHvigorPluginFile(){var e,t;let o=null===(t=null===(e=this.buildOption)||void 0===e?void 0:e.arkOptions)||void 0===t?void 0:t.compilePluginFile;if(o){const e=path.resolve(this.moduleModel.getProjectDir(),o);o=fs_extra_1.default.existsSync(e)?e:`${e}.ts`}return o}getExternalApiPaths(){return this.compileApiVersion>sdk_const_1.ApiVersion.API_VERSION_9&&this.targetData.isHarmonyOS()&&this.sdkInfo.getHmsArkDir()&&this.externalApiPaths.push(this.sdkInfo.getHmsArkDir()),this.externalApiPaths}getUseNormalizedOHMUrl(){var e,t;return!!(null===(t=null===(e=this.buildOption)||void 0===e?void 0:e.strictMode)||void 0===t?void 0:t.useNormalizedOHMUrl)}getPkgContextInfo(){const e=this.pathInfo.getIntermediatesPkgContextInfoPath();return(0,json_util_js_1.getJson5Obj)(e)}getDependencyAliasMap(e){const t=new Map;return e?(Object.values(e).forEach(e=>{e.dependencyAlias&&t.set(e.dependencyAlias,e.packageName)}),t):t}getSourceMapDir(e){return path.isAbsolute(e)?path.resolve(hvigor_1.coreParameter.properties[const_1.OHOS_ARK_COMPILE_SOURCE_MAP_DIR],this.moduleName):path.resolve(this.projectModel.getProjectDir(),"hvigor",hvigor_1.coreParameter.properties[const_1.OHOS_ARK_COMPILE_SOURCE_MAP_DIR],this.moduleName)}}exports.AbstractCompileNode=AbstractCompileNode;