"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,s){void 0===s&&(s=i);var o=Object.getOwnPropertyDescriptor(t,i);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,s,o)}:function(e,t,i,s){void 0===s&&(s=i),e[s]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__decorate=this&&this.__decorate||function(e,t,i,s){var o,r=arguments.length,a=r<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,s);else for(var n=e.length-1;n>=0;n--)(o=e[n])&&(a=(r<3?o(a):r>3?o(t,i,a):o(t,i))||a);return r>3&&a&&Object.defineProperty(t,i,a),a},__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.AbstractProcessHarArtifacts=void 0;const path_1=__importDefault(require("path")),hvigor_1=require("@ohos/hvigor"),fs=__importStar(require("fs-extra")),minimatch_1=__importDefault(require("minimatch")),project_ohos_config_manager_js_1=require("../../common/global/project-ohos-config-manager.js"),build_directory_const_js_1=require("../../const/build-directory-const.js"),common_const_js_1=require("../../const/common-const.js"),cmake_util_js_1=require("../../utils/cmake-util.js"),file_util_js_1=require("../../utils/file-util.js"),oh_package_loader_js_1=require("../../utils/loader/file/oh-package-loader.js"),npm_utils_js_1=require("../../utils/npm-utils.js"),obfuscation_config_resolver_js_1=require("../../utils/obfuscation-config-resolver.js"),abstract_merge_profile_js_1=require("../abstract-merge-profile.js"),ohos_har_task_js_1=require("../task/ohos-har-task.js");class AbstractProcessHarArtifacts extends ohos_har_task_js_1.OhosHarTask{declareExecutionEnv(){return(new Map).set("cwd",this.taskTmpDir)}declareInputs(){var e;const t=(new Map).set("hasNativeOption",this.hasNativeOption).set("needCppTypes",this.needCppTypes).set("harModuleJson",this.harModuleJson).set("isOhpmProject",this.isOhpmProject).set("artifactType",this._harExtendInfo.getArtifactType()).set("isByteCodeHar",this.targetService.isByteCodeHar()).set(abstract_merge_profile_js_1.INPUT_KEY.projectConfigAppOpt,JSON.stringify(null===(e=project_ohos_config_manager_js_1.projectOhosConfigManager.getOverrides())||void 0===e?void 0:e.signingConfig));return this.hasNativeOption&&void 0!==this.cmakeListDir&&t.set("cmakeListDir",this.cmakeListDir),this.hasNativeOption&&this.needCppTypes&&t.set("cppTypes",this.cppTypes),t}get ignoreResourcePattern(){var e;return null===(e=this.targetService.getBuildOption().resOptions)||void 0===e?void 0:e.ignoreResourcePattern}declareInputFiles(){const e=this.allInvalidPrefix.join("|").replace(/\\/g,"\\\\"),t=RegExp(`^(?!${e}).*`),i=(new hvigor_1.FileSet).addEntry(this.harProfile,{isDirectory:!0}).addEntry(this._moduleDir,{isDirectory:!0,test:t}).addEntry(this.generateDir,{isDirectory:!0});fs.pathExistsSync(this.processedLibs)&&i.addEntry(this.processedLibs,{isDirectory:!0}),fs.pathExistsSync(this.resourceTablePath)&&i.addEntry(this.resourceTablePath,{isDirectory:!1});for(const e of this.headerPath){const t=path_1.default.isAbsolute(e)?e:path_1.default.resolve(this._moduleDir,e);fs.pathExistsSync(t)&&i.addEntry(t)}return i}declareOutputFiles(){var e;const t=(new hvigor_1.FileSet).addEntries([this.taskTmpDir],{isDirectory:!0});return hvigor_1.coreParameter.properties[hvigor_1.OHOS_ARK_COMPILE_SOURCE_MAP_DIR]||!this.sdkInfo.hasRollUpPluginInEtsLoader||(null===(e=this.targetService.getBuildOption())||void 0===e?void 0:e.debuggable)||t.addEntry(path_1.default.resolve(this.pathInfo.getDefaultSourceMapPath(),build_directory_const_js_1.BuildArtifactConst.SOURCEMAPS_MAP),{isDirectory:!1}),t}constructor(e,t){var i;super(e,t),this.allInvalidPrefix=[],this.ignoreFileNames=[".gitignore",".ohpmignore"],this.ohpmIgnoreRules=[],this.releaseWhiteListTemDir=["example"],this.packingIgnoreFiles=["/node_modules","/oh_modules","/.preview","/build","/.cxx","/.test"],this.needCopyFileNames=[],this._moduleDir=this.moduleModel.getProjectDir(),this.projectDir=this.projectModel.getProjectDir(),this.taskTmpDir=this.getTaskTempDir(this.targetData,this.service.isFaMode()?`${this.targetService.getTargetData().getTargetName()}@LegacyPackageHar`:`${this.targetService.getTargetData().getTargetName()}@PackageHar`,!1),this.generateDir=this.pathInfo.getGeneratePmDir();const s=null===(i=this.targetService.getBuildOption().nativeLib)||void 0===i?void 0:i.headerPath;"string"==typeof s?this.headerPath=[s]:Array.isArray(s)?this.headerPath=s:this.headerPath=[],this.resourceDir=this.pathInfo.getIntermediatesRes(),this.processedLibs=this.pathInfo.getIntermediatesStrippedLibsDir(),this.resourceTablePath=path_1.default.resolve(this.resourceDir,build_directory_const_js_1.BuildArtifactConst.RESOURCE_TABLE_TXT),this.harProfile=this.pathInfo.getIntermediatesProcessProfileDir(),this.harModuleJson=path_1.default.resolve(this.taskTmpDir,"src","main",common_const_js_1.CommonConst.MODULE_JSON5),cmake_util_js_1.CmakeUtil.nativeTaskCondition(this.moduleModel,this.targetData,this.targetService.getBuildOption().externalNativeOptions)&&(this.cmakeListDir=cmake_util_js_1.CmakeUtil.getCmakeListDir(this.moduleModel,this.targetName,this.targetService.getBuildOption().externalNativeOptions)),this.obfuscationFiles=this.resolveObfuscationFiles(),this.cppTypes=path_1.default.resolve(this._moduleDir,"src","main","cpp","types"),this.hasNativeOption=this._harExtendInfo.hasConfiguredNativeOption(),this.needCppTypes=fs.pathExistsSync(this.cppTypes),this.initModuleToplevelPathFilter(),this.initNeedCopyFileNames()}initModuleToplevelPathFilter(){const e=[build_directory_const_js_1.BuildDirConst.LIBS,build_directory_const_js_1.BuildDirConst.BUILD_ROOT,common_const_js_1.CommonNodeConst.NODE_MODULES,common_const_js_1.CommonConst.OH_MODULES,".cxx",".previewer",".hvigor",...this.ignoreFileNames];e.includes(this.pathInfo.getBuildRoot())||e.push(this.pathInfo.getBuildRoot()),e.forEach(e=>{this.allInvalidPrefix.push(path_1.default.resolve(this._moduleDir,e))})}initNeedCopyFileNames(){const e=this.isOhpmProject?common_const_js_1.CommonConst.OH_PACKAGE_JSON5:common_const_js_1.CommonConst.PACKAGE_JSON,t=oh_package_loader_js_1.ohPackageLoader.getNodeOhPackagePath(path_1.default.resolve(this._moduleDir,e));if(fs.existsSync(t)){const e=hvigor_1.Json5Reader.getJson5Obj(t);e.main&&this.needCopyFileNames.push(e.main)}this.needCopyFileNames=this.needCopyFileNames.map(e=>path_1.default.resolve(this._moduleDir,e))}initFilterRules(){var e,t;if(!this.isOhpmProject)return;const{include:i,exclude:s}=(null===(t=null===(e=this.targetService.getBuildOption())||void 0===e?void 0:e.packingOptions)||void 0===t?void 0:t.asset)||{};if((null==i?void 0:i.length)||(null==s?void 0:s.length))this.ohpmIgnoreRules.push(...this.packingIgnoreFiles);else for(const e of this.ignoreFileNames){const t=path_1.default.resolve(this._moduleDir,e);if(!fs.existsSync(t)||fs.statSync(t).isDirectory())continue;const i=fs.readFileSync(t).toString().split(/\r?\n/).filter(e=>!/^#|^$/.test(e.trim())).map(e=>e.trim());this.ohpmIgnoreRules.push(...i)}for(const e of this.headerPath)this.ohpmIgnoreRules.push(e);this.ohpmIgnoreRules.push("/src/test");this.ohpmIgnoreRules.push("/src/ohosTest"),this.initSourceRootFilterRules()}initSourceRootFilterRules(){var e;const t=this.targetData.getTargetOpt(),i=null===(e=t.source)||void 0===e?void 0:e.sourceRoots;if(!(null==i?void 0:i.length))return;const s=t.name,o=this.moduleModel.getTargetOptions(),r=/^\.[/\\]/,a=i.reduce((e,t)=>(e.add(t.replace(r,"")),e),new Set);o.forEach(e=>{var t,i;e.name!==s&&(null===(i=null===(t=e.source)||void 0===t?void 0:t.sourceRoots)||void 0===i||i.forEach(e=>{const t=e.replace(r,"");a.has(t)||this.ohpmIgnoreRules.push(t)}))})}async doTaskAction(){var e,t,i,s;const o="verify and initialize packaging information",r=this.durationEvent.createSubEvent(o,"");r.start(),this.preCheckBeforePack(),this.copyLocalDepsFileToTempDir(),this._harExtendInfo.isObfuscatedHar()||this.targetService.isByteCodeHar()?(this.copyResourceFileOfReleaseHar(),this.copyModuleSourceFileToTempDirByWhiteList(),this.copyCompiledSourceFileToTempDir(),file_util_js_1.FileUtil.copySpecialFileToTempDir(this._moduleDir,this.taskTmpDir)):(this.initFilterRules(),this.copyModuleSourceFileToTempDirByBlackList()),file_util_js_1.FileUtil.disposalPackingOptionAsset(this._moduleDir,null===(t=null===(e=this.targetService.getBuildOption())||void 0===e?void 0:e.packingOptions)||void 0===t?void 0:t.asset,this.taskTmpDir),await this.syncNativeHeader(),await this.syncObfuscationFile(),this.copyBuildIntermediatesOutToTempDir(),this.copyOtherGenerateFiles(),this.processBundleDepRes(),this.processPackageJson(),this.processSourceMaps(),this.processHarRouterMap(),this.processHarResStartupConfig(),this.processObfuscatedHarAbility();const a=null===(s=null===(i=this.targetService.getBuildOption())||void 0===i?void 0:i.strictMode)||void 0===s?void 0:s.useNormalizedOHMUrl,n=cmake_util_js_1.CmakeUtil.getHarExtraParams(this);let l=new Set;const c=this.pathInfo.getIntermediatesProcessLibs();fs.existsSync(c)&&(l=await file_util_js_1.FileUtil.readDirFileNames(c)),file_util_js_1.FileUtil.addParamToOhPack(this.isOhpmProject,this.taskTmpDir,{useNormalizedOHMUrl:a},n,this.targetName,l),r.stop(),r.setLog(o,hvigor_1.MetricLogType.INFO)}async syncNativeHeader(){const e=new Map;for(const t of this.headerPath){const i=path_1.default.isAbsolute(t)?t:path_1.default.resolve(this._moduleDir,t);cmake_util_js_1.CmakeUtil.checkNativeHeader(i,this.moduleModel,e),await fs.copy(i,path_1.default.resolve(this.taskTmpDir,"include"),{recursive:!0})}}async syncObfuscationFile(){var e,t,i;const s=null===(e=this.targetService.getBuildOption().arkOptions)||void 0===e?void 0:e.obfuscation;if((null===(t=null==s?void 0:s.ruleOptions)||void 0===t?void 0:t.enable)||(null==s?void 0:s.consumerFiles)&&(null===(i=null==s?void 0:s.consumerFiles)||void 0===i?void 0:i.length)>0){const e=this.pathInfo.getObfuscationExportRulePath();fs.existsSync(e)&&await fs.copyFile(e,path_1.default.resolve(this.taskTmpDir,common_const_js_1.CommonConst.OBFUSCATION_TXT))}}resolveObfuscationFiles(){var e;const t=[];if(!this._harExtendInfo.isObfuscatedHar())return t;return(null!==(e=this.moduleModel.getProfileOpt().buildOptionSet)&&void 0!==e?e:[]).forEach(e=>{var i,s,o,r,a;t.push(...(0,obfuscation_config_resolver_js_1.transformRules)(null===(o=null===(s=null===(i=e.arkOptions)||void 0===i?void 0:i.obfuscation)||void 0===s?void 0:s.ruleOptions)||void 0===o?void 0:o.files,this._moduleDir,this.moduleModel,this.targetName)),t.push(...(0,obfuscation_config_resolver_js_1.transformRules)(null===(a=null===(r=e.arkOptions)||void 0===r?void 0:r.obfuscation)||void 0===a?void 0:a.consumerFiles,this._moduleDir,this.moduleModel,this.targetName))}),t}noNeedCopyCmakeList(e){return!(this.hasNativeOption&&e===this.cmakeListDir)}copyLocalDepsFileToTempDir(){(0,npm_utils_js_1.collectLocalFileDependency)(this.packageManagerPath,this.packageJsonObj).forEach(e=>{const t=path_1.default.resolve(this._moduleDir,e);fs.pathExistsSync(t)&&fs.copySync(t,path_1.default.resolve(this.taskTmpDir,path_1.default.relative(this._moduleDir,t)))}),this.localProductDependenciesPath.length>0&&(0,npm_utils_js_1.copyParameterizationLocalProductDependencies)({localProductDependencies:this.localProductDependenciesPath,moduleDir:this._moduleDir,tempDir:this.taskTmpDir,logger:this.logger})}getResourcesDirectories(){var e;const t=null===(e=this.targetService.getTargetData().getTargetOpt().resource)||void 0===e?void 0:e.directories;return(null==t?void 0:t.length)?t:[path_1.default.relative(this.targetService.getTargetData().getPathInfo().getModulePath(),this.targetData.getModuleSourceSetModel().getTargetResPath())]}isResourcePath(e){return this.getResourcesDirectories().some(t=>e.includes(t))}copyResourceFileOfReleaseHar(){this.getResourcesDirectories().forEach(e=>{const t=file_util_js_1.FileUtil.convertToAbsolutePath(e,this.targetService.getTargetData().getPathInfo().getModulePath());if(fs.existsSync(t)){const i=file_util_js_1.FileUtil.convertToAbsolutePath(e,this.taskTmpDir);fs.copySync(t,i,{filter:e=>!this.isResourceIgnored(e)})}})}copyModuleSourceFileToTempDirByWhiteList(){for(const e of this.releaseWhiteListTemDir){const t=path_1.default.resolve(this._moduleDir,e);if(fs.existsSync(t)){const i=path_1.default.resolve(this.taskTmpDir,e);fs.copySync(t,i,{overwrite:!1})}}}getCopyFilter(e){return t=>this.noNeedCopyCmakeList(t)&&!(this.isResourcePath(t)&&this.isResourceIgnored(t))&&!this.needIgnoreSrc(e,t)&&!this.excludeObfuscationFiles(t)||this.needCopyFile(t)}needCopyFile(e){return-1!==this.needCopyFileNames.indexOf(e)}isResourceIgnored(e){const t=path_1.default.basename(e),i=this.ignoreResourcePattern;return!!i&&i.some(e=>(0,minimatch_1.default)(t,e))}excludeObfuscationFiles(e){return!!this.obfuscationFiles.find(t=>""===path_1.default.relative(e,t))}needIgnoreSrc(e,t){const i=e.length,s=t.substring(i+1).split(path_1.default.sep).join("/");return this.ohpmIgnoreRules.some(e=>(0,minimatch_1.default)(s,e)||(0,minimatch_1.default)(`/${s}`,e))}copyModuleSourceFileToTempDirByBlackList(){fs.readdirSync(this._moduleDir).forEach(e=>{const t=path_1.default.resolve(this._moduleDir,e);this.allInvalidPrefix.includes(t)||fs.copySync(t,path_1.default.resolve(this.taskTmpDir,e),{filter:this.getCopyFilter(this._moduleDir)})});const e=this.pathInfo.getHarGenerateBuildProfilePath(),t=path_1.default.resolve(this.taskTmpDir,build_directory_const_js_1.BuildArtifactConst.BUILD_PROFILE_FILE);fs.existsSync(e)&&fs.copySync(e,t),fs.pathExistsSync(this.harModuleJson)&&fs.removeSync(this.harModuleJson)}preCheckBeforePack(){const e=this.packageManagerPath,t=this.packageJsonObj;(0,npm_utils_js_1.checkHasLocalFileDependency)(e,t)&&this.logger._buildError(`Local dependencies detected during har packing of module ${this.moduleName}. Declaring local dependencies in har module might cause failing during install har package.`)._detail("Check package.json/oh-package.json5 of current library module and replace the local dependencies.")._file(e)._printWarn(this.moduleName),fs.emptyDirSync(this.taskTmpDir)}copyBuildIntermediatesOutToTempDir(){fs.pathExistsSync(this.processedLibs)&&fs.copySync(this.processedLibs,path_1.default.resolve(this.taskTmpDir,build_directory_const_js_1.BuildDirConst.LIBS)),fs.pathExistsSync(this.resourceTablePath)&&fs.copySync(this.resourceTablePath,path_1.default.resolve(this.taskTmpDir,build_directory_const_js_1.BuildArtifactConst.RESOURCE_TABLE_TXT)),fs.copySync(this.harProfile,path_1.default.resolve(this.taskTmpDir,build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN))}copyOtherGenerateFiles(){}processHarRouterMap(){}processHarResStartupConfig(){}processBundleDepRes(){}processObfuscatedHarAbility(){}}__decorate([(0,hvigor_1.Input)()],AbstractProcessHarArtifacts.prototype,"ignoreResourcePattern",null),exports.AbstractProcessHarArtifacts=AbstractProcessHarArtifacts;