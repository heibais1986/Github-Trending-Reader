"use strict";var __decorate=this&&this.__decorate||function(t,e,s,o){var r,a=arguments.length,n=a<3?e:null===o?o=Object.getOwnPropertyDescriptor(e,s):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(t,e,s,o);else for(var i=t.length-1;i>=0;i--)(r=t[i])&&(n=(a<3?r(n):a>3?r(e,s,n):r(e,s))||n);return a>3&&n&&Object.defineProperty(e,s,n),n},__importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.AbstractSyscapTransform=void 0;const wdk_1=require("@baize/wdk"),hvigor_1=require("@ohos/hvigor"),fs_1=__importDefault(require("fs")),fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path")),common_const_js_1=require("../../const/common-const.js"),array_util_js_1=require("../../utils/array-util.js"),file_util_js_1=require("../../utils/file-util.js"),json_util_js_1=require("../../utils/json-util.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),process_utils_js_1=require("../../utils/process-utils.js"),pre_check_syscap_js_1=require("../pre-check-syscap.js"),ohos_hap_task_js_1=require("../task/ohos-hap-task.js");class AbstractSyscapTransform extends ohos_hap_task_js_1.OhosHapTask{get sysCapTool(){return this.sdkInfo.getSysCapTool()}get sysCapPath(){return fs_1.default.existsSync(this.sdkInfo.getSdkJsDir())&&!fs_1.default.existsSync(this.sdkInfo.getSdkEtsDir())?this.sdkInfo.getSysCapFileInJs():this.sdkInfo.getSysCapFileInEts()}get deviceTypes(){return this.getJsonProfileByModel().deviceTypes}constructor(t,e){var s;super(t,e),this._log=ohos_logger_js_1.OhosLogger.getLogger(AbstractSyscapTransform.name);const o=t.getTargetData().getTargetName();this.sourceRoot=null===(s=this.service.getModuleModel())||void 0===s?void 0:s.getSourceRootByTargetName(o),this.pathInfo=this.targetService.getTargetData().getPathInfo(),this.sysCapJsonPath=path_1.default.resolve(this.sourceRoot,common_const_js_1.CommonConst.SYSCAP_JSON),this.rpcidScPath=path_1.default.resolve(this.pathInfo.getIntermediatesSysCap(),common_const_js_1.CommonConst.RPCID_SC)}initTaskDepends(){this.declareDepends(pre_check_syscap_js_1.PreCheckSyscap.name)}async doTaskAction(){if(this.targetData.isHarmonyOS())return;const t="generate SysCap transform command",e=this.durationEvent.createSubEvent(t,"");e.start();const s=this.getJsonProfileByModel();let o=new Set;const r=s.deviceTypes,a=this.getIntersectedGeneralSysCapSet(r);if(fs_extra_1.default.existsSync(this.sysCapJsonPath)){const t=(0,json_util_js_1.getJson5Obj)(this.sysCapJsonPath),e=t.devices.custom,s=this.getIntersectedCustomSysCapSet(e);0===r.length?(this.checkCustomSysCapList(e),o=s):o=e&&0!==e.length?(0,array_util_js_1.getIntersectedSet)(s,a):a;const n=t.production;n&&this.processProductionSysCap(n,o)}if(fs_extra_1.default.existsSync(this.sysCapJsonPath)||(o=a),this.moduleModel.isHarModule())return e.stop(),void e.setLog(t,hvigor_1.MetricLogType.INFO);if(!(null==o?void 0:o.size)){const t=this.isFaMode?this.targetData.getModuleSourceSetModel().getLegacyModuleTargetRes().getJsonPath():this.targetData.getModuleSourceSetModel().getModuleTargetRes().getJsonPath();this._log.printErrorExit("INVALID_CUSTOM_SYSCAP",[fs_extra_1.default.existsSync(this.sysCapJsonPath)?this.sysCapJsonPath:t],[[common_const_js_1.CommonConst.SYSCAP_JSON,this.moduleName,common_const_js_1.CommonConst.MODULE_JSON5,common_const_js_1.CommonConst.CONFIG_JSON]])}const n=new Map;n.set(common_const_js_1.CommonConst.API_VERSION,this.compileApiVersion),n.set(common_const_js_1.CommonConst.SYSTEM_CAPABILITY,Array.from(o));const i=this.pathInfo.getIntermediatesSysCap();file_util_js_1.FileUtil.checkDirWithoutDelete(i);const c=path_1.default.resolve(i,common_const_js_1.CommonConst.RPCID_JSON);fs_extra_1.default.outputJsonSync(c,Object.fromEntries(n));const _={moduleName:this.moduleName,taskName:this.name,commandLine:[this.sysCapTool,"-R","-e","-i",c,"-o",i]};e.stop(),e.setLog(t,hvigor_1.MetricLogType.INFO);const l="submit SysCap transform task to work pool",u=this.durationEvent.createSubEvent(l,"");u.start(),await new process_utils_js_1.ProcessUtils(_.moduleName,_.taskName).submitExecutionWithoutReturn(this,this.getWorkerPool(),_,wdk_1.noop,[],u),u.stop(),u.setLog(l,hvigor_1.MetricLogType.INFO)}getIntersectedGeneralSysCapSet(t){var e;if(!(null==t?void 0:t.length))return new Set;if(1===t.length)return null!==(e=this.getSysCapSetFromSdk(t[0],this.sysCapPath))&&void 0!==e?e:new Set;const s=Array.from(t.map(t=>{var e;return Array.from(null!==(e=this.getSysCapSetFromSdk(t,this.sysCapPath))&&void 0!==e?e:new Set)}).reduce((t,e)=>t.filter(t=>e.includes(t))));return new Set(s)}getSysCapSetFromSdk(t,e){const s=path_1.default.resolve(e,`${t}.json`);if(!fs_extra_1.default.existsSync(s))return void this._log.warn(`The systemCapability set corresponding to the '${t}' is not found in the '${e}'.`);const o=new Set;return(0,json_util_js_1.getJson5Obj)(s).SysCaps.forEach(t=>{o.add(t)}),o}getIntersectedCustomSysCapSet(t){if(!(null==t?void 0:t.length)||t.some(t=>"{}"===JSON.stringify(t)))return new Set;const e=[];return t.forEach(t=>{Object.keys(t).forEach(s=>{e.push(t[s])})}),new Set((0,wdk_1.intersection)(...e))}processProductionSysCap(t,e){const s=t.addedSysCaps;s&&s.forEach(t=>{e.add(t)});const o=t.removedSysCaps;o&&o.forEach(t=>{e.delete(t)})}checkCustomSysCapList(t){t&&0!==t.length||this._log.printErrorExit("CUSTOM_SYSCAP_IN_EMPTY_DEVICE_TYPES",[common_const_js_1.CommonConst.MODULE_JSON5,this.moduleName,common_const_js_1.CommonConst.SYSCAP_JSON,this.sysCapJsonPath],[[common_const_js_1.CommonConst.MODULE_JSON5,common_const_js_1.CommonConst.SYSCAP_JSON,this.moduleName]])}}__decorate([(0,hvigor_1.InputFile)()],AbstractSyscapTransform.prototype,"sysCapJsonPath",void 0),__decorate([(0,hvigor_1.OutputFile)()],AbstractSyscapTransform.prototype,"rpcidScPath",void 0),__decorate([(0,hvigor_1.InputFile)()],AbstractSyscapTransform.prototype,"sysCapTool",null),__decorate([(0,hvigor_1.InputFile)()],AbstractSyscapTransform.prototype,"sysCapPath",null),__decorate([(0,hvigor_1.Input)()],AbstractSyscapTransform.prototype,"deviceTypes",null),exports.AbstractSyscapTransform=AbstractSyscapTransform;