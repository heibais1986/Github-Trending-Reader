"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(t,e,i,r){void 0===r&&(r=i);var s=Object.getOwnPropertyDescriptor(e,i);s&&!("get"in s?!e.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return e[i]}}),Object.defineProperty(t,r,s)}:function(t,e,i,r){void 0===r&&(r=i),t[r]=e[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),__importStar=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var i in t)"default"!==i&&Object.prototype.hasOwnProperty.call(t,i)&&__createBinding(e,t,i);return __setModuleDefault(e,t),e},__importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.AbstractPackageHar=void 0;const hvigor_1=require("@ohos/hvigor"),hvigor_2=require("@ohos/hvigor"),fs=__importStar(require("fs-extra")),path_1=__importDefault(require("path")),build_directory_const_js_1=require("../../const/build-directory-const.js"),log_combine_type_js_1=require("../../utils/log/log-combine-type.js"),npm_utils_js_1=require("../../utils/npm-utils.js"),process_utils_js_1=require("../../utils/process-utils.js"),ohos_har_task_js_1=require("../task/ohos-har-task.js"),npm_command_builder_js_1=require("../../builder/npm-command-builder.js");class AbstractPackageHar extends ohos_har_task_js_1.OhosHarTask{declareOutputFiles(){return(new hvigor_1.FileSet).addEntries([this.taskTmpDir,this.outputDir],{isDirectory:!0})}constructor(t,e){super(t,e),this.outputDir=this.pathInfo.getModuleBuildOutputPath(),this.npmPath=path_1.default.dirname(process.execPath),this.npmCommand=new npm_command_builder_js_1.NpmCommandBuilder(this.npmPath).addAllParams(["pack"])}declareExecutionCommand(){return`${this.npmCommand.toString()}`}async doTaskAction(){fs.emptyDirSync(this.outputDir),this.isOhpmProject?await this.executeOhpmPack():await this.executeNpmPack(),this.moveSourceMap()}async executeOhpmPack(){var t;const e=null===(t=this.targetData.getTargetOpt().output)||void 0===t?void 0:t.artifactName,i=e?`${e}`:`${this.moduleName}`;fs.emptyDirSync(this.outputDir),await(0,npm_utils_js_1.execOhpmPack)(this.taskTmpDir,path_1.default.resolve(this.outputDir,`${i}.har`),this.durationEvent)}async executeNpmPack(){const t={moduleName:this.moduleName,taskName:this.name,commandLine:this.npmCommand,commandOptions:{cwd:this.taskTmpDir}},e=t=>{fs.copySync(this.taskTmpDir,this.outputDir,{filter:e=>!fs.lstatSync(e).isDirectory()&&e.endsWith(t)||e===this.taskTmpDir})},i="execute npm packaging command",r=this.durationEvent.createSubEvent(i,"");if(r.start(),!new process_utils_js_1.ProcessUtils(this.moduleName,this.name).submitSyncExecutionWithReturn(this,this.getWorkerPool(),"packageHar",t,e)){e((await new process_utils_js_1.ProcessUtils(this.moduleName,this.name).execute(t.commandLine,t.commandOptions,log_combine_type_js_1.LogCombineType.DEBUG)).stdout.toString())}r.stop(),r.setLog(i,hvigor_1.MetricLogType.INFO)}moveSourceMap(){if(!this.sdkInfo.hasRollUpPluginInEtsLoader)return;const t=this.pathInfo.getSourceMapOriginPath(this.targetService);if(fs.existsSync(t))if(hvigor_1.coreParameter.properties[hvigor_2.OHOS_ARK_COMPILE_SOURCE_MAP_DIR]){const e=hvigor_1.coreParameter.properties[hvigor_2.OHOS_ARK_COMPILE_SOURCE_MAP_DIR],i=path_1.default.isAbsolute(e)?path_1.default.resolve(e,this.moduleName):path_1.default.resolve(this.projectModel.getProjectDir(),"hvigor",e,this.moduleName);fs.ensureDirSync(i),fs.copyFileSync(t,path_1.default.resolve(i,build_directory_const_js_1.BuildArtifactConst.SOURCEMAPS_MAP))}else fs.ensureDirSync(this.pathInfo.getDefaultSourceMapPath()),fs.copyFileSync(t,path_1.default.resolve(this.pathInfo.getDefaultSourceMapPath(),build_directory_const_js_1.BuildArtifactConst.SOURCEMAPS_MAP))}}exports.AbstractPackageHar=AbstractPackageHar;