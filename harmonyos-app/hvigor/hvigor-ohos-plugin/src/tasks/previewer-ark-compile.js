"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PreviewerArkCompile=void 0;const hvigor_1=require("@ohos/hvigor"),hvigor_2=require("@ohos/hvigor"),path_1=__importDefault(require("path")),wdk_1=require("@baize/wdk"),common_const_js_1=require("../const/common-const.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),task_names_js_1=require("./common/task-names.js"),ark_compile_js_1=require("./ark-compile.js"),preview_update_assets_js_1=require("./preview-update-assets.js");var CommonTask=task_names_js_1.TaskNames.CommonTask;const sdk_const_js_1=require("../const/sdk-const.js"),task_util_js_1=require("../utils/task-util.js"),json_util_js_1=require("../utils/json-util.js"),fs_extra_1=__importDefault(require("fs-extra")),build_directory_const_js_1=require("../const/build-directory-const.js"),ohmurl_utils_js_1=require("../utils/ohmurl-utils.js");class PreviewerArkCompile extends ark_compile_js_1.ArkCompile{constructor(){super(...arguments),this.logger=ohos_logger_js_1.OhosLogger.getLogger(PreviewerArkCompile.name)}declareInputFiles(){return this.moduleModel.isHarModule()?super.declareInputFiles().deleteEntry(this.aceBuildJsonDir):super.declareInputFiles()}async doTaskAction(){var e;const t=hvigor_2.hvigorCore.getExtraConfig().get("pageType"),r=await this.getPreviewCompileConfig(this.logger),s=path_1.default.resolve(__dirname,"./worker/preview-build.js"),o=this.getBlockDependencies().map(e=>e.getDependencyName());if(r.pkgNameToPkgBriefInfo=this.pkgNameToPkgBriefInfo,r.otherPaths=this.getTscAddressPaths(r.aceModuleRoot),r.compileBlockPkg=o,!t||t===common_const_js_1.PageType.PAGE){const e="true"===hvigor_2.hvigorCore.getExtraConfig().get("compileHspDependencies"),t=hvigor_2.hvigorCore.getExtraConfig().get("mainModule"),o=(e&&t!==this.moduleName?hvigor_1.normalWorker:hvigor_1.watchWorker).createWorker(this,s,!0,e=>this.handleCompileEvents(e,this.getSubDurationEvent(o),!0),{workerData:{projectConfig:r,logLevel:this.logger.getLevel().levelStr}})}if(this.needSubmitArkTsWidget&&t===common_const_js_1.PageType.CARD){const t={...r,widgetCompile:"true",cachePath:path_1.default.resolve(null!==(e=r.cachePath)&&void 0!==e?e:this.getTaskTempDir(this.targetData,"_widget"),"widget"),port:void 0},o=hvigor_1.watchWorker.createWorker(this,s,!0,e=>this.handleCompileEvents(e,this.getSubDurationEvent(o),!0),{workerData:{projectConfig:t,logLevel:this.logger.getLevel().levelStr}})}this.addOhmurlToHarAbility(),(0,task_util_js_1.warnCreateBuildProfileTask)(this.targetData,this.targetService,this._log)}addOhmurlToHarAbility(){var e;const t=(0,json_util_js_1.getJson5Obj)(this.pathInfo.getPreviewIntermediatesResModuleJsonPath()),r=this.moduleModel.getModule().getNodeDir();for(const s of[common_const_js_1.AbilityConst.UI_ABILITY,common_const_js_1.AbilityConst.EXTENSION_ABILITY]){const o=null===(e=null==t?void 0:t.module)||void 0===e?void 0:e[s];if(!(null==o?void 0:o.length))continue;const i=this.getDependencyHarAbility(s);null==o||o.forEach(e=>{if(!e.srcEntry)return;const t=path_1.default.resolve(r,build_directory_const_js_1.BuildDirConst.SRC_MAIN,e.srcEntry);Object.assign(e,{ohmurl:(0,ohmurl_utils_js_1.generateOhmUrlForSourceFile)(this.targetService.getPkgContextInfo(this.packageJsonObj.name),t.substring(r.length+1))});const s=i.find(t=>t.name===e.name);s&&Object.assign(e,s)}),Object.assign(t.module,{[s]:o})}fs_extra_1.default.writeFileSync(this.pathInfo.getPreviewIntermediatesResModuleJsonPath(),JSON.stringify(t))}getDependencyHarAbility(e){const t=path_1.default.resolve(this.moduleModel.getModule().getNodeDir(),build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN),r=[];return this.service.getHarDependencies().forEach(s=>{const o=s.getModuleJsonObj(),i=null==o?void 0:o.module[e];(null==i?void 0:i.length)&&i.forEach(e=>{const o=(0,wdk_1.cloneDeep)(e);if(!o.srcEntry)return;const i=path_1.default.resolve(s.getDependencyRootPath(),build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN,o.srcEntry);Object.assign(o,{srcEntry:path_1.default.relative(t,i),ohmurl:(0,ohmurl_utils_js_1.generateOhmurlForSrcEntry)(this.targetService,this.moduleName,s,o.srcEntry)}),r.push(o)})}),r}initTaskDepends(){this.declareDepends(preview_update_assets_js_1.PreviewUpdateAssets.name),(0,task_util_js_1.limitMinApiVersion)(this.targetData,sdk_const_js_1.ApiVersion.API_VERSION_9)&&this.declareDepends(CommonTask.CREATE_BUILD_PROFILE.name)}}exports.PreviewerArkCompile=PreviewerArkCompile;