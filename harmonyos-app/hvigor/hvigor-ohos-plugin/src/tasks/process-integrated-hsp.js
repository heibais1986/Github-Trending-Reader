"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ProcessIntegratedHsp=void 0;const fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path")),build_directory_const_js_1=require("../const/build-directory-const.js"),integrated_hsp_utils_js_1=require("../utils/integrated-hsp-utils.js"),process_utils_js_1=require("../utils/process-utils.js"),remote_hsp_utils_js_1=require("../utils/remote-hsp-utils.js"),wdk_1=require("@baize/wdk"),hvigor_1=require("@ohos/hvigor"),sdk_const_js_1=require("../const/sdk-const.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),task_util_js_1=require("../utils/task-util.js"),task_names_js_1=require("./common/task-names.js"),global_project_data_service_js_1=require("./service/global-project-data-service.js"),ohos_module_task_js_1=require("./task/ohos-module-task.js"),dependency_manager_js_1=require("../project/dependency/dependency-manager.js");class ProcessIntegratedHsp extends ohos_module_task_js_1.OhosModuleTask{initTaskDepends(){}constructor(e){super(e,task_names_js_1.TaskNames.CommonTask.PROCESS_INTEGRATED_HSP),this._log=ohos_logger_js_1.OhosLogger.getLogger(ProcessIntegratedHsp.name),this.allRemoteHspPathMap=new Map,this.integratedInputList=[],this.integratedOutputList=[],this.inputFile=path_1.default.resolve(this.pathInfo.getModuleBuildOutputPath(),this.targetData.getModuleTargetOutputFileName("",!1,build_directory_const_js_1.BuildArtifactExtension.DOT_HSP)),this.integratedRemoteHspDir=this.projectModel.getCacheIntegratedHspPath(this.targetData.getProduct().name);const t=this.moduleModel.getRemoteHspPath(),s=this.service.getProjectModel().getRemoteHspPath(),r=new dependency_manager_js_1.DependencyManager(this.projectModel.isFaMode(),this.moduleModel,this.projectModel),{npmDependencies:a}=r.collectAllDependencies();(0,remote_hsp_utils_js_1.initSignRemoteHspMap)(t,this.allRemoteHspPathMap,a),(0,remote_hsp_utils_js_1.initSignRemoteHspMap)(s,this.allRemoteHspPathMap,a);const i=global_project_data_service_js_1.GlobalProjectDataService.getInstance().getIntegratedHspUtils();if(i)for(const e of this.allRemoteHspPathMap.values())e.isIntegratedHsp&&i.isNeedIntegrated(e.hspDirName)&&(this.integratedInputList.push(e.hspPath),this.integratedOutputList.push(path_1.default.resolve(this.integratedRemoteHspDir,e.hspDirName)),i&&(i.setIntegratedRemoteHsps((0,wdk_1.cloneDeep)({...e,isIntegratedHsp:!1})),global_project_data_service_js_1.GlobalProjectDataService.getInstance().setNeedSignedRemoteHspMap(e.hspDirName,{hspFileName:"",hspDirName:"",version:"",hspPath:"",signedHspPath:"",moduleName:this.moduleModel.getName(),isSigned:!1})))}declareInputs(){const e=super.declareInputs(),{bundleName:t,versionCode:s}=(0,integrated_hsp_utils_js_1.getAppInfoByProject)(this.projectModel);return e.set("bundleName",t),e.set("versionCode",s),e}declareInputFiles(){return super.declareInputFiles().addEntries([...this.integratedInputList],{isDirectory:!1})}declareOutputFiles(){const e=super.declareOutputFiles();e.addEntries([...this.integratedOutputList],{isDirectory:!1});const t=this.targetData.getProduct().name,s=path_1.default.resolve(this.projectModel.getCacheIntegratedHspPath(t),build_directory_const_js_1.BuildArtifactConst.INTEGRATED_HSP_CACHE);return e.addEntry(s,{isDirectory:!1}),e}async doTaskAction(){const e=global_project_data_service_js_1.GlobalProjectDataService.getInstance().getIntegratedHspUtils();if(e&&0!==this.integratedInputList.length){(0,task_util_js_1.limitMinApiVersion)(this.targetData,sdk_const_js_1.ApiVersion.API_VERSION_11)||this._log.printErrorExit("INTEGRATED_HSP_UNSUPPORTED_API",[this.moduleModel.getParentProject().getProfilePath()]);for(let t=0;t<this.integratedInputList.length;t++)await this.generateIntegratedHsp(this.integratedInputList[t],this.integratedOutputList[t]),e.changeIntegratedHspStatus(path_1.default.basename(this.integratedOutputList[t]));e.writeIntegratedHspCache()}}async generateIntegratedHsp(e,t){const s=this.durationEvent.createSubEvent("process remote integrated HSPcommand","");s.start(),fs_extra_1.default.existsSync(t)||await fs_extra_1.default.mkdir(t,{recursive:!0});const r=(0,integrated_hsp_utils_js_1.generateIntegratedHspCommand)(this.projectModel,this.sdkInfo.getPackageTool(),e,t),a={moduleName:this.moduleName,taskName:this.name,commandLine:r};this._log._printDebugCommand(this.sdkInfo.getPackageTool(),r),s.stop(),s.setLog(s.getName(),hvigor_1.MetricLogType.INFO);const i="submit generate integrated hsp task to work pool",o=this.durationEvent.createSubEvent(i,"");o.start(),await new process_utils_js_1.ProcessUtils(a.moduleName,a.taskName).submitExecutionWithoutReturn(this,this.getWorkerPool(),a,wdk_1.noop,[],o),o.stop(),o.setLog(i,hvigor_1.MetricLogType.INFO)}}exports.ProcessIntegratedHsp=ProcessIntegratedHsp;