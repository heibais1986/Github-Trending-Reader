"use strict";var __decorate=this&&this.__decorate||function(e,t,n,o){var s,r=arguments.length,i=r<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,n):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,n,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(r<3?s(i):r>3?s(t,n,i):s(t,n))||i);return r>3&&i&&Object.defineProperty(t,n,i),i},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.getSoDefaultContextInfo=exports.GeneratePkgContextInfo=exports.soLibsPattern=void 0;const path_1=__importDefault(require("path")),wdk_1=require("@baize/wdk"),hvigor_1=require("@ohos/hvigor"),fs_extra_1=__importDefault(require("fs-extra")),project_ohos_config_manager_js_1=require("../common/global/project-ohos-config-manager.js"),build_directory_const_js_1=require("../const/build-directory-const.js"),common_const_js_1=require("../const/common-const.js"),dependency_interface_js_1=require("../project/dependency/core/dependency-interface.js"),dependency_manager_js_1=require("../project/dependency/dependency-manager.js"),cmake_util_js_1=require("../utils/cmake-util.js"),copy_resources_util_js_1=require("../utils/copy-resources-util.js"),file_util_js_1=require("../utils/file-util.js"),har_target_util_js_1=require("../utils/har-target-util.js"),inject_util_js_1=require("../utils/inject-util.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),ohos_test_util_js_1=require("../utils/ohos-test-util.js"),process_libs_common_properties_js_1=require("./common-properties/process-libs-common-properties.js"),task_names_js_1=require("./common/task-names.js");exports.soLibsPattern=/^.*\.so(\.[0-9])*$/;class GeneratePkgContextInfo extends process_libs_common_properties_js_1.ProcessLibsCommonProperties{get useNormalizedOHMUrl(){var e,t;return!!(null===(t=null===(e=this.targetService.getBuildOption())||void 0===e?void 0:e.strictMode)||void 0===t?void 0:t.useNormalizedOHMUrl)}declareOutputFiles(){return(new hvigor_1.FileSet).addEntry(this.pkgInfoPath,{isDirectory:!1})}declareInputs(){const e=super.declareInputs();return e.set("pkgContextInfoMap",JSON.stringify(Object.fromEntries(this.pkgContextInfoMap))),e}constructor(e){var t,n,o,s,r,i;super(e,task_names_js_1.TaskNames.Task.GENERATE_PKG_CONTEXT_INFO),this.pkgContextInfoMap=new Map,this._log=ohos_logger_js_1.OhosLogger.getLogger(GeneratePkgContextInfo.name);const a=this.projectModel.getAppRes().getAppResOpt(),l=(0,wdk_1.cloneDeep)(null===(t=project_ohos_config_manager_js_1.projectOhosConfigManager.getOverrides())||void 0===t?void 0:t.appOpt),d=this.targetData.getProduct();this.currentBundleName=null!==(o=null!==(n=null==l?void 0:l.bundleName)&&void 0!==n?n:this.targetData.getProduct().bundleName)&&void 0!==o?o:this.projectModel.getDefaultBundleName(),this.currentBundleType=null!==(i=null!==(r=null!==(s=null==l?void 0:l.bundleType)&&void 0!==s?s:d.bundleType)&&void 0!==r?r:a.app.bundleType)&&void 0!==i?i:common_const_js_1.BundleType.APP,this.pkgInfoPath=this.pathInfo.getIntermediatesPkgContextInfoPath(),fs_extra_1.default.existsSync(path_1.default.dirname(this.pkgInfoPath))||fs_extra_1.default.mkdirSync(path_1.default.dirname(this.pkgInfoPath),{recursive:!0})}async beforeAlwaysAction(){await super.beforeAlwaysAction(),this.initPkgContextInfo()}beforeTask(){fs_extra_1.default.existsSync(this.pkgInfoPath)&&fs_extra_1.default.removeSync(this.pkgInfoPath)}taskShouldDo(){return this.useNormalizedOHMUrl}doTaskAction(){const e=JSON.stringify(Object.fromEntries(this.pkgContextInfoMap));fs_extra_1.default.writeFileSync(this.pkgInfoPath,e)}initPkgContextInfo(){const e=new dependency_manager_js_1.DependencyManager(this.projectModel.isFaMode(),this.moduleModel,this.projectModel);let{npmDependencies:t}=e.collectAllDependenciesForPkgInfo();if(inject_util_js_1.InjectUtil.isLocalTest()||inject_util_js_1.InjectUtil.isPreviewProcess()){const n=e.collectAllDependencies().npmDependencies.filter(e=>e.getDependencyType()===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HSP);t=t.concat(n)}for(const e of t)this.pkgContextInfoMap.set(e.getPackageName(),this.getDependenciesPkgContextInfo(e));this.pkgContextInfoMap.set(this.packageJsonObj.name,this.getCurrentPkgContextInfo()),this.initLibsSoPkgContextInfo()}getCurrentPkgContextInfo(){return{packageName:this.packageJsonObj.name,bundleName:this.getCurrentModuleBundleName(),moduleName:"",version:this.moduleModel.isHarModule()?this.packageJsonObj.version:"",entryPath:this.getCurrentEntryPath(this.moduleModel.getProjectDir(),this.packageJsonObj),isSO:!1,dependencyAlias:""}}getCurrentEntryPath(e,t){if(this.moduleModel.isHapModule()||this.targetName===common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET){const t=this.moduleModel.getSourceRootByTargetName(this.targetName);if(this.targetName===common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET&&(0,ohos_test_util_js_1.isTemplatesAfterSourceCodeMigration)(t)){const e=path_1.default.join((0,ohos_test_util_js_1.getOhosTestIntermediatesRelativePath)(),"src/ohosTest");return`${(0,copy_resources_util_js_1.toUnixPath)(e)}/`}return t?`${(0,copy_resources_util_js_1.toUnixPath)(path_1.default.relative(e,t))}/`:""}if(this.moduleModel.isHarModule()){const n=(0,dependency_manager_js_1.getEntryMainFilePath)(e,t);return n?(0,copy_resources_util_js_1.toUnixPath)(path_1.default.relative(e,path_1.default.resolve(e,n))):""}return""}getDependenciesPkgContextInfo(e){var t,n,o;const s=e.getDependencyType();return{packageName:e.getPackageName(),bundleName:this.getBundleName(e,s),moduleName:s===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HSP&&null!==(n=null===(t=e.getModuleJsonObj())||void 0===t?void 0:t.module.name)&&void 0!==n?n:"",version:this.getVersion(e,s),entryPath:(null!==(o=e.getDependencyMainFileRelativePath())&&void 0!==o?o:"").replace(/\.d\.e?ts$/,""),isSO:s===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_SO,dependencyAlias:this.getDepedencyAlias(e)}}isBundleTypeSharedOrAppPlugin(e){return e===common_const_js_1.BundleType.SHARED||e===common_const_js_1.BundleType.APP_PLUGIN}getBundleName(e,t){var n,o,s,r;const i=e.getModuleJsonObj();return this.isBundleTypeSharedOrAppPlugin(this.currentBundleType)?t!==dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HSP||dependency_manager_js_1.DependencyManager.isLocalDependency(e,this.moduleModelNodePaths)?this.currentBundleName:this.isHspInCommonApp(i,t)&&i?null!==(r=null===(s=i.app)||void 0===s?void 0:s.bundleName)&&void 0!==r?r:"":(this._log.printErrorExit("REMOTE_HSP_NOT_ALLOWED",[e.getPackageName()],[[e.getPackageName()]]),""):i&&this.isHspInCommonApp(i,t)&&(null===(n=i.app)||void 0===n?void 0:n.bundleName)!==this.currentBundleName?null===(o=i.app)||void 0===o?void 0:o.bundleName:""}getVersion(e,t){if(t===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HAR||t===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_OTHER){const t={parameterFilePath:this.service.getProjectModel().getParameterFileAbsolutePath(),ohPackageFilePath:this.isOhpmProject?this.moduleModel.getOhPackageJson5Path():this.moduleModel.getPackageJsonPath()};return file_util_js_1.FileUtil.extracted(e.getDependencyVersion(),this.moduleModel.getParentProject().getParameterFileObj(),t)}return""}getDepedencyAlias(e){return e.getDependencyName()===e.getPackageName()?"":e.getDependencyName()}isHspInCommonApp(e,t){var n;return t===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HSP&&this.isBundleTypeSharedOrAppPlugin(null===(n=e.app)||void 0===n?void 0:n.bundleType)}initLibsSoPkgContextInfo(){this.getNativeLibrary(this.targetService);const e=har_target_util_js_1.HarTargetUtil.calDepHarTargets(this.targetService);for(const[t,n]of e){const e=this.projectModel.getTarget(t,n);e&&(this.getNativeLibrary(e),this.getNativeLibraryByLibs(path_1.default.resolve(e.getModuleService().getModuleModel().getProjectDir(),build_directory_const_js_1.BuildDirConst.LIBS)))}this.getNativeLibraryByLibs(path_1.default.resolve(this.moduleModel.getProjectDir(),build_directory_const_js_1.BuildDirConst.LIBS)),this.service.getHarDependencies().filter(e=>!e.isLocal()).forEach(e=>{this.getNativeLibraryByLibs(e.getDefaultLibsDir())})}getNativeLibraryByLibs(e){this.getLibsInfo(e).map(t=>({name:path_1.default.basename(t),path:path_1.default.resolve(e,t)})).filter(e=>fs_extra_1.default.lstatSync(e.path).isFile()).forEach(e=>{this.setPkgContextInfoMapWithSo(e.name)})}getNativeLibrary(e){const t=e.getTargetData().getPathInfo().getNinjaWorkDir(),n=e.getBuildOption().externalNativeOptions;if(!e.getShouldBuildCmake()||!this.useNormalizedOHMUrl)return;const o=cmake_util_js_1.CmakeUtil.checkAbiFilters(null==n?void 0:n.abiFilters,e.getTargetData().isHarmonyOS(),e.getModuleService().getModuleModel(),e.getTargetData().getTargetName());for(const e of o){const n=path_1.default.resolve(t,e);cmake_util_js_1.CmakeUtil.parseLibraries(n,this.targetName,e).forEach(e=>{const t=e.getNameOnDisk();t&&this.setPkgContextInfoMapWithSo(t)})}}setPkgContextInfoMapWithSo(e){const t=this.getCurrentModuleBundleName();this.pkgContextInfoMap.has(e)||this.pkgContextInfoMap.set(e,getSoDefaultContextInfo(e,t))}getCurrentModuleBundleName(){return this.moduleModel.isHspModule()&&this.isBundleTypeSharedOrAppPlugin(this.currentBundleType)?this.currentBundleName:""}initTaskDepends(){}}function getSoDefaultContextInfo(e,t){return{packageName:e,bundleName:null!=t?t:"",moduleName:"",version:"",entryPath:"",isSO:!0,dependencyAlias:""}}__decorate([(0,hvigor_1.Input)()],GeneratePkgContextInfo.prototype,"useNormalizedOHMUrl",null),exports.GeneratePkgContextInfo=GeneratePkgContextInfo,exports.getSoDefaultContextInfo=getSoDefaultContextInfo;