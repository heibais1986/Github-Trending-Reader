"use strict";var __decorate=this&&this.__decorate||function(t,e,i,s){var r,a=arguments.length,o=a<3?e:null===s?s=Object.getOwnPropertyDescriptor(e,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,i,s);else for(var l=t.length-1;l>=0;l--)(r=t[l])&&(o=(a<3?r(o):a>3?r(e,i,o):r(e,i))||o);return a>3&&o&&Object.defineProperty(e,i,o),o},__importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.DoNativeStrip=void 0;const path_1=__importDefault(require("path")),hvigor_1=require("@ohos/hvigor"),fs_extra_1=__importDefault(require("fs-extra")),file_util_js_1=require("../utils/file-util.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),abstract_native_strip_js_1=require("./abstract/abstract-native-strip.js"),task_names_js_1=require("./common/task-names.js"),process_libs_js_1=require("./process-libs.js"),native_strip_js_1=require("./worker/native-strip.js");class DoNativeStrip extends abstract_native_strip_js_1.AbstractNativeStrip{get doStrippedNativeLibs(){return this.strippedNativeLibs}constructor(t){super(t,task_names_js_1.TaskNames.Task.DO_NATIVE_STRIP),this._log=ohos_logger_js_1.OhosLogger.getLogger(DoNativeStrip.name)}async doTaskAction(){var t,e,i,s;if(await fs_extra_1.default.ensureDir(this.doStrippedNativeLibs),(0,native_strip_js_1.clearExpiredSoInStrippedDir)(this.doStrippedNativeLibs,this.intermediatesProcessLibs),await file_util_js_1.FileUtil.isEmptyDir(this.intermediatesProcessLibs))return;const r={debugSymbol:this.debugSymbol,strip:null===(e=null===(t=this.debugSymbol)||void 0===t?void 0:t.strip)||void 0===e||e,exclude:null!==(i=this.exclude)&&void 0!==i?i:[],intermediatesProcessLibs:this.intermediatesProcessLibs,sdkLlvmStripPath:this.sdkInfo.getSdkLlvmStrip(),strippedNativeLibs:this.doStrippedNativeLibs,moduleName:this.moduleName,taskName:this.name,cacheFilePath:this.cacheFilePath,lastCache:path_1.default.resolve(this.pathInfo.getIntermediatesPatch(),"libs.json"),collectAllLibs:null===(s=this.targetService.getBuildOption().nativeLib)||void 0===s?void 0:s.collectAllLibs},a=path_1.default.resolve(__dirname,"./worker/native-strip.js/strip"),o={workInput:r};if(this.getWorkerPool().submit(this,a,o).getState()===hvigor_1.TaskState.REJECT){const t="strip native libs",e=this.durationEvent.createSubEvent(t,"");e.start(),this._log.debug("Worker dispatch failed, running native strip on main thread."),await(0,native_strip_js_1.strip)(r),e.stop(),e.setLog(t,hvigor_1.MetricLogType.INFO)}}initTaskDepends(){this.declareDepends(process_libs_js_1.ProcessLibs.name)}}__decorate([(0,hvigor_1.OutputFile)({isDirectory:!0})],DoNativeStrip.prototype,"doStrippedNativeLibs",null),exports.DoNativeStrip=DoNativeStrip;