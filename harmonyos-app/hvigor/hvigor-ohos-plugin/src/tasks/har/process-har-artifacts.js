"use strict";var __decorate=this&&this.__decorate||function(e,t,s,i){var r,a=arguments.length,o=a<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,s):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,s,i);else for(var n=e.length-1;n>=0;n--)(r=e[n])&&(o=(a<3?r(o):a>3?r(t,s,o):r(t,s))||o);return a>3&&o&&Object.defineProperty(t,s,o),o},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ProcessHarArtifacts=void 0;const path_1=__importDefault(require("path")),wdk_1=require("@baize/wdk"),hvigor_1=require("@ohos/hvigor"),hvigor_arkts_compose_1=require("@ohos/hvigor-arkts-compose"),fs_extra_1=__importDefault(require("fs-extra")),common_util_js_1=require("../../common/common-util.js"),find_target_product_js_1=require("../../common/find-target-product.js"),project_ohos_config_manager_js_1=require("../../common/global/project-ohos-config-manager.js"),build_directory_const_js_1=require("../../const/build-directory-const.js"),common_const_js_1=require("../../const/common-const.js"),code_type_enum_js_1=require("../../enum/code-type-enum.js"),dependency_interface_js_1=require("../../project/dependency/core/dependency-interface.js"),dependency_manager_js_1=require("../../project/dependency/dependency-manager.js"),copy_resources_util_js_1=require("../../utils/copy-resources-util.js"),file_util_js_1=require("../../utils/file-util.js"),har_target_util_js_1=require("../../utils/har-target-util.js"),json_util_js_1=require("../../utils/json-util.js"),oh_package_loader_js_1=require("../../utils/loader/file/oh-package-loader.js"),res_model_loader_js_1=require("../../utils/loader/file/res-model-loader.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),ohmurl_utils_js_1=require("../../utils/ohmurl-utils.js"),parameter_utils_js_1=require("../../utils/parameter-utils.js"),validate_systemHsp_js_1=require("../../utils/validate/validate-systemHsp.js"),validate_util_js_1=require("../../utils/validate/validate-util.js"),abstract_process_har_artifacts_js_1=require("../abstract/abstract-process-har-artifacts.js"),cache_native_libs_js_1=require("../cache-native-libs.js"),task_names_js_1=require("../common/task-names.js"),compile_resource_js_1=require("../compile-resource.js"),process_obfuscation_files_js_1=require("./process-obfuscation-files.js"),inject_util_js_1=require("../../utils/inject-util.js"),build_mode_manager_js_1=require("../../project/build-option/build-mode-manager.js");var Task=task_names_js_1.TaskNames.Task;class ProcessHarArtifacts extends abstract_process_har_artifacts_js_1.AbstractProcessHarArtifacts{constructor(e){super(e,Task.PROCESS_HAR_ARTIFACTS),this.logger=ohos_logger_js_1.OhosLogger.getLogger(ProcessHarArtifacts.name),this.abilities=common_const_js_1.AbilityConst.UI_ABILITY,this.extensionAbilities=common_const_js_1.AbilityConst.EXTENSION_ABILITY,this.compiledPackageNames=[],this.npmImportees=[],this.affectsCompilationDependencyKeys=[],this.globalAffectsCompilationDependencyKeys=[],this.arkTsCompiledOutputDir=path_1.default.resolve(this.pathInfo.getInterMediatesLoaderOutPath()),this.compiledAbcOutputDir=path_1.default.resolve(this.arkTsCompiledOutputDir,code_type_enum_js_1.CodeType.ETS),this.declaredFilesOutputDir=this.pathInfo.getIntermediatesEtsTgzPath(this.moduleName);const t=this.projectModel.getAppRes();this.appOptObj=t.getAppResOpt();const s=e.getTargetData().getModuleSourceSetModel().getModuleTargetRes();this.targetModuleOptObj=s.getModuleJsonOpt(),this.targetJsonPath=s.getJsonPath(),this.ohPkgMetadataResDir=[],this.nonEntryImportees=[]}get isBundledDependencies(){return this.targetService.isBundledDependencies()}get isNativeStripped(){var e,t,s,i;return null===(i=null===(s=null===(t=null===(e=this.targetService.getBuildOption())||void 0===e?void 0:e.nativeLib)||void 0===t?void 0:t.debugSymbol)||void 0===s?void 0:s.strip)||void 0===i||i}get isByteCodeHarOptimize(){return inject_util_js_1.InjectUtil.isByteCodeHarOptimize()}get shouldPackSourceMaps(){var e,t;if(!this.targetService.isByteCodeHar())return!1;const s=null===(t=null===(e=this.targetService.getBuildOption())||void 0===e?void 0:e.arkOptions)||void 0===t?void 0:t.packSourceMap;return void 0!==s?s:this.targetService.isDebug()}declareInputs(){var e,t,s,i,r,a;const o=(0,wdk_1.cloneDeep)(null===(e=project_ohos_config_manager_js_1.projectOhosConfigManager.getOverrides())||void 0===e?void 0:e.appOpt),n=super.declareInputs().set("bundleType",null!==(s=null!==(t=null==o?void 0:o.bundleType)&&void 0!==t?t:(0,find_target_product_js_1.findTargetProduct)(this.service.getProjectModel()).bundleType)&&void 0!==s?s:this.projectModel.getBundleType()).set("isByteCodeHar",this.targetService.isByteCodeHar()).set("harLocalDependencyCheck",!!(null===(i=this.targetService.getBuildOption().strictMode)||void 0===i?void 0:i.harLocalDependencyCheck)).set("isBundledDependencies",this.isBundledDependencies).set("nonEntryImportees",this.nonEntryImportees).set("isDebug",this.targetService.isDebug()).set("isNativeStripped",this.isNativeStripped);n.set("appStartupFileName",null!==(r=this.appStartupFileName)&&void 0!==r?r:""),n.set("isOpenSource",this.targetService.isOpenSource());const c=null===(a=this.targetService.getTargetData().getTargetOpt().resource)||void 0===a?void 0:a.directories;return c&&n.set("targetDirectories",c),n}declareInputFiles(){const e=super.declareInputFiles();return fs_extra_1.default.existsSync(this.pathInfo.getIntermediatesPkgContextInfoPath())&&e.addEntry(this.pathInfo.getIntermediatesPkgContextInfoPath()),this.appStartupPath&&fs_extra_1.default.existsSync(this.appStartupPath)&&e.addEntry(this.appStartupPath),fs_extra_1.default.existsSync(this.intermediateTempStartupFilePath)&&e.addEntry(this.intermediateTempStartupFilePath),e}async beforeAlwaysAction(){await super.beforeAlwaysAction(),this.collectNonEntryImportees(),this.collectCompiledAndNpmImportees(),this.isByteCodeHarOptimize&&(this.processDirectImportees(),this.processAllImportees()),this.warnWhenPackSourceMapsInReleaseMode()}warnWhenPackSourceMapsInReleaseMode(){!this.targetService.isDebug()&&this.shouldPackSourceMaps&&this.logger.warn("The sourceMaps.map file will be packed into the HAR in release mode. This can potentially lead to code asset leakage within the HAR.\n               To prevent this, set packSourceMap to false.")}getImporteesCachePath(e){return super.getImporteesCachePath(e,"HarCompileArkTS")}initTaskDepends(){this.declareDependsList(cache_native_libs_js_1.CacheNativeLibs.name,compile_resource_js_1.CompileResource.name),this.addSpecialDepends()}addSpecialDepends(){if(this._harExtendInfo.isObfuscatedHar()){const e=this.sdkInfo.hasRollUpPluginInEtsLoader;this.declareDepends(e?"HarCompileArkTS":"HarBuildArkTS")}else this.declareDepends(common_const_js_1.ArktSTaskConst.LINT_ARKTS);this.declareDepends(this.moduleModel.isOhpmProject()?Task.PROCESS_OH_PACKAGE_JSON.name:Task.PROCESS_PACKAGE_JSON.name),this.declareDepends(process_obfuscation_files_js_1.ProcessObfuscationFiles.name)}copyCompiledSourceFileToTempDir(){if(this.targetService.isByteCodeHar()){if(fs_extra_1.default.existsSync(this.compiledAbcOutputDir)&&fs_extra_1.default.copySync(this.compiledAbcOutputDir,path_1.default.join(this.taskTmpDir,path_1.default.basename(this.compiledAbcOutputDir))),fs_extra_1.default.existsSync(this.declaredFilesOutputDir)){fs_extra_1.default.copySync(this.declaredFilesOutputDir,this.taskTmpDir);const e=path_1.default.resolve(this.taskTmpDir,this.pathInfo.getBuildRoot());fs_extra_1.default.existsSync(e)&&fs_extra_1.default.removeSync(e)}}else fs_extra_1.default.existsSync(this.arkTsCompiledOutputDir)&&fs_extra_1.default.copySync(this.arkTsCompiledOutputDir,this.taskTmpDir)}processBundleDepRes(){var e;if(!this.targetService.isBundledDependencies())return;const t=`${build_directory_const_js_1.BuildDirConst.SRC}${path_1.default.sep}${build_directory_const_js_1.BuildDirConst.MAIN}${path_1.default.sep}${build_directory_const_js_1.BuildDirConst.RESOURCES}`,s=null===(e=this.targetService.getTargetData().getTargetOpt().resource)||void 0===e?void 0:e.directories;(null==s?void 0:s.length)?this.ohPkgMetadataResDir.push(...s):this.ohPkgMetadataResDir.push(t);const i=har_target_util_js_1.HarTargetUtil.getDep2ConfigMap(this.targetService);i&&i.dep2Resources.forEach((e,t)=>{this.copyBundledDepRes(e,t)})}copyBundledDepRes(e,t){const s=(0,json_util_js_1.getJson5Obj)(path_1.default.resolve(t.getDependencyRootPath(),common_const_js_1.CommonConst.OH_PACKAGE_JSON5));e.forEach(e=>{this.ohPkgMetadataResDir.push(`${e}-${s.name}`);const i=path_1.default.resolve(t.getDependencyRootPath(),e);if(fs_extra_1.default.existsSync(i)){const t=path_1.default.resolve(this.taskTmpDir,build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN,`${path_1.default.basename(e)}-${s.name}`);fs_extra_1.default.mkdirsSync(t),file_util_js_1.FileUtil.copyDir(i,t)}})}copyOtherGenerateFiles(){if(this._harExtendInfo.isObfuscatedHar())fs_extra_1.default.readdirSync(this.generateDir).forEach(e=>{const t=path_1.default.resolve(this.generateDir,e);fs_extra_1.default.copySync(t,path_1.default.resolve(this.taskTmpDir,e))});else try{fs_extra_1.default.copySync(oh_package_loader_js_1.ohPackageLoader.getNodeOhPackagePath(path_1.default.resolve(this.generateDir,this.isOhpmProject?common_const_js_1.CommonConst.OH_PACKAGE_JSON5:common_const_js_1.CommonConst.PACKAGE_JSON)),oh_package_loader_js_1.ohPackageLoader.getNodeOhPackagePath(path_1.default.resolve(this.taskTmpDir,this.isOhpmProject?common_const_js_1.CommonConst.OH_PACKAGE_JSON5:common_const_js_1.CommonConst.PACKAGE_JSON)))}catch(e){this.logger.warn(e.message)}}processHarRouterMap(){const e=this.moduleModel.getJsonPathByTargetName(this.targetName),t=res_model_loader_js_1.resModelLoader.getModuleJson(e).module.routerMap,s=(0,common_util_js_1.parsingProfileName)(t);if(!s)return;const i=path_1.default.resolve(this.targetData.getPathInfo().getIntermediatesResProfilePath(),`${s}.json`),r=path_1.default.resolve(this.taskTmpDir,build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN,build_directory_const_js_1.BuildDirConst.RESOURCES_BASE_PROFILE_DIR,`${s}.json`),a=(0,json_util_js_1.getJson5Obj)(i);this.targetService.isOpenSource()||a.routerMap.forEach(e=>{const t=this.getObfuscatedPageSourceFile(this.moduleModel,e,this.getObfNameCacheObj());t&&Object.assign(e,{pageSourceFile:t})}),a.routerMap.map(e=>delete e.originalSuffix),fs_extra_1.default.writeFileSync(r,JSON.stringify(a))}processHarResStartupConfig(){var e,t,s;const i=null!==(e=this.appStartupFileName)&&void 0!==e?e:"startup_config",r=path_1.default.resolve(this.targetData.getPathInfo().getIntermediatesResProfilePath(),`${i}.json`);if(!fs_extra_1.default.existsSync(r))return;const a=(0,json_util_js_1.getJson5Obj)(r);if(!a)return;const o=this.getTargetResPath(i);if(!o)return;const n=path_1.default.resolve(this.taskTmpDir,o);null===(t=a.startupTasks)||void 0===t||t.forEach(e=>{var t;delete e.moduleName,delete e.srcEntryAbsolutePath,delete e.startupConfigPath,this.targetService.isOpenSource()||(e.srcEntry=null!==(t=this.getObfuscationSrcEntryPath(this.moduleModel,e.srcEntry,this.getObfNameCacheObj()))&&void 0!==t?t:e.srcEntry)}),null===(s=a.appPreloadHintStartupTasks)||void 0===s||s.forEach(e=>{delete e.moduleName,delete e.startupConfigPath,delete e.isRemoteByteCodeHar}),fs_extra_1.default.writeFileSync(n,JSON.stringify(a))}getTargetResPath(e){var t,s;const i=null===(s=null===(t=this.targetService.getTargetData().getTargetOpt())||void 0===t?void 0:t.resource)||void 0===s?void 0:s.directories;if(!(null==i?void 0:i.length)){const t=path_1.default.join(build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN,build_directory_const_js_1.BuildDirConst.RESOURCES_BASE_PROFILE_DIR,`${e}.json`),s=file_util_js_1.FileUtil.convertToAbsolutePath(t,this.targetService.getTargetData().getPathInfo().getModulePath());return fs_extra_1.default.existsSync(s)?t:void 0}for(let t=0;t<i.length;t++){const s=i[t],r=path_1.default.join(s,common_const_js_1.CommonConst.BASE_PROFILE,`${e}.json`),a=file_util_js_1.FileUtil.convertToAbsolutePath(r,this.targetService.getTargetData().getPathInfo().getModulePath());if(fs_extra_1.default.existsSync(a))return r}}getObfuscationSrcEntryPath(e,t,s){let i;const r=this.hasUseTsHarField()?".ts":".js",a=file_util_js_1.FileUtil.getFileSuffix(t);common_const_js_1.ValidateRegExp.DYNAMIC_IMPORT_FILE_SUFFIX_REG_EXP.test(a)&&(i=`${t.substring(0,t.lastIndexOf("."))}${r}`);const o=e.getName(),n=path_1.default.join(o,build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN,t),c=file_util_js_1.FileUtil.normalizePathSeparator(n);Object.prototype.hasOwnProperty.call(s,c)&&(i=s[c].obfName);const l=path_1.default.relative(file_util_js_1.FileUtil.normalizePathSeparator(path_1.default.join(o,build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN)),null!=i?i:c);return l.replace(path_1.default.extname(l),r)}processDeclarationEntry(e){var t,s,i,r,a,o,n,c;if(!this.targetService.isByteCodeHar())return void this.logger.debug("Since current module is not byte code har, just return.");const l=(null===(s=null===(t=e.metadata)||void 0===t?void 0:t.runtimeOnly)||void 0===s?void 0:s.sources)||[],d=(null===(i=e.metadata)||void 0===i?void 0:i.workers)||[];null===(r=e.metadata)||void 0===r||delete r.workers,null===(o=null===(a=e.metadata)||void 0===a?void 0:a.runtimeOnly)||void 0===o||delete o.sources;const u=this.pathInfo.getIntermediatesPkgContextInfoPath(),_=(0,json_util_js_1.getJson5Obj)(u),p=_[this.packageJsonObj.name];if(!p)return void this.logger.debug(`Can not find package context information with package name: ${this.packageJsonObj.name}`);const h=[];this.isBundledDependencies&&(this.collectConfigOhmurl(null===(n=har_target_util_js_1.HarTargetUtil.getDep2ConfigMap(this.targetService))||void 0===n?void 0:n.dep2Workers,_,h),this.collectRuntimeOnlyOhmurl(_,h),this.collectConfigOhmurl(null===(c=har_target_util_js_1.HarTargetUtil.getDep2ConfigMap(this.targetService))||void 0===c?void 0:c.dep2RouterMapObjPageSourceFiles,_,h)),this.collectByteCodeHarAbilityOhmurl(_,h),this.collectByteCodeHarStartupTasks(h);const g=[...d,...l];g.length&&g.forEach(e=>{h.push((0,ohmurl_utils_js_1.generateOhmUrlForSourceFile)(p,e.replace(/^\.\//,"")))}),e.metadata={...e.metadata,declarationEntry:h}}processDirectImportees(){if(!this.targetService.isByteCodeHar())return;const e=this.getImporteesCachePath(hvigor_arkts_compose_1.DIRECT_IMPORTEE_CACHE_FILE_NAME),{compileDependencyKeys:t,globalCompileDependencyKeys:s}=this.collectDirectAffectsCompilationDependencyKeys(e);[t,s].forEach(e=>{e.sort((e,t)=>e>t?1:-1)}),this.affectsCompilationDependencyKeys=t,this.globalAffectsCompilationDependencyKeys=s}getDependencyRuntimePackages(e,t){var s,i,r,a,o,n,c;if(!e.isLocal()){return(null===(i=null===(s=e.getPackageJsonObj().metadata)||void 0===s?void 0:s.runtimeOnly)||void 0===i?void 0:i.packages)||[]}const l=null!==(a=null===(r=e.getModuleJsonObj())||void 0===r?void 0:r.module.name)&&void 0!==a?a:e.getPackageName(),d=null!==(o=t.get(l))&&void 0!==o?o:"default";return(null===(c=null===(n=build_mode_manager_js_1.buildOptionManager.getTargetBuildOption(l,d).arkOptions)||void 0===n?void 0:n.runtimeOnly)||void 0===c?void 0:c.packages)||[]}processAllImportees(){var e,t,s;if(!this.isBundledDependencies)return;const i=this.service.getAffectsCompilationDependencies(),r=new Set(null===(s=null===(t=null===(e=this.targetService.getBuildOption())||void 0===e?void 0:e.arkOptions)||void 0===t?void 0:t.runtimeOnly)||void 0===s?void 0:s.packages),a=har_target_util_js_1.HarTargetUtil.calDepHarTargets(this.targetService),o=this.getImporteesCachePath(hvigor_arkts_compose_1.COMPILED_IMPORTEE_CACHE_FILE_NAME);this.processImportees(o,i,(e,t,s)=>{r.add(s.getDependencyName()),s.isHarDependency()&&!s.isByteCodeHarDependency()&&this.getDependencyRuntimePackages(s,a).forEach(e=>r.add(e))});const n=Array.from(r);n.sort((e,t)=>e>t?1:-1),this.affectsCompilationDependencyKeys=n}collectNonEntryImportees(){if(!this.targetService.isByteCodeHar()||this.isBundledDependencies)return;const e=new Set,t=this.isByteCodeHarOptimize?this.service.getAllDirectDependencies():this.service.getDirectDependencies(),s=this.getImporteesCachePath(hvigor_arkts_compose_1.NON_ENTRY_IMPORTEE_CACHE_FILE_NAME);this.processImportees(s,t,(t,s)=>{s===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_OTHER&&e.add(t)});const i=Array.from(e);i.sort((e,t)=>e>t?1:-1),this.nonEntryImportees=i}collectCompiledAndNpmImportees(){if(!this.isBundledDependencies)return;const e=this.isByteCodeHarOptimize?this.service.getAffectsCompilationDependencies():this.service.getAllDependencies(),t=new Set,s=new Set,i=this.getImporteesCachePath(hvigor_arkts_compose_1.COMPILED_IMPORTEE_CACHE_FILE_NAME);this.processImportees(i,e,(e,i,r)=>{i!==dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_OTHER?i!==dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HAR||r.isByteCodeHarDependency()||t.add(e):e!==r.getDependencyName()&&s.add(e)});const r=Array.from(t),a=Array.from(s);r.sort((e,t)=>e>t?1:-1),a.sort((e,t)=>e>t?1:-1),this.compiledPackageNames=r,this.npmImportees=a}hasSoFile(){const e=[this.processedLibs];for(;e.length;){const t=e.pop();for(const s of fs_extra_1.default.readdirSync(t)){const i=path_1.default.resolve(t,s),r=fs_extra_1.default.lstatSync(i);if(r.isFile()&&!s.endsWith(".a"))return!0;r.isDirectory()&&e.push(i)}}return!1}copyPkgTypesFilePath(e){const t=e.types;if(t){const e=path_1.default.resolve(this.moduleModel.getModule().getNodeDir(),t),s=path_1.default.resolve(this.taskTmpDir,t);fs_extra_1.default.ensureDirSync(path_1.default.dirname(s)),fs_extra_1.default.existsSync(e)&&fs_extra_1.default.copyFileSync(e,s)}}forEachDependencies(e,t){e.forEach(e=>{const s=e.getDependencyType();s!==dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HAR&&s!==dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_OTHER||t(e.getDependencyName(),e.getDependencyVersion())})}setDependencyPkgVersion(e){var t,s;const i={parameterFilePath:this.service.getProjectModel().getParameterFileAbsolutePath(),ohPackageFilePath:this.isOhpmProject?this.moduleModel.getOhPackageJson5Path():this.moduleModel.getPackageJsonPath()};if(this.isBundledDependencies)return(t=e.metadata).dependencyPkgVersion||(t.dependencyPkgVersion={}),void this.forEachDependencies(this.targetService.getModuleService().getAllDependencies(),(t,s)=>{this.compiledPackageNames.includes(t)||(e.metadata.dependencyPkgVersion[t]=file_util_js_1.FileUtil.extracted(s,this.moduleModel.getParentProject().getParameterFileObj(),i))});this.targetService.isByteCodeHar()&&((s=e.metadata).dependencyPkgVersion||(s.dependencyPkgVersion={}),this.forEachDependencies(this.targetService.getModuleService().getDirectDependencies(),(t,s)=>{e.metadata.dependencyPkgVersion[t]=file_util_js_1.FileUtil.extracted(s,this.moduleModel.getParentProject().getParameterFileObj(),i)}))}traverseToSetOptimizePkgVersion(e,t,s,i){e.forEach(e=>{if(!i(e))return;const r=e.getDependencyName();this.affectsCompilationDependencyKeys.includes(r)&&(t.metadata.dependencyPkgVersion[r]=file_util_js_1.FileUtil.extracted(e.getDependencyVersion(),this.moduleModel.getParentProject().getParameterFileObj(),s))})}setOptimizeDependencyPkgVersion(e){var t;if(!this.targetService.isByteCodeHar())return;(t=e.metadata).dependencyPkgVersion||(t.dependencyPkgVersion={});const s={parameterFilePath:this.service.getProjectModel().getParameterFileAbsolutePath(),ohPackageFilePath:this.isOhpmProject?this.moduleModel.getOhPackageJson5Path():this.moduleModel.getPackageJsonPath()};if(this.isBundledDependencies){const t=this.service.getAffectsCompilationDependencies();return void this.traverseToSetOptimizePkgVersion(t,e,s,e=>e.isByteCodeHarDependency()||e.isOtherDependency())}const i=this.service.getAllDirectDependencies();this.traverseToSetOptimizePkgVersion(i,e,s,e=>e.isHarDependency()||e.isOtherDependency())}processMetadata(e){this.globalAffectsCompilationDependencyKeys.length&&(e.metadata.globalDependencies=this.globalAffectsCompilationDependencyKeys),this.nonEntryImportees.length&&(e.metadata.extraImportees=this.nonEntryImportees),this.isBundledDependencies&&(e.metadata.compiledPackageNames=this.compiledPackageNames,e.metadata.extraImportees=this.npmImportees),this.hasSoFile()&&(e.metadata.nativeDebugSymbol=this.isNativeStripped)}processPackageJson(){var e;const t=path_1.default.basename(this.packageManagerPath),s=path_1.default.resolve(this.taskTmpDir,t);if(!fs_extra_1.default.existsSync(s))return;const i=(0,json_util_js_1.getJson5Obj)(s);this.copyPkgTypesFilePath(i),i.metadata||(i.metadata={});const r=[...(null===(e=this.targetData.getTargetOpt().source)||void 0===e?void 0:e.sourceRoots)||[],`./${build_directory_const_js_1.BuildDirConst.SRC}/${build_directory_const_js_1.BuildDirConst.MAIN}`];if(Object.assign(i.metadata,{sourceRoots:r,debug:this.targetService.isDebug()}),this.targetService.getModuleService().getOhpmDependencyInfo(),this.isByteCodeHarOptimize?this.setOptimizeDependencyPkgVersion(i):this.setDependencyPkgVersion(i),this.isBundledDependencies){if(Object.assign(i.metadata,{bundleDependencies:this.isBundledDependencies}),this.ohPkgMetadataResDir&&0!==this.ohPkgMetadataResDir.length){const e=[];this.ohPkgMetadataResDir.forEach(t=>{e.push(path_1.default.normalize(t))});const t={directories:e};Object.assign(i.metadata,{resource:t})}i.dependencies&&this.deleteOhPkgDep(dependency_interface_js_1.DependencyEnum.DEPENDENCIES,i),i.devDependencies&&delete i.devDependencies;i.dynamicDependencies&&this.deleteOhPkgDep(dependency_interface_js_1.DependencyEnum.DYNAMIC_DEPENDENCIES,i)}this.processDeclarationEntry(i),this.processMetadata(i),fs_extra_1.default.writeFileSync(s,JSON.stringify(i))}processSourceMaps(){if(!this.targetService.isByteCodeHar())return;const e=this.shouldPackSourceMaps,t=path_1.default.join(this.taskTmpDir,code_type_enum_js_1.CodeType.ETS,build_directory_const_js_1.BuildArtifactConst.SOURCEMAPS_MAP);if(fs_extra_1.default.existsSync(t))return void(e||(fs_extra_1.default.removeSync(t),this.logger.debug(`Remove '${build_directory_const_js_1.BuildArtifactConst.SOURCEMAPS_MAP}' from package dir.`)));if(!e)return;const s=this.pathInfo.getSourceMapOriginPath(this.targetService);fs_extra_1.default.existsSync(s)?fs_extra_1.default.copyFileSync(s,t):this.logger.debug(`'${build_directory_const_js_1.BuildArtifactConst.SOURCEMAPS_MAP}' does not exist.`)}deleteOhPkgDep(e,t){if(!this.targetService.isByteCodeHar()||!this.isBundledDependencies||(0,parameter_utils_js_1.getPropertyKeepDependency)())return;const s=t[e];this.service.getAllDependencies().forEach(t=>{const i=t.getPackageJsonObj();i&&Object.assign(s,i[e])});const i=this.service.getHspOrByteCodeHarDependencies().map(e=>e.getDependencyName());for(const e in s)i.includes(e)||delete s[e]}collectRuntimeOnlyOhmurl(e,t){var s;const i=null===(s=har_target_util_js_1.HarTargetUtil.getDep2ConfigMap(this.targetService))||void 0===s?void 0:s.dep2RuntimeOnlyObj;if(!i)return;this.collectConfigOhmurl(i.dep2RuntimeOnlySources,e,t);const r=[];i.dep2RuntimeOnlyPackages.forEach(t=>{t.forEach(t=>{const s=this.service.getHarDependencies().find(e=>e.getDependencyName()===t);if(!s)return;const i=dependency_manager_js_1.DependencyManager.getModuleNameFromOhPkgJson(s.getDependencyRootPath()),a=(0,json_util_js_1.getJson5Obj)(s.getPackageFilePath()).main?s.getDependencyMainFilePath():s.getDependencyTypesFilePath(),o=(0,ohmurl_utils_js_1.generateOhmUrlForSourceFile)(e[i],path_1.default.relative(`${i}`,a));r.push(o)})}),t.push(...r)}collectConfigOhmurl(e,t,s){const i=[];(null==e?void 0:e.size)&&(e.forEach((e,s)=>{const r=dependency_manager_js_1.DependencyManager.getModuleNameFromOhPkgJson(s.getDependencyRootPath());e.forEach(e=>{const s=(0,ohmurl_utils_js_1.generateOhmUrlForSourceFile)(t[r],e.replace(/^\.\//,""));i.push(s)})}),s.push(...i))}async doTaskAction(){const e=this.service.getAllDependencies();return validate_util_js_1.ValidateUtil.validateLocalDependency(this.moduleModel,this.targetService.getBuildOption(),e),(0,validate_systemHsp_js_1.validatePackageBySystemHspModel)(this.service,this.appOptObj,this.targetJsonPath,this.targetModuleOptObj),super.doTaskAction()}getObfuscatedPageSourceFile(e,t,s){const i=e.getModule().getNodeDir().substring(this.projectModel.getProjectDir().length+1),r=`${i}${path_1.default.sep}${t.pageSourceFile}`,a=r.replace(path_1.default.extname(r),t.originalSuffix),o=file_util_js_1.FileUtil.normalizePathSeparator(a);if(!Object.prototype.hasOwnProperty.call(s,o))return;const n=s[o].obfName.substring(i.length+1);return n.replace(path_1.default.extname(n),this.hasUseTsHarField()?".ts":".js")}collectByteCodeHarAbilityOhmurl(e,t){const s=res_model_loader_js_1.resModelLoader.getModuleJson(this.targetJsonPath);for(const i of[this.abilities,this.extensionAbilities]){const r=null==s?void 0:s.module[i];(null==r?void 0:r.length)&&r.forEach(s=>{if(!(null==s?void 0:s.srcEntry))return;const i=this.targetService.getAbsoluteSrcEntryPath(s.srcEntry,this.module.getNodeDir());if(!fs_extra_1.default.existsSync(i))return void this.logger.debug("The srcEntry path for obtaining the ability of the module is incorrect or the corresponding file does not exist.");const r=(0,ohmurl_utils_js_1.generateOhmUrlForSourceFile)(e[this.packageJsonObj.name],i.substring(this._moduleDir.length+1));t.push(r)})}}collectByteCodeHarStartupTasks(e){var t;if(!fs_extra_1.default.existsSync(this.intermediateTempStartupFilePath))return;const s=(0,json_util_js_1.getJson5Obj)(this.intermediateTempStartupFilePath);void 0!==s&&(null===(t=s.startupTasks)||void 0===t||t.forEach(t=>{var s;e.push(null!==(s=t.ohmurl)&&void 0!==s?s:t.srcEntry)}))}processObfuscatedHarAbility(){if(!this.moduleModel.isHarModule()||this.targetService.isOpenSource())return;const e=path_1.default.resolve(this.taskTmpDir,build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN,common_const_js_1.CommonConst.MODULE_JSON);if(!fs_extra_1.default.existsSync(e))return void this.logger.debug("Failed to obtain the module.json file from the module intermediate product.");const t=(0,json_util_js_1.getJson5Obj)(e);for(const e of[this.abilities,this.extensionAbilities]){const s=null==t?void 0:t.module[e];(null==s?void 0:s.length)&&s.forEach(e=>{if(!(null==e?void 0:e.srcEntry))return;const t=this.getObfuscatedHarAbilitySrcEntry(e.srcEntry,this.getObfNameCacheObj());Object.assign(e,{srcEntry:t})})}fs_extra_1.default.writeJSONSync(e,t)}getObfuscatedHarAbilitySrcEntry(e,t){const s=this.targetService.getAbsoluteSrcEntryPath(e,this.module.getNodeDir());if(!fs_extra_1.default.existsSync(s))return void this.logger.debug("The srcEntry path for obtaining the ability of the module is incorrect or the corresponding file does not exist.");const i=(0,copy_resources_util_js_1.toUnixPath)(s).substring(this.projectDir.length+1);if(!Object.prototype.hasOwnProperty.call(t,i))return;const r=path_1.default.dirname(this.targetJsonPath),a=t[i].obfName;if(""===r||!r||""===a||!a)return;const o=`./${path_1.default.relative(r,path_1.default.resolve(this.projectDir,a)).replace(/\\/g,"/")}`;return o.replace(path_1.default.extname(o),this.hasUseTsHarField()?".ts":".js")}getObfNameCacheObj(){const e=path_1.default.resolve(this.pathInfo.getModuleBuildCachePath(),`${this.targetName}@HarCompileArkTS`,"esmodule","release","obfuscation","nameCache.json");return(0,json_util_js_1.getJson5Obj)(e)}}__decorate([(0,hvigor_1.Input)()],ProcessHarArtifacts.prototype,"affectsCompilationDependencyKeys",void 0),__decorate([(0,hvigor_1.Input)()],ProcessHarArtifacts.prototype,"globalAffectsCompilationDependencyKeys",void 0),__decorate([(0,hvigor_1.Input)()],ProcessHarArtifacts.prototype,"isByteCodeHarOptimize",null),__decorate([(0,hvigor_1.Input)()],ProcessHarArtifacts.prototype,"shouldPackSourceMaps",null),exports.ProcessHarArtifacts=ProcessHarArtifacts;