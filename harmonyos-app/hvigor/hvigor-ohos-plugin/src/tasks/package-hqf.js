"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PackageHqf=void 0;const path_1=__importDefault(require("path")),fs_extra_1=__importDefault(require("fs-extra")),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),process_utils_js_1=require("../utils/process-utils.js"),task_names_js_1=require("./common/task-names.js"),sign_util_js_1=require("./sign/sign-util.js"),ohos_hap_task_js_1=require("./task/ohos-hap-task.js");class PackageHqf extends ohos_hap_task_js_1.OhosHapTask{constructor(t){super(t,task_names_js_1.TaskNames.Task.PACKAGE_HQF),this._log=ohos_logger_js_1.OhosLogger.getLogger(PackageHqf.name)}async doTaskAction(){const t="hotReload"!==this.getPatchConfigMode()?this.getColdReloadCommand():this.getHotReloadCommand();await(new process_utils_js_1.ProcessUtils).execute(t,{encoding:"utf-8"})}getHotReloadCommand(){const t=path_1.default.resolve(this.pathInfo.getModuleBuildOutputPath(),(0,sign_util_js_1.getHqfName)(this.moduleName,this.targetName,!1)),e=this.sdkInfo.getPackageTool(),s=path_1.default.resolve(this.pathInfo.getModuleBuildIntermediates(),"hotReload","patch.json"),a=fs_extra_1.default.readJsonSync(this.pathInfo.getBuildConfigPath()).patchConfig.patchAbcPath,o=["java","-jar",e,"--mode","hqf"];return o.push("--json-path",s),o.push("--ets-path",a),o.push("--out-path",t),o.push("--force","true"),o}getColdReloadCommand(){const t=path_1.default.resolve(this.pathInfo.getPatchDir(),"resources"),e=path_1.default.resolve(this.pathInfo.getPatchDir(),"libs"),s=path_1.default.resolve(this.pathInfo.getModuleBuildOutputPath(),(0,sign_util_js_1.getHqfName)(this.moduleName,this.targetName,!1)),a=path_1.default.resolve(t),o=this.sdkInfo.getPackageTool(),h=path_1.default.resolve(this.pathInfo.getPatchDir(),"patch.json"),i=["java","-jar",o,"--mode","hqf"];return i.push("--json-path",h),i.push("--lib-path",e),i.push("--ets-path",path_1.default.resolve(this.pathInfo.getPatchDir(),"ets")),i.push("--resources-path",a),i.push("--out-path",s),i.push("--force","true"),i}getPatchConfigMode(){var t;const e=this.pathInfo.getBuildConfigPath();if(fs_extra_1.default.existsSync(e)){const s=fs_extra_1.default.readJsonSync(e);return null===(t=null==s?void 0:s.patchConfig)||void 0===t?void 0:t.mode}this._log.error(`${e} is not exists`)}initTaskDepends(){this.declareDepends(task_names_js_1.TaskNames.Task.PREPARE_QUICKFIX.name)}}exports.PackageHqf=PackageHqf;