"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PrepareQuickfix=void 0;const promises_1=__importDefault(require("fs/promises")),path_1=__importDefault(require("path")),wdk_1=require("@baize/wdk"),hvigor_1=require("@ohos/hvigor"),fs_extra_1=__importDefault(require("fs-extra")),quick_fix_enum_js_1=require("../enum/quick-fix-enum.js"),file_util_js_1=require("../utils/file-util.js"),json_util_js_1=require("../utils/json-util.js"),libs_file_cache_util_js_1=require("../utils/libs-file-cache-util.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),task_names_js_1=require("./common/task-names.js"),assemble_hqf_js_1=require("./hook/assemble/assemble-hqf.js"),sign_util_js_1=require("./sign/sign-util.js"),ohos_hap_task_js_1=require("./task/ohos-hap-task.js"),logger=ohos_logger_js_1.OhosLogger.getLogger("PrepareQuickfix");class PrepareQuickfix extends ohos_hap_task_js_1.OhosHapTask{constructor(e){super(e,task_names_js_1.TaskNames.Task.PREPARE_QUICKFIX),this.debugSymbol=this.targetService.getNativeLibOption().debugSymbol,this.libsDir=this.pathInfo.getIntermediatesStrippedLibsDir(),this.libsCachePath=path_1.default.resolve(this.pathInfo.getPatchDir(),"base_native_libs.json"),this.lastCachePath=path_1.default.resolve(this.pathInfo.getPatchDir(),"libs.json");const t=this.pathInfo.getBuildConfigPath(),s=(0,json_util_js_1.getJson5Obj)(t);s&&(this.patchConfig=s.patchConfig)}async doTaskAction(){const e=await this.collectNativeLibs(),[t,s]=await this.collectEts();await this.collectResources(),await this.logQuickfixChanges(e,t,s),await libs_file_cache_util_js_1.LibsFileCacheUtil.refreshLibsFileCache(this.pathInfo.getIntermediatesProcessLibs(),this.libsDir,this.lastCachePath,this.debugSymbol),await this.generatePatchJson()}async collectNativeLibs(){const e=path_1.default.resolve(this.pathInfo.getPatchDir(),"libs");await fs_extra_1.default.emptydir(e);const t=fs_extra_1.default.existsSync(this.libsCachePath)?hvigor_1.Json5Reader.getJson5Obj(this.libsCachePath):{stripped:{},libs:{}},s=fs_extra_1.default.existsSync(this.lastCachePath)?hvigor_1.Json5Reader.getJson5Obj(this.lastCachePath):{stripped:{},libs:{}},i=fs_extra_1.default.existsSync(this.libsDir)?await libs_file_cache_util_js_1.LibsFileCacheUtil.generateFileHashesForDirectory(this.libsDir):{},a=this.compareLibs(t.stripped,s.stripped,i);await fs_extra_1.default.emptydir(e);return await fs_extra_1.default.copy(this.libsDir,e,{filter:e=>fs_extra_1.default.statSync(e).isDirectory()||Object.entries(a).some(([t,s])=>""===path_1.default.relative(e,t)&&s>quick_fix_enum_js_1.QuickFixEnum.UNCHANGED),recursive:!0,overwrite:!0}),a}async collectResources(){var e,t,s;const i=path_1.default.resolve(this.pathInfo.getPatchDir(),"resources"),a=path_1.default.resolve(i,"resfile"),o=path_1.default.resolve(i,"rawfile");if(await fs_extra_1.default.emptydir(a),await fs_extra_1.default.emptydir(o),(null===(e=this.patchConfig)||void 0===e?void 0:e.changedFileList)&&fs_extra_1.default.existsSync(this.patchConfig.changedFileList)){const e=(0,json_util_js_1.getJson5Obj)(this.patchConfig.changedFileList);await this.copyResources(i,null===(t=e.resources)||void 0===t?void 0:t.resFile),await this.copyResources(i,null===(s=e.resources)||void 0===s?void 0:s.rawFile)}}async copyResources(e,t){if(t&&(null==t?void 0:t.length))for(const{filePath:s,resourcePath:i}of t)if(".DS_Store"!==path_1.default.basename(s)&&fs_extra_1.default.existsSync(s)){const t=path_1.default.join(e,path_1.default.relative(i,s));fs_extra_1.default.copySync(s,t)}}async collectEts(){var e,t;file_util_js_1.FileUtil.checkDirWithoutDelete(path_1.default.resolve(this.pathInfo.getPatchDir(),"ets"));const s="hotReload"===this.getPatchConfigMode()?path_1.default.resolve(this.pathInfo.getInterMediatesLoaderOutPath(),"ets","ets.json"):path_1.default.resolve(this.pathInfo.getPatchDir(),"ets.json");let i=!1,a=!1;if((null===(e=this.patchConfig)||void 0===e?void 0:e.changedFileList)&&fs_extra_1.default.existsSync(this.patchConfig.changedFileList)){const e=fs_extra_1.default.statSync(this.patchConfig.changedFileList);let o={};if(fs_extra_1.default.existsSync(s)&&(o=(0,json_util_js_1.getJson5Obj)(s),a=null!==(t=o.isImportNewFile)&&void 0!==t?t:a),(null==o?void 0:o.changedFileList)!==String(e.mtimeMs))return logger.debug("changedFileList had been changed"),o.changedFileList=String(e.mtimeMs),fs_extra_1.default.writeJSONSync(s,o),i=!0,[i,a]}return[i,a]}async logQuickfixChanges(e,t,s){var i,a;let o=null!==(i=(0,wdk_1.max)(Object.values(e)))&&void 0!==i?i:quick_fix_enum_js_1.QuickFixEnum.UNCHANGED;if(o!==quick_fix_enum_js_1.QuickFixEnum.UNCHANGED&&logger.debug(`native files had been changed, state is ${o}`),t&&(o=quick_fix_enum_js_1.QuickFixEnum.LAST,logger.debug("arkTs files or resfile had been changed")),o===quick_fix_enum_js_1.QuickFixEnum.UNCHANGED&&(null===(a=this.patchConfig)||void 0===a?void 0:a.changedFileList)&&fs_extra_1.default.existsSync(this.patchConfig.changedFileList)){const e=(0,json_util_js_1.getJson5Obj)(this.patchConfig.changedFileList);o=this.isChanged(e)?quick_fix_enum_js_1.QuickFixEnum.BASE:o}await fs_extra_1.default.ensureDir(this.pathInfo.getModuleBuildOutputPath()),await fs_extra_1.default.writeJSON(path_1.default.resolve(this.pathInfo.getModuleBuildOutputPath(),"quickfix.json"),{changes:e,state:o,isImportNewFile:s,file:(0,sign_util_js_1.getHqfName)(this.moduleName,this.targetName,!1)})}compareLibs(e,t,s){const i={};return Object.entries(s).forEach(([s,a])=>i[s]=t[s]&&t[s]!==a?quick_fix_enum_js_1.QuickFixEnum.LAST:e[s]&&e[s]===a?quick_fix_enum_js_1.QuickFixEnum.UNCHANGED:t[s]?quick_fix_enum_js_1.QuickFixEnum.BASE:quick_fix_enum_js_1.QuickFixEnum.LAST),i}async generatePatchJson(){const e=await PrepareQuickfix.getCurrentHqfVersion(),t=this.projectModel.getAppRes().getAppResOpt();let s;s="hotReload"===this.getPatchConfigMode()?{app:{bundleName:t.app.bundleName,patchVersionCode:e,versionCode:t.app.versionCode},module:{name:this.moduleName,type:"hotreload"}}:{app:{bundleName:t.app.bundleName,versionCode:t.app.versionCode,versionName:t.app.versionName,patchVersionCode:e,patchVersionName:String(e)},module:{name:this.moduleName,type:"patch",deviceTypes:this.moduleModel.getDeviceTypes(),originalModuleHash:""}};const i=path_1.default.resolve(this.pathInfo.getModuleBuildIntermediates(),"hotReload"),a="hotReload"!==this.getPatchConfigMode()?this.pathInfo.getPatchDir():i;try{await promises_1.default.access(a)}catch(e){await promises_1.default.mkdir(a)}await promises_1.default.writeFile(path_1.default.resolve(a,"patch.json"),JSON.stringify(s)),logger.debug(`Prepare ${t.app.bundleName} quickfix with patch versionCode ${e}.`)}initTaskDepends(){"hotReload"!==this.getPatchConfigMode()&&(this.declareDepends("ColdReloadArkTS"),this.declareDepends(task_names_js_1.TaskNames.Task.DO_NATIVE_STRIP.name))}getPatchConfigMode(){var e;const t=this.pathInfo.getBuildConfigPath();if(fs_extra_1.default.existsSync(t)){const s=fs_extra_1.default.readJsonSync(t);return null===(e=null==s?void 0:s.patchConfig)||void 0===e?void 0:e.mode}logger.error(`${t} is not exists`)}isChanged(e){if(Array.isArray(e))return e.length>0;if("object"==typeof e)for(const t of Array.from(Object.values(e)))if(this.isChanged(t))return!0;return!1}static async getCurrentHqfVersion(){const e=path_1.default.resolve(hvigor_1.PathUtil.getHvigorCacheDir(logger),"outputs","patch","patch.json");if(!fs_extra_1.default.existsSync(e))return assemble_hqf_js_1.AssembleHqf.versionCode=3e6,assemble_hqf_js_1.AssembleHqf.versionCode;if(assemble_hqf_js_1.AssembleHqf.versionCode)return assemble_hqf_js_1.AssembleHqf.versionCode;const t=await fs_extra_1.default.readJSON(e);return assemble_hqf_js_1.AssembleHqf.versionCode=parseInt((null==t?void 0:t.patchVersionCode)?t.patchVersionCode:3e6),assemble_hqf_js_1.AssembleHqf.versionCode}}exports.PrepareQuickfix=PrepareQuickfix;