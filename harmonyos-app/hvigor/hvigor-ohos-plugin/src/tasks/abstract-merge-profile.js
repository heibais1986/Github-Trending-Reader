"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.AbstractMergeProfile=exports.INPUT_KEY=void 0;const wdk_1=require("@baize/wdk"),hvigor_1=require("@ohos/hvigor"),fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path")),project_ohos_config_manager_js_1=require("../common/global/project-ohos-config-manager.js"),build_directory_const_js_1=require("../const/build-directory-const.js"),common_const_js_1=require("../const/common-const.js"),sdk_const_js_1=require("../const/sdk-const.js"),ohos_hap_task_js_1=require("./task/ohos-hap-task.js"),har_target_util_js_1=require("../utils/har-target-util.js"),inject_util_js_1=require("../utils/inject-util.js"),cmake_util_js_1=require("../utils/cmake-util.js");exports.INPUT_KEY={isHarModule:"isHarModule",bundleName:"bundleName",targetSdkVersion:"targetSdkVersion",compatibleSdkVersion:"compatibleSdkVersion",multiProjects:"multiProjects",releaseType:"releaseType",buildRoot:"buildRoot",isDebug:"isDebug",asanEnable:"asanEnable",tsanEnable:"tsanEnable",hwasanEnable:"hwasanEnable",ubsanEnable:"ubsanEnable",projectConfigAppOpt:"projectConfigAppOpt",vendor:"vendor",buildProfileAbilities:"buildProfileAbilities",appEnvironments:"appEnvironments",toolChainSdkVersion:"toolChainSdkVersion",moduleJsonOpt:"moduleJsonOpt",appJsonOpt:"appJsonOpt"};class AbstractMergeProfile extends ohos_hap_task_js_1.OhosHapTask{constructor(e,t){var s,o,r,i;super(e,t);const a=(0,wdk_1.cloneDeep)(null===(s=project_ohos_config_manager_js_1.projectOhosConfigManager.getOverrides())||void 0===s?void 0:s.appOpt);this._moduleTargetData=this.targetService.getTargetData(),this._projectModel=this.service.getProjectModel(),this._bundleName=null!==(o=null==a?void 0:a.bundleName)&&void 0!==o?o:this._moduleTargetData.getProduct().bundleName,this._vendor=null!==(r=null==a?void 0:a.vendor)&&void 0!==r?r:this._moduleTargetData.getProduct().vendor,this._targetName=this._moduleTargetData.getTargetName(),this._pathInfo=this._moduleTargetData.getPathInfo(),this._buildRoot=this._pathInfo.getBuildRoot();const n=cmake_util_js_1.CmakeUtil.getCMakeArguments(null===(i=e.getBuildOption().externalNativeOptions)||void 0===i?void 0:i.arguments);this.asanEnable="true"===hvigor_1.hvigorCore.getExtraConfig().get("ohos-debug-asan")||n.includes("-DOHOS_ENABLE_ASAN=ON"),this.tsanEnable="true"===hvigor_1.hvigorCore.getExtraConfig().get("ohos-enable-tsan")||n.includes("-DOHOS_ENABLE_TSAN=ON"),this.hwAsanEnable="true"===hvigor_1.hvigorCore.getExtraConfig().get("ohos-enable-hwasan")||n.includes("-DOHOS_ENABLE_HWASAN=ON"),this.ubsanEnable="true"===hvigor_1.hvigorCore.getExtraConfig().get("ohos-enable-ubsan")||n.includes("-DOHOS_ENABLE_UBSAN=ON"),this.appEnvironments=hvigor_1.hvigorCore.getParameter().getExtParam("ohos-app-environment")}mergeDependsLibs(e){const t=this.service.getDependencyRootPaths(),s=this.service.getHarModuleDependenciesWithRootPath(),o=this.service.getHarModuleDependencyPaths(),r=this.service.getHspModuleDependencyPaths();return t.map(t=>{const i=inject_util_js_1.InjectUtil.getBuildCacheParentDir(t,path_1.default.join(hvigor_1.hvigorCore.getProject().getName(),t.substring(hvigor_1.hvigorCore.getProject().getNodeDir().length)));if(r.includes(t)){const t=path_1.default.resolve(i,this._buildRoot,this.targetData.getProduct().name,build_directory_const_js_1.BuildDirConst.INTERMEDIATES,build_directory_const_js_1.BuildDirConst.INTERMEDIATES_MERGE_PROFILE,this._targetName,e);return fs_extra_1.default.pathExistsSync(t)?t:path_1.default.resolve(i,this._buildRoot,this.targetData.getProduct().name,build_directory_const_js_1.BuildDirConst.INTERMEDIATES,build_directory_const_js_1.BuildDirConst.INTERMEDIATES_MERGE_PROFILE,common_const_js_1.DefaultTargetConst.DEFAULT_TARGET,e)}return o.includes(t)?this.getHarDenPath(s,t,i,e):path_1.default.resolve(t,build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN,e)})}getHarDenPath(e,t,s,o){var r;const i=e.get(t),a=path_1.default.resolve(s,this._buildRoot,this.targetData.getProduct().name,build_directory_const_js_1.BuildDirConst.INTERMEDIATES,build_directory_const_js_1.BuildDirConst.INTERMEDIATES_MERGE_PROFILE,common_const_js_1.DefaultTargetConst.DEFAULT_TARGET,o);if(!i)return a;const n=null!==(r=har_target_util_js_1.HarTargetUtil.calDepHarTargets(this.targetService).get(i[0]))&&void 0!==r?r:"default",_=path_1.default.resolve(s,this._buildRoot,this.targetData.getProduct().name,build_directory_const_js_1.BuildDirConst.INTERMEDIATES,build_directory_const_js_1.BuildDirConst.INTERMEDIATES_MERGE_PROFILE,n,o);return fs_extra_1.default.pathExistsSync(_)?_:a}apiTransform(e){if(e.version<=sdk_const_js_1.ApiVersion.API_VERSION_9)return e.version;let t="";const s=e.api.split(".");for(const e of s)t+=e.padStart(2,"0");t+=`${e.version}`.padStart(3,"0");let o=0;for(let e=0;e<t.length;e++)if(0!==(0,wdk_1.parseInt)(t[e])){o=e;break}return t=t.substring(o),(0,wdk_1.parseInt)(t)}declareInputs(){const e=new Map;this._bundleName&&e.set(exports.INPUT_KEY.bundleName,this._bundleName),this._vendor&&e.set(exports.INPUT_KEY.vendor,this._vendor),e.set(exports.INPUT_KEY.targetSdkVersion,this.compileApiVersion),e.set(exports.INPUT_KEY.compatibleSdkVersion,this.compatibleApiVersion),e.set(exports.INPUT_KEY.releaseType,this.sdkInfo.getReleaseType()),e.set(exports.INPUT_KEY.buildRoot,this._buildRoot),e.set(exports.INPUT_KEY.isDebug,this.targetService.isDebug()),e.set(exports.INPUT_KEY.asanEnable,this.asanEnable),e.set(exports.INPUT_KEY.tsanEnable,this.tsanEnable),e.set(exports.INPUT_KEY.hwasanEnable,this.hwAsanEnable),e.set(exports.INPUT_KEY.ubsanEnable,this.ubsanEnable),this.appEnvironments&&e.set(exports.INPUT_KEY.appEnvironments,this.appEnvironments);const t=this.moduleModel.getJsonProfileOptByTargetName(this.targetName,this.isFaMode);return e.set(exports.INPUT_KEY.moduleJsonOpt,JSON.stringify(t)),e}parseToAppEnvironments(e){const t=[];if(void 0===e)return t;const s=e.replace(/^\s*{\s*(.*)\s*}\s*$/,"$1"),o=/(\w+):([^,]+)/g;let r;for(;null!==(r=o.exec(s));){const e={name:r[1],value:r[2].trim()};t.push(e)}return t}}exports.AbstractMergeProfile=AbstractMergeProfile;