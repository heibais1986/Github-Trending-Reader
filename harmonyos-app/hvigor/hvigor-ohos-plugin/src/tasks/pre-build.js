"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,o){void 0===o&&(o=i);var s=Object.getOwnPropertyDescriptor(t,i);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,o,s)}:function(e,t,i,o){void 0===o&&(o=i),e[o]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PreBuild=void 0;const fs_1=__importDefault(require("fs")),os_1=__importDefault(require("os")),path=__importStar(require("path")),hvigor_1=require("@ohos/hvigor"),fse=__importStar(require("fs-extra")),build_option_path_info_js_1=require("../common/build-option-path-info.js"),common_util_js_1=require("../common/common-util.js"),module_ohos_config_manager_js_1=require("../common/global/module-ohos-config-manager.js"),project_ohos_config_manager_js_1=require("../common/global/project-ohos-config-manager.js"),module_dependency_util_js_1=require("../common/module-dependency-util.js"),module_option_path_info_js_1=require("../common/module-option-path-info.js"),ohos_trace_js_1=require("../common/trace/ohos-trace.js"),build_directory_const_js_1=require("../const/build-directory-const.js"),common_const_js_1=require("../const/common-const.js"),inject_const_js_1=require("../const/inject-const.js"),sdk_const_js_1=require("../const/sdk-const.js"),module_type_enum_js_1=require("../enum/module-type-enum.js"),runtime_type_enum_js_1=require("../enum/runtime-type-enum.js"),hap_extra_info_js_1=require("../project/data/hap-extra-info.js"),dependency_interface_js_1=require("../project/dependency/core/dependency-interface.js"),dependency_manager_js_1=require("../project/dependency/dependency-manager.js"),project_extra_info_service_js_1=require("../project/project-extra-info-service.js"),array_util_js_1=require("../utils/array-util.js"),build_profile_utils_js_1=require("../utils/build-profile-utils.js"),byte_code_har_utils_js_1=require("../utils/byte-code-har-utils.js"),file_util_js_1=require("../utils/file-util.js"),inject_util_js_1=require("../utils/inject-util.js"),json_util_js_1=require("../utils/json-util.js"),res_model_loader_js_1=require("../utils/loader/file/res-model-loader.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),mock_config_utils_js_1=require("../utils/mock-config-utils.js"),ohos_test_util_js_1=require("../utils/ohos-test-util.js"),task_util_js_1=require("../utils/task-util.js"),error_handlers_js_1=require("../utils/validate/error-handlers.js"),validate_config_js_1=require("../utils/validate/validate-config.js"),validate_util_js_1=require("../utils/validate/validate-util.js"),abstract_pre_build_js_1=require("./abstract/abstract-pre-build.js"),task_names_js_1=require("./common/task-names.js"),target_task_service_js_1=require("./service/target-task-service.js");var Task=task_names_js_1.TaskNames.Task;const _log=ohos_logger_js_1.OhosLogger.getLogger("hvigor-preBuild");class PreBuild extends abstract_pre_build_js_1.AbstractPreBuild{declareInputs(){var e,t,i,o,s,r,a,n,l,h;let d=super.declareInputs();const _=Object.keys(this.getDependencies(this.moduleModel,!1)),c=Object.keys(this.getDependencies(this.projectModel,!1)),u=(0,build_profile_utils_js_1.getRuntimeOnlyObjMap)(this.module.getNodeDir(),null===(t=null===(e=this.targetService.getBuildOption())||void 0===e?void 0:e.arkOptions)||void 0===t?void 0:t.runtimeOnly,(0,array_util_js_1.getUnionSet)(_,c));for(const[e,t]of u)d.set(e,t);const g=project_ohos_config_manager_js_1.projectOhosConfigManager.getConfig();g&&d.set("appHvigorFileConfig",(0,hvigor_1.hash)(JSON.stringify(g)));const m=module_ohos_config_manager_js_1.moduleOhosConfigManager.getConfig(this.moduleName);return m&&d.set("moduleHvigorFileConfig",(0,hvigor_1.hash)(JSON.stringify(m))),this.formJsonPathArr.forEach(e=>{const t=(0,hvigor_1.parseJsonFile)(e,!1);t.forms&&t.forms.forEach(e=>{if(e.src){const t="arkts"===e.uiSyntax?path.resolve(this.moduleModel.getProjectDir(),"src/main",e.src):path.resolve(this.moduleModel.getProjectDir(),"src/main",`${e.src}.json`);fs_1.default.existsSync(t)&&d.set(e.src,t)}})}),d.set(common_const_js_1.CommonConst.USE_NORMALIZED_OHM_URL,!!(null===(o=null===(i=this.targetService.getBuildOption())||void 0===i?void 0:i.strictMode)||void 0===o?void 0:o.useNormalizedOHMUrl)),d.set(build_directory_const_js_1.BuildDirConst.INTEGRATED_HSP,!!(null===(s=this.targetService.getBuildOption().arkOptions)||void 0===s?void 0:s.integratedHsp)),d.set("sourceRoots",this.extendSourceValidateResult.isValid),d.set(build_directory_const_js_1.BuildDirConst.TRANSFORM_LIB,null!==(n=null===(a=null===(r=this.targetService.getBuildOption())||void 0===r?void 0:r.arkOptions)||void 0===a?void 0:a.transformLib)&&void 0!==n?n:""),d.set("byteCodeHar",!!(null===(h=null===(l=this.targetService.getBuildOption())||void 0===l?void 0:l.arkOptions)||void 0===h?void 0:h.byteCodeHar)),d=this.addConfigurationToInput(d),fse.existsSync(this.moduleModel.getMockConfigPath())&&d.set("mockConfigSources",(0,mock_config_utils_js_1.getMockConfigSources)(this.moduleModel.getMockConfigPath(),this.moduleModel.getProjectDir()).join(",")),d}declareInputFiles(){const e=(new hvigor_1.FileSet).addEntries([this.appJson5Path,this.targetJsonPath,...this.formJsonPathArr,...this.startWindowJsonPathArr],{isDirectory:!1});this.setIncrementalInput(e,this.projectProfilePath),this.setIncrementalInput(e,this.profilePath),this.setIncrementalInput(e,this.appStartupPath),this.setIncrementalInput(e,this.routerMapJsonPath),this.targetService.getWorkerConfig().forEach(t=>{this.setIncrementalInput(e,t)}),this.setIncrementalInput(e,this.syscapJsonPath),this.setIncrementalInput(e,this.pagesJsonPath),this.setIncrementalInput(e,this.systemThemeJsonPath),this.setIncrementalInput(e,this.insightIntentJsonPath),this.setIncrementalInput(e,this.arkDataPath,{isDirectory:!0}),this.setIncrementalInput(e,this.utdPath,{isDirectory:!0}),this.setIncrementalInput(e,this.hvigorConfigPath,{isDirectory:!0}),this.setIncrementalInput(e,this.moduleModel.getMockConfigPath(),{isDirectory:!1});const t=this.isOhpmProject?this.moduleModel.getOhPackageJson5Path():this.moduleModel.getPackageJsonPath();this.setIncrementalInput(e,t);const i=this.isOhpmProject?this.projectModel.getOhPackageJson5Path():this.projectModel.getPackageJsonPath();return this.setIncrementalInput(e,i),e}setShortcutsJsonPathIncrementalInput(e){this.shortcutsJsonPaths&&this.shortcutsJsonPaths.forEach(t=>{fse.existsSync(t)&&e.addEntry(t)})}setIncrementalInput(e,t,i){t&&fs_1.default.existsSync(t)&&e.addEntry(t,i)}constructor(e,t=Task.PRE_BUILD){super(e,t),this.INSIGHT_INTENT_SRC_ENTRY="insightIntent-srcEntry",this.MODULE_SRC_ENTRY="module-srcEntry",this.MODULE_ABILITIES_SRC_ENTRY="module-abilities-srcEntry",this.MODULE_EXTENSION_ABILITIES_SRC_ENTRY="module-extensionAbilities-srcEntry";const i=this.projectModel.getAppRes();this.appJson5Path=i.getJsonPath();const o=e.getTargetData().getModuleSourceSetModel().getModuleTargetRes();this.targetJsonPath=o.getJsonPath(),this.targetModuleOptObj=o.getModuleJsonOpt(),this.formJsonPathArr=target_task_service_js_1.TargetTaskService.getFormJsonArr(o),this.resourcePath=o.getResourcePath(),this.routerMapJsonPath=e.getRouterMapJsonPath(this.moduleModel),this.shortcutsJsonPaths=e.getShortcutsJsonPaths(this.moduleModel),this.insightIntentJsonPath=e.getInsightIntentJsonPath(),this.pagesJsonPath=this.getPagesJsonPath(),this.startWindowJsonPathArr=this.getStartWindowJsonPath(),this.systemThemeJsonPath=this.getSystemThemeJsonPath(),this.arkDataPath=path.resolve(e.getTargetData().getPathInfo().getModuleSrcMainResourceRawfileArkdataPath()),this.utdPath=path.resolve(e.getTargetData().getPathInfo().getModuleSrcMainResourceRawfileUtdPath()),this.hvigorConfigPath=path.resolve(hvigor_1.HVIGOR_PROJECT_WRAPPER_HOME,hvigor_1.DEFAULT_HVIGOR_CONFIG_JSON_FILE_NAME),this.isPreview=hvigor_1.hvigorCore.getExtraConfig().get(inject_const_js_1.InjectConst.BUILD_ROOT)===build_directory_const_js_1.BuildDirConst.PREVIEW_BUILD_PATH,this.extendSourceValidateResult=this.getExtendSourceDirsValidateResult(),this.mockCacheClean()}doValidateForDiffApiType(){var e;if(this.appJson5Validate(),this.moduleJson5Validate(),this.systemThemeJsonValidate(),this.startWindowJsonValidate(),this.formJsonValidate(),this.pagesJsonValidate(),this.routerMapJsonValidate(),this.hvigorFileConfigValidate(),this.sysCapValidate(),this.hvigorConfigValidate(),this.validateMockConfig(),this.checkAppConfiguration(),fs_1.default.existsSync(this.insightIntentJsonPath)&&(this.buildProfileJsonValidate(),this.insightIntentJsonValidate()),this.targetESVerisonValidate(),fs_1.default.existsSync(this.utdPath)){const e=fs_1.default.readdirSync(this.utdPath);if(void 0!==e&&e.length>0)for(const t of e){const e=path.resolve(this.utdPath,t);this.utdJsonValidate(e)}}if(fs_1.default.existsSync(this.arkDataPath)){const e=fs_1.default.readdirSync(this.arkDataPath);if(void 0!==e&&e.length>0)for(const t of e){const e=path.resolve(this.arkDataPath,t);this.arkDataJsonValidate(e)}}(null===(e=this.service.getModuleModel())||void 0===e?void 0:e.isHapModule())&&this.validateMainElement(),this.checkOHMURL(),this.checkDynamicImportFile(),this.checkAllSrcEntry(),this.checkBundledDependencies(),this.checkUIAbility(),this.checkSdkVersionMatchLazyImport(),this.checkDynamicDependencyTypes()}mockCacheClean(){const e=this.moduleModel.getMockConfigPath();if(!fse.existsSync(e)&&this.isPreview){const e=this.targetData.getTargetName(),t=this.targetData.getPathInfo(),i=t.getModulePreviewPath(),o=t.getModulePreviewIntermediatesResPath(),s=path.resolve(i,`cache/.${e}/mock-config.json`);fse.existsSync(s)&&fse.unlinkSync(s);const r=path.resolve(i,`cache/.${e}/mock-config.json5`);fse.existsSync(r)&&fse.unlinkSync(r);const a=path.resolve(o,"mock-config.json");fse.existsSync(a)&&fse.unlinkSync(a)}}targetESVerisonValidate(){var e,t,i;(null===(i=null===(t=null===(e=this.targetService.getBuildOption())||void 0===e?void 0:e.arkOptions)||void 0===t?void 0:t.tscConfig)||void 0===i?void 0:i.targetESVersion)&&(this.compileApiVersion<sdk_const_js_1.ApiVersion.API_VERSION_12||this.compatibleApiVersion<sdk_const_js_1.ApiVersion.API_VERSION_12)&&_log.printErrorExit("UNSUPPORTED_API_VERSION_TARGET_ES_VERSION",[this.projectProfilePath])}checkByteCodeHar(){var e,t,i,o;if(!this.moduleModel.isHarModule())return;const s=null===(t=null===(e=this.targetService.getBuildOption())||void 0===e?void 0:e.strictMode)||void 0===t?void 0:t.useNormalizedOHMUrl;this.targetService.getByteCodeHar(s,null===(o=null===(i=this.targetService.getBuildOption())||void 0===i?void 0:i.arkOptions)||void 0===o?void 0:o.byteCodeHar)&&(0,byte_code_har_utils_js_1.checkByteCodeHar)({logger:_log,useNormalizedOHMUrl:s,compileApiVersion:this.compileApiVersion,compatibleApiVersion:this.compatibleApiVersion})}buildProfileJsonValidate(){project_extra_info_service_js_1.ProjectExtraInfoService.getProjectRuntimeOS(this.projectModel)!==runtime_type_enum_js_1.RuntimeTypeEnum.HARMONY_OS&&_log.printErrorExit("UNSUPPORTED_RUNTIME_OS",[this.projectProfilePath]),(this.compileApiVersion<sdk_const_js_1.ApiVersion.API_VERSION_11||this.compatibleApiVersion<sdk_const_js_1.ApiVersion.API_VERSION_11)&&_log.printErrorExit("UNSUPPORTED_API_VERSION_INSIGHT_INTENT",[this.targetJsonPath])}insightIntentJsonValidate(){const e=this.sdkInfo.getInsightIntentSchema();fs_1.default.existsSync(e)||_log.printErrorExit("UNSUPPORTED_SDK_VERSION_INSIGHT_INTENT",[this.targetJsonPath]),validate_util_js_1.ValidateUtil.submitSchemaCheckWork({moduleName:this.projectModel.getName(),filePath:this.insightIntentJsonPath,schemaPath:e})}utdJsonValidate(e){const t=this.sdkInfo.getUtdSchema();fs_1.default.existsSync(t)||_log.printErrorExit("UNSUPPORTED_SDK_VERSION_ARK_DATA",[this.targetJsonPath]),validate_util_js_1.ValidateUtil.submitSchemaCheckWork({moduleName:this.projectModel.getName(),filePath:e,schemaPath:t})}arkDataJsonValidate(e){const t=this.sdkInfo.getArkDataSchema();fs_1.default.existsSync(t)||_log.printErrorExit("UNSUPPORTED_SDK_VERSION_ARK_DATA",[this.targetJsonPath]),validate_util_js_1.ValidateUtil.submitSchemaCheckWork({moduleName:this.projectModel.getName(),filePath:e,schemaPath:t})}appJson5Validate(){const e=this.targetService.getSdkInfo().getAppSchema(),t=this.moduleModel.getModuleType()===module_type_enum_js_1.ModuleType.Har;validate_util_js_1.ValidateUtil.submitSchemaCheckWork({moduleName:this.projectModel.getName(),filePath:this.appJson5Path,schemaPath:e,changeAppSchema:t})}validateModuleSrcEntry(e,t){const i=t.module.srcEntry||t.module.srcEntrance;if(void 0===i)return;const o=this.moduleModel.getSourceSetByTargetName(this.targetData.getTargetName());void 0===t.module.srcEntry&&_log.warn(`Field "module.srcEntrance" has been deprecated. Use "module.srcEntry" instead.\n      at ${o.getModuleTargetRes().getJsonPath()}`);const s=path.isAbsolute(i)?i:path.resolve(o.getSourceSetRoot(),i);if(!file_util_js_1.FileUtil.fileExists(s)){const e=o;_log.printErrorExit("MODULE_SRC_ENTRY_NOT_FOUND",[s,e.getModuleTargetRes().getJsonPath()])}}moduleJson5Validate(){const e=this.targetName,t=this.targetService.getSdkInfo().getModuleSchema();validate_util_js_1.ValidateUtil.submitSchemaCheckWork({moduleName:this.moduleName,filePath:this.targetJsonPath,schemaPath:t,errorHandlers:[error_handlers_js_1.removeLegacyPhoneSupport,error_handlers_js_1.handleStartWindowErrors]}),e!==common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET&&this.validateModuleName(this.moduleName,this.targetModuleOptObj.module.name,common_const_js_1.CommonConst.MODULE_JSON5);const i=(0,hvigor_1.parseJsonFile)(this.targetJsonPath,!0),o=(0,hvigor_1.parseJsonFile)(this.targetJsonPath,!1);this.validateModuleSrcEntry(_log,(0,json_util_js_1.getJson5Obj)(this.targetJsonPath)),void 0===i.module.uiSyntax&&this.sdkInfo.requireUISyntax()&&_log.printErrorExit("UNSUPPORTED_SDK_VERSION_UI_SYNTAX",[this.targetJsonPath]),validate_util_js_1.ValidateUtil.validateHybridDeviceTypes(i.module.deviceTypes),validate_util_js_1.ValidateUtil.validateDuplicatedName(o.module.abilities,"ability",this.targetJsonPath)}checkDynamicImportFile(){var e,t;const i=null===(t=null===(e=this.targetService.getBuildOption())||void 0===e?void 0:e.arkOptions)||void 0===t?void 0:t.runtimeOnly;if(!i)return;if((this.compileApiVersion<sdk_const_js_1.ApiVersion.API_VERSION_11||this.apiType===hap_extra_info_js_1.ApiType.FA)&&_log.printErrorExit("UNSUPPORTED_API_VERSION_DYNAMIC_IMPORT",[this.moduleModel.getName(),common_const_js_1.CommonConst.PROFILE_JSON5,this.profilePath]),i.sources){const e=this.targetService.isNoExternalImportByPath(),t=this.module.getNodeDir(),o=[],s=[],r=[],a=[],n=[],l=build_option_path_info_js_1.buildOptionPath.getTargetBuildOptPath(this.moduleModel,this.targetName,"sources");this.projectModel.getAllModules().forEach(e=>{n.push(e.getModule().getNodeDir())}),i.sources.forEach(e=>{const i=path.resolve(t,e);n.some(e=>i.startsWith(e))||a.push(e),fse.existsSync(i)?fse.statSync(i).isFile()&&!common_const_js_1.ValidateRegExp.DYNAMIC_IMPORT_FILE_SUFFIX_REG_EXP.test(file_util_js_1.FileUtil.getFileSuffix(e))&&r.push(e):s.push(e),i.startsWith(this.module.getNodeDir())||o.push(e)}),0!==s.length&&_log.printErrorExit("SOURCES_NOT_FOUND",[this.moduleName,s,l]),0!==a.length&&_log.printErrorExit("DYNAMIC_IMPORT_EXTERNAL_MODULE_PROHIBITED",[[...new Set(a)],this.moduleName,l]),0!==r.length&&_log.printErrorExit("SOURCES_SUFFIX_INCORRECT",[r,this.moduleName,l]),0!==o.length&&(e?_log.printErrorExit("DYNAMIC_IMPORT_ACROSS_MODULE_PROHIBITED",[o,this.moduleName,l]):_log.warn(`Invalid dynamic import configuration [${o}] in current module '${this.moduleName}'. \n   Detail: The sources configuration of runtimeOnly in module is not allowed to configure across modules.\n   at :${l}`))}const o=Object.keys({...this.getDependencies(this.moduleModel,!1),...this.getDynamicDependencies(this.moduleModel)}),s=Object.keys({...this.getDependencies(this.projectModel,!1),...this.getDynamicDependencies(this.projectModel)});i.packages&&((0,array_util_js_1.isSubset)((0,array_util_js_1.getUnionSet)(o,s),i.packages)||_log.printErrorExit("DYNAMIC_IMPORT_PATH_INVALID",[this.moduleModel.getName(),this.profilePath],[[this.moduleModel.getName(),common_const_js_1.CommonConst.OH_PACKAGE_JSON5]]))}checkAllSrcEntry(){const e=new Map,t=res_model_loader_js_1.resModelLoader.getModuleJson(this.targetJsonPath);t.module.srcEntry&&e.set(this.MODULE_SRC_ENTRY,[t.module.srcEntry]);const i=t.module.abilities,o=[];if(null==i?void 0:i.length){for(const e of i)e.srcEntry&&o.push(e.srcEntry);e.set(this.MODULE_ABILITIES_SRC_ENTRY,o)}const s=t.module.extensionAbilities,r=[];if(s){for(const e of s)e.srcEntry&&r.push(e.srcEntry);e.set(this.MODULE_EXTENSION_ABILITIES_SRC_ENTRY,r)}const a=[];if(fse.existsSync(this.insightIntentJsonPath)){const t=(0,json_util_js_1.getJson5Obj)(this.insightIntentJsonPath);for(const e of t.insightIntents)e.srcEntry&&a.push(e.srcEntry);e.set(this.INSIGHT_INTENT_SRC_ENTRY,a)}e.forEach((e,t)=>{(null==e?void 0:e.length)&&(null==e||e.forEach(e=>{common_const_js_1.ValidateRegExp.RELATIVE_PATH_REG_EXP.test(e)||_log.printErrorExit("SOURCE_ENTRY_INVALID_SYNTAX",[t,t===this.INSIGHT_INTENT_SRC_ENTRY?this.insightIntentJsonPath:this.targetJsonPath])}))})}formJsonValidate(){this.formJsonPathArr.forEach(e=>{validate_util_js_1.ValidateUtil.submitSchemaCheckWork({moduleName:this.moduleName,filePath:e,schemaPath:this.sdkInfo.getFormSchema()}),this.validateFormSrc(e)})}async beforeAlwaysAction(){await super.beforeAlwaysAction(),this.checkEntryModuleJson(),this.checkIntegratedHspHsp(),this.checkGenerateSharedTgz(),this.checkTransformLib(),module_dependency_util_js_1.moduleDependencyUtil.init(this.service,this.moduleModel,this.projectModel,this.isFaMode)}checkEntryModuleJson(){const e=(0,hvigor_1.parseJsonFile)(this.targetJsonPath,!0);if(e.module.uiSyntax){const t=e.module.uiSyntax._line,i=e.module.uiSyntax._column+1;_log._file(this.targetJsonPath).warn(`uiSyntax has been deprecated.${os_1.default.EOL}         at ${this.targetJsonPath}:${t}:${i}`)}}getProfileJsonPath(e){const t=(0,common_util_js_1.parsingProfileName)(e);if(!t)return;const i=this.targetService.getTargetResourceBaseProfilePath(`${t}.json`);return i&&fse.existsSync(i)||_log.printErrorExit("PROFILE_NOT_FOUND",[`${t}.json`],[[],[this.targetName],[`${t}.json`]]),i}getSystemThemeJsonPath(){var e;const t=null===(e=this.targetModuleOptObj)||void 0===e?void 0:e.module.systemTheme;return this.getProfileJsonPath(null!=t?t:"")}getPagesJsonPath(){const e=(0,hvigor_1.parseJsonFile)(this.targetJsonPath,!1).module.pages;return this.getProfileJsonPath(e)}getStartWindowJsonPath(){var e;const t=null===(e=(0,hvigor_1.parseJsonFile)(this.targetJsonPath,!1).module)||void 0===e?void 0:e.abilities;if(!t)return[];const i=[];for(const e of t)if(e.startWindow){const t=this.getProfileJsonPath(e.startWindow);t&&i.push(t)}return i}pagesJsonValidate(){const e=this.getPagesJsonPath();void 0!==e&&validate_util_js_1.ValidateUtil.submitSchemaCheckWork({moduleName:this.moduleName,filePath:e,schemaPath:this.sdkInfo.getPageSchema()})}startWindowJsonValidate(){this.startWindowJsonPathArr.forEach(e=>{validate_util_js_1.ValidateUtil.submitSchemaCheckWork({moduleName:this.moduleName,filePath:e,schemaPath:this.sdkInfo.getStartWindowSchema()})})}systemThemeJsonValidate(){this.systemThemeJsonPath&&validate_util_js_1.ValidateUtil.submitSchemaCheckWork({moduleName:this.moduleName,filePath:this.systemThemeJsonPath,schemaPath:this.sdkInfo.getSystemThemeSchema()})}routerMapJsonValidate(){this.checkResReferenceConfig(common_const_js_1.CommonConst.ROUTER_MAP),this.routerMapJsonPath&&fse.existsSync(this.routerMapJsonPath)&&validate_util_js_1.ValidateUtil.submitSchemaCheckWork({moduleName:this.moduleName,filePath:this.routerMapJsonPath,schemaPath:this.sdkInfo.getRouterMapSchema()})}sysCapValidate(){!this.targetData.isHarmonyOS()&&fse.existsSync(this.syscapJsonPath)&&validate_util_js_1.ValidateUtil.submitSchemaCheckWork({moduleName:this.moduleName,filePath:this.syscapJsonPath,schemaPath:this.sdkInfo.getSysCapSchema()})}hvigorConfigValidate(){const e=common_const_js_1.BuildProfileSchemaFileConst.HVIGOR_CONFIG_SCHEMA_PATH;fs_1.default.existsSync(this.hvigorConfigPath)&&fs_1.default.existsSync(e)&&validate_util_js_1.ValidateUtil.submitSchemaCheckWork({moduleName:this.projectModel.getName(),filePath:this.hvigorConfigPath,schemaPath:e})}validateFormSrc(e){const t=(0,hvigor_1.parseJsonFile)(e,!1);if(void 0!==t.forms)for(const i of t.forms){i.src||_log.printErrorExit("FORM_SRC_FIELD_MISSING",[e]);const t=this.moduleModel.getProjectDir(),o=path.resolve(t,"src/main"),s=file_util_js_1.FileUtil.convertToAbsolutePath(i.src,o);path.normalize(s).startsWith(path.normalize(t))||_log.printErrorExit("FORM_SRC_INVALID",[i.src,t,e]);const r="arkts"===i.uiSyntax;this.isValidWidget(r,o,s)||_log.printErrorExit("FORM_SRC_NOT_FOUND",[i.src,e])}}validateMainElement(){if(void 0===this.targetModuleOptObj||this.isNewOhosTestTemplate())return;const e=this.targetModuleOptObj.module.mainElement;this.targetModuleOptObj.module.installationFree&&void 0===e&&_log.printErrorExit("EMPTY_MAIN_ELEMENT",[this.targetJsonPath])}isNewOhosTestTemplate(){return this.targetName===common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET&&(0,ohos_test_util_js_1.isTemplatesAfterSourceCodeMigration)(this.moduleModel.getSourceRootByTargetName(common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET))}validateAtomicService(){var e,t,i,o;if(!this.isAtomicServiceProject())return void _log.debug("current product is not Atomic service.");const s=this.getBundleType(),r=null===(t=null===(e=this.targetModuleOptObj)||void 0===e?void 0:e.module)||void 0===t?void 0:t.installationFree,a=this.targetService.getBuildOption().externalNativeOptions;this.getAtomicServiceErrorPath(s,r);this.targetData.isHarmonyOS()||(this.validateSpecificField(s,r),_log.printErrorExit("ATOMIC_SERVICE_INVALID_RUNTIME_OS",[this.projectModel.getProfilePath()])),(0,task_util_js_1.limitMinApiVersion)(this.targetData,sdk_const_js_1.ApiVersion.API_VERSION_10)||_log.printErrorExit("ATOMIC_SERVICE_UNSUPPORTED_API",[this.projectProfilePath]),a&&_log.printErrorExit("ATOMIC_SERVICE_UNSUPPORTED_NATIVE",[this.projectProfilePath]);const n=this.service.getModuleModel().getModuleType();n!==module_type_enum_js_1.ModuleType.Har&&n!==module_type_enum_js_1.ModuleType.Shared&&(this.formJsonPathArr.forEach(e=>{const t=(0,hvigor_1.parseJsonFile)(e,!1);if(t.forms)for(const i of t.forms)i.uiSyntax&&"arkts"===i.uiSyntax||_log.printErrorExit("ATOMIC_SERVICE_JS_WIDGET",[e])}),void 0!==(null===(o=null===(i=this.targetModuleOptObj)||void 0===i?void 0:i.module)||void 0===o?void 0:o.mainElement)||this.targetName===common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET&&(0,ohos_test_util_js_1.isTemplatesAfterSourceCodeMigration)(this.moduleModel.getSourceRootByTargetName(common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET))||_log.printErrorExit("EMPTY_MAIN_ELEMENT",[this.targetJsonPath]))}getAtomicServiceErrorPath(e,t){let i="";return void 0!==e&&"app"!==e||t&&(i=this.targetJsonPath),e!==common_const_js_1.BundleType.ATOMIC_SERVICE&&t||(i=this.appJson5Path),i}validateSpecificField(e,t){e===common_const_js_1.BundleType.ATOMIC_SERVICE&&t&&_log.printErrorExit("ATOMIC_SERVICE_INVALID_RUNTIME_OS",[this.projectModel.getProfilePath()])}validateMockConfig(){const e=(0,json_util_js_1.getJson5Obj)(this.moduleModel.getMockConfigPath());e&&Object.values(e).forEach(e=>{const t=e.source;if(t){const e=path.resolve(this.moduleModel.getProjectDir(),t);fse.existsSync(e)||_log.printErrorExit("SOURCE_NOT_FOUND",[e,this.moduleModel.getMockConfigPath()])}else _log.printErrorExit("SOURCE_FILED_EMPTY",[this.moduleModel.getMockConfigPath()])})}getJsonProfileByModel(){const e=res_model_loader_js_1.resModelLoader.getModuleJson(this.targetJsonPath);return{jsonFilePath:this.targetJsonPath,profile:e,deviceTypes:e.module.deviceTypes,deviceConfig:common_const_js_1.CommonConst.DEVICE_TYPES,configurationProfile:common_const_js_1.CommonConst.MODULE_JSON5}}hvigorFileConfigValidate(){const e=project_ohos_config_manager_js_1.projectOhosConfigManager.getConfig();void 0!==e&&(0,validate_config_js_1.validateOhosProjectConfig)(e,`${this.module.getProject().getBuildFilePath()}.ts`);const t=module_ohos_config_manager_js_1.moduleOhosConfigManager.getConfig(this.moduleName);void 0!==t&&(this.moduleModel.isHarModule()?(0,validate_config_js_1.validateOhosHarModuleConfig)(t,`${this.module.getBuildFilePath()}.ts`):(0,validate_config_js_1.validateOhosModuleConfig)(t,`${this.module.getBuildFilePath()}.ts`))}checkOHMURL(){var e,t;const i=null===(t=null===(e=this.targetService.getBuildOption())||void 0===e?void 0:e.strictMode)||void 0===t?void 0:t.useNormalizedOHMUrl;ohos_trace_js_1.ohosTrace.traceUseNormalizedOHMUrl(i),i&&!(0,task_util_js_1.limitMinApiVersion)(this.targetData,sdk_const_js_1.ApiVersion.API_VERSION_11)&&_log.printErrorExit("USENORMAILZEDOHMURL_CAN_ONLY_BE_USED_IN_API12",[this.projectModel.getProfilePath()]);const o=this.targetService.getModuleService().getAllDependencies(),s=[];for(const e of o)this.isEqualOHMUrl(e,i)||s.push(e.getPackageName());s.length>0&&_log.printErrorExit("USENORMAILZEDOHMURL_DO_NOT_MATCH",[s.join(),String(i)],[[s.join()]])}isEqualOHMUrl(e,t){return e.getDependencyType()!==dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HSP||(dependency_manager_js_1.DependencyManager.isLocalDependency(e,this.moduleModelNodePaths)||!!t==!!e.getUseNormalizedOHMUrl())}getExtendSourceDirsValidateResult(){var e;let t="",i="";const o=this.targetService.getTargetData(),s=null===(e=o.getTargetOpt().source)||void 0===e?void 0:e.sourceRoots;if(!(null==s?void 0:s.length))return{isValid:!0,cause:t,detail:i};const r=this.pathInfo.getModulePath(),a=this.pathInfo.getModuleSrcPath(),n=this.pathInfo.getModuleSrcMainPath().split(path.sep).length,l=`targets[${this.moduleModel.getTargetOptions().findIndex(e=>e.name===o.getTargetName())}].source.sourceRoots`,h=new Set;for(const e of s){if(path.isAbsolute(e)){t=`Invalid value '${e}' in module '${this.moduleModel.getName()}'.`,i=`Make sure the values of '${l}' are relative paths.`;break}let o=path.resolve(r,e);if(!fse.existsSync(o)){t=`Path '${e}' not found in module '${this.moduleModel.getName()}'.`,i=`Make sure the values of '${l}' are valid paths.`;break}let s=fse.lstatSync(o);if(s.isSymbolicLink())try{o=fse.realpathSync(o),s=fse.lstatSync(o)}catch{t=`Path '${e}' not found in module '${this.moduleModel.getName()}'.`,i=`Make sure the values of '${l}' are valid paths.`;break}if(!s.isDirectory()){t=`Invalid value '${e}' in module '${this.moduleModel.getName()}'.`,i=`Make sure the values of '${l}' are valid directory paths.`;break}if(!file_util_js_1.FileUtil.isSubDir(a,o)||o.split(path.sep).length!==n){t=`Invalid value '${e}' in module '${this.moduleModel.getName()}'.`,i=`Make sure the values of '${l}' are subdirectories of '${a}'.`;break}if(h.has(o)){t=`Invalid value '${e}' in module '${this.moduleModel.getName()}'.`,i=`Make sure the values of '${l}' are unique.`;break}h.add(o)}return{isValid:!(t&&i),cause:t,detail:i}}checkExtendSourceDirs(){const{isValid:e,cause:t,detail:i}=this.extendSourceValidateResult;e||_log._buildError(t)._detail(i)._file(this.profilePath)._printErrorAndExit()}checkIntegratedHspHsp(){var e,t;const i=null===(e=this.targetService.getBuildOption().arkOptions)||void 0===e?void 0:e.integratedHsp,o=null===(t=this.targetService.getBuildOption().strictMode)||void 0===t?void 0:t.useNormalizedOHMUrl;i&&!(0,task_util_js_1.limitMinApiVersion)(this.targetData,sdk_const_js_1.ApiVersion.API_VERSION_11)&&_log.printErrorExit("INTEGRATED_HSP_UNSUPPORTED_API",[this.moduleModel.getParentProject().getProfilePath()]),i&&!o&&_log.printErrorExit("INTEGRATED_HSP_REQUIRED_NORMALIZED_OHMURL",[this.projectModel.getProfilePath()]),i&&this.service.getModuleModel().isHapModule()&&_log.warn(`The integratedHsp does not take effect in the HAP ${this.moduleModel.getName()}.`)}checkGenerateSharedTgz(){void 0!==this.targetService.getBuildOption().generateSharedTgz&&this.service.getModuleModel().isHapModule()&&_log.warn(`The generateSharedTgz does not take effect in the HAP ${this.moduleModel.getName()}.`)}checkTransformLib(){var e,t;const i=null===(t=null===(e=this.targetService.getBuildOption())||void 0===e?void 0:e.arkOptions)||void 0===t?void 0:t.transformLib;if(i){ohos_trace_js_1.ohosTrace.traceIsUseTransformLib(this.moduleName),!inject_util_js_1.InjectUtil.isInTest()&&this.targetService.isSourceCodeHar()&&_log.warn("Only the byte code har supports to configure the 'transformLib' field."),path.isAbsolute(i)&&_log.printErrorExit("TRANSFORM_LIB_SHOULD_BE_RELATIVE_PATH",[path.resolve(this.pathInfo.getModulePath(),"build-profile.json5")]);const e=path.resolve(this.pathInfo.getModulePath(),i);fse.existsSync(e)?(fse.statSync(e).isFile()||_log.printErrorExit("TRANSFORM_LIB_IS_NOT_FILE",[i,path.resolve(this.pathInfo.getModulePath(),"build-profile.json5")]),this.checkTransformLibFileType(e.substring(e.lastIndexOf(".")+1))):_log.printErrorExit("TRANSFORM_LIB_FILE_NOT_EXIST",[i,path.resolve(this.pathInfo.getModulePath(),"build-profile.json5")])}}checkTransformLibFileType(e){(0,hvigor_1.isWindows)()&&"dll"!==e&&_log.printErrorExit("TRANSFORM_LIB_REQUIRES_A_X_FILE",[".dll","Windows",path.resolve(this.pathInfo.getModulePath(),"build-profile.json5")]),((0,hvigor_1.isMac)()||(0,hvigor_1.isLinux)())&&"so"!==e&&_log.printErrorExit("TRANSFORM_LIB_REQUIRES_A_X_FILE",[".so","Mac or Linux",path.resolve(this.pathInfo.getModulePath(),"build-profile.json5")])}checkAppConfiguration(){const e=res_model_loader_js_1.resModelLoader.getAppJson(this.appJson5Path).app.configuration;if(!e)return;const t=this.getConfigurationFilePath(e);if(!t)return;const i=build_option_path_info_js_1.buildOptionPath.getAppConfigPath(this.appJson5Path,"configuration");fse.existsSync(t)||_log.printErrorExit("CONFIG_FILE_NOT_FOUND",[i]);const o=this.sdkInfo.getAppConfigurationSchema();fse.existsSync(o)||_log.printErrorExit("SCHEMA_FILE_CANNOT_BE_FOUND",[o]),validate_util_js_1.ValidateUtil.submitSchemaCheckWork({moduleName:this.projectModel.getName(),filePath:t,schemaPath:o})}getConfigurationFilePath(e){const t=(0,common_util_js_1.parsingProfileName)(e);if(!t)return"";const i=this.projectModel.getAppRes().getResourcePath();return path.resolve(i,"base","profile",`${t}.json`)}addConfigurationToInput(e){var t,i;const o=null===(t=res_model_loader_js_1.resModelLoader.getAppJson(this.appJson5Path).app)||void 0===t?void 0:t.configuration;if(e.set("configuration",null!=o?o:""),o&&fse.existsSync(this.getConfigurationFilePath(o))){const t=hvigor_1.Json5Reader.getJson5Obj(this.getConfigurationFilePath(o));e.set("configurationFileJson",null!==(i=JSON.stringify(t))&&void 0!==i?i:"")}else e.set("configurationFileJson","");return e}checkResReferenceConfig(e){const t=res_model_loader_js_1.resModelLoader.getModuleJson(this.targetJsonPath).module[e];if(!t)return;const i=(0,common_util_js_1.parsingProfileName)(t);if(!i)return;const o=this.targetService.getTargetResourceBaseProfilePath(`${i}.json`);o&&fse.existsSync(o)||_log.printErrorExit("FIELD_FILE_NOT_FOUND",[e,module_option_path_info_js_1.moduleOptionPathInfo.getModuleOptPath(this.targetJsonPath,e)])}checkBundledDependencies(){var e,t,i,o;if(!this.targetService.isBundledDependencies())return;const s=null===(t=null===(e=this.targetService.getBuildOption())||void 0===e?void 0:e.strictMode)||void 0===t?void 0:t.useNormalizedOHMUrl;this.targetService.getByteCodeHar(s,null===(o=null===(i=this.targetService.getBuildOption())||void 0===i?void 0:i.arkOptions)||void 0===o?void 0:o.byteCodeHar)||_log.printErrorExit("BYTE_CODE_HAR_UNSUPPORTED",[this.projectModel.getProfilePath()])}checkUIAbility(){var e,t;const i=this.targetJsonPath;if(!(null===(t=null===(e=res_model_loader_js_1.resModelLoader.getModuleJson(i).module)||void 0===e?void 0:e.abilities)||void 0===t?void 0:t.length)||!this.moduleModel.isHspModule()&&!this.moduleModel.isHarModule())return;this.targetData.getApiMeta().compatibleSdkVersion.version<sdk_const_js_1.ApiVersion.API_VERSION_14&&_log.warn("The UIAbility configuration for HAR or HSP is only supported on the versions which API is greater than or equal to 14. Otherwise it may occur some problems.")}checkSdkVersionMatchLazyImport(){var e,t;(null===(t=null===(e=this.targetService.getBuildOption())||void 0===e?void 0:e.arkOptions)||void 0===t?void 0:t.autoLazyImport)&&(this.compatibleApiVersion<sdk_const_js_1.ApiVersion.API_VERSION_12||12===this.compatibleApiVersion&&("beta1"===this.compatibleSdkVersionStage||"beta2"===this.compatibleSdkVersionStage))&&_log.printErrorExit("AUTO_LAZY_IMPORT_CANNOT_BE_CONFIGURED_FOR_THE_CURRENT_API_VERSION")}iterateDependencies(e){const t=this.service.getHarDependencies(),i=this.service.getOtherDependencies(),o=[];return e.forEach(e=>{(t.find(t=>t.getDependencyName()===e)||i.find(t=>t.getDependencyName()===e))&&o.push(e)}),o}checkDynamicDependencyTypes(){const e=Object.keys(this.getDynamicDependencies(this.moduleModel)),t=Object.keys(this.getDynamicDependencies(this.projectModel)),i=[...this.iterateDependencies(e),...this.iterateDependencies(t)];0!==i.length&&_log.warn(`dynamicDependencies is intended for dynamically distributed HSP dependencies. It is not recommended to configure HAR packages or third-party dependencies. Using package '${i}'.`)}}exports.PreBuild=PreBuild;