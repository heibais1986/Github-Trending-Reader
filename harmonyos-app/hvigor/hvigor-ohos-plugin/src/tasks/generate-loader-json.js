"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,s){void 0===s&&(s=i);var o=Object.getOwnPropertyDescriptor(t,i);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,s,o)}:function(e,t,i,s){void 0===s&&(s=i),e[s]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__decorate=this&&this.__decorate||function(e,t,i,s){var o,n=arguments.length,r=n<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,t,i,s);else for(var a=e.length-1;a>=0;a--)(o=e[a])&&(r=(n<3?o(r):n>3?o(t,i,r):o(t,i))||r);return n>3&&r&&Object.defineProperty(t,i,r),r},__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.GenerateLoaderJson=void 0;const path_1=__importDefault(require("path")),wdk_1=require("@baize/wdk"),hvigor_1=require("@ohos/hvigor"),hvigor_arkts_compose_1=require("@ohos/hvigor-arkts-compose"),fse=__importStar(require("fs-extra")),project_ohos_config_manager_js_1=require("../common/global/project-ohos-config-manager.js"),build_directory_const_js_1=require("../const/build-directory-const.js"),common_const_js_1=require("../const/common-const.js"),inject_const_js_1=require("../const/inject-const.js"),sdk_const_js_1=require("../const/sdk-const.js"),aot_compile_mode_enum_js_1=require("../enum/aot-compile-mode-enum.js"),code_type_enum_js_1=require("../enum/code-type-enum.js"),module_type_enum_js_1=require("../enum/module-type-enum.js"),build_mode_manager_js_1=require("../project/build-option/build-mode-manager.js"),dependency_interface_js_1=require("../project/dependency/core/dependency-interface.js"),dependency_manager_js_1=require("../project/dependency/dependency-manager.js"),array_util_js_1=require("../utils/array-util.js"),build_profile_utils_js_1=require("../utils/build-profile-utils.js"),byte_code_har_utils_js_1=require("../utils/byte-code-har-utils.js"),file_util_js_1=require("../utils/file-util.js"),har_target_util_js_1=require("../utils/har-target-util.js"),hsp_target_utils_js_1=require("../utils/hsp-target-utils.js"),inject_util_js_1=require("../utils/inject-util.js"),json_util_js_1=require("../utils/json-util.js"),oh_package_loader_js_1=require("../utils/loader/file/oh-package-loader.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),ohmurl_utils_js_1=require("../utils/ohmurl-utils.js"),strategy_js_1=require("../utils/strategy.js"),task_util_js_1=require("../utils/task-util.js"),sdk_version_enum_js_1=require("../version/sdk-version-enum.js"),sdk_version_js_1=require("../version/sdk-version.js"),abstract_generate_loader_json_js_1=require("./abstract-generate-loader-json.js"),task_names_js_1=require("./common/task-names.js"),pre_build_js_1=require("./pre-build.js"),target_task_service_js_1=require("./service/target-task-service.js"),log=ohos_logger_js_1.OhosLogger.getLogger("GenerateLoaderJson");class GenerateLoaderJson extends abstract_generate_loader_json_js_1.AbstractGenerateLoaderJson{get useNormalizedOHMUrl(){var e,t;return!!(null===(t=null===(e=this.targetService.getBuildOption())||void 0===e?void 0:e.strictMode)||void 0===t?void 0:t.useNormalizedOHMUrl)}get isByteCodeHarOptimize(){return inject_util_js_1.InjectUtil.isByteCodeHarOptimize()}declareInputs(){var e,t,i;const s=super.declareInputs(),o=this.isOhpmProject?this.moduleModel.getOhPackageJson5Path():this.moduleModel.getPackageJsonPath(),n=(0,json_util_js_1.getJson5Obj)(o);s.set("module_dependencies",JSON.stringify(n.dependencies));const r=this.isOhpmProject?this.projectModel.getOhPackageJson5Path():this.projectModel.getPackageJsonPath(),a=(0,json_util_js_1.getJson5Obj)(r);s.set("overrides",a.overrides),s.set("project_dependencies",JSON.stringify(a.dependencies)),s.set(common_const_js_1.CommonConst.USE_NORMALIZED_OHM_URL,this.useNormalizedOHMUrl),s.set("isOhosTest",inject_util_js_1.InjectUtil.isOhosTest()),this.service.getHarDependencies().forEach(e=>{var t;if(e.isByteCodeHarDependency())return;const i=e.getModuleJsonObj();s.set("dependencyModuleAbility",JSON.stringify(null===(t=null==i?void 0:i.module)||void 0===t?void 0:t.abilities))}),s.set("isFullCompilationEnabled",this.isFullCompilationEnabled());const l=this.pathInfo.getBuildConfigPath();if(fse.existsSync(l)){const e=(0,json_util_js_1.getJson5Obj)(l);s.set("patchConfig",JSON.stringify(e.patchConfig))}return s.set("appStartupFileName",null!==(e=this.appStartupFileName)&&void 0!==e?e:""),this.declareDynamicImportInputs(s),s.set("compileMode",this.targetCompileMode.toString()).set("nodeModulesPath",this.nodeModulesPath).set("targetConfig",JSON.stringify(this.targetData.getTargetOpt())).set("hspNameOhmMap",JSON.stringify(this.hspNameOhmMap)).set("harNameOhmMap",JSON.stringify(this.harNameOhmMap)).set("anBuildMode",null!==(t=this.targetService.getAnBuildMode())&&void 0!==t?t:"").set("apPath",null!==(i=this.apPath)&&void 0!==i?i:"").set("fallbackAnBuild",this.fallbackAnBuild).set("isHarWithCoverage",this.isHarWithCoverage()).set("compileApiVersion",this.compileApiVersion).set("compatibleApiVersion",this.compatibleApiVersion).set("isByteCodeHar",this.targetService.isByteCodeHar()).set("shouldTreatHarAsHap",this.shouldTreatHarAsHap()).set("isBundledDependencies",this.isBundledDependencies).set("needSubmitArkTsWidget",this.needSubmitArkTsWidget)}declareDynamicImportInputs(e){var t,i;const s=Object.keys(this.getDependencies(this.moduleModel,!1)),o=Object.keys(this.getDependencies(this.projectModel,!1)),n=(0,build_profile_utils_js_1.getRuntimeOnlyObjMap)(this.module.getNodeDir(),null===(i=null===(t=this.targetService.getBuildOption())||void 0===t?void 0:t.arkOptions)||void 0===i?void 0:i.runtimeOnly,(0,array_util_js_1.getUnionSet)(o,s));for(const[t,i]of n)e.set(t,i);this.service.getHarModuleDependencies().forEach(([t,i])=>{var s;const n=(null===(s=i.getPackageJsonObj())||void 0===s?void 0:s.dependencies)||{},r=(0,build_profile_utils_js_1.getRuntimeOnlyObjMap)(i.getDependencyRootPath(),this.getLocalDependencyRuntimeOnly(i),(0,array_util_js_1.getUnionSet)(o,Object.keys(n)),t);for(const[t,i]of r)e.set(t,i)})}declareInputFiles(){var e,t;const i=new hvigor_1.FileSet;this.apPath&&fse.existsSync(this.apPath)&&i.addEntry(this.apPath,{isDirectory:!1}),this.insightIntentJsonPath&&fse.existsSync(this.insightIntentJsonPath)&&i.addEntry(this.insightIntentJsonPath),this.mockConfigJsonPath&&fse.existsSync(this.mockConfigJsonPath)&&i.addEntry(this.mockConfigJsonPath),this.addStartupInputFiles(i),fse.existsSync(this.pathInfo.getIntermediatesPkgContextInfoPath())&&i.addEntry(this.pathInfo.getIntermediatesPkgContextInfoPath());const s=this.getModuleEntryFile();this.isHarWithCoverage()&&fse.existsSync(s)&&i.addEntry(s);const o=this.pathInfo.getIntermediatesRouterMap(build_directory_const_js_1.BuildArtifactConst.LOADER_ROUTER_MAP_FILE_NAME);if(fse.existsSync(o)){(null===(e=(0,json_util_js_1.getJson5Obj)(o).routerMap)||void 0===e?void 0:e.length)&&i.addEntry(o)}const n=this.pathInfo.getIntermediatesRouterMap(null!==(t=this.targetService.getRouterMapJsonFileName(this.moduleModel))&&void 0!==t?t:build_directory_const_js_1.BuildArtifactConst.TEMP_ROUTER_MAP_FILE_NAME);return fse.existsSync(n)&&i.addEntry(n),this.allowToCollectEtsFolder()&&fse.existsSync(this.etsSourcePath)&&i.addEntry(this.etsSourcePath,{isDirectory:!0}),this.declareByteCodeHarInputFiles(i),this.declareDynamicImportInputFiles(i),i}addStartupInputFiles(e){this.appStartupPath&&fse.existsSync(this.appStartupPath)&&e.addEntry(this.appStartupPath),this.intermediateTempStartupFilePath&&fse.existsSync(this.intermediateTempStartupFilePath)&&e.addEntry(this.intermediateTempStartupFilePath)}isFullCompilationEnabled(){return!hvigor_1.coreParameter.properties[common_const_js_1.HvigorConfigConst.OHOS_COMPILE_LIB_ENTRY]}getEtsSourcePath(e){return path_1.default.join(e,build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN,code_type_enum_js_1.CodeType.ETS)}get isBundledDependencies(){return this.targetService.isBundledDependencies()}declareDynamicImportInputFiles(e){var t,i,s;if(!this.allowToCollectDependencyEtsFolder())return;const o=[],n=new Map;this.service.getHarDependencies().forEach(e=>{n.set(e.getDependencyName(),e);const t=e.isLocal()?this.getLocalDependencyDynamicImportList(e):this.getRemoteDependencyDynamicImportList(e);o.push(...t)});const r=null===(s=null===(i=null===(t=this.targetService.getBuildOption())||void 0===t?void 0:t.arkOptions)||void 0===i?void 0:i.runtimeOnly)||void 0===s?void 0:s.packages;o.concat(r||[]).forEach(t=>{const i=n.get(t);if(!i)return;const s=this.getEtsSourcePath(i.getDependencyRootPath());fse.existsSync(s)&&e.addEntry(s,{isDirectory:!0})})}declareByteCodeHarInputFiles(e){const t=this.pathInfo.getGenerateModuleInfoPath();this.targetService.isByteCodeHar()&&fse.existsSync(t)&&e.addEntry(t,{isDirectory:!1}),Object.keys(this.byteCodeHarInfo).forEach(t=>{const{abcPath:i,sourceMapsPath:s}=this.byteCodeHarInfo[t];e.addEntry(i,{isDirectory:!1}),s&&e.addEntry(i,{isDirectory:!1})}),this.otherCompileFiles.forEach(t=>{e.addEntry(t,{isDirectory:!1})})}declareOutputFiles(){const e=(new hvigor_1.FileSet).addEntry(this.aceLoaderJson,{isDirectory:!1});return this.needSubmitArkTsWidget&&e.addEntry(this.aceWidgetLoaderJson,{isDirectory:!1}),e}initTaskDepends(){this.declareDepends(pre_build_js_1.PreBuild.name)}constructor(e){super(e,task_names_js_1.TaskNames.Task.GENERATE_LOADER_JSON),this.hspNameOhmMap={},this.harNameOhmMap={},this.otherCompileFiles=[],this.updateVersionInfo={},this.declarationEntry=[],this.pkgContextInfos={},this.byteCodeHarInfo={},this.aceLoaderJson=this.pathInfo.getLoaderJsonPath(),this.aceWidgetLoaderJson=this.pathInfo.getWidgetLoaderJsonPath(),this.nodeModulesPath=path_1.default.resolve(e.getTargetData().getPathInfo().getInterMediatesLoaderOutPath(),common_const_js_1.CommonNodeConst.NODE_MODULES),this.hspResourcesMap=this.getHspResourcesMap(),this.moduleSrcMainPath=e.getTargetData().getPathInfo().getModuleSrcMainPath(),this.modulePath=e.getTargetData().getPathInfo().getModulePath(),this.moduleSrcMockPath=e.getTargetData().getPathInfo().getModuleSrcMockPath(),this.mockConfigJsonPath=path_1.default.resolve(this.moduleSrcMockPath,build_directory_const_js_1.BuildArtifactConst.MOCK_CONFIG_JSON5),this.moduleJson5Path=path_1.default.resolve(this.moduleSrcMainPath,build_directory_const_js_1.BuildArtifactConst.MODULE_JSON5),this.etsSourcePath=path_1.default.join(this.pathInfo.getModuleSrcMainPath(),code_type_enum_js_1.CodeType.ETS),this.insightIntentJsonPath=e.getInsightIntentJsonPath(),this.compileEntry=this.readInsightIntentSrcEntry(),this.dynamicImportLibInfo={},this.intermediatesRouterMapObjs=[],this.tempApDir=this.pathInfo.getIntermediatesApPath(),this.tempApPath=path_1.default.resolve(this.tempApDir,`${this.moduleName}.ap`),this.anBuildOutPutPath=path_1.default.resolve(this.pathInfo.getInterMediatesLoaderOutPath(),aot_compile_mode_enum_js_1.AotCompileModeEnum.AN,aot_compile_mode_enum_js_1.AotCompileModeEnum.ARM64_V8A),this.isPreview=hvigor_1.hvigorCore.getExtraConfig().get(inject_const_js_1.InjectConst.BUILD_ROOT)===build_directory_const_js_1.BuildDirConst.PREVIEW_BUILD_PATH,this.fallbackAnBuild=!inject_util_js_1.InjectUtil.isTestFrameWork()&&this.moduleModel.isHarModule();const t=this.targetService.getApPath();t&&(this.apPath=path_1.default.resolve(this.moduleModel.getProjectDir(),t));const i=e.getTargetData().getModuleSourceSetModel().getModuleTargetRes();this.needSubmitArkTsWidget=(0,task_util_js_1.shouldCompileArkTsWidget)(target_task_service_js_1.TargetTaskService.getFormJsonArr(i))}async beforeAlwaysAction(){await super.beforeAlwaysAction(),this.setPkgContextInfos(),this.hspNameOhmMap=this.getHspNameOhmMap(),this.harNameOhmMap=this.getHarNameOhmMap(),this.setByteCodeHarInfoAndOtherCompileFiles()}isHapOrHsp(){return this.moduleModel.isHspModule()||this.moduleModel.isHapModule()||this.shouldTreatHarAsHap()}setByteCodeHarInfoAndOtherCompileFiles(){if(!this.useNormalizedOHMUrl||!this.isHapOrHsp())return;const{byteCodeInfo:e,otherCompileEntrances:t}=(0,byte_code_har_utils_js_1.collectByteCodeInfoAndOtherCompileEntrances)(this.targetService);e.forEach(e=>{const t=e.packageName;this.byteCodeHarInfo[t]={abcPath:e.abcPath,...e.sourceMapsPath?{sourceMapsPath:e.sourceMapsPath}:{}}}),t.forEach((e,t)=>{e?this.collectCompileFiles(t,this.otherCompileFiles):this.otherCompileFiles.push(t)})}beforeTask(){super.beforeTask(),fse.existsSync(this.aceWidgetLoaderJson)&&fse.removeSync(this.aceWidgetLoaderJson)}getWorkerConfig(){var e;if(this.moduleModel.isHarModule())return 0===this.targetService.getWorkerConfig().length?void 0:this.targetService.getWorkerConfig();const t=this.service.getHarModuleDependencies().reduce((e,t)=>{var i,s,o;const n=this.projectModel.getModuleModelByName(t[0]);if(void 0===n)return e;const r=null!==(i=har_target_util_js_1.HarTargetUtil.calDepHarTargets(this.targetService).get(t[0]))&&void 0!==i?i:"default",a=build_mode_manager_js_1.buildOptionManager.getTargetBuildOption(t[0],r),l=file_util_js_1.FileUtil.convertToAbsolutePaths(null!==(o=null===(s=a.sourceOption)||void 0===s?void 0:s.workers)&&void 0!==o?o:[],n.getProjectDir());return l?e.concat(l):e},null!==(e=this.targetService.getWorkerConfig())&&void 0!==e?e:[]),i=this.service.getHarModuleDependencyPaths();return this.service.getHarDependencies().forEach(e=>{var s;if(i.includes(e.getDependencyRootPath()))return;const o=(0,json_util_js_1.getJson5Obj)(e.getPackageFilePath(),"utf-8");(null===(s=null==o?void 0:o.metadata)||void 0===s?void 0:s.workers)&&t.push(...file_util_js_1.FileUtil.convertToAbsolutePaths(o.metadata.workers,e.getDependencyRootPath()))}),0===t.length?void 0:t}collectCompileFiles(e,t=this.compileEntry){if(!fse.existsSync(e))return;const i=[".ets",".ts",".js"],s=[e];for(;s.length;){const e=s.shift();fse.readdirSync(e).forEach(o=>{const n=path_1.default.join(e,o),r=fse.statSync(n);r.isDirectory()?s.push(n):r.isFile()&&i.includes(path_1.default.extname(n).toLowerCase())&&t.push(n)})}}allowToCollectEtsFolder(){return!(this.targetName===common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET||!this.isFullCompilationEnabled())&&(this.moduleModel.isHspModule()||this.moduleModel.isHarModule())}allowToCollectDependencyEtsFolder(){return!!this.isFullCompilationEnabled()&&(this.moduleModel.isHspModule()||this.moduleModel.isHapModule())}collectDepEtsFolderFilesEntry(e){this.allowToCollectDependencyEtsFolder()&&this.collectCompileFiles(this.getEtsSourcePath(e.getDependencyRootPath()))}checkByteCodeHar(){if(this.useNormalizedOHMUrl||!this.isHapOrHsp())return;const e=this.service.getHarDependencies().filter(e=>e.isByteCodeHarDependency()).map(e=>e.getPackageName());e.length&&this._log.printErrorExit("BYTECODE_HARS_%S_NOT_SUPPORTED_WHEN_USENORMALIZEDOHMURL_IS_NOT_TRUE",[e.join(", ")])}shouldTreatHarAsHap(){return this.moduleModel.isHarModule()&&(0,byte_code_har_utils_js_1.shouldTreatHarAsHap)(this.targetName)}isHarWithCoverage(){return this.moduleModel.isHarModule()&&inject_util_js_1.InjectUtil.isOhosTestCoverage()}getModuleEntryFile(){const e=this.packageJsonObj.main?this.packageJsonObj.main:build_directory_const_js_1.BuildArtifactConst.INDEX_ETS;return path_1.default.resolve(this.pathInfo.getModulePath(),e)}processHarUnitTestWithCoverage(){const e=this.getModuleEntryFile();this.isHarWithCoverage()&&fse.existsSync(e)&&this.compileEntry.push(e)}processCodeFiles(e){const t=/\.d\.(e)?ts$/i;return Array.from(new Set(e)).filter(e=>!t.test(e)&&fse.existsSync(e)).map(e=>fse.realpathSync.native(e))}setPkgContextInfos(){fse.existsSync(this.pathInfo.getIntermediatesPkgContextInfoPath())&&(this.pkgContextInfos=(0,json_util_js_1.getJson5Obj)(this.pathInfo.getIntermediatesPkgContextInfoPath()))}doTaskAction(){var e,t,i,s,o,n;this.checkByteCodeHar();const r=this.moduleModel.getSourceSetByTargetName(this.targetName);if(this.targetName===common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET){const s=null===(i=null===(t=null===(e=r.getModuleTargetRes())||void 0===e?void 0:e.getModuleJsonOpt())||void 0===t?void 0:t.module)||void 0===i?void 0:i.name;s&&(this.modulePathMap={[s]:this.module.getNodeDir(),...this.modulePathMap})}this.processHarUnitTestWithCoverage();const a=this.targetName===common_const_js_1.CommonConst.OHOS_TEST,l=inject_util_js_1.InjectUtil.isLocalTest();(this.isPreview||a||l)&&this.collectMockFileEntry(this.modulePath,this.mockConfigJsonPath),this.allowToCollectEtsFolder()&&this.collectCompileFiles(this.etsSourcePath),fse.existsSync(this.insightIntentJsonPath)&&this.validateForInsightIntentJson(),this.processDeclarationEntry(),this.processDynamicImport(),this.processByteCodeHar(),this.processAppStartupConfig(this.appStartupPath),this.processRouterMap(),this.processBundledDependencies(),this.processUpdateVersionInfo(),this.collectDepAbilitySrcEntryArr();const d=this.handleAotFields(),c={workers:this.workerConfig,modulePathMap:this.modulePathMap,compileMode:this.targetCompileMode,projectRootPath:this.projectRootPath,nodeModulesPath:this.nodeModulesPath,byteCodeHarInfo:this.byteCodeHarInfo,declarationEntry:this.declarationEntry,moduleName:null===(n=null===(o=null===(s=r.getModuleTargetRes())||void 0===s?void 0:s.getModuleJsonOpt())||void 0===o?void 0:o.module)||void 0===n?void 0:n.name,hspNameOhmMap:this.hspNameOhmMap,harNameOhmMap:this.harNameOhmMap,packageManagerType:this.isOhpmProject?"ohpm":"npm",compileEntry:this.processCodeFiles(this.compileEntry),otherCompileFiles:this.processCodeFiles(this.otherCompileFiles),dynamicImportLibInfo:this.dynamicImportLibInfo,routerMap:this.intermediatesRouterMapObjs,hspResourcesMap:this.hspResourcesMap,updateVersionInfo:this.updateVersionInfo,...d};this.targetService.isByteCodeHar()&&(c.byteCodeHar=!0);const h=this.pathInfo.getBuildConfigPath();if((this.isPreview||inject_util_js_1.InjectUtil.isLocalTest())&&(c.buildConfigPath=path_1.default.relative(this.modulePath,h)),fse.existsSync(h)&&!inject_util_js_1.InjectUtil.isOhosTest()){const e=(0,json_util_js_1.getJson5Obj)(h);c.patchConfig=e.patchConfig}fse.outputJSONSync(this.aceLoaderJson,c,{spaces:2}),this.needSubmitArkTsWidget&&fse.outputJSONSync(this.aceWidgetLoaderJson,c,{spaces:2})}processByteCodeHar(){const e=this.pathInfo.getGenerateModuleInfoPath();this.targetService.isByteCodeHar()&&fse.existsSync(e)&&this.compileEntry.push(e)}collectByteCodeHarDeclarationEntry(e,t){var i,s,o;const n=e.getPackageJsonObj();if(e.isByteCodeHarDependency()){const e=(null===(i=n.metadata)||void 0===i?void 0:i.declarationEntry)||[];this.declarationEntry.push(...e)}const r=null===(o=null===(s=n.metadata)||void 0===s?void 0:s.runtimeOnly)||void 0===o?void 0:o.packages;this.collectRuntimeDynamicImportByteCodeHarDeclarationEntry(t,r)}collectRuntimeDynamicImportByteCodeHarDeclarationEntry(e,t){(null==t?void 0:t.length)&&t.forEach(t=>{const i=e.get(t);if(!(null==i?void 0:i.isByteCodeHarDependency()))return;const s=this.pkgContextInfos[i.getPackageName()];s?this.declarationEntry.push((0,ohmurl_utils_js_1.generateOhmUrl)(s)):this._log.debug(`Can not find package context information with package name: ${i.getPackageName()}`)})}shouldCollectDeclarationEntry(){return!!this.useNormalizedOHMUrl&&this.isHapOrHsp()}processDeclarationEntry(){var e,t;if(!this.shouldCollectDeclarationEntry())return;const i=this.service.getHarDependencies(),s=i.reduce((e,t)=>(e.set(t.getPackageName(),t),e),new Map);i.forEach(e=>{this.collectByteCodeHarDeclarationEntry(e,s)});const o=null===(t=null===(e=this.targetService.getBuildOption())||void 0===e?void 0:e.arkOptions)||void 0===t?void 0:t.runtimeOnly;this.collectRuntimeDynamicImportByteCodeHarDeclarationEntry(s,null==o?void 0:o.packages)}collectMockFileEntry(e,t){if(!fse.existsSync(t))return;const i=(0,hvigor_1.parseJsonFile)(t,!1);i&&Object.values(i).forEach(t=>{const i=t.source;if(i){const t=path_1.default.resolve(e,i);fse.existsSync(t)&&this.compileEntry.push(t)}})}logBuildError(e,t){log._buildError(e)._detail(t)._printErrorAndExit()}extensionAbilitiesValidate(e,t,i,s){if(void 0===e.form||void 0===e.form.ability)return;const o=e.form.ability;t.has(o)&&"form"===t.get(o).type||log.printErrorExit("INSIGHT_INTENT_INVALID_FORM_ABILITY_NAME",[o,this.insightIntentJsonPath],[[o]])}intentFormNameValidate(e,t){var i;const s=null===(i=e.form)||void 0===i?void 0:i.formName;void 0!==s&&(t.length&&t.includes(s)||this._log.printErrorExit("INVALID_FORM_NAME_%S",[s]))}validateServiceExtensionAbility(e,t,i,s,o){var n;if(void 0!==e.uiAbility&&void 0!==e.uiAbility.ability){const i=e.uiAbility.ability;void 0!==i&&(t.has(i)||log.printErrorExit("INSIGHT_INTENT_INVALID_ABILITY_NAME",[i,this.insightIntentJsonPath],[[i]]))}if(void 0===e.serviceExtension||void 0===e.serviceExtension.ability)return;const r=e.serviceExtension.ability;i.has(r)&&"service"===(null===(n=i.get(r))||void 0===n?void 0:n.type)||log.printErrorExit("INSIGHT_INTENT_INVALID_SERVICE_EXTENSION_ABILITY_NAME",[r,this.insightIntentJsonPath],[[r]])}uiExtensionValidate(e,t,i,s,o){if(void 0===e.uiExtension||void 0===e.uiExtension.ability)return;const n=e.uiExtension.ability;t.has(n)||i.has(n)||log.printErrorExit("INSIGHT_INTENT_INVALID_UI_EXTENSION_ABILITY_NAME",[n,this.insightIntentJsonPath],[[n]])}validateForInsightIntentJson(){let e="",t="";for(const i of this.compileEntry)fse.existsSync(i)||(e=`Cannot find the file under the specified path '${i}'.`,t="Please check if the file in the path exists.",log.printErrorExit("FILE_NOT_EXIST",[i])),i.endsWith(".ets")||(e=`The file must end with '.ets' in '${i}'.`,t="Please check if the file name is correct.",log.printErrorExit("FILE_NO_END_WITH_ETS",[i,this.insightIntentJsonPath]));const i=new Set,s=(0,hvigor_1.parseJsonFile)(this.moduleJson5Path,!1);if(void 0!==s.module.abilities)for(const e of s.module.abilities)i.add(e.name);const o=new Map;if(void 0!==s.module.extensionAbilities)for(const e of s.module.extensionAbilities)o.set(e.name,e);if(null!==this.insightIntentJson){const s=this.getFormConfigNames();for(const n of this.insightIntentJson.insightIntents)this.validateServiceExtensionAbility(n,i,o,e,t),this.extensionAbilitiesValidate(n,o,e,t),this.intentFormNameValidate(n,s),this.uiExtensionValidate(n,i,o,e,t)}}getFormConfigNames(){var e,t;const i=path_1.default.resolve(this.pathInfo.getModuleSrcMainResourceBaseProfilePath(),build_directory_const_js_1.BuildArtifactConst.FORM_CONFIG_JSON);if(fse.existsSync(i)){const s=hvigor_1.Json5Reader.getJson5Obj(i);return null!==(t=null===(e=null==s?void 0:s.forms)||void 0===e?void 0:e.map(e=>e.name))&&void 0!==t?t:[]}return[]}readInsightIntentSrcEntry(){const e=new Set;let t="";if(fse.existsSync(this.insightIntentJsonPath)){const i=(0,hvigor_1.parseJsonFile)(this.insightIntentJsonPath,!1);this.insightIntentJson=i;const s=this.moduleSrcMainPath;for(const o of i.insightIntents){const i=o.srcEntry;t=path_1.default.resolve(s,i),e.add(t)}}return Array.from(e)}checkAotCompatibleSdkVersion(){if(!this.sdkInfo.isOhos)return;const e=sdk_version_enum_js_1.SdkVersionEnum.SUPPORT_AOT_OHOS,t=this.sdkInfo.getEtsComponentVersion();if(""===t)return;const i=new sdk_version_js_1.SdkVersion(t);if(e.isHigherThan(i)){const t="OpenHarmony SDK";this._log.printErrorExit("AOT_COMPILING_UNSUPPORTED_SDK_VERSION",[i.getVersion(),e.getVersion()],[[t]])}}handleAotFields(){const e=this.targetService.getAnBuildMode();this.warnAnBuildMode(),e&&this.compileApiVersion===sdk_const_js_1.ApiVersion.API_VERSION_9&&this.checkAotCompatibleSdkVersion();const t={anBuildMode:e,apPath:this.apPath,apiVersion:this.compileApiVersion,fallbackAnBuild:this.fallbackAnBuild};return this.getAotStrategy(t)}warnAnBuildMode(){var e,t,i,s,o;const n=this.targetData.getCompileApiVersion(),r=null!==(i=null===(t=null===(e=this.targetService.getBuildOption())||void 0===e?void 0:e.arkOptions)||void 0===t?void 0:t.aotCompileMode)&&void 0!==i?i:null===(s=this.targetService.getBuildOption())||void 0===s?void 0:s.aotCompileMode,a=null===(o=this.targetService.getBuildOption().arkOptions)||void 0===o?void 0:o.hostPGO;switch(n){case sdk_const_js_1.ApiVersion.API_VERSION_9:void 0!==a&&log.warn('Field "hostPGO" is not supported in API version 9. The value of this field will be ignored.');break;case sdk_const_js_1.ApiVersion.API_VERSION_10:default:if(void 0!==r&&log.warn('Field "aotCompileMode" is not supported since API version 10. The value of this field will be ignored.'),this.sdkInfo.isOhos&&!this.sdkInfo.checkAotFixedSdkVersion()){const e="SDK > OpenHarmony";log._buildError(`Current version of sdk has a bug when using AoT compiling. The compiling will continue with AoT compiling function disabled. Current SDK version is ${this.sdkInfo.getEtsComponentVersion()}, but the lowest fixed SDK version is ${sdk_version_enum_js_1.SdkVersionEnum.FIXED_AOT_OHOS.getVersion()}.`)._detail(`Update SDK to the latest version by going to Tools > SDK Manager > ${e}. Open SDK Manager`)._printWarn(this.moduleName)}}}getHarNameOhmMap(){if(!this.targetService.isByteCodeHar())return{};if(this.targetService.isBundledDependencies()){const e=this.isByteCodeHarOptimize?this.service.getRootOtherDependencies().concat(this.service.getRootByteCodeHarDependencies()):this.service.getOtherDependencies().concat(this.service.getHarDependencies().filter(e=>e.isByteCodeHarDependency()));return this.getOHMUrlMap(e,this.pkgContextInfos)}const e=(this.isByteCodeHarOptimize?this.service.getAllDirectDependencies():this.service.getDirectDependencies()).filter(e=>e.getDependencyType()!==dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HSP);return this.getOHMUrlMap(e,this.pkgContextInfos)}getHspDependencies(){const e=inject_util_js_1.InjectUtil.isPreviewProcess()||inject_util_js_1.InjectUtil.isLocalTest();if(this.isByteCodeHarOptimize)return e?this.service.getAllHspDependencies():this.service.getRootHspDependencies();if(e){const e=new dependency_manager_js_1.DependencyManager(this.projectModel.isFaMode(),this.moduleModel,this.projectModel),{npmDependencies:t}=e.collectAllDependencies();return t.filter(e=>e.getDependencyType()===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HSP)}return this.service.getHspDependencies()}getHspNameOhmMap(){let e={};const t=this.getHspDependencies();return this.useNormalizedOHMUrl?e=this.getOHMUrlMap(t,this.pkgContextInfos):t.forEach(t=>{const i=t.getDependencyName(),s=this.getHspDependencyModuleName(t),o=this.getHspDependencyPackageMainName(t);""!==o&&(e[i]=`@bundle:${s}${o}`)}),e}getHspResourcesMap(){const e={};return hsp_target_utils_js_1.HspTargetUtils.calDepHspTargets(this.targetService).forEach((t,i)=>{const s=path_1.default.resolve(t.getPathInfo().getIntermediatesRes(),build_directory_const_js_1.BuildArtifactConst.RESOURCE_TABLE_TXT);fse.existsSync(s)?e[t.getModuleModel().getName()]=s:this._log.debug(`The ResourceTable.txt in ${t.getPathInfo().getModulePath()} does not exist.`)}),this.service.getHspDependencies().forEach(t=>{const i=t.getDependencyName();let s;t.isLocal()||(s=path_1.default.resolve(t.getDependencyRootPath(),build_directory_const_js_1.BuildArtifactConst.RESOURCE_TABLE_TXT)),s&&fse.existsSync(s)?e[i]=s:this._log.debug(`The ResourceTable.txt in ${t.getDependencyRootPath()} does not exist.`)}),e}getOHMUrlMap(e,t){const i={},s=e.map(e=>e.getPackageName());return Object.values(t).forEach(t=>{if(s.includes(t.packageName)){const s=e.filter(e=>e.getPackageName()===t.packageName);i[s[0].getDependencyName()]=(0,ohmurl_utils_js_1.generateOhmUrl)(t)}}),i}getHspDependencyPackageMainName(e){const t=path_1.default.resolve(e.getDependencyRootPath(),"./src/main");let i,s;return i=hvigor_1.Json5Reader.getJson5Obj(e.getPackageFilePath()).main?e.getDependencyMainFilePath():e.getDependencyTypesFilePath(),i.startsWith(t)?s=i.replace(t,""):i.startsWith(e.getDependencyRootPath())&&(s=i.replace(e.getDependencyRootPath(),"")),s?(0,ohmurl_utils_js_1.removeSuffix)(s):(log._buildError(`The "main" or "types" field of hsp module ${e.getPackageName()} must be under the\n      root path of hsp module or under src/main path. Please confirm.`)._file(e.getPackageFilePath())._printWarn(this.moduleName),"")}getHspDependencyModuleName(e){var t,i,s,o,n;const r=this.service.getHspModuleDependencyPaths();let a;const l=path_1.default.resolve(e.getDependencyRootPath(),"src","main","module.json5"),d=path_1.default.resolve(e.getDependencyRootPath(),"src","main","module.json");let c;const h=(0,wdk_1.cloneDeep)(null===(t=project_ohos_config_manager_js_1.projectOhosConfigManager.getOverrides())||void 0===t?void 0:t.appOpt);return r.includes(e.getDependencyRootPath())?(a=hvigor_1.Json5Reader.getJson5Obj(l),c=null!==(s=null!==(i=null==h?void 0:h.bundleName)&&void 0!==i?i:this.targetData.getProduct().bundleName)&&void 0!==s?s:this.projectModel.getDefaultBundleName()):fse.existsSync(d)?(a=(0,json_util_js_1.getJson5Obj)(d),c=a.app.bundleName):(a=hvigor_1.Json5Reader.getJson5Obj(l),c=null!==(n=null!==(o=null==h?void 0:h.bundleName)&&void 0!==o?o:this.targetData.getProduct().bundleName)&&void 0!==n?n:this.projectModel.getDefaultBundleName()),`${c}/${a.module.name}`}getAotStrategy(e){const{apiVersion:t,anBuildMode:i,apPath:s,fallbackAnBuild:o}=e,n=void 0!==s&&fse.pathExistsSync(s),r=void 0!==s&&s.endsWith("ap"),a=[{name:"withEmpty",condition:o,strategy:this.withEmpty},{name:"mismatchAotCompileMode",condition:t===sdk_const_js_1.ApiVersion.API_VERSION_9&&i!==aot_compile_mode_enum_js_1.AotCompileModeEnum.AOT_PARTIAL&&void 0!==s,strategy:this.mismatchAotCompileMode},{name:"partialEmptyPath",condition:t===sdk_const_js_1.ApiVersion.API_VERSION_9&&i===aot_compile_mode_enum_js_1.AotCompileModeEnum.AOT_PARTIAL&&void 0===s,strategy:this.partialEmptyPath},{name:"invalidSuffix",condition:void 0!==s&&!r,strategy:this.invalidSuffix},{name:"invalidPath",condition:i===aot_compile_mode_enum_js_1.AotCompileModeEnum.AOT_PARTIAL&&!n,strategy:this.invalidPath},{name:"withEmpty",condition:(t===sdk_const_js_1.ApiVersion.API_VERSION_9&&void 0===s||t>=sdk_const_js_1.ApiVersion.API_VERSION_10)&&i===aot_compile_mode_enum_js_1.AotCompileModeEnum.AOT_NULL,strategy:this.withEmpty},{name:"withApPath",condition:(t===sdk_const_js_1.ApiVersion.API_VERSION_9&&i===aot_compile_mode_enum_js_1.AotCompileModeEnum.AOT_PARTIAL||t>=sdk_const_js_1.ApiVersion.API_VERSION_10)&&n&&r,strategy:this.withApPath},{name:"withoutApPath",condition:t===sdk_const_js_1.ApiVersion.API_VERSION_9&&i===aot_compile_mode_enum_js_1.AotCompileModeEnum.AOT_TYPE&&void 0===s,strategy:this.withoutApPath},{name:"withoutApPath",condition:t>=sdk_const_js_1.ApiVersion.API_VERSION_10&&i===aot_compile_mode_enum_js_1.AotCompileModeEnum.AOT_TYPE&&!n,strategy:this.withoutApPath}];return(0,strategy_js_1.getStrategy)(a,()=>({})).bind(this)(e)}withApPath(e){return fse.emptyDirSync(this.tempApDir),fse.copyFileSync(e.apPath,this.tempApPath),{anBuildOutPut:this.anBuildOutPutPath,anBuildMode:e.anBuildMode,apPath:e.apPath}}withoutApPath(e){return{anBuildOutPut:this.anBuildOutPutPath,anBuildMode:e.anBuildMode}}withEmpty(){return{}}mismatchAotCompileMode(){this._log.printErrorExit("MISMATCH_AOT_COMPILE_MODE",[this.moduleModel.getProfilePath()])}partialEmptyPath(){this._log.printErrorExit("PARTIAL_EMPTY_PATH",[this.moduleModel.getProfilePath()])}invalidPath(){this._log.printErrorExit("PARTIAL_INVALID_PATH",[this.moduleModel.getProfilePath(),this.apPath])}invalidSuffix(){this._log.printErrorExit("PARTIAL_INVALID_SUFFIX",[this.moduleModel.getProfilePath()])}processAppStartupConfig(e){var t;if(void 0!==e&&fse.existsSync(e)){const t=(0,json_util_js_1.getJson5Obj)(e),i=path_1.default.resolve(this.module.getNodeDir(),build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN);t.configEntry&&this.compileEntry.push(path_1.default.resolve(i,t.configEntry))}const i=(0,json_util_js_1.getJson5Obj)(this.intermediateTempStartupFilePath);void 0!==i&&(null===(t=i.startupTasks)||void 0===t||t.forEach(e=>{void 0!==e.srcEntryAbsolutePath&&this.compileEntry.push(null==e?void 0:e.srcEntryAbsolutePath)}))}processDynamicImport(){var e,t;this.targetService.isByteCodeHar()||this.processIndirectDependency(this.service.getHarDependencies());const i=null===(t=null===(e=this.targetService.getBuildOption())||void 0===e?void 0:e.arkOptions)||void 0===t?void 0:t.runtimeOnly;if(i){if(i.sources){const e=this.module.getNodeDir();i.sources.forEach(t=>{const i=path_1.default.resolve(e,t),s=fse.statSync(i);s.isFile()&&this.compileEntry.push(i),s.isDirectory()&&this.processDirectoryImport(i)})}i.packages&&!this.targetService.isByteCodeHar()&&i.packages.forEach(e=>{this.isHarDependency(e)?this.processHarDynamicImport(e,this.dynamicImportLibInfo):this.processOtherDynamicImport(e,this.dynamicImportLibInfo)})}}processHarDynamicImport(e,t){this.service.getHarDependencies().forEach(i=>{const s=i.getDependencyName();if(s===e){const o=i.isByteCodeHarDependency()?i.getDependencyTypesFilePath():i.getDependencyMainFilePath(),n=i.getPackageFilePath();if(this.existInDynamicImportLibsInfo(e))return;const r={[s]:{hostModulesInfo:[{hostDependencyName:s,hostModuleName:this.moduleModel.getName()}],moduleName:this.getHarDependencyModuleName(i,e),entryFilePath:o,isLocalDependency:i.isLocal(),pkgPath:n.substring(0,n.lastIndexOf(path_1.default.sep))}};if(Object.assign(t,r),i.isByteCodeHarDependency())return;this.compileEntry.push(o),this.collectDepEtsFolderFilesEntry(i)}})}processOtherDynamicImport(e,t){const i=path_1.default.resolve(this.moduleModel.getModule().getNodeDir(),common_const_js_1.CommonConst.OH_MODULES,e),s=path_1.default.resolve(this.projectRootPath,common_const_js_1.CommonConst.OH_MODULES,e),o=fse.existsSync(i)?i:fse.existsSync(s)?s:"";if(""===o)return;const n=fse.realpathSync(o);if(!fse.existsSync(n))return;const r=oh_package_loader_js_1.ohPackageLoader.getNodeOhPackagePath(path_1.default.resolve(o,common_const_js_1.CommonConst.OH_PACKAGE_JSON5)),a=(0,json_util_js_1.getJson5Obj)(r);if(!a)return;const l=this.getEntryMainFilePath(n,a),d=path_1.default.resolve(n,build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN),c=dependency_manager_js_1.DependencyManager.isLocalDependencyForSo(l),h=c?path_1.default.resolve(d,common_const_js_1.CommonConst.MODULE_JSON5):path_1.default.resolve(d,common_const_js_1.CommonConst.MODULE_JSON);let u,_=a.name;if(fse.existsSync(h)){const t=(0,json_util_js_1.getJson5Obj)(h);if(!t)return;u=t.module.type,this.isHspDependency(e)&&(_=t.module.name)}if(u||u===module_type_enum_js_1.ModuleType.Shared||common_const_js_1.ValidateRegExp.SO_DEPENDENCY_REG_EXP.test(e)||this.compileEntry.push(l),this.existInDynamicImportLibsInfo(e))return;const p={[e]:{hostModulesInfo:[{hostDependencyName:e,hostModuleName:this.moduleModel.getName()}],moduleName:_,entryFilePath:l,isLocalDependency:c,pkgPath:n}};Object.assign(t,p)}getLocalDependencyRuntimeOnly(e){var t,i,s,o;if(!e.isLocal())return;const n=null!==(i=null===(t=e.getModuleJsonObj())||void 0===t?void 0:t.module.name)&&void 0!==i?i:e.getPackageName(),r=null!==(s=har_target_util_js_1.HarTargetUtil.calDepHarTargets(this.targetService).get(n))&&void 0!==s?s:"default";return null===(o=build_mode_manager_js_1.buildOptionManager.getTargetBuildOption(n,r).arkOptions)||void 0===o?void 0:o.runtimeOnly}getLocalDependencyDynamicImportList(e){return this.collectDynamicImport(this.getLocalDependencyRuntimeOnly(e))}getRemoteDependencyDynamicImportList(e){var t;const i=e.getPackageFilePath(),s=(0,json_util_js_1.getJson5Obj)(i);if(!s)return[];const o=null===(t=s.metadata)||void 0===t?void 0:t.runtimeOnly;return this.collectDynamicImport(o)}processIndirectDependency(e){e.forEach(e=>{const t=e.isLocal()?this.getLocalDependencyDynamicImportList(e):this.getRemoteDependencyDynamicImportList(e);0!==t.length&&this.processIndirectDependencyInfo(e,t)})}collectDynamicImport(e){var t,i;return[...null!==(t=null==e?void 0:e.sources)&&void 0!==t?t:[],...null!==(i=null==e?void 0:e.packages)&&void 0!==i?i:[]]}processIndirectDependencyInfo(e,t){t.forEach(t=>{if(this.isHarDependency(t)&&this.writeIndirectDependencyInfo(this.service.getHarDependencies(),t),this.isHspDependency(t)&&this.writeIndirectDependencyInfo(this.service.getHspDependencies(),t),common_const_js_1.ValidateRegExp.SO_DEPENDENCY_REG_EXP.test(t)&&this.processIndirectSoDependencyInfo(e,t),common_const_js_1.ValidateRegExp.RELATIVE_PATH_REG_EXP.test(t)){const i=path_1.default.resolve(e.getDependencyRootPath(),t);if(!fse.existsSync(i))return;const s=fse.statSync(i);s.isFile()&&this.compileEntry.push(i),s.isDirectory()&&this.processDirectoryImport(i)}})}processDirectoryImport(e){file_util_js_1.FileUtil.getAllFilesFromFolder(e).forEach(e=>{common_const_js_1.ValidateRegExp.DYNAMIC_IMPORT_FILE_SUFFIX_REG_EXP.test(file_util_js_1.FileUtil.getFileSuffix(e))&&fse.existsSync(e)&&this.compileEntry.push(e)})}processIndirectSoDependencyInfo(e,t){const i=e.getDependencyRootPath(),s=e.getDependencyMainFilePath(),o=e.getPackageFilePath(),n=dependency_manager_js_1.DependencyManager.isLocalDependencyForSo(s);if(!this.existInDynamicImportLibsInfo(t)&&common_const_js_1.ValidateRegExp.SO_DEPENDENCY_REG_EXP.test(t)){let s=n?path_1.default.resolve(i,common_const_js_1.CommonConst.OH_MODULES,t,common_const_js_1.CommonConst.OH_PACKAGE_JSON5):path_1.default.resolve(i.substring(0,i.lastIndexOf(path_1.default.sep)),t,common_const_js_1.CommonConst.OH_PACKAGE_JSON5);s=oh_package_loader_js_1.ohPackageLoader.getNodeOhPackagePath(s);const r=(0,json_util_js_1.getJson5Obj)(s);if(!r)return;const a=path_1.default.resolve(i,build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN,build_directory_const_js_1.BuildDirConst.CPP_TYPES,t,r.types),l={[t]:{hostModulesInfo:[{hostDependencyName:t,hostModuleName:this.getHostModuleName(e)}],moduleName:r.name,entryFilePath:a,isLocalDependency:n,pkgPath:o.substring(0,o.lastIndexOf(path_1.default.sep))}};Object.assign(this.dynamicImportLibInfo,l)}}writeIndirectDependencyInfo(e,t){e.forEach(e=>{if(e.getDependencyName()===t){const i=this.isHarDependency(t);i&&this.collectDepEtsFolderFilesEntry(e);const s=e.getDependencyMainFilePath(),o=fse.existsSync(s)?s:e.getDependencyTypesFilePath();if(!fse.existsSync(o))return;if(i&&!e.isByteCodeHarDependency()){const e=fse.statSync(o);e.isFile()?this.compileEntry.push(o):e.isDirectory()&&file_util_js_1.FileUtil.getAllFilesFromFolder(o).forEach(e=>{common_const_js_1.ValidateRegExp.DYNAMIC_IMPORT_FILE_SUFFIX_REG_EXP.test(file_util_js_1.FileUtil.getFileSuffix(e))&&this.compileEntry.push(e)})}if(this.existInDynamicImportLibsInfo(t))return;const n=path_1.default.resolve(e.getDependencyRootPath(),build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN),r=path_1.default.resolve(n,common_const_js_1.CommonConst.MODULE_JSON),a=path_1.default.resolve(n,common_const_js_1.CommonConst.MODULE_JSON5),l=fse.existsSync(r)?r:fse.existsSync(a)?a:"",d=(0,json_util_js_1.getJson5Obj)(l);if(!d)return;const c=d.module.type,h=c===module_type_enum_js_1.ModuleType.Har?this.getHarDependencyModuleName(e,t):c===module_type_enum_js_1.ModuleType.Shared?d.module.name:"",u=e.getPackageFilePath(),_={[t]:{hostModulesInfo:[{hostDependencyName:t,hostModuleName:this.moduleName}],moduleName:h,entryFilePath:o,isLocalDependency:e.isLocal(),pkgPath:u.substring(0,u.lastIndexOf(path_1.default.sep))}};Object.assign(this.dynamicImportLibInfo,_)}})}getEntryMainFilePath(e,t){var i,s;const o=path_1.default.resolve(e,(0,hvigor_arkts_compose_1.findNodeEntryFiles)(t)[0]);if(fse.existsSync(o))return o;{const o=path_1.default.resolve(e,null!==(s=null!==(i=t.main)&&void 0!==i?i:t.types)&&void 0!==s?s:build_directory_const_js_1.BuildArtifactConst.INDEX_JS);return fse.existsSync(o)?o:""}}getHostModuleName(e){var t;const i=e.getDependencyRootPath(),s=path_1.default.resolve(i,build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN,`${e.isLocal()?common_const_js_1.CommonConst.MODULE_JSON5:common_const_js_1.CommonConst.MODULE_JSON}`),o=(0,json_util_js_1.getJson5Obj)(s);return o?null===(t=o.module)||void 0===t?void 0:t.name:""}getHarDependencyModuleName(e,t){var i;if(!this.isHarDependency(t))return"";const s=e.getDependencyRootPath(),o=path_1.default.resolve(s,build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN,common_const_js_1.CommonConst.MODULE_JSON5),n=(0,json_util_js_1.getJson5Obj)(o);return e.isLocal()?null!==(i=null==n?void 0:n.module.name)&&void 0!==i?i:"":dependency_manager_js_1.DependencyManager.getModuleNameFromOhPkgJson(s)}existInDynamicImportLibsInfo(e){return Object.prototype.hasOwnProperty.call(this.dynamicImportLibInfo,e)}isHarDependency(e){const t=[];return this.service.getHarDependencies().forEach(e=>{t.push(e.getDependencyName())}),t.includes(e)}isHspDependency(e){const t=[];return this.service.getHspDependencies().forEach(e=>{t.push(e.getDependencyName())}),t.includes(e)}processRouterMap(){var e;const t=this.pathInfo.getIntermediatesRouterMap(build_directory_const_js_1.BuildArtifactConst.LOADER_ROUTER_MAP_FILE_NAME);if(!fse.existsSync(t))return;const i=(0,json_util_js_1.getJson5Obj)(t);(null===(e=i.routerMap)||void 0===e?void 0:e.length)&&(i.routerMap.forEach(e=>{this.compileEntry.push(e.pageSourceFile)}),Object.assign(this.intermediatesRouterMapObjs,i.routerMap))}processUpdateVersionInfo(){const e=this.targetService.getModuleService().getModuleModel().isHapModule()||this.targetService.getModuleService().getModuleModel().isHspModule(),t=this.targetName===common_const_js_1.CommonConst.OHOS_TEST,i=inject_util_js_1.InjectUtil.isLocalTest(),s=this.isPreview||t||i,o=this.targetService.getModuleService().getModuleModel().isHarModule();if(!(e||o&&s))return;(this.isByteCodeHarOptimize?this.service.getAllByteCodeHarDependencies():this.targetService.getModuleService().getHarDependencies().filter(e=>e.isByteCodeHarDependency())).forEach(e=>{var t,i,s;const o=e.getPackageJsonObj();(i=this.updateVersionInfo)[s=e.getPackageName()]||(i[s]={});const n=null===(t=null==o?void 0:o.metadata)||void 0===t?void 0:t.dependencyPkgVersion;n?Object.entries(n).filter(([e,t])=>{var i;const s=null===(i=this.pkgContextInfos[e])||void 0===i?void 0:i.version;return void 0!==s&&""!==s.trim()&&s!==t}).forEach(([t])=>{var i;this.updateVersionInfo[e.getPackageName()][t]=null===(i=this.pkgContextInfos[t])||void 0===i?void 0:i.version}):Object.entries({...null==o?void 0:o.dependencies,...null==o?void 0:o.dynamicDependencies}).forEach(([t])=>{var i;const s=null===(i=this.pkgContextInfos[t])||void 0===i?void 0:i.version;s&&""!==s.trim()&&(this.updateVersionInfo[e.getPackageName()][t]=s)})})}processBundledDependencies(){const e=har_target_util_js_1.HarTargetUtil.getDep2ConfigMap(this.targetService);this.targetService.isByteCodeHar()&&this.isBundledDependencies&&e&&(this.pushConfigToCompileEntry(e.dep2Workers),this.pushDepRuntimeOnlyToCompileEntry(null==e?void 0:e.dep2RuntimeOnlyObj),this.pushConfigToCompileEntry(e.dep2RouterMapObjPageSourceFiles))}collectDepAbilitySrcEntryArr(){const e=[];this.service.getHarDependencies().forEach(t=>{var i;if(t.isByteCodeHarDependency())return;const s=t.getModuleJsonObj();if(s)for(const o of[common_const_js_1.AbilityConst.UI_ABILITY,common_const_js_1.AbilityConst.EXTENSION_ABILITY]){const n=null===(i=null==s?void 0:s.module)||void 0===i?void 0:i[o];(null==n?void 0:n.length)&&n.forEach(i=>{if(!i.srcEntry)return;const s=this.targetService.getAbsoluteSrcEntryPath(i.srcEntry,t.getDependencyRootPath());fse.existsSync(s)?e.push(s):this._log.debug("The srcEntry path for obtaining the ability of the module on which the module depends is incorrect or the corresponding file does not exist.")})}}),this.compileEntry.push(...e)}pushDepRuntimeOnlyToCompileEntry(e){e&&(this.pushConfigToCompileEntry(e.dep2RuntimeOnlySources),e.dep2RuntimeOnlyPackages.forEach(e=>{e.forEach(e=>{const t=this.service.getHarDependencies().find(t=>t.getDependencyName()===e);if(!t)return;const i=hvigor_1.Json5Reader.getJson5Obj(t.getPackageFilePath()).main?t.getDependencyMainFilePath():t.getDependencyTypesFilePath();fse.existsSync(i)&&this.compileEntry.push(i)})}))}pushConfigToCompileEntry(e){(null==e?void 0:e.size)&&e.forEach((e,t)=>{e.forEach(e=>{const i=path_1.default.resolve(t.getDependencyRootPath(),e);fse.existsSync(i)&&this.compileEntry.push(i)})})}}__decorate([(0,hvigor_1.Input)()],GenerateLoaderJson.prototype,"isByteCodeHarOptimize",null),exports.GenerateLoaderJson=GenerateLoaderJson;