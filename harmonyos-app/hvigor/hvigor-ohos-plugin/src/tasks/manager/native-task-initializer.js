"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.CmakeConfigureCA=exports.CacheNativeLibsCA=exports.DoNativeStripCA=exports.PrepareQuickfixCA=exports.ProcessLibsCA=exports.NinjaCA=exports.CmakeCA=exports.initNativeTasks=void 0;const path_1=__importDefault(require("path")),hvigor_1=require("@ohos/hvigor"),fs_extra_1=__importDefault(require("fs-extra")),cmake_util_js_1=require("../../utils/cmake-util.js"),har_target_util_js_1=require("../../utils/har-target-util.js"),hsp_target_utils_js_1=require("../../utils/hsp-target-utils.js"),inject_util_js_1=require("../../utils/inject-util.js"),build_native_with_cmake_js_1=require("../build-native-with-cmake.js"),build_native_with_ninja_js_1=require("../build-native-with-ninja.js"),cache_native_libs_js_1=require("../cache-native-libs.js"),task_names_js_1=require("../common/task-names.js"),configure_cmake_js_1=require("../configure-cmake.js"),do_native_strip_js_1=require("../do-native-strip.js"),prepare_quickfix_js_1=require("../prepare-quickfix.js"),process_libs_js_1=require("../process-libs.js"),task_creator_js_1=require("../task-creator.js"),initNativeTasks=(e,s,t=!1)=>{e.registry(new NinjaCA(s,t)),e.registry(new CmakeCA(s,t)),e.registry(new ProcessLibsCA(s,t)),e.registry(new PrepareQuickfixCA(s)),e.registry(new DoNativeStripCA(s,t)),e.registry(new CacheNativeLibsCA(s,t)),e.registry(new CmakeConfigureCA(s,t))};exports.initNativeTasks=initNativeTasks;class CmakeCA extends task_creator_js_1.TargetTaskCreator{constructor(){super(...arguments),this.declareDepends=()=>[configure_cmake_js_1.ConfigureCmake.name],this.declareTaskDetail=()=>task_names_js_1.TaskNames.Task.BUILD_NATIVE_WITH_CMAKE,this.provider=()=>new build_native_with_cmake_js_1.BuildNativeWithCmake(this.targetService)}}exports.CmakeCA=CmakeCA;class NinjaCA extends task_creator_js_1.TargetTaskCreator{constructor(){super(...arguments),this.provider=()=>new build_native_with_ninja_js_1.BuildNativeWithNinja(this.targetService),this.declareDepends=()=>{var e;cmake_util_js_1.CmakeUtil.checkAbiFilters(null===(e=this.targetService.getBuildOption().externalNativeOptions)||void 0===e?void 0:e.abiFilters,this.targetService.getTargetData().isHarmonyOS(),this.targetService.getModuleService().getModuleModel(),this.targetService.getTargetData().getTargetName());const s=[build_native_with_cmake_js_1.BuildNativeWithCmake.name];return getModuleDependencies(this.targetService,task_names_js_1.TaskNames.Task.DO_NATIVE_STRIP.name,s),s},this.declareTaskDetail=()=>task_names_js_1.TaskNames.Task.BUILD_NATIVE_WITH_NINJA}}exports.NinjaCA=NinjaCA;class ProcessLibsCA extends task_creator_js_1.TargetTaskCreator{constructor(){super(...arguments),this.declareDepends=()=>[build_native_with_ninja_js_1.BuildNativeWithNinja.name],this.declareTaskDetail=()=>task_names_js_1.TaskNames.Task.PROCESS_LIB,this.provider=()=>new process_libs_js_1.ProcessLibs(this.targetService)}}exports.ProcessLibsCA=ProcessLibsCA;class PrepareQuickfixCA extends task_creator_js_1.TargetTaskCreator{constructor(){super(...arguments),this.declareDepends=()=>"hotReload"===getPatchConfigMode(this.node.getNodeDir())?["ColdReloadArkTS"]:["ColdReloadArkTS",do_native_strip_js_1.DoNativeStrip.name],this.declareTaskDetail=()=>task_names_js_1.TaskNames.Task.PREPARE_QUICKFIX,this.provider=()=>new prepare_quickfix_js_1.PrepareQuickfix(this.targetService)}}exports.PrepareQuickfixCA=PrepareQuickfixCA;class DoNativeStripCA extends task_creator_js_1.TargetTaskCreator{constructor(){super(...arguments),this.declareDepends=()=>[process_libs_js_1.ProcessLibs.name],this.declareTaskDetail=()=>task_names_js_1.TaskNames.Task.DO_NATIVE_STRIP,this.provider=()=>new do_native_strip_js_1.DoNativeStrip(this.targetService)}}exports.DoNativeStripCA=DoNativeStripCA;class CacheNativeLibsCA extends task_creator_js_1.TargetTaskCreator{constructor(){super(...arguments),this.declareDepends=()=>[task_names_js_1.TaskNames.Task.DO_NATIVE_STRIP.name],this.declareTaskDetail=()=>task_names_js_1.TaskNames.Task.CACHE_NATIVE_LIBS,this.provider=()=>new cache_native_libs_js_1.CacheNativeLibs(this.targetService)}}exports.CacheNativeLibsCA=CacheNativeLibsCA;class CmakeConfigureCA extends task_creator_js_1.TargetTaskCreator{constructor(){super(...arguments),this.declareDepends=()=>{const e=[task_names_js_1.TaskNames.Task.PRE_BUILD.name];return getModuleDependencies(this.targetService,task_names_js_1.TaskNames.Task.BUILD_NATIVE_WITH_CMAKE.name,e),e},this.declareTaskDetail=()=>task_names_js_1.TaskNames.Task.CONFIGURE_CMAKE,this.provider=()=>new configure_cmake_js_1.ConfigureCmake(this.targetService)}}function getModuleDependencies(e,s,t){hsp_target_utils_js_1.HspTargetUtils.calDepHspTargets(e).forEach((e,a)=>t.push(`${a}:${e.getTargetName()}@${s}`));return har_target_util_js_1.HarTargetUtil.calDepHarTargets(e).forEach((e,a)=>t.push(`${a}:${e}@${s}`)),t}function getPatchConfigMode(e){var s;const t=path_1.default.resolve(inject_util_js_1.InjectUtil.getBuildCacheParentDir(e,path_1.default.join(hvigor_1.hvigorCore.getProject().getName(),e.substring(hvigor_1.hvigorCore.getProject().getNodeDir().length)),!0),"build"),a=path_1.default.resolve(t,"config","buildConfig.json");if(fs_extra_1.default.existsSync(a)){const e=fs_extra_1.default.readJsonSync(a);return null===(s=null==e?void 0:e.patchConfig)||void 0===s?void 0:s.mode}}exports.CmakeConfigureCA=CmakeConfigureCA;