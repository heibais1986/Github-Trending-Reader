"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.GlobalProjectDataService=void 0;const hvigor_1=require("@ohos/hvigor"),fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path")),find_target_product_js_1=require("../../common/find-target-product.js"),common_const_js_1=require("../../const/common-const.js"),file_util_js_1=require("../../utils/file-util.js"),wdk_1=require("@baize/wdk"),integrated_hsp_utils_js_1=require("../../utils/integrated-hsp-utils.js"),json_util_js_1=require("../../utils/json-util.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),ohos_test_util_js_1=require("../../utils/ohos-test-util.js"),sign_util_js_1=require("../sign/sign-util.js"),hvigor_config_loader_1=require("@ohos/hvigor/src/common/util/hvigor-config-loader");class GlobalProjectDataService{constructor(){this.compileProjectModel={},this.allModulePaths=[],this.projectPkgJsonFileHash="",this.allModuleNameHash="",this.rootPathSet=new Set,this.isEmptyTargetSdkVersionCheck=!1,this.buildModeInfo={ifThrowError:!1,buildModeName:"",buildProfilePath:""},this.moduleRemoteHspSet=new Set,this.remoteHspCache={signingConfig:{},signedRemoteHsps:new Map},this._log=ohos_logger_js_1.OhosLogger.getLogger(GlobalProjectDataService.name)}static getInstance(){return GlobalProjectDataService.INSTANCE}initGlobalProjectData(e){this.rootPathSet=new Set,this.allModulePaths=[],this.compileProjectModel=this.initCompileProjectModel(e),this.allModuleNameHash=this.initAllModuleNameHash(e),this.projectRemoteHspPromise=void 0,this.moduleRemoteHspSet=new Set,this.initRemoteHspCache(e),this.integratedHspUtils=new integrated_hsp_utils_js_1.IntegratedHspUtils(e),this.buildModeInfo={ifThrowError:!1,buildModeName:"",buildProfilePath:""},this.isEmptyTargetSdkVersionCheck=!1}getIsEmptyTargetSdkVersionCheck(){return this.isEmptyTargetSdkVersionCheck}setIsEmptyTargetSdkVersionCheck(){this.isEmptyTargetSdkVersionCheck=!0}getCompileProjectModel(){return this.compileProjectModel}setProjectPkgJsonFileHash(e){this.projectPkgJsonFileHash=e}getProjectPkgJsonFileHash(){return this.projectPkgJsonFileHash}getAllModuleNameHash(){return this.allModuleNameHash}setProjectRemoteHspPromise(e){this.projectRemoteHspPromise=e}getProjectRemoteHspPromise(){return this.projectRemoteHspPromise}setModuleRemoteHspPromise(e){this.moduleRemoteHspSet.add(e)}getModuleRemoteHspPromise(){return this.moduleRemoteHspSet}setNeedSignedRemoteHspMap(e,t){this.remoteHspCache.signedRemoteHsps.set(e,t)}getRemoteHspCache(){return this.remoteHspCache}getBuildModeInfo(){return this.buildModeInfo}setBuildModeInfo(e){return this.buildModeInfo=e}needSignedRemoteHsp(e,t){if(this.remoteHspCache.signedRemoteHsps.has(e)){const o=this.remoteHspCache.signedRemoteHsps.get(e);return!!(null==o?void 0:o.moduleName)&&o.moduleName===t}return!0}changeRemoteHspSigned(e){for(const t of this.remoteHspCache.signedRemoteHsps.values())t.signedHspPath===e&&(t.isSigned=!0)}allRemoteHspSigned(){for(const e of this.remoteHspCache.signedRemoteHsps.values())if(!e.isSigned)return!1;return!0}getIntegratedHspUtils(){return this.integratedHspUtils}getAllModulePaths(){return this.allModulePaths}initCompileProjectModel(e){const t={};return e.getAllModules().forEach(o=>{var s,i;this.rootPathSet.add(o.getBelongProjectPath());const r=o.getProjectDir();this.allModulePaths.push(r);for(const[e,i]of o.getAllTargetSourceSet()){const a=null!==(s=i.getTargetSourceSetModuleName())&&void 0!==s?s:o.getName(),l=i.getSourceSetRoot();if("ohosTest"===e&&(0,ohos_test_util_js_1.isTemplatesAfterSourceCodeMigration)(l)){const e=(0,ohos_test_util_js_1.getOhosTestIntermediatesEtsPath)(r);t[e]={moduleName:a,modulePkgPath:r,belongProjectPath:o.getBelongProjectPath()}}t[l]={moduleName:a,modulePkgPath:r,belongProjectPath:o.getBelongProjectPath()}}t[r]={moduleName:o.getName(),modulePkgPath:r,belongProjectPath:o.getBelongProjectPath()};const a=null!==(i=hvigor_1.hvigorCore.getExtraConfig().get(common_const_js_1.CommonConst.BUILD_CACHE_DIR))&&void 0!==i?i:hvigor_config_loader_1.HvigorConfigLoader.getInstance().getPropertiesConfigValue(common_const_js_1.CommonConst.BUILD_DIR_KEY);if(a){fs_extra_1.default.ensureDirSync(a),this.rootPathSet.add(path_1.default.resolve(a,e.getName()));const s=path_1.default.resolve(a,e.getName(),o.getName());t[s]={moduleName:o.getName(),modulePkgPath:o.getProjectDir(),belongProjectPath:o.getBelongProjectPath(),isBuildCacheDir:!0},this.allModulePaths.push(s)}}),t[e.getProjectDir()]={moduleName:e.getName(),modulePkgPath:e.getProjectDir(),belongProjectPath:e.getProjectDir()},t}initProjectPkgJsonFileHash(e){var t;const o=e.isOhpmProject();let s=e.getAllModules().map(e=>{var t;const s=o?e.getOhPackageJson5Path():e.getPackageJsonPath();return null!==(t=file_util_js_1.FileUtil.readFile(s))&&void 0!==t?t:""}).join("");const i=o?e.getOhPackageJson5Path():e.getPackageJsonPath();return s+=null!==(t=file_util_js_1.FileUtil.readFile(i))&&void 0!==t?t:"",(0,hvigor_1.hash)(s)}initAllModuleNameHash(e){let t=e.getAllModules().map(e=>{var t;let o="";for(const[s,i]of e.getAllTargetSourceSet())o+=null!==(t=i.getTargetSourceSetModuleName())&&void 0!==t?t:e.getName();return o}).join("");return t+=e.getName(),(0,hvigor_1.hash)(t)}getRootPathSet(){return this.rootPathSet}resetRemoteHspCache(){this.remoteHspCache={signingConfig:{},signedRemoteHsps:new Map}}initRemoteHspCache(e){this.resetRemoteHspCache();const t=(0,find_target_product_js_1.findTargetProduct)(e),o=(0,sign_util_js_1.getSigningConfig)(e),s=e.getCacheRemoteHspPath(t.name),i=path_1.default.resolve(s,common_const_js_1.CommonConst.REMOTE_HSP_CACHE),r=new Map;if(o){if(fs_extra_1.default.existsSync(i)){const e=(0,json_util_js_1.getJson5Obj)(i);if((0,wdk_1.isEqual)(e.signingConfig,o)){const t=fs_extra_1.default.readdirSync(s);Object.keys(e.signedRemoteHsps).forEach(o=>{const s=e.signedRemoteHsps[o];t.includes(o)&&(null==s?void 0:s.signedHspPath)&&fs_extra_1.default.existsSync(s.signedHspPath)&&r.set(o,s)}),this.remoteHspCache.signedRemoteHsps=r}}this.remoteHspCache.signingConfig=o}else this._log.debug("No signingConfig found, initRemoteHspCache failed.")}}exports.GlobalProjectDataService=GlobalProjectDataService,GlobalProjectDataService.INSTANCE=new GlobalProjectDataService;