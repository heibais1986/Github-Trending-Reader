"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.OhosHarTask=exports.DEFAULT_MAIN_FILED_FILE_SUFFIX=void 0;const fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path")),common_const_js_1=require("../../const/common-const.js"),oh_package_loader_1=require("../../utils/loader/file/oh-package-loader"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),har_extend_info_js_1=require("../har/har-extend-info.js"),ohos_module_task_js_1=require("./ohos-module-task.js"),DEFAULT_MAIN_FILED_FILE_NAME="index";exports.DEFAULT_MAIN_FILED_FILE_SUFFIX=[".ets",".ts",".js"];const _log=ohos_logger_js_1.OhosLogger.getLogger("process-package-json");class OhosHarTask extends ohos_module_task_js_1.OhosModuleTask{constructor(e,o){if(super(e,o),this._harExtendInfo=new har_extend_info_js_1.HarExtendInfo(this.moduleModel,e.getBuildOption()),this.modulePackageJsonPath=this.getModulePackageJsonPath(),!this.packageJsonObj){const e=oh_package_loader_1.ohPackageLoader.getNodeOhPackagePath(this.isOhpmProject?common_const_js_1.CommonConst.OH_PACKAGE_JSON5:common_const_js_1.CommonConst.PACKAGE_JSON);_log.printErrorExit("THE_%S_FILE_DOES_NOT_EXIST",[e,this.modulePackageJsonPath],[[e]])}}getModulePackageJsonPath(){return this.moduleModel.isOhpmProject()?this.moduleModel.getOhPackageJson5Path():this.moduleModel.getPackageJsonPath()}getPackageJsonValidMainField(){const e=this.packageJsonObj.main;let o;if(void 0===e||""===e)o=this.findValidMainField();else{o=e;const t=path_1.default.resolve(this.moduleModel.getProjectDir(),o);fs_extra_1.default.existsSync(t)||_log.printErrorExit("THE_MAIN_FIELD_SET_IN_PACKAGE_JSON_CORRSPONDING_PATH",[t,this.modulePackageJsonPath])}return o}findValidMainField(){const e=this.moduleModel.getProjectDir();let o;return exports.DEFAULT_MAIN_FILED_FILE_SUFFIX.forEach(t=>{const s=`index${t}`,_=path_1.default.resolve(e,`index${t}`);fs_extra_1.default.existsSync(_)&&(o=s)}),null!=o?o:"index.ets"}}exports.OhosHarTask=OhosHarTask;