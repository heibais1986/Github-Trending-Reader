"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,o){void 0===o&&(o=s);var i=Object.getOwnPropertyDescriptor(t,s);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,o,i)}:function(e,t,s,o){void 0===o&&(o=s),e[o]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.OhosModuleTask=void 0;const path_1=__importDefault(require("path")),hvigor_1=require("@ohos/hvigor"),fse=__importStar(require("fs-extra")),build_directory_const_js_1=require("../../const/build-directory-const.js"),common_const_js_1=require("../../const/common-const.js"),sdk_const_js_1=require("../../const/sdk-const.js"),module_type_enum_js_1=require("../../enum/module-type-enum.js"),file_util_js_1=require("../../utils/file-util.js"),json_util_js_1=require("../../utils/json-util.js"),oh_package_loader_js_1=require("../../utils/loader/file/oh-package-loader.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),dependency_interface_js_1=require("../../project/dependency/core/dependency-interface.js");class OhosModuleTask extends hvigor_1.IncrementalExecTask{constructor(e,t){super(e.getTargetData().getModuleModel().getModule(),e.buildTaskName(t)),this.paramWhiteList=["version","devDependencies","dynamicDependencies","dependencies"],this.ohosLogger=ohos_logger_js_1.OhosLogger.getLogger(OhosModuleTask.name),this.localProductDependenciesPath=[],this.registryAction=()=>async()=>{await this.beforeTask(),this.taskShouldDo()&&await this.doTaskAction()},this.module=e.getTargetData().getModuleModel().getModule(),this.moduleName=this.module.getName(),this.targetService=e,this.targetData=e.getTargetData(),this.service=e.getModuleService(),this.projectModel=this.service.getProjectModel(),this.moduleModel=this.service.getModuleModel(),this.sdkInfo=this.targetService.getSdkInfo(),this.isFaMode=this.service.isFaMode(),this.targetName=this.targetService.getTargetData().getTargetName(),this.pathInfo=e.getTargetData().getPathInfo(),this.compileApiVersion=this.targetData.getCompileApiVersion(),this.compatibleApiVersion=this.targetData.getCompatibleApiVersion(),this.targetSdkVersion=this.targetData.getTargetSdkVersion(),this.compatibleSdkVersionStage=this.targetData.getCompatibleSdkVersionStage(),this.moduleModelNodePaths=new Set(this.projectModel.getAllModules().map(e=>e.getModule().getNodeDir())),this.appStartupPath=e.getAppStartupPath(this.isFaMode),this.appStartupFileName=e.getAppStartupFileName(this.isFaMode),this.intermediateTempStartupFilePath=this.pathInfo.getIntermediatesStartupPath(this.appStartupFileName),this.isOhpmProject=this.projectModel.isOhpmProject(),this.packageManagerPath=this.isOhpmProject?this.moduleModel.getOhPackageJson5Path():this.moduleModel.getPackageJsonPath(),this.initHarModuleDepends(),hvigor_1.hvigor.nodesEvaluated(()=>{this.initTaskDependsForOtherModule()}),this.getWorkerPool().warmUp(common_const_js_1.CommonConst.WARM_UP_SCRIPT),this.shouldCloseWorkerPoolAfterBuild()&&this.getWorkerPool().setResident(!1),this.packageJsonObj=hvigor_1.Json5Reader.getJson5Obj(this.packageManagerPath);const s=this.projectModel.getParameterFileObj();if(this.isOhpmProject){const e={parameterFilePath:this.projectModel.getParameterFileAbsolutePath(),ohPackageFilePath:this.packageManagerPath};file_util_js_1.FileUtil.resolveJsonObjWithoutParam(this.packageJsonObj,s,e,this.paramWhiteList)}}shouldCloseWorkerPoolAfterBuild(){return(0,hvigor_1.isLinux)()||this.isFaMode||this.sdkInfo.isOhos||this.sdkInfo.getSdkVersion()<sdk_const_js_1.ApiVersion.API_VERSION_11}initTaskDependsForOtherModule(){}initHarModuleDepends(){}beforeTask(){if(this.isOhpmProject){const e={parameterFilePath:this.projectModel.getParameterFileAbsolutePath(),ohPackageFilePath:this.packageManagerPath},t=file_util_js_1.FileUtil.resolveJsonObjWithoutParam(this.packageJsonObj,this.projectModel.getParameterFileObj(),e,this.paramWhiteList,e=>oh_package_loader_js_1.ohPackageLoader.getOhPackageJsonObj(e));this.localProductDependenciesPath.push(...t)}}taskShouldDo(){return!0}getTaskTempDir(e,t,s=!0){const o=path_1.default.resolve(e.getPathInfo().getModuleBuildCachePath(),t||this.name);return s&&!fse.existsSync(o)&&fse.mkdirsSync(o),o}getImporteesCachePath(e,t){const s=this.targetService.getTargetData(),o=this.moduleModel.getCompileMode(s.getProduct());return path_1.default.resolve(this.getTaskTempDir(s,`${this.targetName}@${t}`,!1),o,this.targetService.getBuildMode().toLowerCase(),e)}processImportees(e,t,s){if(!fse.existsSync(e))return;const o=(0,json_util_js_1.getJson5Obj)(e);Array.isArray(o)&&o.forEach(e=>{const o=t.find(t=>e===t.getDependencyName()||e.startsWith(`${t.getDependencyName()}/`));o&&s(e,o.getDependencyType(),o)})}getGlobalDependencyKeys(){const e=this.moduleModel.getModule().getNodeDir();return this.service.getAllDirectPkgNodes().filter(t=>!!t.parent&&t.parent.npm.getDependencyRootPath()!==e).map(e=>e.npm.getDependencyName())}collectDirectAffectsCompilationDependencyKeys(e){var t,s,o;const i=this.getGlobalDependencyKeys(),a=new Set(null===(o=null===(s=null===(t=this.targetService.getBuildOption())||void 0===t?void 0:t.arkOptions)||void 0===s?void 0:s.runtimeOnly)||void 0===o?void 0:o.packages);this.processImportees(e,this.service.getAllDirectDependencies(),(e,t,s)=>{a.add(s.getDependencyName())});const r=Array.from(a),n=r.filter(e=>i.includes(e));return{compileDependencyKeys:r,globalCompileDependencyKeys:n}}doGlobalLocalDependencyCheck(e){if(this.targetName===common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET)return;const{compileDependencyKeys:t,globalCompileDependencyKeys:s}=this.collectDirectAffectsCompilationDependencyKeys(e),o=new Set;this.service.getAllDirectDependencies().forEach(e=>{const i=e.getDependencyName();t.includes(i)&&s.includes(i)&&e.isLocal()&&o.add(i)}),o.size&&this.ohosLogger.warn(`You have used local dependencies [${[...o].join(",")}]. These dependencies are not configured in the oh-package.json5 file of the current module, therefore, the build system does not collect their libs, resources, and related configurations (such as dynamicImport, routerMap, and abilities) during the build process. As a result, a runtime exception may occur during subsequent integration. You are advised to configure these dependencies in the oh-package.json5 file of the current module.`)}doDevDependencyCheck(e){if(this.targetName===common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET)return;const{compileDependencyKeys:t}=this.collectDirectAffectsCompilationDependencyKeys(e),s=new Set;this.service.getAllDirectDependencies().forEach(e=>{const o=e.getDependencyName();t.includes(o)&&e.getDependencyEnum()===dependency_interface_js_1.DependencyEnum.DEV_DEPENDENCIES&&s.add(o)}),s.size&&this.ohosLogger.warn(`The dependencies [${[...s].join(",")}] you are using are listed under devDependencies. As such, the build system won't collect their libs, resources, and related configurations (for dynamicImport, routerMap, abilities, and more) during the build process. This could cause runtime issues later. To avoid these issues, move these dependencies to 'dependencies'.`)}replacePagesInPreview(e,t){const s=path_1.default.resolve(this.pathInfo.getIntermediatesRes(),common_const_js_1.CommonConst.MODULE_JSON),o=(0,json_util_js_1.getJson5Obj)(s),i=path_1.default.resolve(this.projectModel.getProjectDir(),this.moduleModel.getName(),`src/main/${build_directory_const_js_1.BuildDirConst.RESOURCES_BASE_PROFILE_DIR}/${build_directory_const_js_1.BuildArtifactConst.MAIN_PAGES_JSON}`);if(this.moduleModel.getModuleType()===module_type_enum_js_1.ModuleType.Shared&&!fse.existsSync(i)){const e=this.pathInfo.getPreviewIntermediatesMainPagesJsonPath();fse.writeJSONSync(e,{src:["pages/Index"]})}const a=`${o.module.pages.replace(/\$profile:/,"")}.json`,r=path_1.default.resolve(this.pathInfo.getIntermediatesResProfilePath(),a),n=fse.readJSONSync(r);n.src=t,e.debug(`Resolved file ${r}.`),e.debug(`Replace page to ${t}`),fse.outputJSONSync(r,n)}replacePages(e,t){const s={src:t},o=this.getPageJsonFileName(e),i=path_1.default.resolve(this.pathInfo.getIntermediatesResProfilePath(),o);e.debug(`Resolved file ${i}.`),e.debug(`Replace page to ${t}`),fse.outputJSONSync(i,s)}getPageJsonFileName(e){const t=path_1.default.resolve(this.pathInfo.getIntermediatesRes(),common_const_js_1.CommonConst.MODULE_JSON),s=(0,json_util_js_1.getJson5Obj)(t).module.pages;return s||e.printErrorExit("UNABLE_TO_REPLACE_PAGES_CANNOT_FIND_PAGES",[this.moduleModel.getName()]),`${s.replace(/\$profile:/,"")}.json`}getDependencies(e,t){const s=this.projectModel.isOhpmProject()?e.getOhPackageJson5Path():e.getPackageJsonPath();let o={};if(fse.existsSync(s)){const e=hvigor_1.Json5Reader.getJson5Obj(s);o={dependency:o,...e.dependencies},t&&Object.assign(o,e.devDependencies)}const i={};return Object.keys(o).sort().forEach(e=>i[e]=o[e]),i}getDynamicDependencies(e){const t=this.projectModel.isOhpmProject()?e.getOhPackageJson5Path():e.getPackageJsonPath();let s={};if(fse.existsSync(t))try{const e=hvigor_1.Json5Reader.getJson5Obj(t);s={dependency:s,...e.dynamicDependencies}}catch(e){this.ohosLogger.warn("Failed to read json5:",e.message)}const o={};return Object.keys(s).sort().forEach(e=>o[e]=s[e]),o}declareDepends(e,t){let s;return s=e instanceof hvigor_1.CoreTask?e.getName():e,s.split("@").length>1||(s=`${this.targetName}@${s}`),super.dependsOn(s,t)}declareDependsList(...e){e.forEach(e=>{this.declareDepends(e)})}dependsOnHook(e,t){let s;return s=e instanceof hvigor_1.CoreTask?e.getName():e,super.dependsOn(s,t)}hasUseTsHarField(){var e;if(this.targetService.isByteCodeHar())return!0;if(!this.isFaMode){return void 0!==(null===(e=this.moduleModel.getJsonProfileOptByTargetName(this.targetName,!1).module.metadata)||void 0===e?void 0:e.find(e=>e.name===common_const_js_1.CommonConst.USE_TS_HAR&&"true"===e.value))}return!1}}exports.OhosModuleTask=OhosModuleTask;