"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,s)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.LegacyMergeProfile=void 0;const wdk_1=require("@baize/wdk"),hvigor_1=require("@ohos/hvigor"),fs=__importStar(require("fs-extra")),common_const_js_1=require("../../const/common-const.js"),sdk_const_js_1=require("../../const/sdk-const.js"),merge_type_rule_js_1=require("../../enum/merge-type-rule.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),abstract_merge_profile_js_1=require("../abstract-merge-profile.js"),task_names_js_1=require("../common/task-names.js"),legacy_pre_build_js_1=require("./legacy-pre-build.js");var LegacyFATask=task_names_js_1.TaskNames.LegacyFATask;const device_type_const_1=require("../../const/device-type-const"),har_target_util_js_1=require("../../utils/har-target-util.js"),json_util_js_1=require("../../utils/json-util.js"),shell_utils_1=require("../../utils/shell-utils");class LegacyMergeProfile extends abstract_merge_profile_js_1.AbstractMergeProfile{constructor(e){super(e,LegacyFATask.MERGE_PROFILE),this._log=ohos_logger_js_1.OhosLogger.getLogger(LegacyMergeProfile.name),this._harLibs=this.mergeDependsLibs(common_const_js_1.CommonConst.CONFIG_JSON);const t=this.service.getModuleModel().getSourceSetByTargetName(this._targetName);this._moduleTargetRes=t.getLegacyModuleTargetRes(),this._mergedModuleJson=this._pathInfo.getIntermediatesMergeLegacyProfile()}initTaskDepends(){this.declareDepends(legacy_pre_build_js_1.LegacyPreBuild.name)}initHarModuleDepends(){har_target_util_js_1.HarTargetUtil.calDepHarTargets(this.targetService).forEach((e,t)=>this.declareDepends(`${e}@${LegacyFATask.MERGE_PROFILE.name}`,t))}mergeDslConfig(e){var t,r,i;this._bundleName&&(e.app.bundleName=this._bundleName,this._appBundleName=this._bundleName,this._log.debug((0,hvigor_1.replaceBundleName)(`Change app bundleName with '${this._bundleName}'.`,this._bundleName))),this._vendor&&(e.app.vendor=this._vendor,this._log.debug(`Change app vendor with '${this._vendor}'.`));const s=this.targetData.getApiMeta(),o=!![s.compileSdkVersion.version,s.compatibleSdkVersion.version,null!==(r=null===(t=s.targetSdkVersion)||void 0===t?void 0:t.version)&&void 0!==r?r:s.compileSdkVersion.version].find(e=>e<=sdk_const_js_1.ApiVersion.API_VERSION_9),n=null!==(i=s.targetSdkVersion)&&void 0!==i?i:s.compileSdkVersion,a=this.targetData.isHarmonyOS()?this.apiTransform(n):n.version,l=this.targetData.isHarmonyOS()?this.apiTransform(s.compatibleSdkVersion):s.compatibleSdkVersion.version,u=this.targetData.isHarmonyOS()?common_const_js_1.CommonConst.HARMONY_OS:common_const_js_1.CommonConst.OPEN_HARMONY,d=this.sdkInfo.getToolchainsComponentVersion();e.app.apiVersion={compileSdkVersion:d,compileSdkType:u,target:o?n.version:a,compatible:o?s.compatibleSdkVersion.version:l,releaseType:this.sdkInfo.getReleaseType()},this._log.debug(`Change app target API version with '${e.app.apiVersion.target}'`),this._log.debug(`Change app minimum API version with '${e.app.apiVersion.compatible}'`),this._log.debug(`Change app releaseType with '${this.sdkInfo.getReleaseType()}'`)}doTaskAction(){const e=(0,wdk_1.cloneDeep)(this._moduleTargetRes.getConfigJsonOpt());this.mergeAsanAndTsan(e),this.mergeAppEnvironmentConfig(e),this._appBundleName=e.app.bundleName;const t=this._harLibs.map(e=>fs.pathExistsSync(e)?(0,json_util_js_1.getJson5Obj)(e):(this._log.warn(`${e} not found, The library will not be merged.\n         Check the configuration of this module.`),null)),r=this.mergeAllConfigOpt(e,t);if(this.mergeDslConfig(r),this.targetService.isDebug()){void 0===r.deviceConfig.default&&(r.deviceConfig.default={}),r.deviceConfig.default.debug=!0}this.supportLiteDeviceModule(r)&&!r.module.package&&(r.module.package=shell_utils_1.ShellUtils.JS_SHELL_PACKAGE),fs.outputJSONSync(this._mergedModuleJson,r,{spaces:"\t"})}mergeAsanAndTsan(e){this.asanEnable&&(e.app.asanEnabled=this.asanEnable),this.tsanEnable&&(e.app.tsanEnabled=this.tsanEnable),this.hwAsanEnable&&(e.app.hwasanEnabled=this.hwAsanEnable),this.ubsanEnable&&(e.app.ubsanEnabled=this.ubsanEnable)}mergeAppEnvironmentConfig(e){var t;const r=this.parseToAppEnvironments(this.appEnvironments);if(void 0!==e.app.appEnvironments&&0!==e.app.appEnvironments.length){this._log.debug("Change app appEnvironment");const i=new Map;r.forEach(e=>{i.set(e.name,e.value)}),null===(t=e.app.appEnvironments)||void 0===t||t.forEach(e=>{i.set(e.name,e.value)}),e.app.appEnvironments=Array.from(i,([e,t])=>({name:e,value:t}))}else this._log.debug("Use cli appEnvironment"),e.app.appEnvironments=r}supportLiteDeviceModule(e){const t=e.module.deviceType;return t&&(t.includes(device_type_const_1.DeviceTypeConst.LITE_WEARABLE)||t.includes(device_type_const_1.DeviceTypeConst.SMART_VISION))}mergeAllConfigOpt(e,t){var r,i,s,o,n;for(let a=0;a<t.length;a++){const l=t[a];null!==l&&((null===(r=l.app.apiVersion)||void 0===r?void 0:r.compatible)&&(null===(i=e.app.apiVersion)||void 0===i?void 0:i.compatible)&&(null===(s=l.app.apiVersion)||void 0===s?void 0:s.compatible)>(null===(o=e.app.apiVersion)||void 0===o?void 0:o.compatible)&&this._log.printErrorExit("COMPATIBLE_VERSION_TOO_LOW",[l.module.name||(null===(n=l.module.distro)||void 0===n?void 0:n.moduleName)||""],[[l.app.apiVersion.compatible]]),e=this.mergeModel(e,l,"config",a===t.length-1))}return e}mergeModel(e,t,r,i){if(LegacyMergeProfile.enumInclude(merge_type_rule_js_1.KeepHapOptions,r)||void 0===t)return e;if(void 0===e)return t;return(0,wdk_1.union)(Object.keys(e),Object.keys(t)).forEach(s=>{const o=e[s],n=t[s];o&&n&&typeof o!=typeof n&&this._log.printErrorExit("TYPE_OF_VALUE_IN_CONFIG_IS_NOT_SAME",[s,this.moduleName]),this.checkFieldRule(e,t,s,r);switch(void 0===o?typeof n:typeof o){case"boolean":LegacyMergeProfile.handleBooleanMerge(e,o,n,s);break;case"string":case"number":LegacyMergeProfile.handleStringOrNumberMerge(e,o,n,s,r);break;case"object":Array.isArray(o)||Array.isArray(n)?this.handleArrayMerge(e,o,n,s,r,i):LegacyMergeProfile.enumInclude(merge_type_rule_js_1.IsMapFields,s)?this.handleMapMerge(e,o,n,s,r,i):e[s]=this.mergeModel(o,n,s,i);break;default:this._log.error("An unrecognized type!")}}),e}mergeList(e,t,r,i){let s=[];if("skills"===r)return e;switch(0===e.length?typeof t[0]:typeof e[0]){case"string":s=(0,wdk_1.union)(e,t);break;case"object":LegacyMergeProfile.enumInclude(merge_type_rule_js_1.HasPlaceholderOptions,r)&&(e.forEach(e=>this.disposePlaceHolder(e,r)),t.forEach(e=>this.disposePlaceHolder(e,r))),e.forEach(e=>{null===this.findObjectByUniqueKey(t,e,r)&&s.push(e)}),t.forEach(t=>{const o=this.findObjectByUniqueKey(e,t,r);if(null===o)s.push(t);else{const e=this.mergeModel(o,t,r,i);s.push(this.mergeRule(e,o))}});break;default:this._log.error(`Other Type! ${r}`)}if(i)for(const e of s)Object.keys(e).includes("mergeRule")&&(e.mergeRule=void 0);return s}findObjectByUniqueKey(e,t,r){const i=LegacyMergeProfile.getUniqueKey(t,r);for(const s of e){const e=LegacyMergeProfile.getUniqueKey(s,r);if("abilities"===r){const e=t.targetAbility,r=s.targetAbility;!e&&r&&e===i&&this._log.printErrorExit("TARGET_ABILITY_NAME_CONFLICT",[e,this.moduleName])}if(i===e)return s}return null}static getUniqueKey(e,t){return LegacyMergeProfile.enumInclude(merge_type_rule_js_1.UniqueKeyEqualsName,t)?e.name:"shortcuts"===t?e.shortcutId:"abilities"===t?void 0===e.targetAbility?e.name:e.targetAbility:null}mergeRule(e,t){if(null===t||void 0===t.mergeRule)return e;const r=t.mergeRule;if(r.replace){r.replace.forEach(r=>{e[r]&&(e[r]=t[r])})}if(r.remove){r.remove.forEach(t=>{e[t]&&(e[t]=void 0)})}return e}mergeMap(e,t,r,i,s){if(void 0===e)return e;if(void 0===t)return t;const o=(0,wdk_1.cloneDeep)(e),n=Object.keys(e),a=Object.keys(t),l=(0,wdk_1.difference)(a,n);r&&l.forEach(e=>{o[e]=t[e]});return(0,wdk_1.intersection)(a,n).forEach(r=>{Array.isArray(e[r])?o[r]=(0,wdk_1.union)(e[r],t[r]):"object"==typeof e[r]&&(o[r]=this.mergeModel(e[r],t[r],i,s))}),o}checkFieldRule(e,t,r,i){if(!LegacyMergeProfile.enumInclude(merge_type_rule_js_1.IsNeedMergeRule,i)||LegacyMergeProfile.enumInclude(merge_type_rule_js_1.KeepAbilityMergeList,i)||"skills"===r)return;const s=e[r],o=t[r];if(void 0!==s&&void 0!==o&&!(0,wdk_1.isEqual)(s,o)){const t=e.mergeRule;if(!(0,wdk_1.union)(t.replace,t.remove).includes(r)){const e=LegacyMergeProfile.getUniqueKey(s,i);this._log.printErrorExit("MERGE_RULE_CONFLICT",[i,e,r,this.moduleName])}}}disposePlaceHolder(e,t){return Object.keys(e).forEach(r=>{var i;if(LegacyMergeProfile.enumInclude(merge_type_rule_js_1.NeedDisposePlaceholder,r)&&("abilities"!==t||"name"!==r)){const t=e[r];if("string"==typeof t)e[r]=t.replace("{bundleName}",this._appBundleName);else if(Array.isArray(t)&&0!==t.length)if("string"==typeof t[0]){const t=[];for(const i of e[r])t.push(i.replace("{bundleName}",this._appBundleName));e[r]=t}else{const t=[];for(const s of e[r])s.name=null===(i=s.name)||void 0===i?void 0:i.replace("{bundleName}",this._appBundleName),t.push(s);e[r]=t}}}),e}static enumInclude(e,t){return Object.values(e).includes(t)}static handleBooleanMerge(e,t,r,i){LegacyMergeProfile.enumInclude(merge_type_rule_js_1.KeepOneOfThem,i)&&(e[i]=void 0===t&&void 0!==r?r:t)}static handleStringOrNumberMerge(e,t,r,i,s){let o=void 0===t&&void 0!==r?r:t;"deviceConfig"!==s&&"module"!==s||(o=t),e[i]=o}handleArrayMerge(e,t,r,i,s,o){const n=Array.isArray(t)?t:[],a=Array.isArray(r)?r:[];let l;l="module"===s&&LegacyMergeProfile.enumInclude(merge_type_rule_js_1.KeepModuleAttr,i)?[...n]:this.mergeList(n,a,i,o),0!==l.length&&(e[i]=l)}handleMapMerge(e,t,r,i,s,o){let n=!0;"config"===s&&(n=!1,void 0===t.default&&void 0!==r.default&&(void 0===r.default.allowComponentsProxy?r.default=void 0:t.default={})),e[i]=this.mergeMap(t,r,n,i,o)}declareInputFiles(){const e=new hvigor_1.FileSet;return e.addEntry(this._moduleTargetRes.getJsonPath()),this._harLibs.forEach(t=>{fs.existsSync(t)&&e.addEntry(t)}),e}declareOutputFiles(){return(new hvigor_1.FileSet).addEntry(this._mergedModuleJson)}}exports.LegacyMergeProfile=LegacyMergeProfile;