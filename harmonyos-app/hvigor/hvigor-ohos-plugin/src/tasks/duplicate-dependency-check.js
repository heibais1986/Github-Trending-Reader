"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.DuplicateDependencyCheck=void 0;const hvigor_1=require("@ohos/hvigor"),task_names_js_1=require("./common/task-names.js"),ohos_app_task_js_1=require("./task/ohos-app-task.js");var CommonTask=task_names_js_1.TaskNames.CommonTask;const fs_extra_1=__importDefault(require("fs-extra")),os_1=__importDefault(require("os")),path_1=__importDefault(require("path")),ohos_plugin_id_js_1=require("../plugin/common/ohos-plugin-id.js"),har_plugin_js_1=require("../plugin/har-plugin.js"),hsp_plugin_js_1=require("../plugin/hsp-plugin.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),_log=ohos_logger_js_1.OhosLogger.getLogger("hvigor-duplicateDependencyCheck");class DuplicateDependencyCheck extends ohos_app_task_js_1.OhosAppTask{constructor(e,s){super(e,s,CommonTask.DUPLICATE_DEPENDENCY_CHECK),this.ohPackagePath=s.getProjectModel().getOhPackageJson5Path()}doTaskAction(){var e;if(!!!(null===(e=this.service.getBuildOption().strictMode)||void 0===e?void 0:e.duplicateDependencyCheck))return;const s=[],t=new Map,o=new Map,n=new Map,i=new Map;this.collectProjectDependencies(n),this.project.getSubModules().forEach(e=>{var s,t;const o=e.getPluginById(ohos_plugin_id_js_1.OhosPluginId.OHOS_HAR_PLUGIN);if(o&&o instanceof har_plugin_js_1.HarPlugin&&(null===(s=o.getTaskService())||void 0===s?void 0:s.getModuleModel().isHarModule())){const e=null===(t=o.getModuleModel())||void 0===t?void 0:t.getProjectDir();e&&n.get(e)&&i.set(e,n.get(e))}}),this.project.getSubModules().forEach(e=>{const s=e.getPluginById(ohos_plugin_id_js_1.OhosPluginId.OHOS_HSP_PLUGIN);if(!(s&&s instanceof hsp_plugin_js_1.HspPlugin))return;const n=s.getTaskService();if(!n)return;const a=e.getName();i.forEach((e,s)=>{o.has(s)||o.set(s,[]),o.get(s).push(a),t.set(s,e)}),n.getHarDependencies().forEach(e=>{const s=e.getDependencyRootPath();o.has(s)||o.set(s,[]),o.get(s).push(a),t.set(s,e.getPackageName())})}),o.forEach((e,o)=>{e.length<=1||s.push(`[${e.join(", ")}] depend on the same HAR [${t.get(o)}].`)}),s.length&&_log.printErrorExit("FOUND_HSPS_THAT_HAVE_THE_SAME_HAR_DEPENDENCIES",[s.length>1?"dependencies":"dependency",s.join(`${os_1.default.EOL}`)])}collectProjectDependencies(e){if(fs_extra_1.default.existsSync(this.ohPackagePath)){const s=(0,hvigor_1.parseJsonFile)(this.ohPackagePath);Object.keys(s.dependencies).forEach(t=>{const o=s.dependencies[t],n=/^file:(.*)/i.test(o)?/^file:(.*)/i.exec(o)[1]:o;if(!n)return;const i=path_1.default.resolve(this.project.getNodeDir(),n);fs_extra_1.default.existsSync(i)&&e.set(i,t)})}}initTaskDepends(){this.dependsOn(CommonTask.PRE_BUILD_APP.name)}}exports.DuplicateDependencyCheck=DuplicateDependencyCheck;