"use strict";var __decorate=this&&this.__decorate||function(e,t,s,o){var r,i=arguments.length,n=i<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,s):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,s,o);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(n=(i<3?r(n):i>3?r(t,s,n):r(t,s))||n);return i>3&&n&&Object.defineProperty(t,s,n),n},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ProcessResource=void 0;const hvigor_logger_1=require("@ohos/hvigor-logger"),fs_1=__importDefault(require("fs")),path_1=__importDefault(require("path")),hvigor_1=require("@ohos/hvigor"),hvigor_common_1=require("@ohos/hvigor-common"),fs_extra_1=__importDefault(require("fs-extra")),opt_compression_builder_js_1=require("../builder/opt-compression-builder.js"),build_directory_const_js_1=require("../const/build-directory-const.js"),common_const_js_1=require("../const/common-const.js"),inject_util_js_1=require("../utils/inject-util.js"),abstract_process_resource_js_1=require("./abstract/abstract-process-resource.js"),task_names_js_1=require("./common/task-names.js"),unit_test_process_profile_js_1=require("./unitTest/unit-test-process-profile.js");var Task=task_names_js_1.TaskNames.Task;const ohosTestTargetName=common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET,_log=hvigor_1.HvigorLogger.getLogger("process-resource");class ProcessResource extends abstract_process_resource_js_1.AbstractProcessResource{constructor(e){super(e,Task.PROCESS_RESOURCE),this.resConfigFilePath=path_1.default.resolve(this.outputDir,common_const_js_1.CommonConst.RES_CONFIG_FILE),this.optCompressionFilePath=path_1.default.resolve(this.outputDir,common_const_js_1.CommonConst.OPT_COMPRESSION_FILE),this.optCompressionBuilder=this.getOptCompressionBuilder()}initTaskDepends(){super.initTaskDepends(),inject_util_js_1.InjectUtil.isUnitTestProcess()&&this.declareDepends(unit_test_process_profile_js_1.UnitTestProcessProfile.name)}beforeTask(){super.beforeTask(),fs_extra_1.default.existsSync(this.optCompressionFilePath)&&fs_extra_1.default.removeSync(this.optCompressionFilePath)}declareInputs(){const e=super.declareInputs();return e.set(this.optCompressionFilePath,JSON.stringify(this.optCompressionBuilder.getOptCompressionObj())),e.set("resource_str",fs_extra_1.default.existsSync(path_1.default.resolve(this.pathInfo.getIntermediatesRes(),"resource_str"))),e}get ignoreResourcePattern(){var e;return null===(e=this.targetService.getBuildOption().resOptions)||void 0===e?void 0:e.ignoreResourcePattern}doTaskAction(){this.restoolConfigBuilder.addInputDir(this.pathInfo.getResourceStr(),build_directory_const_js_1.ResToolInputTypeConst.HAR);const e=this.optCompressionBuilder.getOptCompressionObj();fs_extra_1.default.outputJSONSync(this.optCompressionFilePath,e),this.restoolConfigBuilder.addCompression(this.optCompressionFilePath),this.restoolConfigBuilder.setResCompileThread(this.processResCompileThreads()),this.restoolConfigBuilder.setIgnoreResourcePattern(this.processIgnoreResourcePattern(this.ignoreResourcePattern)),super.doTaskAction()}declareOutputFiles(){const e=super.declareOutputFiles();return e.addEntry(this.optCompressionFilePath,{isDirectory:!1}),e}getAppResourceDir(){var e;const t=this.targetData.getProduct();return void 0!==t.resource&&0!==t.resource.directories.length?path_1.default.resolve(this.projectModel.getProjectDir(),null===(e=t.resource)||void 0===e?void 0:e.directories[0]):this.projectModel.getAppRes().getResourcePath()}initCommandBuilder(){(this.service.getModuleModel().isHapModule()||this.service.getModuleModel().isHspModule()||this.targetName===ohosTestTargetName)&&this.restoolConfigBuilder.addInputDir(this.getAppResourceDir(),"App");const e=this.projectModel.getAppRes().getAppResOpt().app.bundleName,t=path_1.default.resolve(this.pathInfo.getIntermediatesRes(),"ids_map");if(this.restoolConfigBuilder.addJsonFile(this.processedJson).addModulePackName(e).addOutputDir(this.outputDir).addResTable(path_1.default.resolve(this.pathInfo.getGenerateSourceR(),build_directory_const_js_1.BuildArtifactConst.RESOURCE_TABLE_H)).addIdsPath(t).addDefinedIds(path_1.default.resolve(t,"id_defined.json")),!this.sdkInfo.isOhos){const e=path_1.default.resolve(this.sdkInfo.getHosToolchainsDir(),"id_defined.json");fs_1.default.existsSync(e)&&this.restoolConfigBuilder.addDefinedSysIds(e)}this.isEnabledIconCheck()&&this.restoolConfigBuilder.setIconCheck(!0),this.targetData.getTargetName()===ohosTestTargetName&&(this.addOhosTestExtraCompilationResources(this.restoolConfigBuilder),this.addIntermediatesSrcResource(this.restoolConfigBuilder,this.moduleModel.getSourceRootByTargetName(ohosTestTargetName)))}getOptCompressionBuilder(){var e,t;const s=null===(e=this.targetService.getBuildOption().resOptions)||void 0===e?void 0:e.compression,o=this.targetData.isHarmonyOS()&&((null===(t=null==s?void 0:s.media)||void 0===t?void 0:t.enable)||Array.isArray(null==s?void 0:s.filters)&&s.filters.length>0)&&(this.service.getModuleModel().isHapModule()||this.service.getModuleModel().isHspModule()),r=new opt_compression_builder_js_1.OptCompressionBuilder;if(r.setExtensionPath(this.sdkInfo.getLibimageTranscoderShared()),o){const e=(0,hvigor_common_1.getOsLanguage)(),t=(0,hvigor_logger_1.getUrl)(hvigor_logger_1.DEVELOPER_URL),o="You have enabled the resource compression function, which will change the resource file name and data format. In some cases, you may experience problems with abnormal image displaying, in particular the disappearance of the layered launcher icon.\nYou can set the filter parameters to exclude these files, or to include the files you just need.\n";if(t){const s=`${t}/consumer/${e}/doc/harmonyos-guides-V5/ide-hvigor-build-profile-V5`;_log.warn(`${o}For details, see compression option in ${s}`)}else _log.warn(`${o}For details, go to the official website to see compression option in Guides > DevEco Studio > Building Your App/Atomic Service > Overview > Configuration Files > build-profile.json5`);const i=[...this.restoolConfigBuilder.getResourceDir(),this.getAppResourceDir()];r.setResourceDirArr(i).setCompressionConfig(s)}return r}}__decorate([(0,hvigor_1.Input)()],ProcessResource.prototype,"ignoreResourcePattern",null),exports.ProcessResource=ProcessResource;