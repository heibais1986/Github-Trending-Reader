"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,s){void 0===s&&(s=i);var r=Object.getOwnPropertyDescriptor(t,i);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,s,r)}:function(e,t,i,s){void 0===s&&(s=i),e[s]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ProcessLibs=void 0;const path_1=__importDefault(require("path")),hvigor_1=require("@ohos/hvigor"),fs=__importStar(require("fs-extra")),build_directory_const_js_1=require("../const/build-directory-const.js"),common_const_js_1=require("../const/common-const.js"),module_type_enum_js_1=require("../enum/module-type-enum.js"),dependency_manager_js_1=require("../project/dependency/dependency-manager.js"),cmake_util_js_1=require("../utils/cmake-util.js"),file_util_js_1=require("../utils/file-util.js"),har_target_util_js_1=require("../utils/har-target-util.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),build_native_with_ninja_js_1=require("./build-native-with-ninja.js"),process_libs_common_properties_js_1=require("./common-properties/process-libs-common-properties.js"),task_names_js_1=require("./common/task-names.js"),process_libs_js_1=require("./worker/process-libs.js");var Task=task_names_js_1.TaskNames.Task;class ProcessLibs extends process_libs_common_properties_js_1.ProcessLibsCommonProperties{taskShouldDo(){return this.moduleModel.isAtomicService()&&fs.ensureDirSync(this.pathInfo.getIntermediatesProcessLibs()),!this.moduleModel.isAtomicService()}async beforeAlwaysAction(){this.init(),this.service.isFaMode()&&(this.allHarLibs=this.getAllHarLibs(),this.libsWithPkg=this.getHarLibsWithPkg()),this.hasLocalNativeOutput&&this.localOutput&&(this.localOutputHash=await file_util_js_1.FileUtil.hashEntry(this.localOutput))}declareInputs(){var e;const t=super.declareInputs();return void 0!==this.filterRule&&Object.entries(this.filterRule).filter(([,e])=>!!e).forEach(([e,i])=>t.set(e,i)),this.hasLocalNativeOutput&&this.localOutputHash&&this.localOutputHash.forEach((e,i)=>{this.localOutput&&t.set(path_1.default.relative(this.localOutput,i),e)}),t.set("isBundledDependencies",this.isBundledDependencies).set("isByteCodeHar",this.targetService.isByteCodeHar()).set("excludeFromHar",null===(e=this.targetService.getNativeLibOption().excludeFromHar)||void 0===e||e),t}declareInputFiles(){const e=new hvigor_1.FileSet,t=path_1.default.resolve(this.moduleModel.getProjectDir(),build_directory_const_js_1.BuildDirConst.LIBS);fs.existsSync(t)&&e.addEntry(t,{isDirectory:!0});for(const t of this.allHarLibs.keys())fs.existsSync(t)&&e.addEntry(t);return fs.existsSync(this.projectModel.getProfilePath())&&e.addEntry(this.projectModel.getProfilePath()),fs.existsSync(this.moduleModel.getProfilePath())&&e.addEntry(this.moduleModel.getProfilePath()),this.cangjieLibs&&fs.existsSync(this.cangjieLibs)&&e.addEntry(this.cangjieLibs,{isDirectory:!0}),e}declareOutputFiles(){return this.libsOutputDir?(new hvigor_1.FileSet).addEntry(this.libsOutputDir,{isDirectory:!0}):new hvigor_1.FileSet}constructor(e){super(e,Task.PROCESS_LIB),this.logger=ohos_logger_js_1.OhosLogger.getLogger(ProcessLibs.name),this.allHarLibs=new Map,this.libsWithPkg=[]}init(){var e,t,i;const s=this.targetService,r=s.getTargetData().getPathInfo(),a=cmake_util_js_1.CmakeUtil.checkAbiFilters(null===(e=s.getBuildOption().externalNativeOptions)||void 0===e?void 0:e.abiFilters,s.getTargetData().isHarmonyOS(),this.moduleModel,this.targetName);this.collectAllLibs=!!(null===(t=s.getBuildOption().nativeLib)||void 0===t?void 0:t.collectAllLibs),this.allHarLibs=this.getAllHarLibs(),this.libsWithPkg=this.getHarLibsWithPkg(),this.libsOutputDir=r.getIntermediatesProcessLibs(),this.localOutput=r.getIntermediatesCppOutPut(),this._nativeOption=s.getBuildOption().externalNativeOptions,this.hasLocalNativeOutput=cmake_util_js_1.CmakeUtil.nativeTaskCondition(this.moduleModel,this.targetData,this._nativeOption),this.filterRule=s.getNativeLibOption().filter,this.readElf=s.getSdkInfo().getSdkLlvmReadElf(),this.compileCommandsPath=a.map(e=>path_1.default.resolve(r.getNinjaWorkDir(),e,common_const_js_1.CommonConst.COMPILE_COMMANDS_JSON)),this.hasLocalNativeOutput&&(this.nativeLibs=a.map(e=>cmake_util_js_1.CmakeUtil.parseLibraries(path_1.default.resolve(r.getNinjaWorkDir(),e),this.targetName,e))),this.cangjieLibs=path_1.default.resolve(r.getIntermediatesCangjieOutPut()),this.isHarType=this.moduleModel.getModuleType()===module_type_enum_js_1.ModuleType.Har,this.nativeOptionArg=null===(i=this._nativeOption)||void 0===i?void 0:i.arguments}get isBundledDependencies(){return this.targetService.isBundledDependencies()}initTaskDepends(){this.declareDepends(build_native_with_ninja_js_1.BuildNativeWithNinja.name)}async doTaskAction(){const e=this.service.getDependencyInfo().getSelfAsDependency(),t=path_1.default.resolve(this.moduleModel.getProjectDir(),"libs"),i=this.pathInfo.getIntermediatesCppOutPut();if(!this.libsOutputDir||!this.cangjieLibs)return void this.logger.warn("processLibs task error: this.libsOutputDir or this.cangjieLibs is undefined");const s={allHarLibs:this.libsWithPkg,outputDir:this.libsOutputDir,filterRule:this.filterRule,localLibs:(0,process_libs_js_1.buildLibs)(this.getLibsInfo(t),e,t),outputLibs:(0,process_libs_js_1.buildLibs)(this.getLibsInfo(i),e,i),profilePath:cmake_util_js_1.CmakeUtil.getMayBeOccurErrorsFilePath(this.moduleModel),moduleName:this.moduleName,cangjieLibs:(0,process_libs_js_1.buildLibs)(this.getLibsInfo(this.cangjieLibs),e,this.cangjieLibs),collectAllLibs:this.collectAllLibs,readElf:this.readElf,localOutputDir:this.localOutput,compileCommandsPath:this.compileCommandsPath,isHarType:this.isHarType,nativeOptionArg:this.nativeOptionArg,nativeLibs:this.nativeLibs},r="process libs",a=this.durationEvent.createSubEvent(r,"");a.start(),this.logger.debug("Worker dispatch failed, running processLibs on main thread."),await(0,process_libs_js_1.processLibs)(s),a.stop(),a.setLog(r,hvigor_1.MetricLogType.INFO)}getHarLibsWithPkg(){const e=[];for(const[t,i]of this.allHarLibs.entries())e.push(...(0,process_libs_js_1.buildLibs)(this.getLibsInfo(t),i,t));return e}getAllHarLibs(){const e=new Map;if(this.collectRemoteHarLibs(this.targetService,e),this.moduleModel.isHarModule()&&this.targetService.getTargetData().getTargetName()!==common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET)return this.isBundledDependencies?(this.service.getHarModuleDependencies().forEach(t=>{const i=har_target_util_js_1.HarTargetUtil.getHarTargetData(t,this.moduleModel,this.targetService.getTargetData().getTargetName(),this.moduleName,this.targetService),s=dependency_manager_js_1.DependencyManager.getModuleModelByDependency(t[1],this.projectModel);if(s){const t=this.projectModel.getTarget(null==s?void 0:s.getName(),i);this.collectLocalHarLibs(t,e)}}),e):e;const t=har_target_util_js_1.HarTargetUtil.calDepHarTargets(this.targetService);for(const[i,s]of t){const t=this.projectModel.getTarget(i,s);this.collectLocalHarLibs(t,e)}return e}collectLocalHarLibs(e,t){if(e){const i=e.getTargetData().getPathInfo().getIntermediatesProcessLibs(),s=e.getModuleService().getDependencyInfo().getSelfAsDependency();t.set(i,s),t.set(s.getDefaultLibsDir(),s)}}collectRemoteHarLibs(e,t){this.service.getRemoteHarDependencies().forEach(e=>{if(this.isBundledDependencies){if(e.isByteCodeHarDependency())return;t.set(e.getDefaultLibsDir(),e)}else{if(this.moduleModel.isHarModule()&&this.targetService.getTargetData().getTargetName()!==common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET)return;t.set(e.getDefaultLibsDir(),e)}})}}exports.ProcessLibs=ProcessLibs;