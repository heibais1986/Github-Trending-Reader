"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,s){void 0===s&&(s=r);var o=Object.getOwnPropertyDescriptor(t,r);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,s,o)}:function(e,t,r,s){void 0===s&&(s=r),e[s]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__decorate=this&&this.__decorate||function(e,t,r,s){var o,i=arguments.length,a=i<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,r):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,s);else for(var n=e.length-1;n>=0;n--)(o=e[n])&&(a=(i<3?o(a):i>3?o(t,r,a):o(t,r))||a);return i>3&&a&&Object.defineProperty(t,r,a),a},__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ProcessStartupConfig=void 0;const path=__importStar(require("path")),hvigor_1=require("@ohos/hvigor"),fse=__importStar(require("fs-extra")),common_util_js_1=require("../common/common-util.js"),module_option_path_info_js_1=require("../common/module-option-path-info.js"),build_directory_const_js_1=require("../const/build-directory-const.js"),common_const_js_1=require("../const/common-const.js"),module_type_enum_js_1=require("../enum/module-type-enum.js"),dependency_manager_js_1=require("../project/dependency/dependency-manager.js"),dependency_util_js_1=require("../utils/dependency-util.js"),json_util_js_1=require("../utils/json-util.js"),res_model_loader_js_1=require("../utils/loader/file/res-model-loader.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),ohmurl_utils_js_1=require("../utils/ohmurl-utils.js"),validate_util_js_1=require("../utils/validate/validate-util.js"),task_names_js_1=require("./common/task-names.js"),ohos_hap_task_js_1=require("./task/ohos-hap-task.js"),_log=ohos_logger_js_1.OhosLogger.getLogger("hvigor-processStartupConfig");class ProcessStartupConfig extends ohos_hap_task_js_1.OhosHapTask{constructor(e){super(e,task_names_js_1.TaskNames.Task.PROCESS_STARTUP_CONFIG);const t=e.getTargetData().getModuleSourceSetModel().getModuleTargetRes();this.targetJsonPath=t.getJsonPath()}get useNormalizedOHMUrl(){var e,t;return!!(null===(t=null===(e=this.targetService.getBuildOption())||void 0===e?void 0:e.strictMode)||void 0===t?void 0:t.useNormalizedOHMUrl)}declareInputs(){var e;const t=super.declareInputs();t.set("appStartupFileName",null!==(e=this.appStartupFileName)&&void 0!==e?e:"");const r=this.moduleModel.getModuleType();if(r===module_type_enum_js_1.ModuleType.Har&&(t.set("isBundledDependencies",this.targetService.isBundledDependencies()),t.set("isByteCodeHar",this.targetService.isByteCodeHar())),r!==module_type_enum_js_1.ModuleType.Har||this.targetService.isBundledDependencies()){const e=this.service.getHarDependencies();for(let r=0;r<e.length;r++){const s=e[r];if(!s.isLocal())continue;const[o]=this.getLocalHarDepStartupConfig(s);t.set(s.getDependencyName(),null!=o?o:"")}}return t}declareInputFiles(){const e=super.declareInputFiles();this.appStartupPath&&fse.existsSync(this.appStartupPath)&&e.addEntry(this.appStartupPath);if(this.moduleModel.getModuleType()!==module_type_enum_js_1.ModuleType.Har||this.targetService.isBundledDependencies()){const t=this.service.getHarDependencies();for(let r=0;r<t.length;r++){const s=t[r];if(!s.isLocal())continue;const[,o]=this.getLocalHarDepStartupConfig(s);o&&fse.existsSync(o)&&e.addEntry(o)}}return fse.existsSync(this.pathInfo.getIntermediatesPkgContextInfoPath())&&e.addEntry(this.pathInfo.getIntermediatesPkgContextInfoPath()),e}declareOutputFiles(){return super.declareOutputFiles().addEntry(this.intermediateTempStartupFilePath)}doTaskAction(){this.appStartupValidate(),this.checkAppStartupConfig()}initTaskDepends(){}appStartupValidate(){if(this.checkResReferenceConfig(common_const_js_1.CommonConst.APP_STARTUP),!this.appStartupPath||!fse.existsSync(this.appStartupPath))return;let e=this.sdkInfo.getAppStartupSchema();const t=this.moduleModel.getModuleType();t===module_type_enum_js_1.ModuleType.Shared&&(e=this.sdkInfo.getHspStartupSchema()),t===module_type_enum_js_1.ModuleType.Har&&(e=this.sdkInfo.getHarStartupSchema()),validate_util_js_1.ValidateUtil.submitSchemaCheckWork({moduleName:this.moduleName,filePath:this.appStartupPath,schemaPath:e})}checkAppStartupConfig(){const e=this.appStartupPath,t=this.moduleModel.getModuleType(),r=this.pathInfo.getIntermediatesPkgContextInfoPath(),s=(0,json_util_js_1.getJson5Obj)(r);if(void 0!==e&&fse.existsSync(e)&&this.processModuleStartupConfig(e,s,t),t!==module_type_enum_js_1.ModuleType.Har||this.targetService.isBundledDependencies()){const e=this.service.getHarDependencies();for(let t=0;t<e.length;t++){const r=e[t];r.isLocal()?this.processLocalHarDependency(r,s):this.processRemoteHarDependency(r,s)}}void 0!==this.startupMergedOptions?(this.checkStartupTaskName(this.startupMergedOptions.startupTasks,"startupTask"),this.checkStartupTaskName(this.startupMergedOptions.appPreloadHintStartupTasks,"appPreloadHintStartupTask"),fse.ensureFileSync(this.intermediateTempStartupFilePath),fse.writeFileSync(this.intermediateTempStartupFilePath,JSON.stringify(this.startupMergedOptions))):fse.existsSync(this.intermediateTempStartupFilePath)&&fse.removeSync(this.intermediateTempStartupFilePath)}checkResReferenceConfig(e){const t=res_model_loader_js_1.resModelLoader.getModuleJson(this.targetJsonPath).module[e];if(!t)return;const r=(0,common_util_js_1.parsingProfileName)(t);if(!r)return;const s=module_option_path_info_js_1.moduleOptionPathInfo.getModuleOptPath(this.targetJsonPath,e),o=this.targetService.getTargetResourceBaseProfilePath(`${r}.json`);o&&fse.existsSync(o)||_log.printErrorExit("STARTUP_CONFIG_FILE_NOT_EXIST",[this.moduleName,s],[[o]])}processLocalHarDependency(e,t){const r=dependency_manager_js_1.DependencyManager.getModuleModelByDependency(e,this.projectModel);if(void 0===r)return;const s=r.getModule().getName(),[o,i]=this.getLocalHarDepStartupConfig(e);if(!o||!i)return;const a=(0,json_util_js_1.getJson5Obj)(i);void 0!==a.startupTasks&&a.startupTasks.forEach(t=>{this.checkStartupPath(i,t.srcEntry,null==r?void 0:r.getModule().getNodeDir(),s),t.srcEntryAbsolutePath=path.resolve(null==r?void 0:r.getModule().getNodeDir(),common_const_js_1.CommonConst.SRC_MAIN,t.srcEntry),t.moduleName=s,t.startupConfigPath=i,t.ohmurl=(0,ohmurl_utils_js_1.generateOhmurlForSrcEntry)(this.targetService,this.moduleName,e,t.srcEntry)}),void 0!==a.appPreloadHintStartupTasks&&a.appPreloadHintStartupTasks.forEach(e=>{var r;this.checkAppPreloadHintStartupTaskPath(i,e.srcEntry,s,t),e.moduleName=s,e.startupConfigPath=i;const o=path.basename(e.srcEntry);e.ohmurl=this.useNormalizedOHMUrl?(0,ohmurl_utils_js_1.generateOhmUrlForSo)(null!==(r=t[o])&&void 0!==r?r:{},e.srcEntry):(0,ohmurl_utils_js_1.generateOldOhmUrlForSo)(this.targetService,e.srcEntry,this.moduleName)}),void 0===this.startupMergedOptions?this.startupMergedOptions=a:(this.startupMergedOptions.startupTasks=[...this.startupMergedOptions.startupTasks||[],...a.startupTasks||[]],this.startupMergedOptions.appPreloadHintStartupTasks=[...this.startupMergedOptions.appPreloadHintStartupTasks||[],...a.appPreloadHintStartupTasks||[]])}getLocalHarDepStartupConfig(e){if(void 0===dependency_manager_js_1.DependencyManager.getModuleModelByDependency(e,this.projectModel))return[void 0,void 0];const t=e.getModuleJsonObj();if(void 0===t)return[void 0,void 0];const r=t.module.appStartup;if(void 0===r)return[void 0,void 0];const s=(0,common_util_js_1.parsingProfileName)(r);if(void 0===s)return[void 0,void 0];return[s,this.getLocalHarDepStartupFile(this.targetService,e,this.projectModel,s)]}getLocalHarDepStartupFile(e,t,r,s){const o=(0,dependency_util_js_1.getLocalDepHarTargetSources)(e,t,r);for(const e of o){const t=path.resolve(e,common_const_js_1.CommonConst.BASE_PROFILE,`${s}.json`);if(fse.existsSync(t))return t}}processRemoteHarDependency(e,t){var r,s,o;const i=path.resolve(e.getDependencyRootPath(),build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN),a=dependency_manager_js_1.DependencyManager.getModuleObjByRemoteDependency(e),n=null!==(r=(0,common_util_js_1.parsingProfileName)(a.module.appStartup))&&void 0!==r?r:void 0;if(!n)return;const u=this.getRemoteHarDepStartupFile(e,n);if(!u)return;const l=(0,json_util_js_1.getJson5Obj)(u);null===(s=l.startupTasks)||void 0===s||s.forEach(t=>{t.srcEntryAbsolutePath=path.resolve(i,t.srcEntry),t.moduleName=a.module.name,t.startupConfigPath=u,t.ohmurl=(0,ohmurl_utils_js_1.generateOhmurlForSrcEntry)(this.targetService,this.moduleName,e,t.srcEntry)}),null===(o=l.appPreloadHintStartupTasks)||void 0===o||o.forEach(r=>{var s;r.moduleName=a.module.name,r.startupConfigPath=u,r.isRemoteByteCodeHar=e.isByteCodeHarDependency();const o=path.basename(r.srcEntry);r.ohmurl=this.useNormalizedOHMUrl?(0,ohmurl_utils_js_1.generateOhmUrlForSo)(null!==(s=t[o])&&void 0!==s?s:{},r.srcEntry):(0,ohmurl_utils_js_1.generateOldOhmUrlForSo)(this.targetService,r.srcEntry,this.moduleName)}),void 0===this.startupMergedOptions?this.startupMergedOptions=l:(this.startupMergedOptions.startupTasks=[...this.startupMergedOptions.startupTasks||[],...l.startupTasks||[]],this.startupMergedOptions.appPreloadHintStartupTasks=[...this.startupMergedOptions.appPreloadHintStartupTasks||[],...l.appPreloadHintStartupTasks||[]])}getRemoteHarDepStartupFile(e,t){const r=(0,dependency_util_js_1.getRemoteDepHarTargetSources)(e);for(const e of r){const r=path.resolve(e,common_const_js_1.CommonConst.BASE_PROFILE,`${t}.json`);if(fse.existsSync(r))return r}}processModuleStartupConfig(e,t,r){const s=(0,json_util_js_1.getJson5Obj)(e);void 0!==(null==s?void 0:s.startupTasks)&&s.startupTasks.forEach(s=>{var o;this.checkStartupPath(e,s.srcEntry,this.moduleModel.getModule().getNodeDir(),this.moduleName);const i=path.resolve(this.module.getNodeDir(),build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN);s.srcEntryAbsolutePath=path.resolve(i,s.srcEntry),s.moduleName=this.moduleName,s.startupConfigPath=e,(this.targetService.isByteCodeHar()||r!==module_type_enum_js_1.ModuleType.Har)&&(s.ohmurl=this.useNormalizedOHMUrl?(0,ohmurl_utils_js_1.generateOhmUrlForSourceFile)(null!==(o=t[this.packageJsonObj.name])&&void 0!==o?o:{},path.join(build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN,s.srcEntry)):(0,ohmurl_utils_js_1.getOldOhmUrlForSrcEntry)(this.targetService,s.srcEntry,this.moduleName))}),void 0!==(null==s?void 0:s.appPreloadHintStartupTasks)&&s.appPreloadHintStartupTasks.forEach(s=>{var o;if(this.checkAppPreloadHintStartupTaskPath(e,s.srcEntry,this.moduleName,t),s.moduleName=this.moduleName,s.startupConfigPath=e,this.targetService.isByteCodeHar()||r!==module_type_enum_js_1.ModuleType.Har){const e=path.basename(s.srcEntry);s.ohmurl=this.useNormalizedOHMUrl?(0,ohmurl_utils_js_1.generateOhmUrlForSo)(null!==(o=t[e])&&void 0!==o?o:{},s.srcEntry):(0,ohmurl_utils_js_1.generateOldOhmUrlForSo)(this.targetService,s.srcEntry,this.moduleName)}}),void 0!==(null==s?void 0:s.configEntry)&&this.checkStartupPath(e,s.configEntry,this.moduleModel.getModule().getNodeDir(),this.moduleName),void 0!==s&&(this.startupMergedOptions=s)}checkStartupPath(e,t,r,s){if(void 0===t)return;const o=path.resolve(r,build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN,t);path.isAbsolute(t)&&_log.printErrorExit("STARTUP_SRCENTRY_IS_ABSOLUTE",[t,s,e],[]),common_const_js_1.ValidateRegExp.STARTUP_TASK_SRC_ENTRY_REG_EXP.test(path.extname(o))||_log.printErrorExit("STARTUP_SRCENTRY_SUFFIX",[t,s,e],[]),o.startsWith(r)||_log.printErrorExit("STARTUP_SRCENTRY_MODULE_FILE",[t,s,e],[]),fse.existsSync(o)||_log.printErrorExit("STARTUP_SRCENTRY_FILE_EXIST",[t,s,e],[])}checkAppPreloadHintStartupTaskPath(e,t,r,s){if(common_const_js_1.ValidateRegExp.PRELOAD_STARTUP_TASK_SRC_ENTRY_REG_EXP.test(t)||_log.printErrorExit("APP_PRELOAD_STARTUP_SRCENTRY_SUFFIX",[t,r,e],[]),this.useNormalizedOHMUrl&&s){Object.keys(s).includes(path.basename(t))||_log.printErrorExit("STARTUP_SO_FILE_EXIST",[t,r,e],[[t]])}}checkStartupTaskName(e,t){if(!e||e.length<=1)return;const r=new Set;for(let s=0;s<e.length;s++){const o=e[s].name;r.has(o)?_log.printErrorExit("STARTUP_TASK_NAME_UNIQUE",[o,t,e[s].moduleName],[[t,e[s].moduleName,o]]):r.add(o)}}}__decorate([(0,hvigor_1.Input)()],ProcessStartupConfig.prototype,"useNormalizedOHMUrl",null),exports.ProcessStartupConfig=ProcessStartupConfig;