"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.getObfuscationOptionsWithCache=void 0;const fs_1=__importDefault(require("fs")),path_1=__importDefault(require("path")),build_mode_manager_js_1=require("../../project/build-option/build-mode-manager.js"),dependency_interface_js_1=require("../../project/dependency/core/dependency-interface.js"),har_target_util_js_1=require("../../utils/har-target-util.js"),hsp_target_utils_js_1=require("../../utils/hsp-target-utils.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),_log=ohos_logger_js_1.OhosLogger.getLogger("obfuscation"),getObfuscationOptionsWithCache=async(e,t,o)=>{var s,r,i;const n=e.getTargetData().getModuleModel();if(!t)return;const l=process.hrtime.bigint(),a=walkFromTree(e.getModuleService().getDependencyInfo().getModulePkgNode(),e);_log.debug(`Resolve obfuscation options tasks ${(process.hrtime.bigint()-l)/BigInt(1e6)} ms.`);const u=n.getModule();return t.ruleOptions={enable:null===(s=t.ruleOptions)||void 0===s?void 0:s.enable,rules:(null===(r=t.ruleOptions)||void 0===r?void 0:r.rules)||transformRules(null===(i=t.ruleOptions)||void 0===i?void 0:i.files,n.getProjectDir(),u.getName(),u.getBuildProfilePath())},t.consumerRules=t.consumerRules||transformRules(t.consumerFiles,n.getProjectDir(),u.getName(),u.getBuildProfilePath()),{selfConfig:t,sdkApis:[],obfuscationCacheDir:o,exportRulePath:e.getTargetData().getPathInfo().getObfuscationExportRulePath(),dependencies:a}};exports.getObfuscationOptionsWithCache=getObfuscationOptionsWithCache;const walkFromTree=(e,t)=>{const o=[...e.children],s=new Set,r={libraries:[],hars:[],hspLibraries:[],hsps:[]},i=har_target_util_js_1.HarTargetUtil.calDepHarTargets(t),n=hsp_target_utils_js_1.HspTargetUtils.calDepHspTargets(t);for(;o.length>0;){const e=o.shift();s.has(e.modulePkgJsonPath)||(e.npm.isLocal()?collectLocalConfigs(e,r,o,i,n):collectRemoteFiles(e,r),s.add(e.modulePkgJsonPath))}return r},collectLocalConfigs=(e,t,o,s,r)=>{var i,n,l,a;if(!e.module)return;const u=e.module.getDependencyType();if(u!==dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HAR&&u!==dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HSP)return;const c=u===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HAR,d=c?"libraries":"hspLibraries",p=c?s.get(e.moduleName):null===(i=r.get(e.moduleName))||void 0===i?void 0:i.getTargetName(),g=null===(n=build_mode_manager_js_1.buildOptionManager.getTargetBuildOption(e.module.getModuleName(),null!=p?p:"default").arkOptions)||void 0===n?void 0:n.obfuscation;if(g){const o=e.module.getModule(),s=e.module.getDependencyRootPath(),r={ruleOptions:{enable:null===(l=g.ruleOptions)||void 0===l?void 0:l.enable,rules:transformRules(null===(a=g.ruleOptions)||void 0===a?void 0:a.files,s,o.getName(),o.getBuildProfilePath())},consumerRules:transformRules(g.consumerFiles,s,o.getName(),o.getBuildProfilePath()),libDir:s};t[d].push(r)}c&&o.push(...e.children)},collectRemoteFiles=(e,t)=>{const o=path_1.default.resolve(e.npm.getDependencyRootPath(),"obfuscation.txt");fs_1.default.existsSync(o)&&("har"===e.npm.getDependencyType()&&t.hars.push(o),"hsp"===e.npm.getDependencyType()&&t.hsps.push(o))},transformRules=(e,t,o,s)=>{if(!e)return[];const r=[];return"string"==typeof e?(checkObFile(e,t,r,o,s),r):(e.forEach(e=>checkObFile(e,t,r,o,s)),r)},checkObFile=(e,t,o,s,r)=>{const i=path_1.default.resolve(t,e);fs_1.default.existsSync(i)||_log.printErrorExit("OBFUSCATION_FILE_LOST",[e,i,s,r],[[e,i]]),o.push(i)};