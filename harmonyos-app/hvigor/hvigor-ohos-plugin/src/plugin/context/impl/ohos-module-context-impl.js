"use strict";var __decorate=this&&this.__decorate||function(e,o,t,l){var r,i=arguments.length,d=i<3?o:null===l?l=Object.getOwnPropertyDescriptor(o,t):l;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)d=Reflect.decorate(e,o,t,l);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(d=(i<3?r(d):i>3?r(o,t,d):r(o,t))||d);return i>3&&d&&Object.defineProperty(o,t,d),d},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.OhosModuleContextImpl=void 0;const path_1=__importDefault(require("path")),wdk_1=require("@baize/wdk"),hvigor_1=require("@ohos/hvigor"),fs_extra_1=__importDefault(require("fs-extra")),build_option_path_info_js_1=require("../../../common/build-option-path-info.js"),core_project_profile_js_1=require("../../../common/global/core-project-profile.js"),module_option_path_info_js_1=require("../../../common/module-option-path-info.js"),ohos_trace_js_1=require("../../../common/trace/ohos-trace.js"),common_const_js_1=require("../../../const/common-const.js"),build_mode_manager_js_1=require("../../../project/build-option/build-mode-manager.js"),inject_util_js_1=require("../../../utils/inject-util.js"),har_module_build_profile_loader_js_1=require("../../../utils/loader/file/har-module-build-profile-loader.js"),module_build_profile_loader_js_1=require("../../../utils/loader/file/module-build-profile-loader.js"),oh_package_loader_js_1=require("../../../utils/loader/file/oh-package-loader.js"),res_model_loader_js_1=require("../../../utils/loader/file/res-model-loader.js"),ohos_logger_js_1=require("../../../utils/log/ohos-logger.js");class OhosModuleContextImpl{constructor(e){var o;this.logger=ohos_logger_js_1.OhosLogger.getLogger(OhosModuleContextImpl.name),this.modulePlugin=e,this.taskService=this.modulePlugin.getTaskService(),this.targetArr=this.taskService.getTargets(),this.moduleOhPackagePath=null===(o=this.modulePlugin.getModuleModel())||void 0===o?void 0:o.getOhPackageJson5Path()}targets(e){this.targetArr.forEach(o=>e(o))}getModuleName(){return this.modulePlugin.getModuleModel().getModule().getName()}getModulePath(){return this.modulePlugin.getModuleModel().getModule().getNodeDir()}getModuleType(){return this.modulePlugin.getModuleModel().getModuleType()}getBuildProductRootPath(){return path_1.default.resolve(inject_util_js_1.InjectUtil.getModuleBuildRootPath(this.getModulePath()),this.getModulePath())}getOhpmDependencyInfo(){return this.taskService.getOhpmDependencyInfo()}getOhpmRemoteHspDependencyInfo(e=!1){const o=this.taskService.getProjectModel().getProject().getNodeDir(),t=core_project_profile_js_1.CoreProjectProfile.getInstance(o).getCurrentProductOpt();return this.taskService.getOhpmRemoteHspDependencies(this.taskService,t.name,e)}getBuildProfileOpt(){return(0,wdk_1.cloneDeep)(this.taskService.getModuleModel().isHarModule()?har_module_build_profile_loader_js_1.harModuleBuildProfileLoader.getBuildProfile(this.getModuleName()):module_build_profile_loader_js_1.moduleBuildProfileLoader.getBuildProfile(this.getModuleName()))}getModuleJsonOpt(){const e=path_1.default.resolve(this.taskService.getProjectModel().getProjectDir(),this.getModulePath(),`src/main/${common_const_js_1.CommonConst.MODULE_JSON5}`);return(0,wdk_1.cloneDeep)(res_model_loader_js_1.resModelLoader.getModuleJson(e))}setBuildProfileOpt(e){var o;this.taskService.isFaMode()&&this.logger.printErrorExit("FA_MODE_NOT_SUPPORT_MODIFY_FILE",["buildProfile"]),this.taskService.getModuleModel().isHarModule()?har_module_build_profile_loader_js_1.harModuleBuildProfileLoader.setBuildProfileJson5Obj(this.getModuleName(),e):module_build_profile_loader_js_1.moduleBuildProfileLoader.setBuildProfileJson5Obj(this.getModuleName(),e),null===(o=this.modulePlugin.getModuleModel())||void 0===o||o.refreshData(),this.modulePlugin.initBuildOptionMap((0,build_option_path_info_js_1.getHookFilePath)()),this.modulePlugin.refreshTargetServiceList()}setModuleJsonOpt(e){this.taskService.isFaMode()&&this.logger.printErrorExit("FA_MODE_NOT_SUPPORT_MODIFY_FILE",["module.json5"]);const o=path_1.default.resolve(this.taskService.getProjectModel().getProjectDir(),this.getModulePath(),`src/main/${common_const_js_1.CommonConst.MODULE_JSON5}`);res_model_loader_js_1.resModelLoader.setModuleJson(o,e),module_option_path_info_js_1.moduleOptionPathInfo.setModuleOptPathMap(o,null==e?void 0:e.module,(0,build_option_path_info_js_1.getHookFilePath)())}getDependenciesOpt(){return(0,wdk_1.cloneDeep)(oh_package_loader_js_1.ohPackageLoader.getDependenciesOpt(this.moduleOhPackagePath))}getDevDependenciesOpt(){return(0,wdk_1.cloneDeep)(oh_package_loader_js_1.ohPackageLoader.getDevDependenciesOpt(this.moduleOhPackagePath))}getDynamicDependenciesOpt(){return(0,wdk_1.cloneDeep)(oh_package_loader_js_1.ohPackageLoader.getDynamicDependenciesOpt(this.moduleOhPackagePath))}setDependenciesOpt(e){oh_package_loader_js_1.ohPackageLoader.setDependenciesOpt(this.moduleOhPackagePath,e)}setDevDependenciesOpt(e){oh_package_loader_js_1.ohPackageLoader.setDevDependenciesOpt(this.moduleOhPackagePath,e)}setDynamicDependenciesOpt(e){oh_package_loader_js_1.ohPackageLoader.setDynamicDependenciesOpt(this.moduleOhPackagePath,e)}getVersion(){return oh_package_loader_js_1.ohPackageLoader.getVersion(this.moduleOhPackagePath)}setVersion(e){oh_package_loader_js_1.ohPackageLoader.setVersion(this.moduleOhPackagePath,e)}loadCompilePlugin(e){var o,t;ohos_trace_js_1.ohosTrace.traceIsUseCompilePlugin(null===(o=this.modulePlugin.getModuleModel())||void 0===o?void 0:o.getName()),e&&!path_1.default.isAbsolute(e)||this.logger.printErrorExit("IS_NOT_RELATIVE_PATH",[e]);const l=path_1.default.resolve(this.modulePlugin.getModuleModel().getModule().getNodeDir(),e);fs_extra_1.default.existsSync(l)||this.logger.printErrorExit("PLUGIN_PATH_NOT_FOUND",[l]),l.endsWith(".ts")||this.logger.printErrorExit("PLUGIN_FILE_MUST_END_WITH_TS",[l]),(0,hvigor_1.doCompilePluginTypeCheck)(l),null===(t=this.modulePlugin.getModuleModel())||void 0===t||t.setCompilePluginPath(l)}getBuildMode(){return build_mode_manager_js_1.BuildModeManager.getBuildMode()}}__decorate([hvigor_1.TrackAPI],OhosModuleContextImpl.prototype,"targets",null),__decorate([hvigor_1.TrackAPI],OhosModuleContextImpl.prototype,"getModuleName",null),__decorate([hvigor_1.TrackAPI],OhosModuleContextImpl.prototype,"getModulePath",null),__decorate([hvigor_1.TrackAPI],OhosModuleContextImpl.prototype,"getModuleType",null),__decorate([hvigor_1.TrackAPI],OhosModuleContextImpl.prototype,"getBuildProductRootPath",null),__decorate([hvigor_1.TrackAPI],OhosModuleContextImpl.prototype,"getOhpmDependencyInfo",null),__decorate([hvigor_1.TrackAPI],OhosModuleContextImpl.prototype,"getOhpmRemoteHspDependencyInfo",null),__decorate([hvigor_1.TrackAPI],OhosModuleContextImpl.prototype,"getBuildProfileOpt",null),__decorate([hvigor_1.TrackAPI],OhosModuleContextImpl.prototype,"getModuleJsonOpt",null),__decorate([hvigor_1.TrackAPI],OhosModuleContextImpl.prototype,"setBuildProfileOpt",null),__decorate([hvigor_1.TrackAPI],OhosModuleContextImpl.prototype,"setModuleJsonOpt",null),__decorate([hvigor_1.TrackAPI],OhosModuleContextImpl.prototype,"getDependenciesOpt",null),__decorate([hvigor_1.TrackAPI],OhosModuleContextImpl.prototype,"getDevDependenciesOpt",null),__decorate([hvigor_1.TrackAPI],OhosModuleContextImpl.prototype,"getDynamicDependenciesOpt",null),__decorate([hvigor_1.TrackAPI],OhosModuleContextImpl.prototype,"setDependenciesOpt",null),__decorate([hvigor_1.TrackAPI],OhosModuleContextImpl.prototype,"setDevDependenciesOpt",null),__decorate([hvigor_1.TrackAPI],OhosModuleContextImpl.prototype,"setDynamicDependenciesOpt",null),__decorate([hvigor_1.TrackAPI],OhosModuleContextImpl.prototype,"getVersion",null),__decorate([hvigor_1.TrackAPI],OhosModuleContextImpl.prototype,"setVersion",null),__decorate([hvigor_1.TrackAPI],OhosModuleContextImpl.prototype,"loadCompilePlugin",null),__decorate([hvigor_1.TrackAPI],OhosModuleContextImpl.prototype,"getBuildMode",null),exports.OhosModuleContextImpl=OhosModuleContextImpl;