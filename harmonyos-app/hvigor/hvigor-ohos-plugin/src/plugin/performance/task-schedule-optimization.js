"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.CompileDependencyCalculator=void 0;const hvigor_1=require("@ohos/hvigor"),ohos_logger_1=require("../../utils/log/ohos-logger");class CompileDependencyCalculator{constructor(e){this.project=e,this.visitedTasks=new Set,this.currentSubModuleNode=void 0,this._log=ohos_logger_1.OhosLogger.getLogger(CompileDependencyCalculator.name)}computeAndSetCompileDependencies(){for(const e of this.project.getSubModules().values()){this.currentSubModuleNode=e;const s=this.extractCompileTasks(e);0!==s.length&&this.processTaskQueue([...s])}const e=["clean",...this.processVisitedTasks()];hvigor_1.hvigorCore.setCompileDependArr(e)}extractCompileTasks(e){return e.getTaskContainer().getTaskPaths().filter(e=>e.includes("CompileArkTS"))}processTaskQueue(e){for(;e.length>0;){const s=e.shift();this.visitedTasks.has(s)||(this.visitedTasks.add(s),this.addTaskDependenciesToQueue(e,s))}}addTaskDependenciesToQueue(e,s){const t=this.getSafeTaskDependencies(s);null==t||t.forEach(s=>{this.visitedTasks.has(s)||e.push(s)})}getSafeTaskDependencies(e){var s,t;try{return(null===(t=null===(s=this.currentSubModuleNode)||void 0===s?void 0:s.getTaskDepends(e))||void 0===t?void 0:t.map(e=>e.includes(":")?e.split(":")[1]:e))||[]}catch(s){return this._log.debug(`Failed to get task dependencies giving the task path: "${e}"`),[]}}processVisitedTasks(){return Array.from(this.visitedTasks).map(e=>e.includes("@")?e.split("@")[1]:e)}}exports.CompileDependencyCalculator=CompileDependencyCalculator;