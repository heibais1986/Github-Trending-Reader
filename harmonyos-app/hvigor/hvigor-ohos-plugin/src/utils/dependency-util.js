"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.getLocalDependencyRouterMap=exports.getRemoteDepHarTargetSources=exports.getLocalDepHarTargetSources=exports.getDependenciesWithoutHar=exports.minimizeHspDependencies=exports.getJson5Obj=void 0;const fs_1=__importDefault(require("fs")),path_1=__importDefault(require("path")),hvigor_1=require("@ohos/hvigor"),common_const_js_1=require("../const/common-const.js"),dependency_interface_js_1=require("../project/dependency/core/dependency-interface.js"),dependency_manager_js_1=require("../project/dependency/dependency-manager.js"),file_util_js_1=require("./file-util.js"),har_target_util_js_1=require("./har-target-util.js"),parameter_utils_js_1=require("./parameter-utils.js"),json5Map=hvigor_1.hvigorCore.getCache("JSON_CACHE");function getJson5Obj(e){var t;const n=fs_1.default.statSync(e).mtime.getTime();return(null===(t=json5Map.get(e))||void 0===t?void 0:t.timeStamp)!==n&&json5Map.set(e,{timeStamp:n,fileContent:hvigor_1.Json5Reader.getJson5Obj(e)}),json5Map.get(e).fileContent}function minimizeHspDependencies(e,t,n){(0,parameter_utils_js_1.getPropertyKeepDependency)()||(e.dependencies=getDependenciesWithoutHar(dependency_interface_js_1.DependencyEnum.DEPENDENCIES,t,n),e.dynamicDependencies=getDependenciesWithoutHar(dependency_interface_js_1.DependencyEnum.DYNAMIC_DEPENDENCIES,t,n),e.devDependencies&&delete e.devDependencies)}function getDependenciesWithoutHar(e,t,n){const r={},o=t.getHspDependencies().filter(t=>t.getDependencyEnum()===e);if(0===o.length)return{};const s={parameterFilePath:t.getProjectModel().getParameterFileAbsolutePath(),ohPackageFilePath:n};return o.forEach(e=>{const n=e.getDependencyName();r[n]=file_util_js_1.FileUtil.extracted(e.getDependedVersion(),t.getModuleModel().getParentProject().getParameterFileObj(),s)}),r}function getLocalDepHarTargetSources(e,t,n){var r;const o=[],s=har_target_util_js_1.HarTargetUtil.calDepHarTargets(e),a=dependency_manager_js_1.DependencyManager.getModuleModelByDependency(t,n),i=null==a?void 0:a.getModule().getNodeDir(),c=null==a?void 0:a.getModule().getName(),d=c?s.get(c):"default",p=null==a?void 0:a.getTargetOptions().filter(e=>e.name===d),l=p?null===(r=p[0].resource)||void 0===r?void 0:r.directories:void 0;if((null==l?void 0:l.length)&&i&&l.forEach(e=>{const t=path_1.default.resolve(i,e);fs_1.default.existsSync(t)&&(null==o||o.push(t))}),!(null==l?void 0:l.length)&&i){const e=path_1.default.resolve(i,common_const_js_1.CommonConst.SRC_MAIN_RESOURCES);fs_1.default.existsSync(e)&&(null==o||o.push(e))}return o}function getRemoteDepHarTargetSources(e){var t,n;const r=[],o=e.getDependencyRootPath(),s=null===(n=null===(t=getJson5Obj(path_1.default.resolve(o,common_const_js_1.CommonConst.OH_PACKAGE_JSON5)).metadata)||void 0===t?void 0:t.resource)||void 0===n?void 0:n.directories;(null==s?void 0:s.length)&&s.forEach(e=>{const t=path_1.default.resolve(o,e);fs_1.default.existsSync(t)&&(null==r||r.push(t))});const a=path_1.default.resolve(o,common_const_js_1.CommonConst.SRC_MAIN_RESOURCES);return!r.includes(a)&&fs_1.default.existsSync(a)&&(null==r||r.push(a)),r}function getLocalDependencyRouterMap(e,t,n){const r=dependency_manager_js_1.DependencyManager.getModuleModelByDependency(n,e),o=har_target_util_js_1.HarTargetUtil.calDepHarTargets(t),s=r&&o.get(r.getName());return dependency_manager_js_1.DependencyManager.getLocalDependencyRouterMapObjList(n,e,s)}exports.getJson5Obj=getJson5Obj,exports.minimizeHspDependencies=minimizeHspDependencies,exports.getDependenciesWithoutHar=getDependenciesWithoutHar,exports.getLocalDepHarTargetSources=getLocalDepHarTargetSources,exports.getRemoteDepHarTargetSources=getRemoteDepHarTargetSources,exports.getLocalDependencyRouterMap=getLocalDependencyRouterMap;