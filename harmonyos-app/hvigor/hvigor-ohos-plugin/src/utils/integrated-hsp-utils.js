"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.getAppInfoByProject=exports.generateIntegratedHspCommand=exports.IntegratedHspUtils=void 0;const wdk_1=require("@baize/wdk"),project_ohos_config_manager_js_1=require("../common/global/project-ohos-config-manager.js"),common_const_1=require("../const/common-const"),packing_tool_options_js_1=require("../builder/inner-java-command-builder/packing-tool-options.js"),find_target_product_js_1=require("../common/find-target-product.js"),fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path")),build_directory_const_js_1=require("../const/build-directory-const.js"),json_util_js_1=require("./json-util.js"),ohos_logger_1=require("./log/ohos-logger"),log=ohos_logger_1.OhosLogger.getLogger("IntegratedHspUtils");class IntegratedHspUtils{constructor(e){this.integratedHspCache={bundleName:"",versionCode:"",integratedRemoteHsps:new Map};const t=(0,find_target_product_js_1.findTargetProduct)(e);this.integratedHspCachePath=path_1.default.resolve(e.getCacheIntegratedHspPath(t.name),build_directory_const_js_1.BuildArtifactConst.INTEGRATED_HSP_CACHE),this.initIntegratedHspCache(e,t)}initIntegratedHspCache(e,t){var s,a,n,r,o;if(e.isFaMode())return;const i=e.getAppRes().getAppResOpt();if(!i){const t=path_1.default.resolve(e.getProjectDir(),common_const_1.CommonConst.APP_SCOPE,common_const_1.CommonConst.APP_CONFIG);log.printErrorExit("APPJSON5_NOT_FOUND",[t])}if(!i.app)return;const d=(0,wdk_1.cloneDeep)(null===(s=project_ohos_config_manager_js_1.projectOhosConfigManager.getOverrides())||void 0===s?void 0:s.appOpt),p=null!==(n=null!==(a=null==d?void 0:d.bundleName)&&void 0!==a?a:t.bundleName)&&void 0!==n?n:i.app.bundleName,g=null!==(o=null!==(r=null==d?void 0:d.versionCode)&&void 0!==r?r:t.versionCode)&&void 0!==o?o:i.app.versionCode,l={bundleName:p,versionCode:null==g?void 0:g.toString(),integratedRemoteHsps:new Map};if(!fs_extra_1.default.existsSync(this.integratedHspCachePath))return void(this.integratedHspCache=l);const c=(0,json_util_js_1.getJson5Obj)(this.integratedHspCachePath),_=path_1.default.dirname(this.integratedHspCachePath);if(c.bundleName===p&&c.versionCode===g.toString()){const e=fs_extra_1.default.readdirSync(path_1.default.dirname(this.integratedHspCachePath));Object.keys(c.integratedRemoteHsps).forEach(t=>{const s=c.integratedRemoteHsps[t];e.includes(t)&&(null==s?void 0:s.hspPath)&&fs_extra_1.default.existsSync(s.hspPath)&&fs_extra_1.default.existsSync(path_1.default.resolve(_,s.hspDirName,s.hspFileName))&&l.integratedRemoteHsps.set(t,s)})}this.integratedHspCache=l}getIntegratedHspCache(){return this.integratedHspCache}isNeedIntegrated(e){return!this.integratedHspCache.integratedRemoteHsps.has(e)}setIntegratedRemoteHsps(e){this.integratedHspCache.integratedRemoteHsps.set(e.hspDirName,e)}changeIntegratedHspStatus(e){for(const t of this.integratedHspCache.integratedRemoteHsps.values())t.hspDirName===e&&(t.isIntegratedHsp=!0)}writeIntegratedHspCache(){if(0!==this.integratedHspCache.integratedRemoteHsps.size){for(const e of this.integratedHspCache.integratedRemoteHsps.values())if(!e.isIntegratedHsp)return;fs_extra_1.default.existsSync(path_1.default.dirname(this.integratedHspCachePath))||fs_extra_1.default.mkdirSync(path_1.default.dirname(this.integratedHspCachePath),{recursive:!0}),fs_extra_1.default.writeJsonSync(this.integratedHspCachePath,{bundleName:this.integratedHspCache.bundleName,versionCode:this.integratedHspCache.versionCode,integratedRemoteHsps:Object.fromEntries(this.integratedHspCache.integratedRemoteHsps)})}else fs_extra_1.default.existsSync(path_1.default.dirname(this.integratedHspCachePath))&&fs_extra_1.default.removeSync(path_1.default.dirname(this.integratedHspCachePath))}resetIntegratedHspCache(){this.integratedHspCache={bundleName:"",versionCode:"",integratedRemoteHsps:new Map}}}function generateIntegratedHspCommand(e,t,s,a){const{bundleName:n,versionCode:r}=getAppInfoByProject(e),o=new packing_tool_options_js_1.PackingToolOptions;return o.addCalledJarFile(t),o.addMode("packageNormalize").addBundleName(n).addVersionCode(r.toString()).addHspList(s).addOutPath(a).build()}function getAppInfoByProject(e){var t,s,a,n,r;const o=e.getAppRes().getAppResOpt(),i=(0,wdk_1.cloneDeep)(null===(t=project_ohos_config_manager_js_1.projectOhosConfigManager.getOverrides())||void 0===t?void 0:t.appOpt),d=(0,find_target_product_js_1.findTargetProduct)(e);return{bundleName:null!==(a=null!==(s=null==i?void 0:i.bundleName)&&void 0!==s?s:d.bundleName)&&void 0!==a?a:o.app.bundleName,versionCode:null!==(r=null!==(n=null==i?void 0:i.versionCode)&&void 0!==n?n:d.versionCode)&&void 0!==r?r:o.app.versionCode}}exports.IntegratedHspUtils=IntegratedHspUtils,exports.generateIntegratedHspCommand=generateIntegratedHspCommand,exports.getAppInfoByProject=getAppInfoByProject;