"use strict";var _a,__importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.DecipherUtil=void 0;const buffer_1=__importDefault(require("buffer")),crypto_1=__importDefault(require("crypto")),fs_1=__importDefault(require("fs")),path_1=__importDefault(require("path")),ohos_logger_js_1=require("./log/ohos-logger.js");class DecipherUtil{static decryptPwd(t,e){this.materialDir=t,32>e.length&&this._logger.printErrorExit("INVALID_DATA",[this.getProjectBuildProfilePath()],[[this.getProjectBuildProfilePath()]]),0!=e.length%2&&this._logger.printErrorExit("INVALID_PASSWORD_LENGTH",[this.getProjectBuildProfilePath()],[[this.getProjectBuildProfilePath()]]);let r=buffer_1.default.Buffer.from("");const i=DecipherUtil.getKey(t),o=new Int8Array(buffer_1.default.Buffer.from(e,"hex"));return r=DecipherUtil.decrypt(i,o),r.toString("utf-8")}static getKey(t){const e=path_1.default.resolve(t,"material");fs_1.default.statSync(e).isDirectory()||this._logger.printErrorExit("SIGNING_FAILED_NO_SIGNING_NATERIALS_IS_NOT_A_DIRECTORY",[e,this.getProjectBuildProfilePath()],[[e],[this.getProjectBuildProfilePath()],[t]]);const r=fs_1.default.readdirSync(e).filter(t=>t!=this.macDSStore);0===r.length&&this._logger.printErrorExit("SIGNING_FAILED_NO_SIGNING_NATERIALS_IS_AN_EMPTY_DIRECTORY",[e,this.getProjectBuildProfilePath()],[[e],[this.getProjectBuildProfilePath()],[t]]),this.dirs.forEach(i=>{r.includes(i)||this._logger.printErrorExit("SIGNING_FAILED_CAN_NOT_FIND_SIGNING_MATERIAL",[i,this.getProjectBuildProfilePath()],[[this.dirs.join("、"),e],[this.getProjectBuildProfilePath()],[t]])});const i=this.readFd(e,this.dirs[0]),o=this.readSalt(path_1.default.resolve(e,this.dirs[1])),l=this.getRootKey(i,o),a=this.readWorkMaterial(path_1.default.resolve(e,this.dirs[2]));return new Int8Array(DecipherUtil.decrypt(l,a))}static getRootKey(t,e){const r=t.concat(this.component),i=this.xorComponents(r),o=crypto_1.default.pbkdf2Sync(i.toString(),e,1e4,16,"sha256");return new Int8Array(o)}static decrypt(t,e){try{const r=(255&e[0])<<24|(255&e[1])<<16|(255&e[2])<<8|255&e[3],i=e.length-4-r,o=e.slice(4,4+i),l=crypto_1.default.createDecipheriv("aes-128-gcm",t,o),a=e.slice(e.length-16);l.setAuthTag(a);const s=l.update(e.subarray(4+i,e.length-16)),_=l.final();return buffer_1.default.Buffer.concat([s,_])}catch(t){this._logger.printErrorExit("KEY_PASSWORD_VALID_FAILED",[t.message,this.getProjectBuildProfilePath()],[[]])}return buffer_1.default.Buffer.alloc(0)}static xorComponents(t){t.forEach(t=>{16!==t.length&&this._logger.printErrorExit("SIGNING_FAILED_SIGZNING_MATERIAL_DATA_ERROR",[this.getProjectBuildProfilePath()],[[this.getProjectBuildProfilePath()],[this.materialDir]])});let e=this.xor(t[0],t[1]);for(let r=2;r<t.length;r++)e=this.xor(e,t[r]);return buffer_1.default.Buffer.from(e)}static xor(t,e){t.byteLength!==e.byteLength&&this._logger.printErrorExit("SIGNING_FAILED_SIGZNING_MATERIAL_DATA_ERROR",[this.getProjectBuildProfilePath()],[[this.getProjectBuildProfilePath()],[this.materialDir]]);const r=new Int8Array(t.byteLength);for(let i=0;i<t.byteLength;i++)r[i]=t[i]^e[i];return r}static readFd(t,e){const r=path_1.default.resolve(t,e);fs_1.default.existsSync(r)||this._logger.printErrorExit("SIGNING_FAILED_CAN_NOT_FIND_SIGNING_MATERIAL",[e,this.getProjectBuildProfilePath()],[[this.dirs.join("、"),t],[this.getProjectBuildProfilePath()],[this.materialDir]]);const i=fs_1.default.readdirSync(r).filter(t=>t!=this.macDSStore);3!==i.length&&this._logger.printErrorExit("SIGNING_FAILED_SIGNING_MATERIAL_IS_ILLEGAL",[r,this.getProjectBuildProfilePath()],[[r],[this.getProjectBuildProfilePath()],[this.materialDir]]);const o=[];return i.forEach(t=>o.push(this.readDirBytes(path_1.default.resolve(r,t)))),o}static readSalt(t){return this.readDirBytes(t)}static readWorkMaterial(t){return this.readDirBytes(t)}static decryptPluginDataFromResource(t){const e=path_1.default.resolve(__dirname,t),r=fs_1.default.readFileSync(e).toString();return DecipherUtil.decryptPwd(path_1.default.resolve(__dirname,"../../res"),r)}static getProjectBuildProfilePath(){return path_1.default.resolve(process.cwd(),"build-profile.json5")}}exports.DecipherUtil=DecipherUtil,_a=DecipherUtil,DecipherUtil.component=new Int8Array([49,243,9,115,214,175,91,184,211,190,177,88,101,131,192,119]),DecipherUtil.dirs=["fd","ac","ce"],DecipherUtil._logger=ohos_logger_js_1.OhosLogger.getLogger("Decipher"),DecipherUtil.macDSStore=".DS_Store",DecipherUtil.readDirBytes=t=>{fs_1.default.existsSync(t)&&fs_1.default.statSync(t).isDirectory()||DecipherUtil._logger.printErrorExit("SIGNING_FAILED_CAN_NOT_FIND_THE_SIGZNING_MATERIAL",[_a.getProjectBuildProfilePath()],[[t],[_a.getProjectBuildProfilePath()],[_a.materialDir]]);const e=fs_1.default.readdirSync(t);1!==e.length&&DecipherUtil._logger.printErrorExit("SIGNING_FAILED_SIGZNING_MATERIAL_ERROR",[_a.getProjectBuildProfilePath()],[[t],[_a.getProjectBuildProfilePath()],[_a.materialDir]]);const r=fs_1.default.readFileSync(path_1.default.resolve(t,e[0]));return new Int8Array(r)};