"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.initSignRemoteHspMap=exports.getRemoteHspPathMap=exports.getSignRemoteHspMetadata=exports.semverMaxSatisfying=exports.compareIfSetRemoteHsp=exports.getHspBaseData=exports.getRemoteHspObj=exports.getRemoteHspMap=exports.getRemoteHspObjList=void 0;const fs_extra_1=__importDefault(require("fs-extra")),semver_1=require("semver"),path_1=__importDefault(require("path")),build_directory_const_js_1=require("../const/build-directory-const.js"),common_const_js_1=require("../const/common-const.js"),ohos_logger_js_1=require("./log/ohos-logger.js"),map_util_js_1=require("./map-util.js"),sign_util_js_1=require("../tasks/sign/sign-util.js"),oh_package_loader_js_1=require("./loader/file/oh-package-loader.js"),module_task_service_js_1=require("../tasks/service/module-task-service.js"),_log=ohos_logger_js_1.OhosLogger.getLogger("remote-hsp-info"),getRemoteHspObjList=e=>{const t=e.getProject(),s=path_1.default.resolve(e.getNodeDir(),common_const_js_1.CommonConst.OH_MODULES,build_directory_const_js_1.BuildArtifactExtension.DOT_HSP),o=path_1.default.resolve(t.getNodeDir(),common_const_js_1.CommonConst.OH_MODULES,build_directory_const_js_1.BuildArtifactExtension.DOT_HSP),a=(0,exports.getRemoteHspMap)(s),r=(0,exports.getRemoteHspMap)(o,a);return r?[...r.values()]:[]};exports.getRemoteHspObjList=getRemoteHspObjList;const getRemoteHspMap=(e,t)=>{if(!fs_extra_1.default.existsSync(e))return _log.debug("allRemoteHspMap does not exist."),t;t&&_log.debug(`allRemoteHspMap: ${JSON.stringify((0,map_util_js_1.strMapToObj)(t))}`);const s=null!=t?t:new Map,o=fs_extra_1.default.readdirSync(e);for(const a of o){const o=path_1.default.resolve(e,a),r=(0,exports.getRemoteHspObj)(o,a,_log);r&&checkIfNeedSet(r,_log,t)&&s.set(r.hspFileName,{...r})}return s};exports.getRemoteHspMap=getRemoteHspMap;const checkIfNeedSet=(e,t,s)=>{if(!s)return t.debug(`allRemoteHspMap does not exist, ${e.hspFileName} ${e.hspVersion} should be stored in the allRequiredSignRemoteHspMap`),!0;return s.get(e.hspFileName)?(0,exports.compareIfSetRemoteHsp)(e,s)?(t.debug(`allRemoteHspMap exists, ${e.hspFileName} is in allRemoteHspMap, but ${e.hspFileName} ${e.hspVersion} is higher, ${e.hspFileName} ${e.hspVersion} should be stored in the allRequiredSignRemoteHspMap`),!0):(t.debug(`${e.hspFileName} ${e.hspVersion} should not be stored in the allRequiredSignRemoteHspMap`),!1):(t.debug(`allRemoteHspMap exists, but ${e.hspFileName} is not in allRemoteHspMap, ${e.hspFileName} ${e.hspVersion} should be stored in the allRequiredSignRemoteHspMap`),!0)},getRemoteHspObj=(e,t,s)=>{if(!fs_extra_1.default.existsSync(e))return;const o=fs_extra_1.default.readdirSync(e);let a,r;for(const t of o)if(t.endsWith(build_directory_const_js_1.BuildArtifactExtension.DOT_HSP)&&(a&&s.printErrorExit("ALLOW_ONE_HSP",[e],[[e]]),a=t),t.includes(common_const_js_1.CommonConst.OH_PACKAGE_JSON5)){const t=oh_package_loader_js_1.ohPackageLoader.getNodeOhPackagePath(path_1.default.resolve(e,common_const_js_1.CommonConst.OH_PACKAGE_JSON5));r=(0,exports.getHspBaseData)(t,s)}return r?a?(r.hspFileName=a,r.hspPath=path_1.default.resolve(e,a),r.hspDirName=t,r):void s.printErrorExit("NO_HSP_FOUND",[e],[[e]]):void s.printErrorExit("NO_PACKAGE_FOUND",[a,e],[[e]])};exports.getRemoteHspObj=getRemoteHspObj;const getHspBaseData=(e,t)=>{var s;if(!fs_extra_1.default.existsSync(e))return;const o=fs_extra_1.default.readJsonSync(e);return(0,semver_1.valid)(null==o?void 0:o.version)||t.printErrorExit("VERSION_ILLEGAL",[e]),{hspName:o.name,hspVersion:o.version,hspPath:"",hspDirName:"",hspFileName:"",isIntegratedHsp:!!(null===(s=null==o?void 0:o.metadata)||void 0===s?void 0:s.integratedHsp)}};exports.getHspBaseData=getHspBaseData;const compareIfSetRemoteHsp=(e,t)=>{if(!t.has(e.hspFileName))return!0;const s=t.get(e.hspFileName);if(s){return semverMaxSatisfying([e.hspVersion,s.hspVersion])===e.hspVersion}return!0};function semverMaxSatisfying(e){return(0,semver_1.maxSatisfying)(e,"*")||(0,semver_1.maxSatisfying)(e,"*",{includePrerelease:!0,loose:!0})}function getSignRemoteHspMetadata(e,t){const s=e.getProjectModel(),o=[];if(!(0,sign_util_js_1.isSigned)(s))return;const a=e.getOhpmRemoteHspAllInfo(e,t,!0);return Object.entries(a).forEach(([e,t])=>{var s,a;const r={hspName:t.signedRemoteHspPath?path_1.default.basename(t.signedRemoteHspPath):"",hspVersion:t.version,hspPath:null!==(s=t.signedRemoteHspPath)&&void 0!==s?s:"",soPath:null!==(a=t.soPath)&&void 0!==a?a:""};o.push(r)}),o}function getRemoteHspPathMap(e,t){const s=e.getProjectModel(),o=new Map,a=new Map,r=s.getRemoteHspPath();if(e instanceof module_task_service_js_1.ModuleTaskService){initSignRemoteHspMap(e.getModuleModel().getRemoteHspPath(),a,t)}return initSignRemoteHspMap(r,a,t),a.forEach(e=>{const t=e.hspFileName;o.set(e.hspName,t)}),o}function initSignRemoteHspMap(e,t,s){if(!fs_extra_1.default.existsSync(e))return;const o=fs_extra_1.default.readdirSync(e);for(const a of o){const o=path_1.default.resolve(e,a),r=(0,exports.getRemoteHspObj)(o,a,_log);r&&(0,exports.compareIfSetRemoteHsp)(r,t)&&s.forEach(e=>{e.getPackageName()===r.hspName&&t.set(r.hspFileName,{...r})})}}exports.compareIfSetRemoteHsp=compareIfSetRemoteHsp,exports.semverMaxSatisfying=semverMaxSatisfying,exports.getSignRemoteHspMetadata=getSignRemoteHspMetadata,exports.getRemoteHspPathMap=getRemoteHspPathMap,exports.initSignRemoteHspMap=initSignRemoteHspMap;