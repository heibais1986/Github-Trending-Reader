"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.projectBuildProfileLoader=void 0;const wdk_1=require("@baize/wdk"),hvigor_1=require("@ohos/hvigor"),class_type_const_js_1=require("@ohos/hvigor/src/base/common/options/class-type-const.js"),common_const_js_1=require("../../../const/common-const.js"),abstract_build_profile_loader_js_1=require("./abstract-build-profile-loader.js");class ProjectBuildProfileLoader extends abstract_build_profile_loader_js_1.AbstractBuildProfileLoader{constructor(){super(...arguments),this.logger=hvigor_1.HvigorLogger.getLogger(ProjectBuildProfileLoader.name)}getBuildProfile(){return this.getBuildProfileJson5Obj(hvigor_1.hvigor.getRootNode().getNodeName(),!0,class_type_const_js_1.ClassTypeConst.HVIGOR_PROJECT)}setBuildProfileJson5Obj(o,e,r=!0){super.setBuildProfileJson5ObjCheck(o,e,common_const_js_1.BuildProfileSchemaFileConst.PROJECT_BUILD_PROFILE_SCHEMA_PATH,class_type_const_js_1.ClassTypeConst.HVIGOR_PROJECT)}initializeReplace(o){return this.replaceTargets(o)}replaceTargets(o){const e=(0,wdk_1.cloneDeep)(o);return hvigor_1.hvigor.getRootNode().subNodes(o=>{var r;if(!e.modules.some(e=>e.name===o.getNodeName())){const t=null===(r=hvigor_1.hvigorConfig.getNodeDescriptorByName(o.getNodeName()))||void 0===r?void 0:r.srcPath;e.modules.push({name:o.getNodeName(),srcPath:null!=t?t:o.getNodePath()})}const t=o.getExtraOption("targets");if(t){e.modules.forEach(e=>{e.name===o.getNodeName()&&(e.targets=t)})}}),e.modules=e.modules.filter(o=>hvigor_1.hvigor.getAllNodes().some(e=>e.getNodeName()===o.name)),e}checkBuildProfile(o,e){if(!o.app.products||!e.app.products||o.app.products.length!==e.app.products.length)return void this.logger.printErrorExit("CAN_NOT_ADD_OR_DELETE_PRODUCTS",["build-profile.json5"]);this.checkMaxFlowDepth(e)&&this.logger.warn("Setting maxFlowDepth in hvigorfile.ts is not supported and may cause side effects.");const r=o.app.products,t=e.app.products;r.forEach(o=>{const e=t.find(e=>e.name===o.name);e?e.runtimeOS!==o.runtimeOS&&this.logger.printErrorExit("CAN_NOT_CHANGE_NAME_OR_RUNTIME_PRODUCTS",[o.runtimeOS]):this.logger.printErrorExit("CAN_NOT_CHANGE_NAME_OR_RUNTIME_PRODUCTS",[o.name])})}checkMaxFlowDepth(o){var e,r,t,i,s,l,d,n;for(const s of(null===(e=null==o?void 0:o.app)||void 0===e?void 0:e.products)||[])if(void 0!==(null===(i=null===(t=null===(r=null==s?void 0:s.buildOption)||void 0===r?void 0:r.arkOptions)||void 0===t?void 0:t.tscConfig)||void 0===i?void 0:i.maxFlowDepth))return!0;for(const e of(null===(s=null==o?void 0:o.app)||void 0===s?void 0:s.buildModeSet)||[])if(void 0!==(null===(n=null===(d=null===(l=null==e?void 0:e.buildOption)||void 0===l?void 0:l.arkOptions)||void 0===d?void 0:d.tscConfig)||void 0===n?void 0:n.maxFlowDepth))return!0;return!1}}exports.projectBuildProfileLoader=new ProjectBuildProfileLoader;