"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ohPackageLoader=void 0;const path_1=__importDefault(require("path")),hvigor_1=require("@ohos/hvigor"),class_type_const_js_1=require("@ohos/hvigor/src/base/common/options/class-type-const.js"),node_config_path_info_1=require("@ohos/hvigor/src/common/node-config-path-info"),fs_extra_1=__importDefault(require("fs-extra")),common_const_1=require("../../../const/common-const"),json_util_1=require("../../json-util"),ohos_logger_1=require("../../log/ohos-logger"),config_file_loader_1=require("../config-file-loader"),_log=ohos_logger_1.OhosLogger.getLogger("OhPackageLoader");class OhPackageLoader{constructor(){this.isUpdatedOhPackageInfo=!1,this.isLoaded=!1,this.isChangedParameterFile=!1,this.OhPackagePathMap=new Map,this.UpdatePathToOriginMap=new Map}getDependenciesOpt(e){var o;return this.saveOhPackagePathInfoToLoader(),null===(o=this.getOhPackageJsonObj(e))||void 0===o?void 0:o.dependencies}clean(){this.isUpdatedOhPackageInfo=!1,this.isLoaded=!1,this.OhPackagePathMap=new Map,this.UpdatePathToOriginMap=new Map,this.isChangedParameterFile=!1}getDevDependenciesOpt(e){var o;return this.saveOhPackagePathInfoToLoader(),null===(o=this.getOhPackageJsonObj(e))||void 0===o?void 0:o.devDependencies}getDynamicDependenciesOpt(e){var o;return this.saveOhPackagePathInfoToLoader(),null===(o=this.getOhPackageJsonObj(e))||void 0===o?void 0:o.dynamicDependencies}getOhPackageJsonObj(e){var o;return config_file_loader_1.configFileLoader.getConfigFileJson(null!==(o=this.UpdatePathToOriginMap.get(e))&&void 0!==o?o:e)}setDependenciesOpt(e,o){this.validateDependency(o),this.saveOhPackagePathInfoToLoader();const t=config_file_loader_1.configFileLoader.getConfigFileJson(e);t.dependencies=o,config_file_loader_1.configFileLoader.setConfigFileJson(e,t),this.isUpdatedOhPackageInfo=!0}setDevDependenciesOpt(e,o){this.validateDependency(o),this.saveOhPackagePathInfoToLoader();const t=config_file_loader_1.configFileLoader.getConfigFileJson(e);t.devDependencies=o,config_file_loader_1.configFileLoader.setConfigFileJson(e,t),this.isUpdatedOhPackageInfo=!0}setDynamicDependenciesOpt(e,o){this.validateDependency(o),this.saveOhPackagePathInfoToLoader();const t=config_file_loader_1.configFileLoader.getConfigFileJson(e);t.dynamicDependencies=o,config_file_loader_1.configFileLoader.setConfigFileJson(e,t),this.isUpdatedOhPackageInfo=!0}getVersion(e){return this.saveOhPackagePathInfoToLoader(),config_file_loader_1.configFileLoader.getConfigFileJson(e).version}setVersion(e,o){"string"!=typeof o&&_log.printErrorExit("VERSION_IS_NOT_A_STRING",[o]),this.saveOhPackagePathInfoToLoader();const t=config_file_loader_1.configFileLoader.getConfigFileJson(e);t.version=o,config_file_loader_1.configFileLoader.setConfigFileJson(e,t),this.isUpdatedOhPackageInfo=!0}shouldDoOhpmInstall(){return this.isUpdatedOhPackageInfo||this.isChangedParameterFile||node_config_path_info_1.nodeConfigPathInfo.getIsModuleChanged()}loadUpdatedOhPackageToDisk(e,o){_log.debug("start to load updatedOhPackageInfo to the disk"),this.saveOhPackagePathInfoToLoader();const t=path_1.default.resolve(hvigor_1.PathUtil.getHvigorCacheDir(),common_const_1.CommonConst.DEPENDENCYMAP,e),a=path_1.default.resolve(t,`${common_const_1.CommonConst.DEPENDENCYMAP}.json5`);fs_extra_1.default.removeSync(path_1.default.resolve(hvigor_1.PathUtil.getHvigorCacheDir(),common_const_1.CommonConst.DEPENDENCYMAP)),fs_extra_1.default.mkdirSync(t,{recursive:!0});const i={basePath:a,targetName:e||void 0,rootDependency:`./${common_const_1.CommonConst.OH_PACKAGE_JSON5}`,dependencyMap:{},modules:[]};hvigor_1.hvigor.getAllNodes().forEach(e=>{const n=path_1.default.resolve(e.getNodePath(),common_const_1.CommonConst.OH_PACKAGE_JSON5);if(e.getNodeName()===hvigor_1.hvigor.getRootNode().getNodeName()&&e.classKind===class_type_const_js_1.ClassTypeConst.HVIGOR_PROJECT){const e=config_file_loader_1.configFileLoader.getConfigFileJson(n);return e.parameterFile=o,fs_extra_1.default.writeFileSync(path_1.default.resolve(t,common_const_1.CommonConst.OH_PACKAGE_JSON5),JSON.stringify(e)),this.OhPackagePathMap.set(n,path_1.default.resolve(t,common_const_1.CommonConst.OH_PACKAGE_JSON5)),void this.UpdatePathToOriginMap.set(path_1.default.resolve(t,common_const_1.CommonConst.OH_PACKAGE_JSON5),n)}i.modules.push({name:`${e.getNodeName()}`,srcPath:`${path_1.default.relative(a,e.getNodePath())}`}),fs_extra_1.default.existsSync(path_1.default.resolve(t,e.getNodeName()))||fs_extra_1.default.mkdirSync(path_1.default.resolve(t,e.getNodeName())),fs_extra_1.default.writeFileSync(path_1.default.resolve(t,e.getNodeName(),common_const_1.CommonConst.OH_PACKAGE_JSON5),JSON.stringify(config_file_loader_1.configFileLoader.getConfigFileJson(n))),this.OhPackagePathMap.set(n,path_1.default.resolve(t,e.getNodeName(),common_const_1.CommonConst.OH_PACKAGE_JSON5)),this.UpdatePathToOriginMap.set(path_1.default.resolve(t,e.getNodeName(),common_const_1.CommonConst.OH_PACKAGE_JSON5),n),i.dependencyMap[e.getNodeName()]=`./${e.getNodeName()}/${common_const_1.CommonConst.OH_PACKAGE_JSON5}`}),fs_extra_1.default.writeFileSync(a,JSON.stringify(i)),_log.debug("load to the disk finished")}getNodeOhPackagePath(e){var o;return this.isUpdatedOhPackageInfo&&(null===(o=this.OhPackagePathMap)||void 0===o?void 0:o.get(e))||e}saveOhPackagePathInfoToLoader(){this.isLoaded||(hvigor_1.hvigor.getAllNodes().forEach(e=>{const o=path_1.default.resolve(e.getNodePath(),common_const_1.CommonConst.OH_PACKAGE_JSON5);config_file_loader_1.configFileLoader.setConfigFileJson(o,(0,json_util_1.getJson5Obj)(o))}),this.isLoaded=!0)}validateDependency(e){for(const o in e)"string"!=typeof e[o]&&_log.printErrorExit("DEPENDENCY_VERSION_IS_NOT_A_STRING",[e[o]])}getOriginPathFromUpdatePath(e){return this.isUpdatedOhPackageInfo?(e.forEach((o,t)=>{o=o.includes(common_const_1.CommonConst.OH_PACKAGE_JSON5)?o:path_1.default.resolve(o,common_const_1.CommonConst.OH_PACKAGE_JSON5);const a=exports.ohPackageLoader.UpdatePathToOriginMap.get(o);e[t]=a?path_1.default.dirname(a):path_1.default.dirname(o)}),e):e=e.map(e=>path_1.default.dirname(e))}setIsChangeParameterFile(e,o){if("string"!=typeof e)return void _log.printErrorExit("OHOS_ALIGN_TARGET_TYPE_ERROR",[path_1.default.resolve(hvigor_1.hvigor.getRootNode().getNodePath(),"hvigor","hvigor-config.json5")]);const t=path_1.default.resolve(hvigor_1.PathUtil.getHvigorCacheDir(),common_const_1.CommonConst.DEPENDENCYMAP,e,common_const_1.CommonConst.OH_PACKAGE_JSON5);if(!fs_extra_1.default.existsSync(t)&&o)return;const a=(0,json_util_1.getJson5Obj)(t),i=null==a?void 0:a.parameterFile;this.isChangedParameterFile=i!==o}getOverrides(e){var o;return this.saveOhPackagePathInfoToLoader(),null===(o=this.getOhPackageJsonObj(e))||void 0===o?void 0:o.overrides}setOverrides(e,o){this.validateDependency(o),this.saveOhPackagePathInfoToLoader();const t=config_file_loader_1.configFileLoader.getConfigFileJson(e);t.overrides=o,config_file_loader_1.configFileLoader.setConfigFileJson(e,t),this.isUpdatedOhPackageInfo=!0}}exports.ohPackageLoader=new OhPackageLoader;