"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.generateOhmurlForSrcEntry=exports.removeSuffix=exports.generateOldOhmUrlForSo=exports.generateOhmUrlForSo=exports.getOldOhmUrlForSrcEntry=exports.generateOhmUrlForSourceFile=exports.generateOhmUrl=void 0;const path_1=__importDefault(require("path")),fs_extra_1=__importDefault(require("fs-extra")),dependency_manager_js_1=require("../project/dependency/dependency-manager.js"),ohos_logger_js_1=require("./log/ohos-logger.js"),log=ohos_logger_js_1.OhosLogger.getLogger("ohmurl-utils");function generateOhmUrl(e){return`@normalized:${e.isSO?"Y":"N"}&${e.moduleName}&${e.bundleName}&${e.entryPath?`${e.packageName}/${removeSuffix(e.entryPath)}`:""}&${e.version}`}function generateOhmUrlForSourceFile(e,r){return`@normalized:${e.isSO?"Y":"N"}&${e.moduleName}&${e.bundleName}&${r?`${e.packageName}/${removeSuffix(r)}`:""}&${e.version}`}function getOldOhmUrlForSrcEntry(e,r,t){var o;const n=e.getModuleService().getProjectModel(),l=null!==(o=e.getTargetData().getProduct().bundleName)&&void 0!==o?o:n.getDefaultBundleName(),a=r.replace(/^\.\//,"");return`@bundle:${l}/${t}/${a.substring(0,a.indexOf("."))}`}function generateOhmUrlForSo(e,r){return`@normalized:${e.isSO?"Y":"N"}&${e.moduleName}&${e.bundleName}&${r?path_1.default.basename(r):""}&${e.version}`}function generateOldOhmUrlForSo(e,r,t){var o;const n=e.getModuleService().getProjectModel(),l=path_1.default.basename(r).replace(/^lib/,"");return`@app:${null!==(o=e.getTargetData().getProduct().bundleName)&&void 0!==o?o:n.getDefaultBundleName()}/${t}/${removeSuffix(l)}`}function removeSuffix(e){const r=e.split(path_1.default.sep).join("/"),t=[".d.ets",".d.ts",".d.mjs",".d.cjs",".d.js",".ets",".ts",".mjs",".cjs",".js",".so"].find(e=>r.endsWith(e));return t?r.substring(0,r.lastIndexOf(t)):r}function generateOhmurlForSrcEntry(e,r,t,o){var n,l,a;let d,u;const i=e.getAbsoluteSrcEntryPath(o,t.getDependencyRootPath());if(!t.isByteCodeHarDependency()&&!fs_extra_1.default.existsSync(i))return log.debug("Failed to generate the ohmurl corresponding to the srcEntry that depends on the ability module. The srcEntry path for obtaining the ability of the module on which the module depends is incorrect or the corresponding file does not exist."),"";const s=e.getModuleService().getProjectModel(),g=dependency_manager_js_1.DependencyManager.getModuleModelByDependency(t,s);if(t.isLocal()){if(!g)return log.debug("Failed to generate the ohmurl corresponding to the srcEntry that depends on the ability module. Failed to obtain the corresponding module model through the local dependency of the module."),"";u=i.substring(g.getModule().getNodeDir().length+1)}else u=i.substring(t.getDependencyRootPath().length+1);if(null===(l=null===(n=e.getBuildOption())||void 0===n?void 0:n.strictMode)||void 0===l?void 0:l.useNormalizedOHMUrl)d=generateOhmUrlForSourceFile(e.getPkgContextInfo(t.getDependencyName()),u);else{const n=null!==(a=e.getTargetData().getProduct().bundleName)&&void 0!==a?a:s.getDefaultBundleName(),l=o.replace(/^\.\//,""),u=l.substring(0,l.indexOf("."));d=t.isLocal()?`@bundle:${n}/${r}@${g.getModule().getName()}/${u}`:`@bundle:${n}/${r}@${t.getDependencyName()}/${u}`}return d}exports.generateOhmUrl=generateOhmUrl,exports.generateOhmUrlForSourceFile=generateOhmUrlForSourceFile,exports.getOldOhmUrlForSrcEntry=getOldOhmUrlForSrcEntry,exports.generateOhmUrlForSo=generateOhmUrlForSo,exports.generateOldOhmUrlForSo=generateOldOhmUrlForSo,exports.removeSuffix=removeSuffix,exports.generateOhmurlForSrcEntry=generateOhmurlForSrcEntry;