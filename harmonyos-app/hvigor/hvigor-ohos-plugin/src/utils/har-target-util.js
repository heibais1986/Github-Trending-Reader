"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.HarTargetUtil=void 0;const path_1=__importDefault(require("path")),hvigor_1=require("@ohos/hvigor"),task_util_js_1=require("@ohos/hvigor/src/base/util/task-util.js"),build_directory_const_js_1=require("../const/build-directory-const.js"),common_const_js_1=require("../const/common-const.js"),ohos_plugin_id_js_1=require("../plugin/common/ohos-plugin-id.js"),dependency_manager_js_1=require("../project/dependency/dependency-manager.js"),ohos_logger_js_1=require("./log/ohos-logger.js"),target_utils_js_1=require("./target-utils.js"),DEP_TARGET_CACHE_NAME="depTargetsCache";class HarTargetUtil{static getHarTargetName(e,t){const r=e.getModuleService().getProjectModel().getModuleSpecificTargets().get(t);if((null==r?void 0:r.length)&&r[0]!==common_const_js_1.DefaultTargetConst.ALL_TARGET)return r[0];const o=e.getTargetData().getTargetName();if(o===common_const_js_1.CommonConst.OHOS_TEST)return common_const_js_1.DefaultTargetConst.DEFAULT_TARGET;const s=e.getModuleService().getProjectModel().getModuleModelByName(t);if(!s)return common_const_js_1.DefaultTargetConst.DEFAULT_TARGET;const a=s.getTargetOptions().map(e=>e.name),i=(0,task_util_js_1.getAlignTarget)();return i&&a.includes(i)?(0,task_util_js_1.getAlignTarget)():a.includes(o)?o:common_const_js_1.DefaultTargetConst.DEFAULT_TARGET}static calDepHarTargets(e){const t=new Map,r=e.getModuleService(),o=r.getModuleModel(),s=o.getName(),a=e.getTargetData().getTargetName(),i=hvigor_1.hvigorCore.getCache("depTargetsCache"),n=i.get(`${s}@${a}`);return n||(r.getHarModuleDependencies().forEach(r=>{const i=this.getHarTargetData(r,o,a,s,e);if(i)t.set(r[0],i);else{const s=r[1].getLastDependencyName();if(s){const a=t.get(s);if(a){const i=this.getHarTargetData(r,o,a,s,e);i&&t.set(r[0],i)}}}}),i.set(`${s}@${a}`,t),t)}static getHarTargetData(e,t,r,o,s){const a=e[0];if(e[1].getLastDependencyName()&&e[1].getLastDependencyName()!==o)return"";const i=t.getModule().findModuleByName(a);if(!i)return this._log.printErrorExit("HAR_TARGET_NOT_MATCH",[r,a],[[a,o]]),"";if(s.getModuleService().isFaMode())return this.getHarTargetName(s,a);const n=i.getPluginById(ohos_plugin_id_js_1.OhosPluginId.OHOS_HAR_PLUGIN).getNeedExecTargetServiceList();n&&0!==n.length||this._log.printErrorExit("HAR_TARGET_NOT_MATCH",[r,a],[[a,o]]);const g=target_utils_js_1.TargetUtils.pushTryTargets({projectModel:s.getModuleService().getProjectModel(),moduleName:a,superTargetName:r});for(const e of g){if(n.find(t=>t.getTargetData().getTargetName()===e))return e}return common_const_js_1.DefaultTargetConst.DEFAULT_TARGET}static getDep2ConfigMap(e){if(!e)return;const t=e.getModuleService();if(!t)return;const r=new Map,o=new Map,s=new Map,a=new Map,i=new Map;return t.getHarModuleDependencies().forEach(t=>{var n,g,c;const l=this.getDepTargetService(e,t);l&&(this.collectWorkers(r,null===(n=l.getBuildOption().sourceOption)||void 0===n?void 0:n.workers,t[1]),this.collectRuntimeOnly(o,s,null===(g=l.getBuildOption().arkOptions)||void 0===g?void 0:g.runtimeOnly,t[1]),this.collectRouterMapPageSourceFiles(a,l.getTargetRouterMapObjList(l.getModuleService().getModuleModel()),t[1]),this.collectResources(i,null===(c=l.getTargetData().getTargetOpt().resource)||void 0===c?void 0:c.directories,t[1]))}),t.getRemoteHarDependencies().forEach(e=>{var t,n,g,c;if(e.isByteCodeHarDependency())return;const l=e.getPackageJsonObj();this.collectWorkers(r,null===(t=l.metadata)||void 0===t?void 0:t.workers,e),this.collectRuntimeOnly(o,s,null===(n=l.metadata)||void 0===n?void 0:n.runtimeOnly,e),this.collectRouterMapPageSourceFiles(a,dependency_manager_js_1.DependencyManager.getRemoteDependencyRouterMapObjList(e),e),this.collectResources(i,null===(c=null===(g=l.metadata)||void 0===g?void 0:g.resource)||void 0===c?void 0:c.directories,e)}),{dep2Workers:r,dep2RuntimeOnlyObj:{dep2RuntimeOnlySources:o,dep2RuntimeOnlyPackages:s},dep2RouterMapObjPageSourceFiles:a,dep2Resources:i}}static collectWorkers(e,t,r){(null==t?void 0:t.length)&&e.set(r,t)}static collectRuntimeOnly(e,t,r,o){r&&(r.sources&&e.set(o,r.sources),r.packages&&t.set(o,r.packages))}static collectRouterMapPageSourceFiles(e,t,r){if(!(null==t?void 0:t.length))return;const o=[];t.forEach(e=>{o.push(e.pageSourceFile)}),e.set(r,[...o])}static collectResources(e,t,r){const o=`${build_directory_const_js_1.BuildDirConst.SRC}${path_1.default.sep}${build_directory_const_js_1.BuildDirConst.MAIN}${path_1.default.sep}${build_directory_const_js_1.BuildDirConst.RESOURCES}`;e.set(r,(null==t?void 0:t.length)?[...t]:[o])}static getDepTargetService(e,t){if(!e)return;const r=e.getModuleService(),o=r.getProjectModel(),s=r.getModuleModel(),a=HarTargetUtil.getHarTargetData(t,s,e.getTargetData().getTargetName(),s.getName(),e),i=dependency_manager_js_1.DependencyManager.getModuleModelByDependency(t[1],o);return i?o.getTarget(i.getName(),a):void 0}}exports.HarTargetUtil=HarTargetUtil,HarTargetUtil._log=ohos_logger_js_1.OhosLogger.getLogger("HarTargetUtil");