"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,i,t,o){void 0===o&&(o=t);var r=Object.getOwnPropertyDescriptor(i,t);r&&!("get"in r?!i.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return i[t]}}),Object.defineProperty(e,o,r)}:function(e,i,t,o){void 0===o&&(o=t),e[o]=i[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,i){Object.defineProperty(e,"default",{enumerable:!0,value:i})}:function(e,i){e.default=i}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var i={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(i,e,t);return __setModuleDefault(i,e),i},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ValidateUtil=void 0;const wdk_1=require("@baize/wdk"),hvigor_1=require("@ohos/hvigor"),hvigor_config_loader_js_1=require("@ohos/hvigor/src/common/util/hvigor-config-loader.js"),sdkmanager_common_1=require("@ohos/sdkmanager-common"),fs=__importStar(require("fs-extra")),os=__importStar(require("os")),path_1=__importDefault(require("path")),util=__importStar(require("util")),java_command_builder_js_1=require("../../builder/java-command-builder.js"),find_target_product_js_1=require("../../common/find-target-product.js"),project_ohos_config_manager_js_1=require("../../common/global/project-ohos-config-manager.js"),common_const_js_1=require("../../const/common-const.js"),version_const_js_1=require("../../const/version-const.js"),hap_extra_info_js_1=require("../../project/data/hap-extra-info.js"),sdk_util_js_1=require("../../sdk/sdk-util.js"),array_util_js_1=require("../array-util.js"),file_util_js_1=require("../file-util.js"),ohos_logger_js_1=require("../log/ohos-logger.js"),process_utils_js_1=require("../process-utils.js"),validator_store_js_1=require("./validator-store.js"),const_1=require("@ohos/hvigor/src/common/const/const"),path_const_1=require("@ohos/hvigor/src/common/const/path-const"),dependency_interface_1=require("../../project/dependency/core/dependency-interface"),sign_request_js_1=require("../../tasks/sign/sign-request.js"),json_util_js_1=require("../json-util.js"),npm_utils_1=require("../npm-utils");class ValidateUtil{static modelVersionCheck(){var e;const i=null===(e=hvigor_config_loader_js_1.HvigorConfigLoader.getInstance().getHvigorConfig())||void 0===e?void 0:e.modelVersion,t=path_1.default.resolve(path_const_1.HVIGOR_PROJECT_ROOT_DIR,const_1.DEFAULT_OH_PACKAGE_JSON_FILE_NAME),o=path_1.default.resolve(path_const_1.HVIGOR_PROJECT_ROOT_DIR,const_1.HVIGOR,const_1.DEFAULT_HVIGOR_CONFIG_JSON_FILE_NAME),r=(0,hvigor_1.parseJsonFile)(t,!1).modelVersion;i&&r?("string"!=typeof i&&this._log.printErrorExit("INCOMPATIBLE_TYPES_OF_HVIGOR_MODEL_VERSION",[o],[[typeof i]]),"string"!=typeof r&&this._log.printErrorExit("INCOMPATIBLE_TYPES_OF_OH_MODEL_VERSION",[t],[[typeof r]]),i===r?(((0,sdkmanager_common_1.compareVersion)(i,version_const_js_1.VersionConst.CURRENT_MODEL_VERSION)>0||(0,sdkmanager_common_1.compareVersion)(i,version_const_js_1.VersionConst.MINIMUM_MODEL_VERSION)<0)&&this._log.printErrorExit("UNSUPPORTED_MODEL_VERSION_OF_HVIGOR",[i],[[version_const_js_1.VersionConst.CURRENT_MODEL_VERSION]]),((0,sdkmanager_common_1.compareVersion)(r,version_const_js_1.VersionConst.CURRENT_MODEL_VERSION)>0||(0,sdkmanager_common_1.compareVersion)(r,version_const_js_1.VersionConst.MINIMUM_MODEL_VERSION)<0)&&this._log.printErrorExit("UNSUPPORTED_MODEL_OH_PKG_OF_HVIGOR",[i,t],[[version_const_js_1.VersionConst.CURRENT_MODEL_VERSION]])):this._log.printErrorExit("INCONSISTENT_MODEL_VERSION",[i,r,t])):this._log.printErrorExit("PROJECT_STRUCTURE_AND_CONFIGURATION")}static integrationVersionCheck(e,i,t,o){if(e){if(i.compileSdkVersion){const e=(0,sdk_util_js_1.parseApiVersion)(i.compileSdkVersion),t=(0,sdk_util_js_1.parseApiVersion)(version_const_js_1.VersionConst.SUPPORT_COMPILE_VERSION);e.version===t.version&&0===(0,sdkmanager_common_1.compareVersion)(e.api,t.api)||this._log.printErrorExit("UNSUPPORTED_COMPILESDKVERSION",[i.compileSdkVersion,o],[[version_const_js_1.VersionConst.SUPPORT_COMPILE_VERSION]])}if(i.compatibleSdkVersion){const e=(0,sdk_util_js_1.parseApiVersion)(i.compatibleSdkVersion),r=t?version_const_js_1.VersionConst.ATOMIC_SERVICE_MINIMUM_COMPATIBLE_VERSION:version_const_js_1.VersionConst.MINIMUM_COMPATIBLE_VERSION,n=(0,sdk_util_js_1.parseApiVersion)(r);(e.version<n.version||(0,sdkmanager_common_1.compareVersion)(e.api,n.api)<0)&&this._log.printErrorExit("UNSUPPORTED_COMPATIBLESDKVERSION",[i.compileSdkVersion,o],[[r,version_const_js_1.VersionConst.SUPPORT_COMPILE_VERSION]])}}else i.compileSdkVersion||this._log.printErrorExit("OPENHARMONY_WITHOUT_COMPLETIONSDKVERSION",[o])}static apiConfigurationCheck(e){const i=(0,find_target_product_js_1.findTargetProduct)(e);i.compatibleSdkVersion||this._log.printErrorExit("NO_COMPATIBLESDKVERSION",[e.getProfilePath()]),i.runtimeOS!==common_const_js_1.CommonConst.OPEN_HARMONY&&"number"!=typeof i.compatibleSdkVersion||i.compileSdkVersion||this._log.printErrorExit("NO_COMPILESDKVERSION_IN_OPENHARMONY",[e.getProfilePath()])}static checkProducts(e){return!(!e.compileSdkVersion&&!e.compatibleSdkVersion)}static apiCompatibleCheck(e,i,t){if((null==t?void 0:t.getApiType())===hap_extra_info_js_1.ApiType.FA&&i.getCompatibleApiVersion()<=7)return{suggestedVersion:8,errorHandler:()=>{this._log.printErrorExit("FA_COMPATIBLESDKVERSION",[],[[null==e?void 0:e.getProfilePath()]])}};const o={suggestedVersion:-1};if((null==t?void 0:t.getApiType())!==hap_extra_info_js_1.ApiType.STAGE&&!i.isHarmonyOS())return o;if((null==t?void 0:t.getApiType())===hap_extra_info_js_1.ApiType.STAGE&&i.getCompatibleApiVersion()<=8)return{suggestedVersion:9,errorHandler:()=>{this._log.printErrorExit("STAGE_COMPATIBLESDKVERSION",[],[[null==e?void 0:e.getProfilePath()]])}};const r=this.hosApiMatrixCheck(i);return r[0]?o:{suggestedVersion:r[1],errorHandler:()=>{this._log.printErrorExit("API_COMPATIBLESDKVERSION",[i.getCompileApiVersion(),r[1]],[[r[1],null==e?void 0:e.getProfilePath()]])}}}static hosApiMatrixCheck(e){if(!e.isHarmonyOS())return[!0,e.getApiMeta().compatibleSdkVersion.version];const i=this.hosApiCompatible.get(e.getApiMeta().compileSdkVersion.version);return i?[e.getApiMeta().compatibleSdkVersion.version>=i,i]:[!0,-1]}static schemaCheckOnly(e,i,t){return t((0,json_util_js_1.getJson5Obj)(i))}static submitSchemaCheckWork(e){const{moduleName:i,filePath:t,schemaPath:o,changeAppSchema:r=!1,checkOnly:n=!1,errorHandlers:s}=e,a=validator_store_js_1.ValidatorStore.addValidator(o,r);return n?ValidateUtil.schemaCheckOnly(i,t,a):ValidateUtil.doSchemaCheck(i,t,a,s)}static schemaCheckJSObject(e,i,t){var o;const r=t(e);if(!r){if(!t.errors)return r;const e=[];if(null===(o=t.errors)||void 0===o||o.forEach(t=>{const o={instancePath:t.instancePath,keyword:t.keyword,params:t.params,message:t.message};i&&(o.location=`${null==i?void 0:i.replace(/\\/g,"/")}`),e.push(o)}),0!==e.length){let t="";null==e||e.forEach(e=>{t+=util.format(e,os.EOL)});const o=i?`Schema validate failed, at file: ${i}`:"Schema validate failed.";ValidateUtil._log.printErrorExit("SCHEMA_VALIDATE_FAILED",[o],[["Please check the following fields.",os.EOL,t]])}}return r}static doSchemaCheck(e,i,t,o){var r;const n=(0,json_util_js_1.getJson5Obj)(i),s=t(n);if(!s){if(!t.errors)return s;const e=(0,hvigor_1.parseJsonFile)(i,!0);let a=[];if(null===(r=t.errors)||void 0===r||r.forEach(t=>{const o={instancePath:t.instancePath,keyword:t.keyword,params:t.params,message:t.message,location:`${i.replace(/\\/g,"/")}`};ValidateUtil.addLocationInfo(o,e),a.push(o)}),o&&o.forEach(e=>{a=e(a,n)}),0!==a.length){let e="";null==a||a.forEach(i=>{e+=util.format(i,os.EOL)});const t=`Schema validate failed, at file: ${i}`;ValidateUtil._log.printErrorExit("SCHEMA_VALIDATE_FAILED",[t],[["Please check the following fields.",os.EOL,e]])}}return s}static addLocationInfo(e,i){var t;let o="",r=i;null===(t=e.instancePath)||void 0===t||t.split("/").forEach(e=>{null===e||""===e||("NaN"===parseInt(e).toString()?(r=r[e],o+=""===o?e:`.${e}`):(r=r[parseInt(e)],o+=`[${e}]`))}),e.instancePath=o,e.location+=`:${r._line}:${r._column+1}`}static async getBundleNameFromP7b(e,i,t,o,r=!1){if(void 0!==i){const{verifyTool:n,signingConfigP7bFile:s,signConfigCheckJsonFile:a}=this.getVerifySignInfo(e,i,t),_="verify signing configuration and get bundle name",l=o.createSubEvent(_,"");l.start(),r?await this.executeVerifySingningConfigRequest(n,s,a):await this.executeVerifySingningConfig(n,s,a),l.stop(),l.setLog(_,hvigor_1.MetricLogType.INFO);const c=(0,json_util_js_1.getJson5Obj)(a).content["bundle-info"]["bundle-name"];return fs.existsSync(a)&&fs.removeSync(a),c}return null}static getVerifySignInfo(e,i,t){const o=e.getVerifySignConfigTool();""!==o&&fs.existsSync(path_1.default.resolve(o))||ValidateUtil._log.printErrorExit("NO_HAP_SIGNING_TOOL",[],[[e.getSdkToolchainsDir()]]);const r=i.material.profile,n=t.getIntermediatesTemp(),s=path_1.default.resolve(n,"signConfigCheckJson.json");return file_util_js_1.FileUtil.checkDirWithoutDelete(path_1.default.resolve(n)),file_util_js_1.FileUtil.checkFile(s),{verifyTool:o,signingConfigP7bFile:r,signConfigCheckJsonFile:s}}static getVerifySignCommands(e,i,t){if(void 0!==i){const{verifyTool:o,signingConfigP7bFile:r,signConfigCheckJsonFile:n}=this.getVerifySignInfo(e,i,t);return(new java_command_builder_js_1.JavaCommandBuilder).addCalledJarFile(o).addJvmOption("verify-profile").addJvmOption("-inFile").addJvmOption(r).addJvmOption("-outFile").addJvmOption(n).build()}return null}static async executeVerifySingningConfig(e,i,t){const o=(new java_command_builder_js_1.JavaCommandBuilder).addCalledJarFile(e).addJvmOption("verify-profile").addJvmOption("-inFile").addJvmOption(i).addJvmOption("-outFile").addJvmOption(t).build();await(new process_utils_js_1.ProcessUtils).execute(o)}static async executeVerifySingningConfigRequest(e,i,t){await(0,sign_request_js_1.sendVerifyProfileRequest)(e,{inFile:i,outFile:t})}static getBundleNameFromHap(e,i){var t;const o=(0,wdk_1.cloneDeep)(null===(t=project_ohos_config_manager_js_1.projectOhosConfigManager.getOverrides())||void 0===t?void 0:t.appOpt);if(null==o?void 0:o.bundleName)return o.bundleName;const r=e.bundleName;return r||i.getDefaultBundleName()}static searchDuplicateName(e){return(0,array_util_js_1.findDuplicateElement)(e.map(e=>e.name))}static checkUniqueModuleName(e){const i=new Map,t=new Set;for(const o of e){const e=o.name;i.has(e.toLowerCase())?(t.add(e),t.add(i.get(e.toLowerCase()))):i.set(e.toLowerCase(),e)}return Array.from(t)}static validateDuplicatedName(e,i,t){if(void 0===e)return;const o="modules"===i?ValidateUtil.checkUniqueModuleName(e):ValidateUtil.searchDuplicateName(e);0!==o.length&&ValidateUtil._log.printErrorExit("UNEQUAL_NAMES",[i,o.join(",")],[[i,t]])}static validateContainsDefault(e,i){e&&e.some(e=>"default"===e.name)||ValidateUtil._log.printErrorExit("NO_DEFAULT_PRODUCT",[],[[i]])}static isDeviceTypeExist(e,i){return e.some(e=>i.has(e))}static isAllLiteDeviceType(e,i){return e.every(e=>i.has(e))}static validateHybridDeviceTypes(e){ValidateUtil.isDeviceTypeExist(e,ValidateUtil.richDeviceTypes)&&ValidateUtil.isDeviceTypeExist(e,ValidateUtil.liteDeviceTypes)?ValidateUtil._log.printErrorExit("INCONSISTENT_DEVICE_TYPES"):ValidateUtil.isAllLiteDeviceType(e,ValidateUtil.liteDeviceTypes)&&e.length>1&&ValidateUtil._log.printErrorExit("UNEQUAL_MINI_SYSTEM_DEVICE_TYPES")}static validateFALiteDevice(e){e.some(e=>ValidateUtil.liteDeviceTypes.has(e))&&ValidateUtil._log.printErrorExit("FA_MINI_SYSTEM_DEVICE_TYPES")}static validateTargetCustomizeResources(e,i){e&&null!==e.match("^./?[\\s\\S]*[^ ]$")&&fs.existsSync(i)||ValidateUtil._log.printErrorExit("INVALID_TARGETS_RESOURCE",[e])}static isDefaultCheck(e,i){if(0===e.length)return;let t=0;for(const i of e){!0===i.isDefault&&(t+=1)}t>1&&ValidateUtil._log.printErrorExit("ONLY_DEFAULT_CARD",[i])}static checkUpdateEnable(e,i){for(const t of e)t.updateEnabled&&void 0===t.scheduledUpdateTime&&void 0===t.updateDuration&&ValidateUtil._log.printErrorExit("WHEN_UPDATEENABLED_EXISTS_UPDATEDURATION_AND_SCHEDULEUPDATETIME_ARE_NOT_EMPTY",[i])}static validateLocalDependency(e,i,t){var o;if(!(null==t?void 0:t.length))return;if(!(null===(o=null==i?void 0:i.strictMode)||void 0===o?void 0:o.harLocalDependencyCheck))return;const r=[dependency_interface_1.DependencyType.DEPENDENCY_TYPE_HAR,dependency_interface_1.DependencyType.DEPENDENCY_TYPE_HSP],n=e.getProjectDir(),s=e.isHspModule();t.forEach(i=>{var t;const o=i.getDependencyType(),a=i.getDependedVersion(),_=i.getDependencyEnum()===dependency_interface_1.DependencyEnum.DEV_DEPENDENCIES,l=r.includes(o),c=s&&o===dependency_interface_1.DependencyType.DEPENDENCY_TYPE_HAR;if(!l||_||!(0,npm_utils_1.isLocalDependency)(a)||c)return void this._log.debug("Exit dependency chick: ",`Dependency Type: ${o};`,`Dependency value: ${a}`);const d=(null===(t=this.FILE_START_EXP.exec(a))||void 0===t?void 0:t[1])||a,p=path_1.default.resolve(n,d);!path_1.default.isAbsolute(d)&&file_util_js_1.FileUtil.isSubDir(n,p)||this._log.printErrorExit("THE_LOCAL_DEPENDENCY_BELOW_IN_MODULE_%S_IS_INVALID",[e.getName(),`"${i.getDependencyName()}":"${a}"`])})}}exports.ValidateUtil=ValidateUtil,ValidateUtil._log=ohos_logger_js_1.OhosLogger.getLogger(ValidateUtil.name),ValidateUtil.richDeviceTypes=new Set(["phone","tablet","tv","wearable","car"]),ValidateUtil.liteDeviceTypes=new Set(["lite Wearable","smart Vision","router"]),ValidateUtil.hosApiCompatible=new Map([[9,9],[10,9],[11,9],[12,10]]),ValidateUtil.FILE_START_EXP=/^file:(.*)/i;