"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.shouldTreatHarAsHap=exports.checkByteCodeHar=exports.collectByteCodeInfoAndOtherCompileEntrances=void 0;const hvigor_arkts_compose_1=require("@ohos/hvigor-arkts-compose"),path_1=__importDefault(require("path")),fs_extra_1=__importDefault(require("fs-extra")),sdk_const_js_1=require("../const/sdk-const.js"),dependency_interface_js_1=require("../project/dependency/core/dependency-interface.js"),ohos_logger_js_1=require("./log/ohos-logger.js"),inject_util_js_1=require("./inject-util.js"),code_type_enum_1=require("../enum/code-type-enum"),build_directory_const_1=require("../const/build-directory-const"),common_const_1=require("../const/common-const"),logger=ohos_logger_js_1.OhosLogger.getLogger("byte-code-har-utils"),isHsp=e=>e.getDependencyType()===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HSP,isHar=e=>e.getDependencyType()===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HAR,isNpmPackage=e=>e.getDependencyType()===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_OTHER,isByteCodeHar=e=>e.isByteCodeHarDependency(),isBundledDependency=e=>e.isBundleDependency(),isSourceCodeHar=e=>isHar(e)&&!e.isByteCodeHarDependency(),isBlockedByByteCodeHar=e=>!!e.parent&&isByteCodeHar(e.parent.npm),getPackageNameFromImportee=e=>{const t=e.startsWith("@"),o=e.split(/[/\\]/);return t?o.slice(0,2).join("/"):o[0]},getFinalNodes=e=>inject_util_js_1.InjectUtil.isByteCodeHarOptimize()?e.filter(e=>!e.npm.isHspDependency()):e.filter(e=>{const t=e.npm;return!isHsp(t)&&t.getDependencyEnum()!==dependency_interface_js_1.DependencyEnum.DEV_DEPENDENCIES}),collectByteCodeHarInfo=(e,t)=>{const o=e.getPackageName(),n=e.getDependencyRootPath(),r=path_1.default.join(n,code_type_enum_1.CodeType.ETS,build_directory_const_1.BuildArtifactConst.MODULES_ABC);if(t.has(r))return;if(!fs_extra_1.default.existsSync(r))return void logger.debug(`Dependency [${o}] is byte-code HAR, but '${code_type_enum_1.CodeType.ETS}/${build_directory_const_1.BuildArtifactConst.MODULES_ABC}' does not exists.`);const s=path_1.default.join(n,code_type_enum_1.CodeType.ETS,build_directory_const_1.BuildArtifactConst.SOURCEMAPS_MAP),c={abcPath:r,packageName:o,...fs_extra_1.default.existsSync(s)?{sourceMapsPath:s}:{}};t.set(n,c)},collectEntryPath=(e,t)=>{const o=e.getDependencyRootPath(),n=e.getDependencyMainFileRelativePath(),r=n?path_1.default.resolve(o,n):e.getDependencyMainFilePath();!t.has(r)&&fs_extra_1.default.existsSync(r)&&t.set(r,!1)},collectSourceCodeHarInfo=(e,t)=>{collectEntryPath(e,t);const o=e.getDependencyRootPath(),n=path_1.default.resolve(o,build_directory_const_1.BuildDirConst.SRC,build_directory_const_1.BuildDirConst.MAIN,code_type_enum_1.CodeType.ETS);!t.has(n)&&fs_extra_1.default.existsSync(n)&&fs_extra_1.default.statSync(n).isDirectory()&&t.set(n,!0)},collectExtraImportees=(e,t)=>{var o;const n=e.getPackageJsonObj();((null===(o=null==n?void 0:n.metadata)||void 0===o?void 0:o.extraImportees)||[]).forEach(e=>{t.add(e)})},processBundledNodeDependencies=e=>{var t;const{node:o,childrenPendingOrProcessed:n}=e,r=o.npm.getDependencyRootPath();if(n.has(r))return;n.add(r);const s=o.npm.getPackageJsonObj(),c=(null===(t=null==s?void 0:s.metadata)||void 0===t?void 0:t.compiledPackageNames)||[],d=getFinalNodes(o.children);for(;d.length;){const t=d.shift(),o=t.npm.getPackageName();c.includes(o)?d.push(...getFinalNodes(t.children)):processNode({...e,node:t,blockedByByteCodeHar:!0})}},processBundledNode=e=>{const{node:t,byteCodeInfo:o,extraImportees:n}=e,r=t.npm;return!!isBundledDependency(r)&&(collectByteCodeHarInfo(r,o),collectExtraImportees(r,n),processBundledNodeDependencies(e),!0)},enqueueChildren=e=>{const{node:t,childrenPendingOrProcessed:o,queue:n}=e,r=t.npm.getDependencyRootPath();o.has(r)||(o.add(r),n.push(...getFinalNodes(t.children)))},processByteCodeHarNode=e=>{const{node:t,byteCodeInfo:o,extraImportees:n}=e,r=t.npm;return!(!isByteCodeHar(r)||isBundledDependency(r))&&(collectByteCodeHarInfo(r,o),collectExtraImportees(r,n),enqueueChildren(e),!0)},processSourceCodeHarNode=e=>{const{node:t,queue:o,otherCompileEntrances:n,blockedByByteCodeHar:r}=e,s=t.npm;return!!isSourceCodeHar(s)&&((r||isBlockedByByteCodeHar(t))&&collectSourceCodeHarInfo(s,n),enqueueChildren(e),!0)},processNpmPackageNode=e=>{const{node:t,queue:o,otherCompileEntrances:n,blockedByByteCodeHar:r}=e,s=t.npm;return!!isNpmPackage(s)&&((r||isBlockedByByteCodeHar(t))&&collectEntryPath(s,n),!0)},chains=[processBundledNode,processByteCodeHarNode,processSourceCodeHarNode,processNpmPackageNode],processNode=e=>{chains.some(t=>t(e))},processExtraImportees=(e,t,o)=>{const n=new Map;e.getModuleService().getOtherDependencies().forEach(e=>{n.set(e.getPackageName(),e)}),t.forEach(e=>{const t=getPackageNameFromImportee(e);if(!n.has(t))return void logger.debug(`Can not find dependency [${t}], make sure it has been installed successfully`);const r=n.get(t);if(t===e)return void collectEntryPath(r,o);const s=path_1.default.join(r.getDependencyRootPath(),e.substring(t.length)),c=(0,hvigor_arkts_compose_1.findSuitableFilePath)(s,hvigor_arkts_compose_1.SUPPORT_EXTENSIONS);c?o.set(c,!1):logger.debug(`Can not find file path by importee: ${e} [${t}]`)})},collectByteCodeInfoAndOtherCompileEntrances=e=>{const t=e.getModuleService(),o=inject_util_js_1.InjectUtil.isByteCodeHarOptimize()?t.getAllDirectPkgNodes():t.getDirectPkgNodes(),n=getFinalNodes(o),r=new Set,s=new Set,c=new Map,d=new Map;for(;n.length;){const e=n.shift();processNode({node:e,queue:n,byteCodeInfo:d,extraImportees:r,childrenPendingOrProcessed:s,otherCompileEntrances:c})}return processExtraImportees(e,r,c),{byteCodeInfo:d,otherCompileEntrances:c}};exports.collectByteCodeInfoAndOtherCompileEntrances=collectByteCodeInfoAndOtherCompileEntrances;const checkByteCodeHar=({logger:e,compileApiVersion:t,compatibleApiVersion:o,useNormalizedOHMUrl:n})=>{(t<sdk_const_js_1.ApiVersion.API_VERSION_12||o<sdk_const_js_1.ApiVersion.API_VERSION_12)&&e.printErrorExit("BYTECODEHAR_NOT_SUPPORTED_WHEN_BLOW_API_VERSION_12"),n||e.printErrorExit("BYTECODEHAR_NOT_SUPPORTED_WHEN_USENORMALLIZEDOHMURL_IS_NOT_TRUE")};exports.checkByteCodeHar=checkByteCodeHar;const shouldTreatHarAsHap=e=>inject_util_js_1.InjectUtil.isLocalTest()||inject_util_js_1.InjectUtil.isPreviewProcess()||inject_util_js_1.InjectUtil.isOhosTest()&&e===common_const_1.DefaultTargetConst.OHOS_TEST_TARGET;exports.shouldTreatHarAsHap=shouldTreatHarAsHap;