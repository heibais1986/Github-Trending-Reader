"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,o){void 0===o&&(o=i);var c=Object.getOwnPropertyDescriptor(t,i);c&&!("get"in c?!t.__esModule:c.writable||c.configurable)||(c={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,o,c)}:function(e,t,i,o){void 0===o&&(o=i),e[o]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.copyParameterizationLocalProductDependencies=exports.getTypesFieldFromMainField=exports.execOhpmPack=exports.getNpmPath=exports.isLocalDependency=exports.collectLocalFileDependency=exports.checkHasLocalFileDependency=void 0;const hvigor_1=require("@ohos/hvigor"),hvigor_2=require("@ohos/hvigor"),fse=__importStar(require("fs-extra")),path_1=__importDefault(require("path")),tar_1=__importDefault(require("tar")),file_util_js_1=require("./file-util.js"),hvigor_common_1=require("@ohos/hvigor-common"),isFileSpec=(0,hvigor_2.isWindows)()?/^(?:[.]|~[/]|[/\\]|[a-zA-Z]:)/:/^(?:[.]|~[/]|[/]|[a-zA-Z]:)/,hasSlashes=(0,hvigor_2.isWindows)()?/\\|[/]/:/[/]/,isFileName=/[.](?:tgz|tar.gz|tar)$/i;function checkHasLocalFileDependency(e,t,i){const o=t;return void 0!==o.dependencies&&Object.values(o.dependencies).some(t=>{if(!1!==(null==i?void 0:i.allowInside)&&isLocalDependency(t)&&t){const i=/^file:(.*)/i.test(t)?/^file:(.*)/i.exec(t)[1]:t;return!file_util_js_1.FileUtil.isSubDir(path_1.default.dirname(e),path_1.default.resolve(path_1.default.dirname(e),i))}return isLocalDependency(t)})}function collectLocalFileDependency(e,t){const i=[],o=t;return void 0===o.dependencies||Object.values(o.dependencies).forEach(t=>{if(isLocalDependency(t)&&t){const o=/^file:(.*)/i.test(t)?/^file:(.*)/i.exec(t)[1]:t;file_util_js_1.FileUtil.isSubDir(path_1.default.dirname(e),path_1.default.resolve(path_1.default.dirname(e),o))&&i.push(o)}}),i}function isLocalDependency(e){return!!e&&(isFileSpec.test(e)||/^file:/i.test(e)||hasSlashes.test(e)||isFileName.test(e))}function getNpmPath(){return process.execPath}async function execOhpmPack(e,t,i,o=!0){const c="execute ohpm packaging command",r=i.createSubEvent(c,"");r.start(),await tar_1.default.create({cwd:e,noDirRecurse:!1,file:t,gzip:!0,prefix:o?"package":void 0},await fse.readdir(e)),r.stop(),r.setLog(c,hvigor_1.MetricLogType.INFO)}exports.checkHasLocalFileDependency=checkHasLocalFileDependency,exports.collectLocalFileDependency=collectLocalFileDependency,exports.isLocalDependency=isLocalDependency,exports.getNpmPath=getNpmPath,exports.execOhpmPack=execOhpmPack;const REGEX_ETS=/(.+)\.ets$/,REGEX_TS=/(.+)\.ts$/,REGEX_D=/(.+)\.d$/,getTypesFieldFromMainField=e=>void 0===e||""===e?"index.d.ets":REGEX_ETS.test(e)?e.replace(REGEX_ETS,"$1.d.ets"):REGEX_TS.test(e)?e.replace(REGEX_TS,"$1.d.ts"):REGEX_D.test(e)?e:`${e}.d`;function copyParameterizationLocalProductDependencies(e){const{localProductDependencies:t,moduleDir:i,tempDir:o,logger:c}=e;i&&o&&(null==c||c.debug("These local product dependencies should be copied to har.",{moduleDir:i,localProductDependencies:t}),null==t||t.forEach(e=>{if((0,hvigor_common_1.isSubPath)(e,i)){const t=path_1.default.relative(i,e),r=path_1.default.resolve(o,t);if(fse.existsSync(r))return;fse.ensureDirSync(path_1.default.dirname(r)),fse.copyFileSync(e,r),null==c||c.debug("This local product dependency inside the module has been copied to har.",{depPath:e,moduleDir:i,copyTo:r})}else{const t=path_1.default.basename(e),i=path_1.default.resolve(o,t);if(fse.existsSync(i))return;fse.copyFileSync(e,i),null==c||c.debug("This local product dependency outside the module has been copied to har.",{depPath:e,copyTo:i})}}))}exports.getTypesFieldFromMainField=getTypesFieldFromMainField,exports.copyParameterizationLocalProductDependencies=copyParameterizationLocalProductDependencies;