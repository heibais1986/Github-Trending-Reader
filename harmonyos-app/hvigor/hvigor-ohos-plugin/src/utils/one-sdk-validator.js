"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ApiModel=exports.OneSdkValidator=void 0;const hos_sdkmanager_common_1=require("@ohos/hos-sdkmanager-common"),find_target_product_js_1=require("../common/find-target-product.js"),common_const_js_1=require("../const/common-const.js"),sdk_const_js_1=require("../const/sdk-const.js"),project_build_profile_js_1=require("../options/build/project-build-profile.js"),ohos_logger_js_1=require("./log/ohos-logger.js");var ApiValType=project_build_profile_js_1.ProjectBuildProfile.ApiValType;const validate_util_js_1=require("./validate/validate-util.js"),task_util_js_1=require("./task-util.js");class OneSdkValidator{static evlProductRuntimeOS(t){const o=(0,find_target_product_js_1.findTargetProduct)(t),e=t.getTargetRuntimeOSs();if(o.runtimeOS)return o.runtimeOS;return e.filter(t=>t.productName===o.name).find(t=>t.runtimeOS===common_const_js_1.CommonConst.HARMONY_OS)?common_const_js_1.CommonConst.HARMONY_OS:common_const_js_1.CommonConst.OPEN_HARMONY}static apiInspection(t){var o,e,i;const r=(0,find_target_product_js_1.findTargetProduct)(t),s=this.evlProductRuntimeOS(t)===common_const_js_1.CommonConst.HARMONY_OS,n=(0,task_util_js_1.isAtomicServiceProject)(r,t);validate_util_js_1.ValidateUtil.integrationVersionCheck(s,(0,find_target_product_js_1.findTargetProduct)(t),n,t.getProfilePath());const _=null===(o=t.getProductApiMeta(r.name))||void 0===o?void 0:o.compileSdkVersion,a=null===(e=t.getProductApiMeta(r.name))||void 0===e?void 0:e.compatibleSdkVersion,p=null===(i=t.getProductApiMeta(r.name))||void 0===i?void 0:i.targetSdkVersion;this.versionCompatibilityCheck(t,s,common_const_js_1.CommonConst.COMPILE_SDK_VERSION,_),this.versionCompatibilityCheck(t,s,common_const_js_1.CommonConst.COMPATIBLE_SDK_VERSION,a),this.versionCompatibilityCheck(t,s,common_const_js_1.CommonConst.TARGET_SDK_VERSION,p),this.versionTypeCheck(t,s,_),this.versionTypeCheck(t,s,a),this.versionTypeCheck(t,s,p);const l=_.version,d=a.version,c=null==p?void 0:p.version;l<8&&this._log.printErrorExit("SDK_VERSION_UNDER_API8",[l,t.getProfilePath()]),s&&_.version>9&&(0===_.type||0===a.type||p&&0===p.type)&&this._log.printErrorExit("API_VERSION_VALIDATE_FAILED"),this.apiTypeCheck(s,r.compileSdkVersion,t),this.apiTypeCheck(s,r.compatibleSdkVersion,t),this.apiTypeCheck(s,r.targetSdkVersion,t),s&&OneSdkValidator.evlApiModel(t,r)===ApiModel.ONE_MSF&&this.msfCompare(t,_,a,p),(c?d<=c&&d<=l&&c<=l:d<=l)||this._log.printErrorExit("SDKVERSION_ORDER_ERROR",[t.getProfilePath()])}static apiTypeCheck(t,o,e){o&&typeof o==(t?"number":"string")&&this._log.printErrorExit("API_VERSION_VALIDATE_FAILED")}static versionTypeCheck(t,o,e){if(!o&&(null==e?void 0:e.type)===ApiValType.NUM)return;if(!e)return;const i=e.version;if(e.type===ApiValType.NUM?i>sdk_const_js_1.ApiVersion.API_VERSION_9:i<sdk_const_js_1.ApiVersion.API_VERSION_9){e.type,ApiValType.NUM;this._log.printErrorExit("API_VERSION_VALIDATE_FAILEDR")}}static versionCompatibilityCheck(t,o,e,i){if(!o||(null==i?void 0:i.type)===ApiValType.NUM)return;if(!i)return;const r=hos_sdkmanager_common_1.HosVersionMapper.INSTANCE.transferVersionIntoHosVersion(i.api);r?this.isBaseApiEqual(r,i.version)||this._log.printErrorExit("SDKMANAGER_APIVERSION_AND_PLATFORM_NOT_MATCH",[i.api,i.version,e,t.getProfilePath()]):this._log.printErrorExit("SDKMANAGER_NOT_SUPPORT_THIS_API",[e,i.api,i.version,t.getProfilePath()])}static isBaseApiEqual(t,o){return t.getBaseApi()===o}static msfCompare(t,o,e,i){let r=OneSdkValidator.compareMsf(o.api,e.api);r<0&&this._log.printErrorExit("SDKVERSION_ORDER_ERROR",[t.getProfilePath()]),i&&(r=OneSdkValidator.compareMsf(o.api,i.api),r<0&&this._log.printErrorExit("SDKVERSION_ORDER_ERROR",[t.getProfilePath()]),r=OneSdkValidator.compareMsf(i.api,e.api),r<0&&this._log.printErrorExit("SDKVERSION_ORDER_ERROR",[t.getProfilePath()]))}static ohosProductApiValid(t){return!!t&&"number"==typeof t&&t<sdk_const_js_1.ApiVersion.API_VERSION_10}static compareMsf(t,o){const e=OneSdkValidator.parseMsf(t),i=OneSdkValidator.parseMsf(o);return e.m!==i.m?e.m>i.m?1:-1:e.s!==i.s?e.s>i.s?1:-1:e.f!==i.f?e.f>i.f?1:-1:0}static parseMsf(t){const o=t.split(".");if(3!==o.length)throw new Error("Invalid MSF version string.");return{m:parseInt(o[0]),s:parseInt(o[1]),f:parseInt(o[2])}}static evlApiModel(t,o){var e,i;const r=null===(e=t.getProductApiMeta(o.name))||void 0===e?void 0:e.compileSdkVersion,s=null===(i=t.getProductApiMeta(o.name))||void 0===i?void 0:i.compatibleSdkVersion;return 1===r.type&&1===s.type?ApiModel.ONE_MSF:0===r.type&&0===s.type?ApiModel.ONE_NUM:ApiModel.ORIGINAL}}var ApiModel;exports.OneSdkValidator=OneSdkValidator,OneSdkValidator._log=ohos_logger_js_1.OhosLogger.getLogger("OneSdk"),function(t){t[t.ORIGINAL=0]="ORIGINAL",t[t.ONE_MSF=1]="ONE_MSF",t[t.ONE_NUM=2]="ONE_NUM",t[t.UNDEFINED=4]="UNDEFINED"}(ApiModel=exports.ApiModel||(exports.ApiModel={}));