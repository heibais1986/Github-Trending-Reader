"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,o,s){void 0===s&&(s=o);var r=Object.getOwnPropertyDescriptor(t,o);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,s,r)}:function(e,t,o,s){void 0===s&&(s=o),e[s]=t[o]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&__createBinding(t,e,o);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ProcessUtils=void 0;const hvigor_1=require("@ohos/hvigor"),hvigor_2=require("@ohos/hvigor"),child_process_1=require("child_process"),fs_1=__importDefault(require("fs")),os=__importStar(require("os")),path_1=__importDefault(require("path")),error_code_map_js_1=require("../error/error-code-map.js"),task_names_js_1=require("../tasks/common/task-names.js"),log_combine_type_1=require("./log/log-combine-type"),ohos_logger_js_1=require("./log/ohos-logger.js");class ProcessUtils{constructor(e="root",t="defaultTask",o="",s="Tools execution failed.",r="Please check the message from tools.",i=((0,hvigor_2.isWindows)()?"GBK":"utf-8")){this._defaultOptions={encoding:null,windowsHide:!0},this._moduleName=e,this._taskName=t,this._errLog=s,this._solution=r,this._ohosCharset=i,this._log=ohos_logger_js_1.OhosLogger.getLogger(`${e}:${t}`),o&&this._log.setLevel(o)}async submitExecutionWithoutReturn(e,t,o,s,r,i,n,a=log_combine_type_1.LogCombineType.WARN){const _={workInput:o={...o},callback:s,callbackInput:r,targetWorkers:n},l=path_1.default.resolve(__dirname,"../tasks/worker/worker-process-script.js/generalExecute");if(t.submit(e,l,_).getState()===hvigor_1.TaskState.REJECT){const e="execute the command",t=i.createSubEvent(e,"");t.start(),await this.execute(o.commandLine,o.commandOptions,a),o.integratedHspCommand&&await this.execute(o.integratedHspCommand),await s(...r),t.stop(),t.setLog(e,hvigor_1.MetricLogType.INFO)}}submitSyncExecutionWithReturn(e,t,o,s,r,i){const n={workInput:s={...s},callback:r,targetWorkers:i,useReturnVal:!0};return t.submit(e,path_1.default.resolve(__dirname,"../tasks/worker/worker-process-script.js",o),n).getState()!==hvigor_1.TaskState.REJECT}async execute(e,t,o=log_combine_type_1.LogCombineType.WARN,s){var r,i;const n=this.processOptionsFactory(t),a={stdout:"",stderr:""};try{this.validateExecuteFile(e[0]),this._log.debug("current process  memoryUsage:",process.memoryUsage(),"os memoryUsage :"+(os.totalmem()-os.freemem())/1024/1024/1024);const t=(0,child_process_1.spawn)(e[0],e.slice(1),n);null===(r=t.stdout)||void 0===r||r.on("data",e=>{const t=hvigor_1.iconv.decode(e,this._ohosCharset);this._log.debug(t),this.needPrintWarnWhenNoReturnValue()&&this.nativeNoReturnValueWarningHandler(t,o),a.stdout+=t}),null===(i=t.stderr)||void 0===i||i.on("data",e=>{const t=hvigor_1.iconv.decode(e,this._ohosCharset);a.stderr+=t}),await new Promise((r,i)=>{t.once("close",t=>{if(0===t){if(s&&s(a,this._ohosCharset))return void r();o===log_combine_type_1.LogCombineType.DEBUG&&this._log.debug(a.stderr),o===log_combine_type_1.LogCombineType.WARN&&this._log.warn(a.stderr),r()}else i(this.makeError(a.stdout.trim(),a.stderr.trim(),"",t,e.join(" "),e.join(" ")))})})}catch(e){throw this.handleException(e,o),e}return a}executeSync(e,t,o=log_combine_type_1.LogCombineType.WARN){var s,r;const i=this.processOptionsFactory(t);let n;try{this.validateExecuteFile(e[0]),n=(0,child_process_1.spawnSync)(e[0],e.slice(1),i);const t=hvigor_1.iconv.decode(n.stdout,this._ohosCharset),a=hvigor_1.iconv.decode(n.stderr,this._ohosCharset);if(n.error||0!==n.status){const s=this.makeError(t.trim(),a.trim(),n.error,n.status,e.join(" "),e.join(" "));this.handleException(s,o)}(null===(s=n.stdout)||void 0===s?void 0:s.length)>0&&this._log.debug(t),(null===(r=n.stderr)||void 0===r?void 0:r.length)>0&&(o===log_combine_type_1.LogCombineType.DEBUG&&this._log.debug(a),o===log_combine_type_1.LogCombineType.WARN&&this._log.warn(a))}catch(t){const s=this.makeError("","",t,t.status,e.join(" "),e.join(" "));this.handleException(s,o)}return n}handleOutput(e,t){var o;if((null===(o=e.stderr)||void 0===o?void 0:o.length)>0){const o=hvigor_1.iconv.decode(e.stderr,this._ohosCharset);t===log_combine_type_1.LogCombineType.DEBUG&&this._log.debug(o),t===log_combine_type_1.LogCombineType.WARN&&this._log.warn(o)}0!==e.status&&this._log._buildError(this._errLog)._solution(hvigor_1.iconv.decode(e.stderr,this._ohosCharset))._printError(this._moduleName)}handleException(e,t){var o;if(e.stderr&&e.stderr.length>0){const s=/(-keystorePwd|-keyPwd) \S+/g,r=null===(o=e.command)||void 0===o?void 0:o.replace(s,"$1 ***");this._log.debug(`ERROR: command = ${r}`),this._log._buildError(t===log_combine_type_1.LogCombineType.IGNORE?`${this._errLog}${os.EOL}${e.message}`:`${this._errLog}${os.EOL}${e.stderr}`),this._log._solution(this._solution)}else this._log._buildError(`${this._errLog}${os.EOL}${e.message}`);this._log._errorCode(error_code_map_js_1.ECM.DECE.PROCESS_UTILS_HANDLE_EXCEPTION),this._log._printErrorAndExit(this._moduleName)}execaCommandSync(e,t){const o=(0,child_process_1.spawnSync)(e,t);return this.printExecaResultLog(o),o}async execaCommand(e,t){const o=this.processOptionsFactory(t);await new Promise((t,s)=>{var r,i;const n=(0,child_process_1.spawn)(e,o);let a="",_="";null===(r=n.stdout)||void 0===r||r.on("data",e=>{a+=hvigor_1.iconv.decode(e,this._ohosCharset)}),null===(i=n.stderr)||void 0===i||i.on("data",e=>{_+=hvigor_1.iconv.decode(e,this._ohosCharset)}),n.on("close",e=>{if(0!==e){s(a+_)}else t(a)})}).then(e=>{this._log.info(e)}).catch(e=>{this._log._buildError(this._errLog)._solution(e)._printErrorAndExit()})}printExecaResultLog(e){var t,o;(null===(t=e.stdout)||void 0===t?void 0:t.length)>0&&this._log.info(hvigor_1.iconv.decode(e.stdout,this._ohosCharset)),(null===(o=e.stderr)||void 0===o?void 0:o.length)>0&&this._log.warn(hvigor_1.iconv.decode(e.stderr,this._ohosCharset)),0!==e.status&&this._log._buildError(this._errLog)._solution(hvigor_1.iconv.decode(e.stderr,this._ohosCharset))._printErrorAndExit()}needPrintWarnWhenNoReturnValue(){return this._taskName.endsWith(task_names_js_1.TaskNames.Task.BUILD_NATIVE_WITH_NINJA.name)||this._taskName.endsWith(task_names_js_1.TaskNames.Task.BUILD_NATIVE_WITH_CMAKE.name)}processOptionsFactory(e){var t,o;const s=null!==(t=process.env.PATH)&&void 0!==t?t:"";return e&&(e.windowsHide=!0),(null==e?void 0:e.env)&&(e.env={...process.env,...e.env}),(null===(o=null==e?void 0:e.env)||void 0===o?void 0:o.path)&&(e.env.PATH=e.env.path+((0,hvigor_2.isWindows)()?";":":")+s),{...this._defaultOptions,...e}}validateExecuteFile(e){"java"!==e&&"javac"!==e&&(fs_1.default.existsSync(path_1.default.normalize(e))||this._log.printErrorExit("FILE_NOT_FOUNF_OR_UNEXCUTABLE",[e],[[e],[e]]))}makeError(e,t,o,s,r,i){const n=void 0!==s?`Command failed with exit code ${s}: ${r}`:`failed: ${r}`,a="[object Error]"===Object.prototype.toString.call(o),_=a?`${n}\n${o.message}`:n,l=[_,t,e].filter(Boolean).join("\n");return a?(o.originalMessage=o.message,o.message=l):o=new Error(l),o.shortMessage=_,o.command=r,o.escapedCommand=i,o.exitCode=s,o.stdout=e,o.stderr=t,"bufferedData"in o&&delete o.bufferedData,o.failed=!0,o}nativeNoReturnValueWarningHandler(e,t){/warning: non-void function does not return a value/.test(e)&&t===log_combine_type_1.LogCombineType.WARN&&this._log.warn(e)}}exports.ProcessUtils=ProcessUtils;