"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.transformRules=exports.resolveObfuscationDependencies=exports.resolveObfuscationOptions=void 0;const fs_1=__importDefault(require("fs")),promises_1=__importDefault(require("fs/promises")),path_1=__importDefault(require("path")),hvigor_1=require("@ohos/hvigor"),build_option_path_info_js_1=require("../common/build-option-path-info.js"),common_const_js_1=require("../const/common-const.js"),module_type_enum_js_1=require("../enum/module-type-enum.js"),build_mode_manager_js_1=require("../project/build-option/build-mode-manager.js"),dependency_interface_js_1=require("../project/dependency/core/dependency-interface.js"),file_util_js_1=require("./file-util.js"),ohos_logger_js_1=require("./log/ohos-logger.js"),_log=ohos_logger_js_1.OhosLogger.getLogger("obfuscation"),resolveObfuscationOptions=async(e,o,t)=>{var s,n,i;const r=e.getTargetData().getModuleModel(),l=e.getTargetData().getTargetName();if(!o)return;const a=await(0,exports.resolveObfuscationDependencies)(r,e.getModuleService());return o.ruleOptions={enable:null===(s=o.ruleOptions)||void 0===s?void 0:s.enable,rules:(null===(n=o.ruleOptions)||void 0===n?void 0:n.rules)||(0,exports.transformRules)(null===(i=o.ruleOptions)||void 0===i?void 0:i.files,r.getProjectDir(),r,l)},o.consumerRules=o.consumerRules||(0,exports.transformRules)(o.consumerFiles,r.getProjectDir(),r,l),{selfConfig:o,sdkApis:[],obfuscationCacheDir:t,exportRulePath:e.getTargetData().getPathInfo().getObfuscationExportRulePath(),dependencies:a}};exports.resolveObfuscationOptions=resolveObfuscationOptions;const resolveObfuscationDependencies=async(e,o)=>{const t={libraries:[],hspLibraries:[],hars:[],hsps:[]};return await resolveDepObfuscationOptions(e,o,t),t};exports.resolveObfuscationDependencies=resolveObfuscationDependencies;const resolveDepObfuscationOptions=async(e,o,t)=>{var s,n,i;const r=e.getParentProject().isOhpmProject(),l=["version","devDependencies","dynamicDependencies","dependencies"],a=r?e.getOhPackageJson5Path():e.getPackageJsonPath();if(!fs_1.default.existsSync(a))return;const u=await hvigor_1.Json5Reader.readJson5File(a);if(r){const o=e.getParentProject().getParameterFileObj(),t={parameterFilePath:e.getParentProject().getParameterFileAbsolutePath(),ohPackageFilePath:a};file_util_js_1.FileUtil.resolveJsonObjWithoutParam(u,o,t,l)}if(!(null==u?void 0:u.name))return;const c=r?common_const_js_1.CommonConst.OH_MODULES:common_const_js_1.CommonNodeConst.NODE_MODULES;for(const r in u.dependencies){if(!Object.prototype.hasOwnProperty.call(null==u?void 0:u.dependencies,r))continue;const l=path_1.default.resolve(e.getProjectDir(),c,...r.split("/"));if(!fs_1.default.existsSync(l)){_log.warn(`Dependency ${r} not found.`);continue}let a;try{a=await promises_1.default.lstat(l)}catch(e){_log.warn(`Dependency ${r} not found or symbolic link is invalid.`);continue}const p=a.isSymbolicLink()?await promises_1.default.realpath(l):l,d=resolveModuleWithPath(p,e.getAllModules());if(!d){const e=path_1.default.resolve(p,common_const_js_1.CommonConst.OBFUSCATION_TXT),s=o.getAllDependencyType().get(r);fs_1.default.existsSync(e)&&(_log.debug(`Collect obfuscation config from dependency ${r}.`),s===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HAR&&-1===t.hars.indexOf(e)&&t.hars.push(e),s===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HSP&&-1===t.hsps.indexOf(e)&&t.hsps.push(e));continue}const _=d.getModuleType(),f=null===(s=build_mode_manager_js_1.buildOptionManager.getTargetBuildOption(d.getName(),"default").arkOptions)||void 0===s?void 0:s.obfuscation;if(f){if(t.libraries.find(e=>e.libDir===p)||t.hspLibraries.find(e=>e.libDir===p))continue;_log.debug(`Collect obfuscation config from library ${d.getName()}.`);const e={ruleOptions:{enable:null===(n=f.ruleOptions)||void 0===n?void 0:n.enable,rules:(0,exports.transformRules)(null===(i=f.ruleOptions)||void 0===i?void 0:i.files,p,d,"default")},consumerRules:(0,exports.transformRules)(f.consumerFiles,p,d,"default"),libDir:p};_===module_type_enum_js_1.ModuleType.Har&&t.libraries.push(e),_===module_type_enum_js_1.ModuleType.Shared&&t.hspLibraries.push(e)}d.isHarModule()&&await resolveDepObfuscationOptions(d,o,t)}},resolveModuleWithPath=(e,o)=>{for(const t of o.values()){if(""===path_1.default.relative(t.getProjectDir(),e))return t}},transformRules=(e,o,t,s)=>{if(!e)return[];const n=[];return"string"==typeof e?(checkObFile(e,o,n,t,s),n):(e.forEach(e=>checkObFile(e,o,n,t,s)),n)};exports.transformRules=transformRules;const checkObFile=(e,o,t,s,n)=>{const i=path_1.default.resolve(o,e),r=build_option_path_info_js_1.buildOptionPath.getTargetBuildOptPath(s,n,"files");fs_1.default.existsSync(i)||_log.printErrorExit("OBFUSCATION_FILE_LOST",[e,i,s.getName(),r],[[e,i]]),t.push(i)};