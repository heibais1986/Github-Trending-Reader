"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ModuleModelImpl=void 0;const path_1=__importDefault(require("path")),hvigor_1=require("@ohos/hvigor"),find_target_product_js_1=require("../../common/find-target-product.js"),common_const_js_1=require("../../const/common-const.js"),module_type_enum_js_1=require("../../enum/module-type-enum.js"),array_util_js_1=require("../../utils/array-util.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),task_util_js_1=require("../../utils/task-util.js"),validate_util_js_1=require("../../utils/validate/validate-util.js"),target_source_set_impl_js_1=require("../source-set/target-source-set-impl.js"),core_module_model_impl_js_1=require("./core-module-model-impl.js"),defaultTargetName=common_const_js_1.DefaultTargetConst.DEFAULT_TARGET,ohosTestTargetName=common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET,_log=ohos_logger_js_1.OhosLogger.getLogger("moduleModel");class ModuleModelImpl extends core_module_model_impl_js_1.CoreModuleModelImpl{constructor(e,t){super(e,t),this.initDefaultTargetSourceSet()}getDeviceTypes(){var e;const t=null===(e=this.getSourceSetByTargetName().getModuleTargetRes().getModuleJsonOpt())||void 0===e?void 0:e.module.deviceTypes;return null==t&&_log.printErrorExit("DEVICE_TYPE_NOT_FOUND_STAGE",[],[[this.getSourceSetByTargetName().getModuleTargetRes().getJsonPath()]]),t}initDefaultTargetSourceSet(){const e=new target_source_set_impl_js_1.TargetSourceSetImpl(path_1.default.resolve(this._sourceRootDir,"main"));this.targetSourceSetMap.set(defaultTargetName,e);if((0,array_util_js_1.getElementFromArr)(this.getProfileOpt().targets,ohosTestTargetName)){const e=new target_source_set_impl_js_1.TargetSourceSetImpl(path_1.default.resolve(this._sourceRootDir,ohosTestTargetName));this.targetSourceSetMap.set(ohosTestTargetName,e)}}getModuleType(){const e=this.getSourceSetByTargetName();e||_log.printErrorExit("STAGE_NO_SYSTEM_PLUGIN",[`${path_1.default.resolve(this.getProjectDir(),hvigor_1.HvigorCommonConst.BUILD_FILE_NAME)}.ts`],[[`${path_1.default.resolve(this.getProjectDir(),hvigor_1.HvigorCommonConst.BUILD_FILE_NAME)}.ts`]]);const t=e.getModuleTargetRes().getModuleJsonOpt();return void 0===t&&_log.printErrorExit("MODULEJSON5_FILE_NOT_FOUND",[],[[e.getModuleTargetRes().getJsonPath()]]),void 0===t.module&&_log.printErrorExit("NO_MODULE_INFORMATION",[e.getModuleTargetRes().getJsonPath()],[[e.getModuleTargetRes().getJsonPath()]]),void 0===t.module.type&&_log.printErrorExit("NO_MODULE_TYPE",[e.getModuleTargetRes().getJsonPath()],[[e.getModuleTargetRes().getJsonPath()]]),module_type_enum_js_1.ModuleType.valueOf(t.module.type)}getSourceSetByTargetName(e=defaultTargetName){return this.targetSourceSetMap.has(e)?this.targetSourceSetMap.get(e):this.targetSourceSetMap.get(defaultTargetName)}getJsonObjByTargetName(e){return this.getSourceSetByTargetName(e).getModuleTargetRes().getModuleJsonOpt()}getJsonPathByTargetName(e){return this.getSourceSetByTargetName(e).getModuleTargetRes().getJsonPath()}isAtomicService(){const e=(0,find_target_product_js_1.findTargetProduct)(this.getParentProject());return(0,task_util_js_1.isAtomicServiceProject)(e,this.getParentProject())}isInstallFree(){return this.getJsonObjByTargetName(defaultTargetName).module.installationFree||!1}getFormJsonObjByTargetName(e,t){const r=this.getSourceSetByTargetName(e).getModuleTargetRes().getFormJsonOpt(t);validate_util_js_1.ValidateUtil.validateDuplicatedName(r.forms,"Form",t);const o=path_1.default.resolve(this.getSourceSetByTargetName(e).getModuleTargetRes().getResourcePath(),t);return validate_util_js_1.ValidateUtil.isDefaultCheck(r.forms,o),validate_util_js_1.ValidateUtil.checkUpdateEnable(r.forms,o),r}getPermission(){const e=this.getSourceSetByTargetName().getModuleTargetRes().getModuleJsonOpt();return{requestPermissions:e.module.requestPermissions,definePermissions:e.module.definePermissions}}getCompressNativeLib(){return this.getSourceSetByTargetName().getModuleTargetRes().getModuleJsonOpt().module.compressNativeLibs}}exports.ModuleModelImpl=ModuleModelImpl;