"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.validataParameterKeys=exports.matchValueWithParameterizationKey=void 0;const path_1=__importDefault(require("path")),hvigor_common_1=require("@ohos/hvigor-common"),fs_extra_1=__importDefault(require("fs-extra")),semver_1=require("semver"),common_const_js_1=require("../const/common-const.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),npm_utils_js_1=require("../utils/npm-utils.js"),dependency_tag_validate_js_1=require("./dependency-tag-validate.js"),log=ohos_logger_js_1.OhosLogger.getLogger("ParameterFileLog"),PARAMETER_KEY_REG=/(?=^(@(?![0-9\-_])[a-z0-9\-_]+(?<![-_])\/)?(?![0-9\-_.])[a-z0-9\-_.]+(?<![-_.])$).{1,128}$/i;function matchValueWithLongestPrefixStrategy(e,t){let a="";for(let r=e.length;r>0;r--){if(a=getValueFromJson(e.slice(0,r).join("."),a,t),"string"==typeof a)return a;if(a&&("object"==typeof a&&r!==e.length&&(a=matchValueWithLongestPrefixStrategy(e.slice(r,e.length),a),a)))return a}return""}function matchValueWithParameterizationKey({keys:e,parameterFileJson:t,pathParamsObj:a,ohPackageInfoGetter:r,dependencyName:o}){const n=matchValueWithLongestPrefixStrategy(e,t);return!n&&a.parameterFilePath&&log.printErrorExit("INVALID_PARAMETER_KEYS",[e.join(".")],[[a.parameterFilePath]]),processParameterizationValue({value:n,key:e.join("."),parameterFileJson:t,pathParamsObj:a,ohPackageInfoGetter:r,dependencyName:o})}function getValueFromJson(e,t,a){return t=getObjectValueByKey(e,t||a)}function getObjectValueByKey(e,t){return"string"==typeof t?t:t[e]}function validataParameterKeys(e){Object.keys(e).forEach(t=>{PARAMETER_KEY_REG.test(t)||log.printErrorExit("INCORRECT_PARAMETER_KEYS_FORMAT",[t]),"object"==typeof e[t]&&null!==e[t]&&validataParameterKeys(e[t])})}function processParameterizationValue(e){var t;const{value:a,key:r,pathParamsObj:o,dependencyName:n}=e;return"latest"===a||"*"===a?{value:a}:(0,npm_utils_js_1.isLocalDependency)(a)?e.ohPackageInfoGetter&&e.dependencyName&&(null===(t=e.pathParamsObj)||void 0===t?void 0:t.parameterFilePath)?handleParameterizationLocalDependencies(e):{value:`${common_const_js_1.ParameterizationConst.PREFIX}${r}`,localDepArr:[]}:((0,dependency_tag_validate_js_1.isValidateTag)({key:r,value:a,parameterFilePath:o.parameterFilePath,ohPackageFilePath:o.ohPackageFilePath,dependencyName:n})||(0,semver_1.validRange)(a,{loose:!0,includePrerelease:!0})||log.printErrorExit("INVALID_PARAMETER_VALUES",[a]),{value:a})}function handleParameterizationLocalDependencies(e){const{value:t,pathParamsObj:a,ohPackageInfoGetter:r,dependencyName:o,parameterFileJson:n}=e,_=t.startsWith(common_const_js_1.CommonConst.LOCAL_DEPENDENCY_PREFIX)?t.slice(common_const_js_1.CommonConst.LOCAL_DEPENDENCY_PREFIX.length):t,i=path_1.default.resolve(path_1.default.dirname(a.parameterFilePath),_);let s=!1;try{s=fs_extra_1.default.realpathSync.native(i)===i}catch(e){s=!1}if(s||log.printErrorExit("LOCAL_DEPENDENCY_IN_PARAMETER_FILE_DOES_NOT_EXIST",[],[[i,a.ohPackageFilePath,o]]),fs_extra_1.default.statSync(i).isDirectory()){r(path_1.default.resolve(i,common_const_js_1.CommonConst.OH_PACKAGE_JSON5))||log.printErrorExit("UNABLE_TO_GET_VERSION_AND_NAME_IN_OH_PACKAGE_JSON5",[o,path_1.default.resolve(i,common_const_js_1.CommonConst.OH_PACKAGE_JSON5)],[[a.parameterFilePath]]);const{version:e,name:t}=r(path_1.default.resolve(i,common_const_js_1.CommonConst.OH_PACKAGE_JSON5));o!==t&&log.printErrorExit("THERE_ARE_SOME_DEPENDENCY_NAMES_THAT_ARE_INCONSISTENT_WITH_THE_ACTUAL_PACKAGE_NAMES",[],[[o,a.ohPackageFilePath,t,t]]);const _=e.match(common_const_js_1.ParameterizationConst.REGEX);if(_){const{value:e}=matchValueWithParameterizationKey({keys:_[1].split("."),parameterFileJson:n,pathParamsObj:a,dependencyName:"version"});return{value:e}}return{value:e}}const l=path_1.default.extname(i).toLowerCase();if(".har"===l||".tgz"===l){const e=path_1.default.dirname(a.ohPackageFilePath);return{value:(0,hvigor_common_1.isSubPath)(i,e)?`${common_const_js_1.CommonConst.LOCAL_DEPENDENCY_PREFIX}${path_1.default.relative(e,i)}`:`${common_const_js_1.CommonConst.LOCAL_DEPENDENCY_PREFIX}${path_1.default.basename(i)}`,localDepArr:[i]}}log.printErrorExit("UNRECOGNIZED_ARCHIVE_FORMAT_IN_PARAMETER_FILE",[],[[i,a.ohPackageFilePath,o]])}exports.matchValueWithParameterizationKey=matchValueWithParameterizationKey,exports.validataParameterKeys=validataParameterKeys;