"use strict";var __importDefault=this&&this.__importDefault||function(o){return o&&o.__esModule?o:{default:o}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.HmosSdkLoader=void 0;const path_1=__importDefault(require("path")),hos_sdkmanager_common_1=require("@ohos/hos-sdkmanager-common"),hvigor_1=require("@ohos/hvigor"),fs_extra_1=__importDefault(require("fs-extra")),common_const_js_1=require("../const/common-const.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),meta_util_js_1=require("../utils/meta-util.js"),default_progress_js_1=require("./lib/default-progress.js"),property_get_js_1=require("./lib/property-get.js"),sdk_util_js_1=require("./sdk-util.js"),_log=ohos_logger_js_1.OhosLogger.getLogger("SdkLoader");class HmosSdkLoader{constructor(){this.hmsSdkMap=new Map,this.sdkMap=new Map,this.property=new property_get_js_1.Property,this.setHosMetaCompileSdkVersion()}static getInstance(){return HmosSdkLoader.container||(HmosSdkLoader.container=new HmosSdkLoader),HmosSdkLoader.container}setHosMetaCompileSdkVersion(){const o=hos_sdkmanager_common_1.HosVersionMapper.INSTANCE,e=o.getLatestSupportVersion(),s=`${o.getHosVersion(e.getBaseApi())}(${e.getBaseApi()})`;(0,meta_util_js_1.updateMetaCompileSdkVersion)(s)}async getHmosSdkComponents(o,e){var s;this.validateCache();const t=null!==(s=this.sdkMap.get(o.version))&&void 0!==s?s:new Map;if(this.checkComponentExistence(e,t,!1)){const o=new Map;return e.forEach(e=>o.set(e,t.get(e))),o}this.ohosSdkInfoHandler||this.initHandler();const r=hvigor_1.MetricFactory.createDurationEvent("harmonyOS sdk scan","HarmonyOS sdk scan",hvigor_1.HvigorTaskGroupType.OTHER_TASK_GROUP);r.log.debug(`Local scan or download HarmonyOS sdk components ${e.join(",")}`);const n=this.ohosSdkInfoHandler.getLocalSdks(`${o.version}`);this.checkComponentExistence(e,n,!1)||_log.printErrorExit("SDK_COMPONENT_MISSING");for(const[o,e]of n.entries())t.set(o,e);this.sdkMap.set(o.version,t),r.stop();const a=new Map;return e.forEach(o=>a.set(o,t.get(o))),a}checkComponentExistence(o,e,s){var t;for(const r of o){const o=e.get(r);if(!o)return!1;const n=s?common_const_js_1.CommonConst.HMS_SDK_COMPONENT_DEFINITION:common_const_js_1.CommonConst.OHOS_SDK_COMPONENT_DEFINITION,a=path_1.default.resolve(null!==(t=o.getLocation())&&void 0!==t?t:"",n);if(!fs_extra_1.default.existsSync(a))return!1}return!0}async getHmsSdkComponents(o,e){var s;this.validateCache();const t=null!==(s=this.hmsSdkMap.get(o.api))&&void 0!==s?s:new Map;if(this.checkComponentExistence(e,t,!0)){const o=new Map;return e.forEach(e=>o.set(e,t.get(e))),o}this.hmosSdkInfoHandler||this.initHandler();const r=hvigor_1.MetricFactory.createDurationEvent("hmscore sdk scan","Hmscore sdk scan",hvigor_1.HvigorTaskGroupType.OTHER_TASK_GROUP);r.log.debug(`Local scan or download hmscore sdk components ${e.join(",")}`);const n=this.hmosSdkInfoHandler.getLocalSdks(o.api);this.checkComponentExistence(e,n,!0)||_log.printErrorExit("SDK_COMPONENT_MISSING");for(const[o,e]of n.entries())t.set(o,e);this.hmsSdkMap.set(o.api,t),r.stop();const a=new Map;return e.forEach(o=>a.set(o,t.get(o))),a}initHandler(){const o=hos_sdkmanager_common_1.HosPrjSdkConfig.builder(this.property.getHosSdkDir()).sdkProxy(sdk_util_js_1.proxyFun),e=new hos_sdkmanager_common_1.SimpleHosPrjSdkHandler(o,new default_progress_js_1.DefaultProgress);this.hmosSdkInfoHandler=e.getSdkHandler(hos_sdkmanager_common_1.HosPrjSdkType.HARMONYOS),this.ohosSdkInfoHandler=e.getSdkHandler(hos_sdkmanager_common_1.HosPrjSdkType.OPENHARMONY)}validateCache(){const o=new property_get_js_1.Property;o.getHosSdkDir()!==this.property.getHosSdkDir()&&(_log.debug("HarmonyOS sdk dir changed."),this.property=o,this.sdkMap.clear(),this.hmsSdkMap.clear(),this.initHandler())}}exports.HmosSdkLoader=HmosSdkLoader;