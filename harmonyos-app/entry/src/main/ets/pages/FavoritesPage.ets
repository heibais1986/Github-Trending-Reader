/**
 * Favorites page
 */

import router from '@ohos.router';
import { createFavoritesManager, FavoriteItem } from '../models';
import { Repository } from '../models/Repository';

@Entry
@Component
struct FavoritesPage {
  @State favoriteItems: FavoriteItem[] = [];
  @State isLoading: boolean = true;
  @State isEmpty: boolean = true;
  
  private favoritesManager = createFavoritesManager();

  aboutToAppear() {
    this.loadFavorites();
  }

  /**
   * åŠ è½½æ”¶è—åˆ—è¡¨
   */
  private loadFavorites() {
    this.isLoading = true;
    try {
      this.favoriteItems = this.favoritesManager.getFavorites();
      this.isEmpty = this.favoriteItems.length === 0;
      console.info('FavoritesPage', 'åŠ è½½æ”¶è—:', this.favoriteItems.length, 'æ¡');
    } catch (error) {
      console.error('FavoritesPage', 'åŠ è½½æ”¶è—å¤±è´¥:', error);
      this.isEmpty = true;
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * å¯¼èˆªåˆ°ä»“åº“è¯¦æƒ…
   */
  private navigateToRepositoryDetail(repository: Repository) {
    try {
      router.pushUrl({
        url: 'pages/WebViewPage',
        params: {
          url: repository.htmlUrl || '',
          title: repository.name
        }
      });
    } catch (error) {
      console.error('FavoritesPage', 'å¯¼èˆªå¤±è´¥:', error);
    }
  }

  /**
   * ä»æ”¶è—ä¸­ç§»é™¤
   */
  private removeFromFavorites(repositoryId: string) {
    this.favoritesManager.removeFromFavorites(repositoryId);
    this.loadFavorites(); // é‡æ–°åŠ è½½
  }

  /**
   * æ ¼å¼åŒ–æ—¥æœŸ
   */
  private formatDate(date: Date): string {
    const now = new Date();
    const diff = now.getTime() - date.getTime();
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    
    if (days === 0) {
      return 'ä»Šå¤©';
    } else if (days === 1) {
      return 'æ˜¨å¤©';
    } else if (days < 7) {
      return `${days}å¤©å‰`;
    } else {
      return date.toLocaleDateString();
    }
  }

  build() {
    Column() {
      // é¡µé¢æ ‡é¢˜
      Row() {
        Button('â†')
          .fontSize(16)
          .fontColor('#333')
          .backgroundColor(Color.Transparent)
          .onClick(() => {
            router.back();
          })
        
        Text('æˆ‘çš„æ”¶è—')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333')
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#f5f5f5')

      // å†…å®¹åŒºåŸŸ
      if (this.isLoading) {
        Column() {
          LoadingProgress()
            .width(40)
            .height(40)
            .margin({ top: 50 })
          Text('åŠ è½½ä¸­...')
            .fontSize(16)
            .fontColor('#666')
            .margin({ top: 10 })
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
      } else if (this.isEmpty) {
        Column() {
          Text('æš‚æ— æ”¶è—')
            .fontSize(18)
            .fontColor('#999')
            .margin({ top: 50 })
          Text('æ”¶è—çš„ä»“åº“ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ')
            .fontSize(14)
            .fontColor('#ccc')
            .margin({ top: 10 })
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
      } else {
        // æ”¶è—åˆ—è¡¨
        List({ space: 8 }) {
          ForEach(this.favoriteItems, (item: FavoriteItem) => {
            ListItem() {
              this.FavoriteItem(item)
            }
          }, (item: FavoriteItem) => item.id)
        }
        .layoutWeight(1)
        .padding(12)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
  }

  @Builder
  FavoriteItem(item: FavoriteItem) {
    Column() {
      Row() {
        // ä»“åº“ä¿¡æ¯
        Column({ space: 4 }) {
          Text(item.repository.name)
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#333')
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .width('100%')
            .textAlign(TextAlign.Start)
          
          Text(item.repository.owner?.login || '')
            .fontSize(14)
            .fontColor('#666')
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .width('100%')
            .textAlign(TextAlign.Start)
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)
        
        // å–æ¶ˆæ”¶è—æŒ‰é’®
        Button('â¤ï¸')
          .fontSize(16)
          .fontColor('#ff4757')
          .backgroundColor(Color.Transparent)
          .width(32)
          .height(32)
          .onClick(() => {
            this.removeFromFavorites(item.repository.id);
          })
      }
      .width('100%')
      .alignItems(VerticalAlign.Center)

      // æ”¶è—æ—¶é—´
      Text(`æ”¶è—äº ${this.formatDate(item.favoritedAt)}`)
        .fontSize(12)
        .fontColor('#999')
        .width('100%')
        .textAlign(TextAlign.Start)
        .margin({ top: 4 })

      // ä»“åº“æè¿°
      if (item.repository.description) {
        Text(item.repository.description)
          .fontSize(14)
          .fontColor('#666')
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .width('100%')
          .textAlign(TextAlign.Start)
          .margin({ top: 4 })
      }

      // æ ‡ç­¾
      if (item.tags && item.tags.length > 0) {
        Row({ space: 8 }) {
          ForEach(item.tags, (tag: string) => {
            Text(tag)
              .fontSize(12)
              .fontColor('#409eff')
              .padding({ left: 8, right: 8, top: 2, bottom: 2 })
              .backgroundColor('#e6f7ff')
              .borderRadius(4)
          }, (tag: string) => tag)
        }
        .width('100%')
        .margin({ top: 4 })
      }

      // å¤‡æ³¨
      if (item.notes && item.notes.trim() !== '') {
        Text(item.notes)
          .fontSize(12)
          .fontColor('#666')
          .fontStyle(FontStyle.Italic)
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .width('100%')
          .textAlign(TextAlign.Start)
          .margin({ top: 4 })
      }

      // ç»Ÿè®¡ä¿¡æ¯
      Row({ space: 16 }) {
        Row({ space: 4 }) {
          Text('â­')
            .fontSize(12)
          Text(item.repository.stars.toString())
            .fontSize(12)
            .fontColor('#666')
        }

        if (item.repository.language) {
          Row({ space: 4 }) {
            Text('ğŸ”¤')
              .fontSize(12)
            Text(item.repository.language)
              .fontSize(12)
              .fontColor('#666')
          }
        }
      }
      .width('100%')
      .margin({ top: 8 })
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(8)
    .shadow({ radius: 2, color: '#00000010', offsetX: 0, offsetY: 1 })
    .onClick(() => {
      this.navigateToRepositoryDetail(item.repository);
    })
  }
}