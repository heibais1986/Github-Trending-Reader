/**
 * WebView page for displaying web content within the app
 */

import webview from '@ohos.web.webview';
import window from '@ohos.window';
import common from '@ohos.app.ability.common';
import promptAction from '@ohos.promptAction';
import router from '@ohos.router';
import { LoadingIndicator, LoadingType, LoadingSize } from '../components/LoadingIndicator';
import { FeedbackUtils } from '../utils/FeedbackManager';
import { createFavoritesManager, createRepository, createRepositoryOwner, Repository } from '../models';

@Entry
@Component
struct WebViewPage {
  @State url: string = '';
  @State title: string = 'ç½‘é¡µæµè§ˆ';
  @State loading: boolean = true;
  @State error: string | null = null;
  @State isFavorited: boolean = false;
  @State repository: Repository | null = null;
  @State retryCount: number = 0;
  private maxRetries: number = 2;
  
  private webviewController: webview.WebviewController = new webview.WebviewController();
  private context: common.UIAbilityContext = getContext(this) as common.UIAbilityContext;
  private favoritesManager = createFavoritesManager();

  aboutToAppear() {
    // Get URL and title from router parameters
    const routerParams: Object | undefined = router.getParams();
    if (routerParams) {
      const params = routerParams as Object;
      this.url = (params as Record<string, string>)['url'] || '';
      this.title = (params as Record<string, string>)['title'] || 'ç½‘é¡µæµè§ˆ';
    }
    
    // é‡ç½®çŠ¶æ€
    this.loading = true;
    this.error = null;
    this.retryCount = 0;

    // åˆå§‹åŒ–ä»“åº“å¯¹è±¡å’Œæ”¶è—çŠ¶æ€
    this.repository = this.createRepositoryFromUrl(this.url, this.title);
    this.checkFavoriteStatus();
  }

  /**
   * Handle page start loading
   */
  private onPageStart() {
    this.loading = true;
    this.error = null;
  }

  /**
   * Handle page finish loading
   */
  private onPageFinish() {
    this.loading = false;
  }

  /**
   * Handle page error
   */
  private onErrorReceived(errorInfo: Object) {
    this.loading = false;
    // æ£€æŸ¥æ˜¯å¦æ˜¯ç½‘ç»œè¶…æ—¶é”™è¯¯
    const error = errorInfo as Record<string, Object>;
    const errorCode = error.errorCode || 0;

    if (errorCode === -7) { // ERR_TIMED_OUT
      this.error = 'ç½‘é¡µåŠ è½½è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
    } else {
      this.error = 'åŠ è½½ç½‘é¡µæ—¶å‘ç”Ÿé”™è¯¯';
    }
    console.error('WebView error:', errorInfo);
    
    // æ ¹æ®é”™è¯¯ç±»å‹æ˜¾ç¤ºä¸åŒçš„æç¤º
    if (errorCode === -7) { // ERR_TIMED_OUT
      FeedbackUtils.showError('ç½‘é¡µåŠ è½½è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
    } else {
      FeedbackUtils.showError('ç½‘é¡µåŠ è½½å¤±è´¥');
    }
  }

  /**
   * Handle navigation back
   */
  private goBack() {
    if (this.webviewController) {
      this.webviewController.backward();
    }
  }

  /**
   * Handle navigation forward
   */
  private goForward() {
    if (this.webviewController) {
      this.webviewController.forward();
    }
  }

  /**
   * Reload current page
   */
  private reload() {
    if (this.webviewController) {
      this.loading = true;
      this.error = null;
      this.retryCount = 0; // é‡ç½®é‡è¯•è®¡æ•°
      this.webviewController.refresh();
    }
  }

  /**
   * Close webview and go back
   */
  private close() {
    this.retryCount = 0; // é‡ç½®é‡è¯•è®¡æ•°
    router.back();
  }

  /**
   * Toggle favorite status
   */
  private toggleFavorite() {
    if (!this.repository) {
      // å¦‚æœæ²¡æœ‰ä»“åº“ä¿¡æ¯ï¼Œå°è¯•ä»URLåˆ›å»ºä¸€ä¸ªç®€å•çš„ä»“åº“å¯¹è±¡
      this.repository = this.createRepositoryFromUrl(this.url, this.title);
    }
    
    if (this.repository) {
      if (this.isFavorited) {
        // å–æ¶ˆæ”¶è—
        const success = this.favoritesManager.removeFromFavorites(this.repository.id);
        if (success) {
          this.isFavorited = false;
          FeedbackUtils.showSuccess('å·²å–æ¶ˆæ”¶è—');
        }
      } else {
        // æ·»åŠ æ”¶è—
        const success = this.favoritesManager.addToFavorites(this.repository);
        if (success) {
          this.isFavorited = true;
          FeedbackUtils.showSuccess('å·²æ·»åŠ åˆ°æ”¶è—');
        }
      }
    }
  }

  /**
   * Check if current repository is favorited
   */
  private checkFavoriteStatus() {
    if (this.repository) {
      this.isFavorited = this.favoritesManager.isFavorited(this.repository.id);
    }
  }

  /**
   * Create repository from URL
   */
  private createRepositoryFromUrl(url: string, title: string): Repository | null {
    try {
      // å°è¯•ä»URLè§£æGitHubä»“åº“ä¿¡æ¯
      const githubMatch = url.match(/github\.com\/([^\/]+)\/([^\/]+)/);
      if (githubMatch) {
        const owner = githubMatch[1];
        const name = githubMatch[2];
        
        return createRepository({
          id: `repo_${owner}_${name}`,
          name: name,
          fullName: `${owner}/${name}`,
          description: title,
          owner: createRepositoryOwner({
            login: owner,
            avatarUrl: ''
          }),
          url: url,
          stars: 0,
          language: ''
        });
      }
      
      // å¦‚æœä¸æ˜¯GitHubä»“åº“ï¼Œåˆ›å»ºä¸€ä¸ªé€šç”¨çš„ä»“åº“å¯¹è±¡
      return createRepository({
        id: `repo_${Date.now()}`,
        name: title || 'Unknown',
        fullName: title || 'Unknown',
        description: title,
        owner: createRepositoryOwner({
          login: 'Unknown',
          avatarUrl: ''
        }),
        url: url,
        stars: 0,
        language: ''
      });
    } catch (error) {
      console.error('WebViewPage', 'åˆ›å»ºä»“åº“å¯¹è±¡å¤±è´¥:', error);
      return null;
    }
  }

  build() {
    Column() {
      // Header with navigation controls
      Row() {
        // Back button
        Button('â†')
          .fontSize(16)
          .fontColor($r('app.color.text_primary'))
          .backgroundColor($r('app.color.card_background'))
          .borderRadius(8)
          .width(40)
          .height(40)
          .margin({ right: 8 })
          .onClick(() => {
            if (this.webviewController && this.webviewController.accessBackward()) {
              this.webviewController.backward();
            } else {
              this.close();
            }
          })

        // Title
        Text(this.title)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor($r('app.color.text_primary'))
          .layoutWeight(1)
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })

        // Favorite button
        Button(this.isFavorited ? 'â¤ï¸' : 'ğŸ¤')
          .fontSize(16)
          .fontColor(this.isFavorited ? '#ff4757' : $r('app.color.text_primary'))
          .backgroundColor($r('app.color.card_background'))
          .borderRadius(8)
          .width(40)
          .height(40)
          .margin({ right: 8 })
          .onClick(() => {
            this.toggleFavorite();
          })

        // Reload button
        Button('â†»')
          .fontSize(16)
          .fontColor($r('app.color.text_primary'))
          .backgroundColor($r('app.color.card_background'))
          .borderRadius(8)
          .width(40)
          .height(40)
          .margin({ right: 8 })
          .onClick(() => {
            this.reload();
          })

        // Close button
        Button('âœ•')
          .fontSize(16)
          .fontColor($r('app.color.text_primary'))
          .backgroundColor($r('app.color.card_background'))
          .borderRadius(8)
          .width(40)
          .height(40)
          .onClick(() => {
            this.close();
          })
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor($r('app.color.card_background'))
      .alignItems(VerticalAlign.Center)

      // Progress bar when loading
      if (this.loading) {
        Divider()
          .color($r('app.color.primary_color'))
          .strokeWidth(2)
          .width('30%')
          .alignSelf(ItemAlign.Start)
      }

      // WebView content
      Stack() {
        // WebView component
        Web({
          controller: this.webviewController,
          src: this.url
        })
        .onPageBegin((event) => {
          this.onPageStart();
        })
        .onPageEnd((event) => {
          this.onPageFinish();
        })
        .onErrorReceive((event) => {
          this.onErrorReceived(event.error);
        })
        .layoutWeight(1)
        .width('100%')
        .height('100%')

        // Loading indicator
        if (this.loading && !this.error) {
          Column() {
            LoadingIndicator({
              type: LoadingType.SPINNER,
              indicatorSize: LoadingSize.LARGE,
              message: 'æ­£åœ¨åŠ è½½ç½‘é¡µ...',
              showMessage: true
            })
          }
          .width('100%')
          .height('100%')
          .justifyContent(FlexAlign.Center)
          .backgroundColor('#FFFFFF')
        }

        // Error view
        if (this.error) {
          Column() {
            Text(this.error)
              .fontSize(14)
              .fontColor($r('app.color.error_color'))
              .textAlign(TextAlign.Center)
              .padding(24)

            Button('é‡æ–°åŠ è½½')
              .fontSize(14)
              .fontColor(Color.White)
              .backgroundColor($r('app.color.primary_color'))
              .borderRadius(8)
              .padding({ left: 24, right: 24, top: 12, bottom: 12 })
              .onClick(() => {
                this.reload();
              })
          }
          .width('100%')
          .height('100%')
          .justifyContent(FlexAlign.Center)
          .backgroundColor('#FFFFFF')
        }
      }
      .layoutWeight(1)
      .width('100%')
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.background_color'))
  }
}