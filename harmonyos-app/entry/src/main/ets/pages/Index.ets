import router from '@ohos.router';
import { createTrendingViewModel, TrendingUiState, createGitHubTrendingViewModel, GitHubTrendingUiState } from '../viewmodels';
import { Repository, createBrowsingHistoryManager, createFavoritesManager } from '../models';

@Entry
@Component
struct Index {
  @State currentTabIndex: number = 0;
  private zReadPageViewModel = createTrendingViewModel();
  @State zReadUiState: TrendingUiState = new TrendingUiState();
  private gitHubPageViewModel = createGitHubTrendingViewModel();
  @State gitHubUiState: GitHubTrendingUiState = new GitHubTrendingUiState();
  
  // "æˆ‘çš„"é¡µé¢çš„çŠ¶æ€
  @State browsingHistoryCount: number = 0;
  @State favoritesCount: number = 0;
  @State appVersion: string = '2.0.0';
  
  // æ•°æ®ç®¡ç†å™¨
  private browsingHistoryManager = createBrowsingHistoryManager();
  private favoritesManager = createFavoritesManager();

  aboutToAppear() {
    // ç›‘å¬ZReadé¡µé¢ViewModelçŠ¶æ€å˜åŒ–
    this.zReadPageViewModel.addStateChangeListener((state: TrendingUiState) => {
      this.zReadUiState.isLoading = state.isLoading;
      this.zReadUiState.isRefreshing = state.isRefreshing;
      this.zReadUiState.repositories = state.repositories.slice();
      this.zReadUiState.error = state.error;
      this.zReadUiState.openBrowserEvent = state.openBrowserEvent;
      
      // å¤„ç†æ‰“å¼€æµè§ˆå™¨äº‹ä»¶
      if (state.openBrowserEvent && state.openBrowserEvent.repository) {
        this.navigateToRepositoryDetail(state.openBrowserEvent.repository);
      }
    });
    
    // ç›‘å¬GitHubé¡µé¢ViewModelçŠ¶æ€å˜åŒ–
    this.gitHubPageViewModel.addStateChangeListener((state: GitHubTrendingUiState) => {
      this.gitHubUiState.isLoading = state.isLoading;
      this.gitHubUiState.isRefreshing = state.isRefreshing;
      this.gitHubUiState.repositories = state.repositories.slice();
      this.gitHubUiState.error = state.error;
      this.gitHubUiState.openBrowserEvent = state.openBrowserEvent;
      
      // å¤„ç†æ‰“å¼€æµè§ˆå™¨äº‹ä»¶
      if (state.openBrowserEvent && state.openBrowserEvent.repository) {
        this.navigateToRepositoryDetail(state.openBrowserEvent.repository);
      }
    });
    
    // åŠ è½½æµè§ˆåŽ†å²å’Œæ”¶è—æ•°æ®
    this.loadUserData();
  }
  
  /**
   * åŠ è½½ç”¨æˆ·æ•°æ®
   */
  private loadUserData() {
    try {
      this.browsingHistoryCount = this.browsingHistoryManager.getHistoryCount();
      this.favoritesCount = this.favoritesManager.getFavoritesCount();
      console.info('Index', 'åŠ è½½ç”¨æˆ·æ•°æ®å®Œæˆ:', {
        browsingHistoryCount: this.browsingHistoryCount,
        favoritesCount: this.favoritesCount
      });
    } catch (error) {
      console.error('Index', 'åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
    }
  }

  aboutToDisappear() {
    // æ¸…ç†èµ„æº
    this.zReadPageViewModel.destroy();
    this.gitHubPageViewModel.destroy();
  }

  /**
   * å¯¼èˆªåˆ°ä»“åº“è¯¦æƒ…é¡µé¢
   * @param url - ä»“åº“URL
   */
  private navigateToRepositoryDetail(repository: Repository) {
    try {
      router.pushUrl({
        url: 'pages/WebViewPage',
        params: {
          url: repository.htmlUrl || repository.url,
          title: repository.name
        }
      });
    } catch (error) {
      console.error('Index', 'å¯¼èˆªåˆ°ä»“åº“è¯¦æƒ…é¡µé¢å¤±è´¥:', error);
    }
  }

  @Builder
  ZReadTrendingContent() {
    Column({ space: 20 }) {
      // æ ‡é¢˜
      Text('GitHubè¶‹åŠ¿ä»“åº“ (ZRead)')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .margin({ top: 20, bottom: 10 })

      // åŠ è½½çŠ¶æ€
      if (this.zReadUiState.isLoading) {
        LoadingProgress()
          .width(40)
          .height(40)
          .margin({ top: 20 })
        Text('åŠ è½½ä¸­...')
          .fontSize(16)
          .fontColor('#666')
      } 
      // é”™è¯¯çŠ¶æ€
      else if (this.zReadUiState.error) {
        Column({ space: 10 }) {
          Text('åŠ è½½å¤±è´¥')
            .fontSize(18)
            .fontColor('#f56c6c')
          Text(this.zReadUiState.error)
            .fontSize(14)
            .fontColor('#999')
            .textAlign(TextAlign.Center)
            .maxLines(3)
          Button('é‡è¯•')
            .backgroundColor('#409eff')
            .fontColor(Color.White)
            .onClick(() => {
              this.zReadPageViewModel.retry();
            })
        }
        .padding(20)
      }
      // æ•°æ®å±•ç¤º
      else {
        // åˆ·æ–°æŽ§åˆ¶
        Row({ space: 10 }) {
          Text(`å…± ${this.zReadUiState.repositories.length} ä¸ªä»“åº“`)
            .fontSize(14)
            .fontColor('#666')
          Button('åˆ·æ–°')
            .backgroundColor(this.zReadUiState.isRefreshing ? '#ccc' : '#67c23a')
            .fontColor(Color.White)
            .enabled(!this.zReadUiState.isRefreshing)
            .onClick(() => {
              this.zReadPageViewModel.onRefresh();
            })
        }
        .margin({ bottom: 10 })

        // ä»“åº“åˆ—è¡¨
        List({ space: 10 }) {
          ForEach(this.zReadUiState.repositories, (item: Repository) => {
            ListItem() {
              this.RepositoryItem(item)
            }
          }, (item: Repository) => item.id)
        }
        .layoutWeight(1)
        .padding(10)
      }
    }
    .width('100%')
    .height('100%')
    .padding({ left: 20, right: 20, bottom: 60 })
    .backgroundColor('#f5f5f5')
  }

  @Builder
  GitHubTrendingContent() {
    Column({ space: 20 }) {
      // æ ‡é¢˜
      Text('GitHubè¶‹åŠ¿ä»“åº“')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .margin({ top: 20, bottom: 10 })

      // åŠ è½½çŠ¶æ€
      if (this.gitHubUiState.isLoading) {
        LoadingProgress()
          .width(40)
          .height(40)
          .margin({ top: 20 })
        Text('åŠ è½½ä¸­...')
          .fontSize(16)
          .fontColor('#666')
      } 
      // é”™è¯¯çŠ¶æ€
      else if (this.gitHubUiState.error) {
        Column({ space: 10 }) {
          Text('åŠ è½½å¤±è´¥')
            .fontSize(18)
            .fontColor('#f56c6c')
          Text(this.gitHubUiState.error)
            .fontSize(14)
            .fontColor('#999')
            .textAlign(TextAlign.Center)
            .maxLines(3)
          Button('é‡è¯•')
            .backgroundColor('#409eff')
            .fontColor(Color.White)
            .onClick(() => {
              this.gitHubPageViewModel.retry();
            })
        }
        .padding(20)
      }
      // æ•°æ®å±•ç¤º
      else {
        // åˆ·æ–°æŽ§åˆ¶
        Row({ space: 10 }) {
          Text(`å…± ${this.gitHubUiState.repositories.length} ä¸ªä»“åº“`)
            .fontSize(14)
            .fontColor('#666')
          Button('åˆ·æ–°')
            .backgroundColor(this.gitHubUiState.isRefreshing ? '#ccc' : '#67c23a')
            .fontColor(Color.White)
            .enabled(!this.gitHubUiState.isRefreshing)
            .onClick(() => {
              this.gitHubPageViewModel.onRefresh();
            })
        }
        .margin({ bottom: 10 })

        // ä»“åº“åˆ—è¡¨
        List({ space: 10 }) {
          ForEach(this.gitHubUiState.repositories, (item: Repository) => {
            ListItem() {
              this.RepositoryItem(item)
            }
          }, (item: Repository) => item.id)
        }
        .layoutWeight(1)
        .padding(10)
      }
    }
    .width('100%')
    .height('100%')
    .padding({ left: 20, right: 20, bottom: 60 })
    .backgroundColor('#f5f5f5')
  }

  @Builder
  MyPageContent() {
    Column({ space: 16 }) {
      // é¡µé¢æ ‡é¢˜
      Text('æˆ‘çš„')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')
        .margin({ top: 20, bottom: 10 })
        .alignSelf(ItemAlign.Start)

      // åŠŸèƒ½å¡ç‰‡åˆ—è¡¨
      Column({ space: 12 }) {
        // æˆ‘çš„å¡ç‰‡
        this.MenuCard(
          'ðŸ‘¤',
          'æˆ‘çš„',
          'ç®¡ç†ä½ çš„æµè§ˆè®°å½•å’Œæ”¶è—',
          () => {
            // å¯ä»¥è·³è½¬åˆ°ä¸ªäººä¿¡æ¯é¡µé¢
          }
        )

        // æµè§ˆåŽ†å²å¡ç‰‡
        this.MenuCard(
          'ðŸ•',
          'æµè§ˆåŽ†å²',
          `${this.browsingHistoryCount} ä¸ªä»“åº“`,
          () => {
            // è·³è½¬åˆ°æµè§ˆåŽ†å²é¡µé¢
            try {
              router.pushUrl({
                url: 'pages/BrowsingHistoryPage'
              });
            } catch (error) {
              console.error('Index', 'è·³è½¬åˆ°æµè§ˆåŽ†å²é¡µé¢å¤±è´¥:', error);
            }
          }
        )

        // æˆ‘çš„æ”¶è—å¡ç‰‡
        this.MenuCard(
          'â¤ï¸',
          'æˆ‘çš„æ”¶è—',
          `${this.favoritesCount} ä¸ªä»“åº“`,
          () => {
            // è·³è½¬åˆ°æ”¶è—é¡µé¢
            try {
              router.pushUrl({
                url: 'pages/FavoritesPage'
              });
            } catch (error) {
              console.error('Index', 'è·³è½¬åˆ°æ”¶è—é¡µé¢å¤±è´¥:', error);
            }
          }
        )

        // å…³äºŽå¡ç‰‡
        this.MenuCard(
          'â„¹ï¸',
          'å…³äºŽ',
          `ç‰ˆæœ¬ ${this.appVersion}`,
          () => {
            // å¯ä»¥è·³è½¬åˆ°å…³äºŽé¡µé¢
          }
        )
      }
      .padding({ left: 16, right: 16 })
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5FAFB')
    .padding({ bottom: 60 })
  }

  @Builder
  MenuCard(icon: string, title: string, subtitle: string, onClick: () => void) {
    Row() {
      // å·¦ä¾§å›¾æ ‡
      Text(icon)
        .fontSize(24)
        .width(40)
        .height(40)
        .textAlign(TextAlign.Center)

      // ä¸­é—´æ ‡é¢˜å’Œå‰¯æ ‡é¢˜
      Column({ space: 4 }) {
        Text(title)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
          .alignSelf(ItemAlign.Start)
        
        Text(subtitle)
          .fontSize(14)
          .fontColor('#666666')
          .alignSelf(ItemAlign.Start)
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)
      .margin({ left: 12 })

      // å³ä¾§ç®­å¤´
      Text('>')
        .fontSize(16)
        .fontColor('#999999')
        .margin({ right: 8 })
    }
    .width('100%')
    .height(60)
    .padding({ left: 16, right: 16 })
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
    .shadow({ radius: 4, color: '#00000010', offsetX: 0, offsetY: 2 })
    .justifyContent(FlexAlign.SpaceBetween)
    .onClick(() => {
      onClick();
    })
  }

  @Builder
  RepositoryItem(repo: Repository) {
    Column({ space: 8 }) {
      // ä»“åº“åç§°å’Œä½œè€…
      Row({ space: 10 }) {
        Text(repo.name)
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333')
        Text(repo.owner.login || '')
          .fontSize(14)
          .fontColor('#666')
      }
      .width('100%')
      .justifyContent(FlexAlign.Start)

      // æè¿°
      if (repo.description) {
        Text(repo.description)
          .fontSize(14)
          .fontColor('#666')
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .width('100%')
          .textAlign(TextAlign.Start)
      }

      // ç»Ÿè®¡ä¿¡æ¯
      Row({ space: 20 }) {
        Row({ space: 5 }) {
          Image($r('app.media.ic_star'))
            .width(16)
            .height(16)
          Text(repo.stars.toString())
            .fontSize(12)
            .fontColor('#666')
        }

        if (repo.language) {
          Row({ space: 5 }) {
            Image($r('app.media.ic_language'))
              .width(16)
              .height(16)
            Text(repo.language)
              .fontSize(12)
              .fontColor('#666')
          }
        }
      }
      .width('100%')
      .justifyContent(FlexAlign.Start)
    }
    .padding(15)
    .backgroundColor(Color.White)
    .borderRadius(8)
    .shadow({ radius: 4, color: '#00000010', offsetX: 0, offsetY: 2 })
    .onClick(() => {
      // æ·»åŠ åˆ°æµè§ˆåŽ†å²
      try {
        this.browsingHistoryManager.addToHistory(repo);
        // å¼ºåˆ¶æ›´æ–°è®¡æ•°ï¼Œç¡®ä¿UIåˆ·æ–°
        this.browsingHistoryCount = 0;
        setTimeout(() => {
          this.browsingHistoryCount = this.browsingHistoryManager.getHistoryCount();
        }, 0);
      } catch (error) {
        console.error('Index', 'æ·»åŠ æµè§ˆåŽ†å²å¤±è´¥:', error);
      }
      
      // å¤„ç†é¡µé¢å¯¼èˆª
      if (this.currentTabIndex === 0) {
        this.zReadPageViewModel.onRepositoryClick(repo);
      } else if (this.currentTabIndex === 1) {
        this.gitHubPageViewModel.onRepositoryClick(repo);
      }
    })
  }

  build() {
    Column() {
      // å†…å®¹åŒºåŸŸ
      Tabs({ barPosition: BarPosition.End, index: this.currentTabIndex }) {
        TabContent() {
          this.ZReadTrendingContent()
        }
        .tabBar('ZRead')
        .backgroundColor('#f5f5f5')

        TabContent() {
          this.GitHubTrendingContent()
        }
        .tabBar('GitHub')
        .backgroundColor('#f5f5f5')

        TabContent() {
          this.MyPageContent()
        }
        .tabBar('æˆ‘çš„')
        .backgroundColor('#f5f5f5')
      }
      .barHeight(50)
      .animationDuration(300)
      .onChange((index: number) => {
        this.currentTabIndex = index;
      })
      .backgroundColor('#f5f5f5')
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
  }
}